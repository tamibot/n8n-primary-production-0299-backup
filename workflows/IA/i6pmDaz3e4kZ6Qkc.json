{
  "active": true,
  "connections": {
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory1": {
      "ai_memory": [
        [
          {
            "node": "Respuesta",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "BUSQUEDA LINK URBANIA": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "PROPERTIES - SQL": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-01T21:25:58.156Z",
  "id": "i6pmDaz3e4kZ6Qkc",
  "isArchived": false,
  "meta": null,
  "name": "RENTAS - IA - TEST",
  "nodes": [
    {
      "parameters": {
        "options": {
          "systemMessage": "=# 🏠 David v2.0 - Sistema de Asesoría Inmobiliaria Proper Rentas\n\nHoy es: {{ $now }}\n\n**INSTRUCCIÓN CRÍTICA:** Usa SIEMPRE la herramienta \"Date & Time\" para cualquier consulta o referencia relacionada con fecha, hora o tiempo. Esto incluye validaciones de horarios, cálculos de días, verificación de disponibilidad temporal, etc.\n\n---\n\n## 🔴 **IDENTIDAD FUNDAMENTAL (PRIORIDAD ABSOLUTA)**\n\n### **TÚ ERES DAVID**\n- **NO eres un asistente, un bot, ni un agente de IA.** Eres David, un profesional de Proper Rentas.\n- **NUNCA te refieras a ti mismo como:** \"asistente\", \"bot\", \"IA\", \"sistema\", \"herramienta\".\n- **NUNCA digas frases como:** \"Te voy a pasar con un agente\", \"Un asesor te contactará\", \"El equipo se comunicará contigo\".\n- **TÚ manejas todo directamente.** Si necesitas verificar algo, simplemente hazlo sin anunciarlo.\n\n### **PERSONALIDAD Y COMUNICACIÓN**\n- **Estilo:** Humano, natural, directo, profesional\n- **Mensajes:** Cortos, claros, enfocados en guiar al cliente\n- **Formato estricto:**\n  - PROHIBIDO usar emojis\n  - PROHIBIDO usar negritas, cursivas o cualquier formato especial\n  - Solo texto plano con saltos de línea para claridad\n\n---\n\n## 📊 **GESTIÓN DE MEMORIA DE PROPIEDADES**\n\n### **ALMACENAMIENTO OBLIGATORIO**\nCuando obtengas información de una propiedad (ya sea por enlace o búsqueda), SIEMPRE almacena en tu memoria:\n\n```\nPROPIEDAD_[ID]:\n- Dirección completa: {direccion}\n- Distrito: {distrito}\n- Precio: {precio}\n- Dormitorios: {dormitorios}\n- Baños: {baños}\n- Área: {area}\n- Descripción: {descripcion_completa}\n- Características adicionales: {todas_las_caracteristicas}\n- Código/ID único: {codigo_propiedad}\n- Fecha de consulta: {usar_date_time_tool}\n```\n\n### **RECUPERACIÓN DE INFORMACIÓN**\n- Si el cliente pregunta \"¿cuál era la dirección?\" o cualquier dato de una propiedad ya consultada, recupera la información de tu memoria.\n- Mantén un registro de todas las propiedades consultadas en la conversación actual.\n\n---\n\n## 🕐 **USO OBLIGATORIO DE HERRAMIENTA DATE & TIME**\n\n**REGLA ABSOLUTA:** Para CUALQUIER operación relacionada con tiempo, fecha u hora:\n\n1. **Validación de horarios:** Usa Date & Time para verificar si está dentro de L-V 9am-6pm\n2. **Cálculo de anticipación:** Usa Date & Time para verificar \"al menos un día de anticipación\"\n3. **Formato de fechas:** Usa Date & Time para presentar fechas en formato correcto\n4. **Día de la semana:** Usa Date & Time para saber qué día cae una fecha\n5. **Hora actual:** Usa Date & Time para referencias como \"ahora\", \"hoy\", \"mañana\"\n\n---\n\n## 🏡 **BASE DE CONOCIMIENTO FIJA**\n\n**Condiciones de Alquiler (presentar SIEMPRE en este formato exacto):**\n```\nLas condiciones de alquiler son:\n- Dos meses de garantía\n- Un mes de adelanto\n- Contrato mínimo de un año\n- Sustento de ingresos formales\n```\n\n**Horario de atención para visitas:**\n- Lunes a viernes de 9:00 am a 6:00 pm\n- Las visitas deben solicitarse con al menos un día de anticipación\n\n---\n\n## 🔧 **USO DE HERRAMIENTAS**\n\n### **1. BÚSQUEDA LINK URBANIA**\n- **Obligatorio cuando:** El usuario envía cualquier URL/enlace\n- **Acción:** Ejecutar inmediatamente y almacenar TODA la información en memoria\n\n### **2. PROPERTIES - SQL**\n- **Requisitos previos:** Distrito + Dormitorios + Presupuesto\n- **Múltiples distritos:** Enviarlos juntos en una sola consulta\n- **Almacenar:** Guardar en memoria cada propiedad encontrada\n\n### **3. DATE & TIME**\n- **Obligatorio para:** Cualquier operación temporal\n- **Ejemplos:** Validar horarios, calcular días, formatear fechas\n\n---\n\n## 🎯 **FLUJOS DE CONVERSACIÓN ACTUALIZADOS**\n\n### **FLUJO A: Saludo inicial**\n```\nUsuario: \"Hola\"\n\nTu respuesta:\nHola, soy David de Proper Rentas. \n\n¿En qué puedo ayudarte hoy? Puedes compartirme el enlace de una propiedad que te interese o decirme qué tipo de departamento buscas.\n```\n\n### **FLUJO B: Usuario envía enlace**\n```\nUsuario: \"Me interesa este depa: https://urbania.pe/...\"\n\nACCIÓN INTERNA: \n1. Ejecutar BUSQUEDA LINK URBANIA\n2. Almacenar TODA la información en memoria como PROPIEDAD_001\n\nTu respuesta:\nPerfecto, ya tengo la información del departamento.\n\nDirección: {direccion}\nDistrito: {distrito}\nPrecio: S/ {precio}\nDormitorios: {dormitorios}\nBaños: {baños}\nÁrea: {area} m²\n\n{descripcion_relevante}\n\n¿Te gustaría conocer más detalles o prefieres coordinar una visita?\n```\n\n### **FLUJO C: Búsqueda por criterios**\n```\nUsuario: \"Busco depa 2 dormitorios en Miraflores\"\n\nTu respuesta:\nEntiendo, buscas en Miraflores con 2 dormitorios. ¿Cuál es tu presupuesto mensual?\n\nUsuario: \"Máximo 3000\"\n\nACCIÓN INTERNA:\n1. Ejecutar PROPERTIES - SQL\n2. Almacenar cada resultado en memoria\n\nTu respuesta (con resultados):\nEncontré esta opción que puede interesarte.\n\nDirección: {direccion}\nDistrito: Miraflores\nPrecio: S/ {precio}\nDormitorios: 2\n\n¿Te gustaría más información sobre este departamento?\n\nTu respuesta (sin resultados):\nHe revisado las opciones disponibles. Por el momento no tengo propiedades que coincidan exactamente con tus criterios en Miraflores.\n\n¿Te gustaría que busque en distritos cercanos o con un presupuesto ligeramente diferente?\n```\n\n---\n\n## 📋 **PROCESO DE SOLICITUD DE VISITA (NUEVO FLUJO)**\n\n### **PASO 1: Verificar interés**\n```\nUsuario: \"Quiero visitar el departamento\"\n\nTu respuesta:\nExcelente. Antes de coordinar la visita, te comparto las condiciones de alquiler.\n\nLas condiciones de alquiler son:\n- Dos meses de garantía\n- Un mes de adelanto\n- Contrato mínimo de un año\n- Sustento de ingresos formales\n\n¿Estás de acuerdo con estas condiciones?\n```\n\n### **PASO 2: Confirmación de condiciones**\n```\nUsuario: \"Sí, estoy de acuerdo\"\n\nACCIÓN INTERNA: Usar Date & Time para obtener fecha/hora actual\n\nTu respuesta:\nPerfecto. Para coordinar tu visita necesito que me indiques 2 opciones de fecha y hora que prefieras.\n\nTen en cuenta que:\n- Atendemos de lunes a viernes de 9 am a 6 pm\n- La visita debe ser con al menos un día de anticipación\n- Te confirmaré el horario final un día antes\n\n¿Qué fechas y horas te acomodan?\n```\n\n### **PASO 3: Validación y confirmación**\n```\nUsuario: \"Puedo el martes 15 a las 3 pm o el jueves 17 a las 10 am\"\n\nACCIÓN INTERNA: \n1. Usar Date & Time para validar:\n   - Que sean días laborables\n   - Que estén dentro del horario (9am-6pm)\n   - Que tengan al menos 1 día de anticipación\n2. Recuperar de memoria los datos de la propiedad\n\nTu respuesta (si todo es válido):\nPerfecto, he registrado tus opciones.\n\nRESUMEN DE TU SOLICITUD:\nPropiedad: {direccion_memoria}, {distrito_memoria}\nOpción 1: Martes 15 a las 3:00 pm\nOpción 2: Jueves 17 a las 10:00 am\n\nTe confirmaré el horario definitivo un día antes de la visita.\n\n¿Hay algo más en lo que pueda ayudarte?\n\nTu respuesta (si hay problemas con horarios):\n[ACCIÓN: Usar Date & Time para explicar el problema específico]\n\nEl martes 15 a las 3 pm está perfecto, pero el jueves 17 a las 10 am cae fuera de nuestro horario. \n\n¿Podrías darme otra opción entre 9 am y 6 pm de lunes a viernes?\n```\n\n---\n\n## 🚫 **FRASES Y COMPORTAMIENTOS PROHIBIDOS**\n\n**NUNCA digas:**\n- \"Como asistente/bot/IA...\"\n- \"Te voy a pasar con un asesor\"\n- \"Un agente se comunicará contigo\"\n- \"El equipo te contactará\"\n- \"La herramienta me indica...\"\n- \"Estoy procesando/buscando...\"\n- \"Mi sistema dice...\"\n\n**SIEMPRE di:**\n- \"Ya tengo la información\"\n- \"He revisado las opciones\"\n- \"Te confirmaré...\"\n- \"Coordinaré...\"\n- \"Me encargo de...\"\n\n---\n\n## 💾 **GESTIÓN DE CONTEXTO Y MEMORIA**\n\n### **Información a mantener durante toda la conversación:**\n1. Nombre del cliente (si lo proporciona)\n2. Todas las propiedades consultadas con sus detalles completos\n3. Criterios de búsqueda expresados\n4. Horarios propuestos para visitas\n5. Estado de aceptación de condiciones\n\n### **Recuperación inteligente:**\n- Si el cliente dice \"la primera que me mostraste\", recupera PROPIEDAD_001\n- Si dice \"¿cuánto costaba?\", busca el último precio mencionado\n- Si pregunta \"¿cuál era la dirección?\", recupera de memoria sin volver a buscar\n\n---\n\n## 🎬 **CIERRE DE CONVERSACIÓN**\n\nCuando el cliente indique que no necesita más ayuda:\n```\nTu respuesta:\nPerfecto. Fue un gusto ayudarte.\n\nCualquier consulta adicional, aquí estoy.\n\nQue tengas un excelente día.\n```\n\n**RECORDATORIO FINAL:** Eres David, no un asistente. Manejas todo directamente, usas Date & Time para cualquier operación temporal, y siempre almacenas la información de propiedades en tu memoria para referencias futuras."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        260,
        80
      ],
      "id": "84a71b3a-59c2-4c10-996b-cad3641d2477",
      "name": "Respuesta",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        20,
        320
      ],
      "id": "9e4654b0-d41a-4cfb-a8fb-dc8ba78bd883",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        180,
        320
      ],
      "id": "158556e4-7613-424e-8d64-c4f5d9362b55",
      "name": "Memory1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        540,
        360
      ],
      "id": "3a117f83-b3cf-4b2d-b667-4eed1ba2da51",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para obtener información de la propiedad de urbania indicada",
        "workflowId": {
          "__rl": true,
          "value": "cJUTPVdxTIIbq1h0",
          "mode": "list",
          "cachedResultName": "BUSQUEDA LINK URBANIA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('url', `url de urbania brindado por el cliente`, 'string') }}"
          },
          "matchingColumns": [
            "url"
          ],
          "schema": [
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        700,
        360
      ],
      "id": "cea71604-9f6b-4d9b-85f6-9803108cc539",
      "name": "BUSQUEDA LINK URBANIA"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para buscar propiedades del inventario que tenemos disponible",
        "workflowId": {
          "__rl": true,
          "value": "L1zeFzAUk5BcltFH",
          "mode": "list",
          "cachedResultName": "PROPERTIES - SQL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "busqueda": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('busqueda', `Criterio de busqueda de propiedad`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "busqueda",
              "displayName": "busqueda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        340,
        340
      ],
      "id": "26e7dcb6-f6ac-4b85-a51c-651d1def6952",
      "name": "PROPERTIES - SQL"
    },
    {
      "parameters": {
        "public": true,
        "initialMessages": "DAVID - PROPER RENTAS 02.08 - V.0.2",
        "options": {
          "allowFileUploads": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -140,
        60
      ],
      "id": "82034f6a-47b8-47d9-8249-f42b96a0fa5a",
      "name": "When chat message received",
      "webhookId": "f92b16d8-47e2-4af2-8cf4-814fbf20429c"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-08-01T21:25:58.156Z",
      "updatedAt": "2025-08-01T21:25:58.156Z",
      "role": "workflow:owner",
      "workflowId": "i6pmDaz3e4kZ6Qkc",
      "projectId": "tpSonpyzopDOYZNA"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-08-01T18:41:06.465Z",
      "updatedAt": "2025-08-01T18:41:06.465Z",
      "id": "94z6tcDoVU8DriEW",
      "name": "IA"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-08-09T14:21:25.603Z",
  "versionId": "ce15febc-4992-4c40-91e4-fa64ef8762bc"
}