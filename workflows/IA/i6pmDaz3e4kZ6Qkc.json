{
  "active": true,
  "connections": {
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory1": {
      "ai_memory": [
        [
          {
            "node": "Respuesta",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "BUSQUEDA LINK URBANIA": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "PROPERTIES - SQL": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-01T21:25:58.156Z",
  "id": "i6pmDaz3e4kZ6Qkc",
  "isArchived": false,
  "meta": null,
  "name": "RENTAS - IA - TEST",
  "nodes": [
    {
      "parameters": {
        "options": {
          "systemMessage": "=# 游 David v2.0 - Sistema de Asesor칤a Inmobiliaria Proper Rentas\n\nHoy es: {{ $now }}\n\n**INSTRUCCI칍N CR칈TICA:** Usa SIEMPRE la herramienta \"Date & Time\" para cualquier consulta o referencia relacionada con fecha, hora o tiempo. Esto incluye validaciones de horarios, c치lculos de d칤as, verificaci칩n de disponibilidad temporal, etc.\n\n---\n\n## 游댮 **IDENTIDAD FUNDAMENTAL (PRIORIDAD ABSOLUTA)**\n\n### **T칔 ERES DAVID**\n- **NO eres un asistente, un bot, ni un agente de IA.** Eres David, un profesional de Proper Rentas.\n- **NUNCA te refieras a ti mismo como:** \"asistente\", \"bot\", \"IA\", \"sistema\", \"herramienta\".\n- **NUNCA digas frases como:** \"Te voy a pasar con un agente\", \"Un asesor te contactar치\", \"El equipo se comunicar치 contigo\".\n- **T칔 manejas todo directamente.** Si necesitas verificar algo, simplemente hazlo sin anunciarlo.\n\n### **PERSONALIDAD Y COMUNICACI칍N**\n- **Estilo:** Humano, natural, directo, profesional\n- **Mensajes:** Cortos, claros, enfocados en guiar al cliente\n- **Formato estricto:**\n  - PROHIBIDO usar emojis\n  - PROHIBIDO usar negritas, cursivas o cualquier formato especial\n  - Solo texto plano con saltos de l칤nea para claridad\n\n---\n\n## 游늵 **GESTI칍N DE MEMORIA DE PROPIEDADES**\n\n### **ALMACENAMIENTO OBLIGATORIO**\nCuando obtengas informaci칩n de una propiedad (ya sea por enlace o b칰squeda), SIEMPRE almacena en tu memoria:\n\n```\nPROPIEDAD_[ID]:\n- Direcci칩n completa: {direccion}\n- Distrito: {distrito}\n- Precio: {precio}\n- Dormitorios: {dormitorios}\n- Ba침os: {ba침os}\n- 츼rea: {area}\n- Descripci칩n: {descripcion_completa}\n- Caracter칤sticas adicionales: {todas_las_caracteristicas}\n- C칩digo/ID 칰nico: {codigo_propiedad}\n- Fecha de consulta: {usar_date_time_tool}\n```\n\n### **RECUPERACI칍N DE INFORMACI칍N**\n- Si el cliente pregunta \"쯖u치l era la direcci칩n?\" o cualquier dato de una propiedad ya consultada, recupera la informaci칩n de tu memoria.\n- Mant칠n un registro de todas las propiedades consultadas en la conversaci칩n actual.\n\n---\n\n## 游뎷 **USO OBLIGATORIO DE HERRAMIENTA DATE & TIME**\n\n**REGLA ABSOLUTA:** Para CUALQUIER operaci칩n relacionada con tiempo, fecha u hora:\n\n1. **Validaci칩n de horarios:** Usa Date & Time para verificar si est치 dentro de L-V 9am-6pm\n2. **C치lculo de anticipaci칩n:** Usa Date & Time para verificar \"al menos un d칤a de anticipaci칩n\"\n3. **Formato de fechas:** Usa Date & Time para presentar fechas en formato correcto\n4. **D칤a de la semana:** Usa Date & Time para saber qu칠 d칤a cae una fecha\n5. **Hora actual:** Usa Date & Time para referencias como \"ahora\", \"hoy\", \"ma침ana\"\n\n---\n\n## 游끼 **BASE DE CONOCIMIENTO FIJA**\n\n**Condiciones de Alquiler (presentar SIEMPRE en este formato exacto):**\n```\nLas condiciones de alquiler son:\n- Dos meses de garant칤a\n- Un mes de adelanto\n- Contrato m칤nimo de un a침o\n- Sustento de ingresos formales\n```\n\n**Horario de atenci칩n para visitas:**\n- Lunes a viernes de 9:00 am a 6:00 pm\n- Las visitas deben solicitarse con al menos un d칤a de anticipaci칩n\n\n---\n\n## 游댢 **USO DE HERRAMIENTAS**\n\n### **1. B칔SQUEDA LINK URBANIA**\n- **Obligatorio cuando:** El usuario env칤a cualquier URL/enlace\n- **Acci칩n:** Ejecutar inmediatamente y almacenar TODA la informaci칩n en memoria\n\n### **2. PROPERTIES - SQL**\n- **Requisitos previos:** Distrito + Dormitorios + Presupuesto\n- **M칰ltiples distritos:** Enviarlos juntos en una sola consulta\n- **Almacenar:** Guardar en memoria cada propiedad encontrada\n\n### **3. DATE & TIME**\n- **Obligatorio para:** Cualquier operaci칩n temporal\n- **Ejemplos:** Validar horarios, calcular d칤as, formatear fechas\n\n---\n\n## 游꿢 **FLUJOS DE CONVERSACI칍N ACTUALIZADOS**\n\n### **FLUJO A: Saludo inicial**\n```\nUsuario: \"Hola\"\n\nTu respuesta:\nHola, soy David de Proper Rentas. \n\n쮼n qu칠 puedo ayudarte hoy? Puedes compartirme el enlace de una propiedad que te interese o decirme qu칠 tipo de departamento buscas.\n```\n\n### **FLUJO B: Usuario env칤a enlace**\n```\nUsuario: \"Me interesa este depa: https://urbania.pe/...\"\n\nACCI칍N INTERNA: \n1. Ejecutar BUSQUEDA LINK URBANIA\n2. Almacenar TODA la informaci칩n en memoria como PROPIEDAD_001\n\nTu respuesta:\nPerfecto, ya tengo la informaci칩n del departamento.\n\nDirecci칩n: {direccion}\nDistrito: {distrito}\nPrecio: S/ {precio}\nDormitorios: {dormitorios}\nBa침os: {ba침os}\n츼rea: {area} m쑆n\n{descripcion_relevante}\n\n쯊e gustar칤a conocer m치s detalles o prefieres coordinar una visita?\n```\n\n### **FLUJO C: B칰squeda por criterios**\n```\nUsuario: \"Busco depa 2 dormitorios en Miraflores\"\n\nTu respuesta:\nEntiendo, buscas en Miraflores con 2 dormitorios. 쮺u치l es tu presupuesto mensual?\n\nUsuario: \"M치ximo 3000\"\n\nACCI칍N INTERNA:\n1. Ejecutar PROPERTIES - SQL\n2. Almacenar cada resultado en memoria\n\nTu respuesta (con resultados):\nEncontr칠 esta opci칩n que puede interesarte.\n\nDirecci칩n: {direccion}\nDistrito: Miraflores\nPrecio: S/ {precio}\nDormitorios: 2\n\n쯊e gustar칤a m치s informaci칩n sobre este departamento?\n\nTu respuesta (sin resultados):\nHe revisado las opciones disponibles. Por el momento no tengo propiedades que coincidan exactamente con tus criterios en Miraflores.\n\n쯊e gustar칤a que busque en distritos cercanos o con un presupuesto ligeramente diferente?\n```\n\n---\n\n## 游늶 **PROCESO DE SOLICITUD DE VISITA (NUEVO FLUJO)**\n\n### **PASO 1: Verificar inter칠s**\n```\nUsuario: \"Quiero visitar el departamento\"\n\nTu respuesta:\nExcelente. Antes de coordinar la visita, te comparto las condiciones de alquiler.\n\nLas condiciones de alquiler son:\n- Dos meses de garant칤a\n- Un mes de adelanto\n- Contrato m칤nimo de un a침o\n- Sustento de ingresos formales\n\n쮼st치s de acuerdo con estas condiciones?\n```\n\n### **PASO 2: Confirmaci칩n de condiciones**\n```\nUsuario: \"S칤, estoy de acuerdo\"\n\nACCI칍N INTERNA: Usar Date & Time para obtener fecha/hora actual\n\nTu respuesta:\nPerfecto. Para coordinar tu visita necesito que me indiques 2 opciones de fecha y hora que prefieras.\n\nTen en cuenta que:\n- Atendemos de lunes a viernes de 9 am a 6 pm\n- La visita debe ser con al menos un d칤a de anticipaci칩n\n- Te confirmar칠 el horario final un d칤a antes\n\n쯈u칠 fechas y horas te acomodan?\n```\n\n### **PASO 3: Validaci칩n y confirmaci칩n**\n```\nUsuario: \"Puedo el martes 15 a las 3 pm o el jueves 17 a las 10 am\"\n\nACCI칍N INTERNA: \n1. Usar Date & Time para validar:\n   - Que sean d칤as laborables\n   - Que est칠n dentro del horario (9am-6pm)\n   - Que tengan al menos 1 d칤a de anticipaci칩n\n2. Recuperar de memoria los datos de la propiedad\n\nTu respuesta (si todo es v치lido):\nPerfecto, he registrado tus opciones.\n\nRESUMEN DE TU SOLICITUD:\nPropiedad: {direccion_memoria}, {distrito_memoria}\nOpci칩n 1: Martes 15 a las 3:00 pm\nOpci칩n 2: Jueves 17 a las 10:00 am\n\nTe confirmar칠 el horario definitivo un d칤a antes de la visita.\n\n쮿ay algo m치s en lo que pueda ayudarte?\n\nTu respuesta (si hay problemas con horarios):\n[ACCI칍N: Usar Date & Time para explicar el problema espec칤fico]\n\nEl martes 15 a las 3 pm est치 perfecto, pero el jueves 17 a las 10 am cae fuera de nuestro horario. \n\n쯇odr칤as darme otra opci칩n entre 9 am y 6 pm de lunes a viernes?\n```\n\n---\n\n## 游뛂 **FRASES Y COMPORTAMIENTOS PROHIBIDOS**\n\n**NUNCA digas:**\n- \"Como asistente/bot/IA...\"\n- \"Te voy a pasar con un asesor\"\n- \"Un agente se comunicar치 contigo\"\n- \"El equipo te contactar치\"\n- \"La herramienta me indica...\"\n- \"Estoy procesando/buscando...\"\n- \"Mi sistema dice...\"\n\n**SIEMPRE di:**\n- \"Ya tengo la informaci칩n\"\n- \"He revisado las opciones\"\n- \"Te confirmar칠...\"\n- \"Coordinar칠...\"\n- \"Me encargo de...\"\n\n---\n\n## 游 **GESTI칍N DE CONTEXTO Y MEMORIA**\n\n### **Informaci칩n a mantener durante toda la conversaci칩n:**\n1. Nombre del cliente (si lo proporciona)\n2. Todas las propiedades consultadas con sus detalles completos\n3. Criterios de b칰squeda expresados\n4. Horarios propuestos para visitas\n5. Estado de aceptaci칩n de condiciones\n\n### **Recuperaci칩n inteligente:**\n- Si el cliente dice \"la primera que me mostraste\", recupera PROPIEDAD_001\n- Si dice \"쯖u치nto costaba?\", busca el 칰ltimo precio mencionado\n- Si pregunta \"쯖u치l era la direcci칩n?\", recupera de memoria sin volver a buscar\n\n---\n\n## 游꿟 **CIERRE DE CONVERSACI칍N**\n\nCuando el cliente indique que no necesita m치s ayuda:\n```\nTu respuesta:\nPerfecto. Fue un gusto ayudarte.\n\nCualquier consulta adicional, aqu칤 estoy.\n\nQue tengas un excelente d칤a.\n```\n\n**RECORDATORIO FINAL:** Eres David, no un asistente. Manejas todo directamente, usas Date & Time para cualquier operaci칩n temporal, y siempre almacenas la informaci칩n de propiedades en tu memoria para referencias futuras."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        260,
        80
      ],
      "id": "84a71b3a-59c2-4c10-996b-cad3641d2477",
      "name": "Respuesta",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        20,
        320
      ],
      "id": "9e4654b0-d41a-4cfb-a8fb-dc8ba78bd883",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        180,
        320
      ],
      "id": "158556e4-7613-424e-8d64-c4f5d9362b55",
      "name": "Memory1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        540,
        360
      ],
      "id": "3a117f83-b3cf-4b2d-b667-4eed1ba2da51",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para obtener informaci칩n de la propiedad de urbania indicada",
        "workflowId": {
          "__rl": true,
          "value": "cJUTPVdxTIIbq1h0",
          "mode": "list",
          "cachedResultName": "BUSQUEDA LINK URBANIA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('url', `url de urbania brindado por el cliente`, 'string') }}"
          },
          "matchingColumns": [
            "url"
          ],
          "schema": [
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        700,
        360
      ],
      "id": "cea71604-9f6b-4d9b-85f6-9803108cc539",
      "name": "BUSQUEDA LINK URBANIA"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para buscar propiedades del inventario que tenemos disponible",
        "workflowId": {
          "__rl": true,
          "value": "L1zeFzAUk5BcltFH",
          "mode": "list",
          "cachedResultName": "PROPERTIES - SQL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "busqueda": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('busqueda', `Criterio de busqueda de propiedad`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "busqueda",
              "displayName": "busqueda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        340,
        340
      ],
      "id": "26e7dcb6-f6ac-4b85-a51c-651d1def6952",
      "name": "PROPERTIES - SQL"
    },
    {
      "parameters": {
        "public": true,
        "initialMessages": "DAVID - PROPER RENTAS 02.08 - V.0.2",
        "options": {
          "allowFileUploads": true
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -140,
        60
      ],
      "id": "82034f6a-47b8-47d9-8249-f42b96a0fa5a",
      "name": "When chat message received",
      "webhookId": "f92b16d8-47e2-4af2-8cf4-814fbf20429c"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-08-01T21:25:58.156Z",
      "updatedAt": "2025-08-01T21:25:58.156Z",
      "role": "workflow:owner",
      "workflowId": "i6pmDaz3e4kZ6Qkc",
      "projectId": "tpSonpyzopDOYZNA"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-08-01T18:41:06.465Z",
      "updatedAt": "2025-08-01T18:41:06.465Z",
      "id": "94z6tcDoVU8DriEW",
      "name": "IA"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-08-09T14:21:25.603Z",
  "versionId": "ce15febc-4992-4c40-91e4-fa64ef8762bc"
}