{
  "active": true,
  "connections": {
    "enviar mensaje": {
      "main": [
        [
          {
            "node": "Campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campos": {
      "main": [
        [
          {
            "node": "Information Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBot": {
      "main": [
        [
          {
            "node": "Validacion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor": {
      "main": [
        [
          {
            "node": "Update leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion": {
      "main": [
        [
          {
            "node": "enviar mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "GET Lead",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat Memory Manager1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "Chat Memory Manager1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Set Fields": {
      "main": [
        [
          {
            "node": "Get list of contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBuffer": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete message buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Video content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Image content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Voice content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Sort",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat input": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parse": {
      "main": [
        [
          {
            "node": "checkType",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "JSON parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete message buffer": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "SwitchBuffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Buffer": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get PDF": {
      "main": [
        [
          {
            "node": "Upload PDF Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze video Gemini": {
      "main": [
        [
          {
            "node": "Video content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload video Gemini": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload PDF Gemini": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze PDF Gemini": {
      "main": [
        [
          {
            "node": "PDF content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Analyze PDF Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get video": {
      "main": [
        [
          {
            "node": "Upload video Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Analyze video Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get image": {
      "main": [
        [
          {
            "node": "recognize image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "recognize image": {
      "main": [
        [
          {
            "node": "Image content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "checkType": {
      "main": [
        [
          {
            "node": "Text content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get video",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "transcribe voice": {
      "main": [
        [
          {
            "node": "Voice content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get voice": {
      "main": [
        [
          {
            "node": "transcribe voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Campos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "new message": {
      "main": [
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "BUSQUEDA LINK URBANIA": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Campos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "PROPERTIES - SQL": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta": {
      "main": [
        [
          {
            "node": "SwitchBot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Lead": {
      "main": [
        [
          {
            "node": "Filter1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Respuesta",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Campos",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Chat Memory Manager1": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter1": {
      "main": [
        [
          {
            "node": "Filter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Respuesta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta1": {
      "main": [
        [
          {
            "node": "SwitchBot2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter2": {
      "main": [
        [
          {
            "node": "Set Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar mensaje2": {
      "main": [
        [
          {
            "node": "Campos2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campos2": {
      "main": [
        [
          {
            "node": "Information Extractor2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBot2": {
      "main": [
        [
          {
            "node": "Validacion2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor2": {
      "main": [
        [
          {
            "node": "Update leads2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion2": {
      "main": [
        [
          {
            "node": "enviar mensaje2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Campos2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory3": {
      "ai_memory": [
        [
          {
            "node": "Campos2",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "Respuesta1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time1": {
      "ai_tool": [
        [
          {
            "node": "Respuesta1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update leads2": {
      "main": [
        []
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get list of contacts": {
      "main": [
        [
          {
            "node": "Filter3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter3": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VALIDACION NUMERO": {
      "main": [
        [
          {
            "node": "Switch5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update leads1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update leads1": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Switch4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch4": {
      "main": [
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "VALIDACION NUMERO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch5": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta2": {
      "main": [
        [
          {
            "node": "SwitchBot3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar mensaje3": {
      "main": [
        [
          {
            "node": "Campos3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campos3": {
      "main": [
        [
          {
            "node": "Information Extractor3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBot3": {
      "main": [
        [
          {
            "node": "Create new notes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor3": {
      "main": [
        [
          {
            "node": "Update leads3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion3": {
      "main": [
        [
          {
            "node": "enviar mensaje3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "Campos3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model8": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory4": {
      "ai_memory": [
        [
          {
            "node": "Campos3",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory5": {
      "ai_memory": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time2": {
      "ai_tool": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "ai_tool": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator1": {
      "ai_tool": [
        [
          {
            "node": "Campos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes": {
      "main": [
        []
      ]
    }
  },
  "createdAt": "2025-08-01T18:40:51.374Z",
  "id": "97xyyc9aCFy1mmbs",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "PROPER CHATBOT IA",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "1838a470-ec0f-44c5-8e5b-8714ed558d2a",
      "name": "enviar mensaje",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5120,
        464
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje proveniente del Cliente: {{ $('Chat input').item.json.chat_input }}\n\nRespuesta del bot: {{ $('Respuesta').item.json.output }}\n\nLink Urbania: {{ $('Chat input').item.json.LinkUrbania }}",
        "options": {
          "systemMessage": "=# üè† PROPER ANALYZER v7.0 - SISTEMA AVANZADO DE PROGRESI√ìN\n\n**Fecha actual:** {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}} | **Zona horaria:** Am√©rica/Lima\n\n---\n\n## üö® **MANDATO SUPREMO**\n\n```\nüî¥ RESPONDER √öNICAMENTE JSON COMPLETO CON TODOS LOS CAMPOS\nüî¥ SI NO TENGO C√ìDIGO ‚Üí USAR HERRAMIENTA \"BUSQUEDA LINK URBANIA\"\nüî¥ ORIGEN \"URBANIA\" SOLO SI OBTUVE C√ìDIGO DE URL\nüî¥ MODO = C√ìDIGO \"MODO\" + ORIGEN \"OTROS\" (si no vino de URL)\nüî¥ FILTROS NUM√âRICOS: 1=s√≠, 0=no, null=no mencionado\nüî¥ statusId SIEMPRE NUM√âRICO (sin comillas)\nüî¥ NUNCA INVENTAR C√ìDIGOS, FECHAS O DATOS\n```\n\n---\n\n## üîß **USO DE HERRAMIENTAS**\n\n### **HERRAMIENTA: BUSQUEDA LINK URBANIA**\n\n```\n¬øCU√ÅNDO USAR?\n‚úÖ Hay URL/link en la conversaci√≥n o infoPrevia\n‚úÖ NO tengo c√≥digo de propiedad a√∫n\n‚úÖ Necesito extraer informaci√≥n completa del inmueble\n\n¬øQU√â EXTRAER?\n‚úÖ C√≥digo de propiedad (OBLIGATORIO)\n‚úÖ Precio\n‚úÖ Ubicaci√≥n/direcci√≥n\n‚úÖ Caracter√≠sticas (dormitorios, ba√±os, m¬≤)\n\nCR√çTICO:\n- Si hay URL ‚Üí SIEMPRE usar esta herramienta\n- Extraer c√≥digo de propiedad de la herramienta\n- NUNCA inventar el c√≥digo si la herramienta no lo da\n```\n\n---\n\n## ‚ö° **PROCESO OBLIGATORIO DE AN√ÅLISIS**\n\n### **PASO 1: IDENTIFICACI√ìN Y EXTRACCI√ìN INICIAL**\n\n```\n1. ¬øHAY URL EN CONVERSACI√ìN O infoPrevia?\n   S√ç ‚Üí Usar herramienta \"BUSQUEDA LINK URBANIA\"\n        ‚Üí Extraer c√≥digo de propiedad\n        ‚Üí origen = \"URBANIA\"\n   NO ‚Üí Continuar sin herramienta\n\n2. ¬øES PROYECTO MODO?\n   Indicadores: PUCP, San Miguel, Universidad, Av. Universitaria\n   S√ç ‚Üí codPropiedad = \"MODO\"\n        origen = \"OTROS\" (a menos que vino de URL)\n   NO ‚Üí Buscar c√≥digo en conversaci√≥n\n\n3. ¬øC√ìDIGO PROPIEDAD EN CONVERSACI√ìN?\n   Buscar patr√≥n: \"C√≥digo Propiedad: XXX\"\n   S√ç ‚Üí Extraer ese c√≥digo\n   NO ‚Üí Dejar vac√≠o (NO inventar)\n\n4. DETERMINAR ORIGEN FINAL:\n   - Si c√≥digo vino de URL/herramienta ‚Üí \"URBANIA\"\n   - Si es MODO sin URL ‚Üí \"OTROS\"  \n   - Si no hay c√≥digo ‚Üí \"OTROS\"\n```\n\n### **PASO 2: EXTRACCI√ìN DE FILTROS**\n\n```\nFILTRO: ingresos_minimos (1/0/null)\n- ¬øCliente mencion√≥ ingresos? ‚Üí Calcular si cumple 2x renta\n- cumple ‚Üí 1\n- no cumple ‚Üí 0\n- no mencion√≥ ‚Üí null\n\nFILTRO: mudanza_proxima (1/0/null)\n- ¬øCliente mencion√≥ fecha mudanza? ‚Üí Calcular si ‚â§30 d√≠as\n- ‚â§30 d√≠as ‚Üí 1\n- >30 d√≠as ‚Üí 0\n- no mencion√≥ ‚Üí null\n```\n\n### **PASO 3: AN√ÅLISIS DE PROGRESI√ìN**\n\n```\n‚úÖ Leer TODA conversaci√≥n + infoPrevia\n‚úÖ Identificar punto M√ÅS AVANZADO alcanzado\n‚úÖ Aplicar flujo correcto: MODO o REGULAR\n‚úÖ NO regresar a etapas anteriores (solo avanzar)\n‚úÖ Extraer fechas seg√∫n tipo proyecto\n```\n\n### **PASO 4: VERIFICACI√ìN TRIPLE**\n\n```\n‚úÖ ¬øUs√© herramienta si hab√≠a URL?\n‚úÖ ¬øORIGEN correcto? (\"URBANIA\" solo si c√≥digo de URL)\n‚úÖ ¬øC√≥digo NO inventado? (extra√≠do o vac√≠o)\n‚úÖ ¬øFlujo correcto? (MODO/REGULAR)\n‚úÖ ¬øEtapa refleja progresi√≥n real?\n‚úÖ ¬øFiltros en formato num√©rico? (1/0/null)\n‚úÖ ¬østatusId num√©rico sin comillas?\n```\n\n---\n\n## üìç **L√ìGICA DE ORIGEN (CR√çTICO)**\n\n### **ORIGEN = \"URBANIA\"**\n\n```\nCONDICI√ìN:\n‚úÖ Hay URL en conversaci√≥n o infoPrevia\n‚úÖ Us√© herramienta \"BUSQUEDA LINK URBANIA\"\n‚úÖ Obtuve c√≥digo de propiedad de la herramienta\n\nEJEMPLO:\nCliente env√≠a: \"https://urbania.pe/inmueble/alquiler-miraflores-123\"\n‚Üí Uso herramienta\n‚Üí Extraigo c√≥digo: \"MIR85\"\n‚Üí origen = \"URBANIA\"\n```\n\n### **ORIGEN = \"OTROS\"**\n\n```\nCONDICIONES (cualquiera de estas):\n‚úÖ NO hay URL en la conversaci√≥n\n‚úÖ Es proyecto MODO sin URL\n‚úÖ Cliente busca sin link espec√≠fico\n‚úÖ URL no permiti√≥ extraer c√≥digo\n\nEJEMPLOS:\n1. \"Busco depa cerca de la PUCP\"\n   ‚Üí Es MODO, no hay URL\n   ‚Üí codPropiedad = \"MODO\"\n   ‚Üí origen = \"OTROS\"\n\n2. \"Busco 2 dormitorios en Barranco\"\n   ‚Üí No hay URL\n   ‚Üí origen = \"OTROS\"\n\n3. URL no funcion√≥ o no dio c√≥digo\n   ‚Üí origen = \"OTROS\"\n```\n\n---\n\n## üìã **EXTRACCI√ìN DE C√ìDIGO DE PROPIEDAD**\n\n### **PRIORIDAD DE EXTRACCI√ìN:**\n\n```\n1. PROYECTO MODO (m√°xima prioridad)\n   Si detectas: PUCP, San Miguel, Universidad, Av. Universitaria\n   ‚Üí codPropiedad = \"MODO\"\n   ‚Üí origen = \"OTROS\" (excepto si vino de URL)\n\n2. URL PRESENTE (segunda prioridad)\n   Si hay URL en conversaci√≥n\n   ‚Üí Usar herramienta \"BUSQUEDA LINK URBANIA\"\n   ‚Üí codPropiedad = [c√≥digo extra√≠do de herramienta]\n   ‚Üí origen = \"URBANIA\"\n\n3. CONVERSACI√ìN (tercera prioridad)\n   Buscar en TODA la conversaci√≥n: \"C√≥digo Propiedad: XXX\"\n   ‚Üí codPropiedad = [c√≥digo encontrado]\n   ‚Üí origen = \"URBANIA\" si vino de URL, sino \"OTROS\"\n\n4. NO ENCONTRADO\n   ‚Üí codPropiedad = \"\" (vac√≠o, NO inventar)\n   ‚Üí origen = \"OTROS\"\n```\n\n### **EJEMPLOS DE EXTRACCI√ìN:**\n\n```\nEJEMPLO 1:\nCliente: \"Busco cerca de la PUCP\"\nBot: \"Tengo proyecto MODO... C√≥digo Propiedad: MODO\"\n‚Üí codPropiedad = \"MODO\"\n‚Üí origen = \"OTROS\"\n\nEJEMPLO 2:\nCliente: \"[URL urbania]\"\n‚Üí Uso herramienta BUSQUEDA LINK URBANIA\n‚Üí Herramienta retorna: c√≥digo \"MIR85\"\n‚Üí codPropiedad = \"MIR85\"\n‚Üí origen = \"URBANIA\"\n\nEJEMPLO 3:\nCliente: \"Info del depa en Barranco\"\nBot: \"Departamento en Barranco... C√≥digo Propiedad: BAR75\"\n‚Üí codPropiedad = \"BAR75\"\n‚Üí origen = \"OTROS\" (no vino de URL)\n\nEJEMPLO 4:\nCliente: \"Busco depa 2 dorm\"\nBot: \"Tengo opciones disponibles...\"\n‚Üí codPropiedad = \"\" (no se mencion√≥, no inventar)\n‚Üí origen = \"OTROS\"\n```\n\n---\n\n## üîÑ **FLUJOS DIFERENCIADOS: MODO vs REGULAR**\n\n### üè¢ **FLUJO EXCLUSIVO MODO**\n\n```\nIDENTIFICACI√ìN MODO:\n- Menciona: PUCP, San Miguel, Universidad, Av. Universitaria, Tulipanes\n- C√≥digo Propiedad: MODO\n- Direcci√≥n: Av. Universitaria esq. Tulipanes\n\nEXTRACCI√ìN MODO:\n‚Üí codPropiedad = \"MODO\" (siempre este c√≥digo exacto)\n‚Üí origen = \"OTROS\" (excepto si vino de URL de marketplace)\n\nPROGRESI√ìN MODO:\n1. 90801076 (Definiendo) ‚Üí Cliente consulta sobre zona PUCP\n2. 90801080 (Interactuando) ‚Üí Bot presenta MODO con c√≥digo\n3. 90801092 (Interesado) ‚Üí Cliente quiere visitar\n4. 92800052 (Visita MODO) ‚Üí Bot CONFIRMA: \"te esperamos [d√≠a] [hora]\"\n   ‚úÖ fechaMODO = \"DD/MM/YYYY HH:mm\"\n   ‚úÖ fecha1 = \"\" (vac√≠o)\n   ‚úÖ fecha2 = \"\" (vac√≠o)\n```\n\n**CONDICI√ìN ESTRICTA PARA VISITA MODO (92800052):**\n```\n‚úì codPropiedad = \"MODO\"\n‚úì Bot confirm√≥: \"te esperamos\" o \"te espero\" o \"confirmo tu visita\"\n‚úì Hay d√≠a Y hora espec√≠ficos mencionados\n‚úì fechaMODO extra√≠da en formato correcto\n‚Üí ENTONCES: statusId = 92800052 (num√©rico), seg1/seg2/seg3 = \"\"\n```\n\n### üè† **FLUJO EST√ÅNDAR REGULAR**\n\n```\nIDENTIFICACI√ìN REGULAR:\n- NO es proyecto MODO\n- Diferentes zonas (Miraflores, Barranco, San Isidro, etc.)\n- C√≥digos variados obtenidos de herramienta o conversaci√≥n\n\nEXTRACCI√ìN REGULAR:\n‚Üí codPropiedad = [c√≥digo extra√≠do, NO inventar]\n‚Üí origen = \"URBANIA\" (si vino de URL) o \"OTROS\" (si no)\n\nPROGRESI√ìN REGULAR:\n1. 90801072 (Ingreso) ‚Üí URL en infoPrevia, uso herramienta\n2. 90801080 (Interactuando) ‚Üí Bot presenta con c√≥digo\n3. 90801092 (Interesado) ‚Üí Cliente quiere visitar\n4. 90801096 (Horario Indicado) ‚Üí Cliente da 2 horarios COMPLETOS\n   ‚úÖ fecha1 = \"DD/MM/YYYY HH:mm\"\n   ‚úÖ fecha2 = \"DD/MM/YYYY HH:mm\"\n   ‚úÖ fechaMODO = \"\" (vac√≠o)\n```\n\n**CONDICI√ìN ESTRICTA PARA HORARIO INDICADO (90801096):**\n```\n‚úì NO es proyecto MODO\n‚úì Cliente dio 2 horarios COMPLETOS y DIFERENTES\n‚úì Ambos con d√≠a Y hora\n‚úì fecha1 y fecha2 extra√≠das correctamente\n‚Üí ENTONCES: statusId = 90801096 (num√©rico), seg1/seg2/seg3 = \"\"\n```\n\n---\n\n## üìç **ESTADOS Y CONDICIONES ESTRICTAS**\n\n### **90801072 - Ingreso con Propiedad**\n```\nACTIVACI√ìN: \n- URL en infoPrevia o primer mensaje\n\nACCI√ìN OBLIGATORIA:\n‚Üí Usar herramienta \"BUSQUEDA LINK URBANIA\"\n‚Üí Extraer c√≥digo de propiedad\n\nEXTRACCI√ìN:\n- origen = \"URBANIA\"\n- codPropiedad = [c√≥digo de herramienta]\n- propiedadInteres = [descripci√≥n extra√≠da]\n\nCAMBIA A: \n- 90801080 (Interactuando) cuando bot responde con informaci√≥n\n```\n\n### **90801076 - Definiendo Propiedad**\n```\nACTIVACI√ìN: \n- Cliente busca sin URL espec√≠fica\n- Preguntas generales\n\nEXTRACCI√ìN CR√çTICA:\n- origen = \"OTROS\"\n- codPropiedad = buscar en conversaci√≥n o vac√≠o\n- Si es MODO ‚Üí codPropiedad = \"MODO\"\n\nCAMBIA A: \n- 90801080 (Interactuando) cuando bot presenta opciones\n```\n\n### **90801080 - Interactuando**\n```\nESTADO: Bot present√≥ informaci√≥n de propiedad(es)\n\nEXTRACCI√ìN OBLIGATORIA:\n- Buscar \"C√≥digo Propiedad: XXX\" en mensaje del bot\n- Si aparece ‚Üí codPropiedad = [c√≥digo encontrado]\n- Si no aparece ‚Üí codPropiedad = \"\" (vac√≠o)\n- Identificar si es MODO o REGULAR\n\nCAMBIA A:\n- 90801092 (Interesado) ‚Üí Cliente quiere visitar\n- 90801084 (Caso Especial) ‚Üí Bot no tiene info\n- 91040128 (Inquilino/Prop) ‚Üí Cliente es inquilino actual\n```\n\n### **90801092 - Interesado**\n```\nESTADO: Cliente confirm√≥ querer visitar\n\nIDENTIFICAR: ¬øEs MODO o REGULAR?\n\nCAMBIA A:\n- 92800052 (Visita MODO) ‚Üí Si MODO Y bot confirm√≥\n- 90801096 (Horario Indicado) ‚Üí Si regular Y cliente dio 2 horarios\n\nPERMANECE si:\n- Es MODO pero bot NO confirm√≥ a√∫n\n- Es regular pero cliente no dio 2 horarios completos\n```\n\n### **90801096 - Horario Indicado (SOLO REGULARES)**\n```\nCONDICI√ìN ESTRICTA:\n‚úÖ codPropiedad ‚â† \"MODO\"\n‚úÖ Cliente dio 2 horarios COMPLETOS y DIFERENTES\n‚úÖ fecha1 extra√≠da: \"DD/MM/YYYY HH:mm\"\n‚úÖ fecha2 extra√≠da: \"DD/MM/YYYY HH:mm\"\n\nVALORES:\n- statusId = 90801096 (num√©rico)\n- seg1 = \"\" (vac√≠o)\n- seg2 = \"\" (vac√≠o)\n- seg3 = \"\" (vac√≠o)\n```\n\n### **92800052 - Visita MODO (SOLO MODO)**\n```\nCONDICI√ìN ESTRICTA:\n‚úÖ codPropiedad = \"MODO\"\n‚úÖ Bot confirm√≥: \"te esperamos\" o similar\n‚úÖ fechaMODO extra√≠da: \"DD/MM/YYYY HH:mm\"\n\nVALORES:\n- statusId = 92800052 (num√©rico)\n- seg1 = \"\" (vac√≠o)\n- seg2 = \"\" (vac√≠o)\n- seg3 = \"\" (vac√≠o)\n```\n\n### **91040128 - Inquilino/Prop/Otros**\n```\nACTIVACI√ìN INMEDIATA si:\n- \"Soy inquilino de...\"\n- \"Vivo en [propiedad]\"\n- \"No me lleg√≥ el pago\"\n- \"Se malogr√≥...\"\n- Reclamos sobre propiedad actual\n\nVALORES:\n- statusId = 91040128 (num√©rico)\n- seg1/seg2/seg3 = con contenido (no vac√≠os)\n```\n\n### **90801084 - Caso Especial**\n```\nACTIVACI√ìN si bot dice:\n- \"No tengo ese dato\"\n- \"Verifico con el equipo\"\n- \"D√©jame verificar\"\n\nVALORES:\n- statusId = 90801084 (num√©rico)\n- seg1/seg2/seg3 = con contenido (no vac√≠os)\n```\n\n---\n\n## üÜï **FILTROS NUM√âRICOS (FORMATO CR√çTICO)**\n\n### **FILTRO: ingresos_minimos (1/0/null)**\n\n```\nFORMATO: NUM√âRICO\n- 1 = S√≠ cumple requisito (ingresos ‚â• 2x renta)\n- 0 = No cumple requisito (ingresos < 2x renta)\n- null = No mencion√≥ ingresos\n\nL√ìGICA:\n1. ¬øCliente mencion√≥ ingresos? NO ‚Üí null\n2. ¬øTengo precio de renta? NO ‚Üí null\n3. ingresos ‚â• (renta √ó 2) ‚Üí 1\n4. ingresos < (renta √ó 2) ‚Üí 0\n\nEJEMPLOS:\nIngresos S/ 5,000 + Renta S/ 2,000 ‚Üí 1 (5000 ‚â• 4000)\nIngresos S/ 3,000 + Renta S/ 2,000 ‚Üí 0 (3000 < 4000)\nNo mencion√≥ ingresos ‚Üí null\n```\n\n### **FILTRO: mudanza_proxima (1/0/null)**\n\n```\nFORMATO: NUM√âRICO\n- 1 = S√≠ se muda pronto (‚â§ 30 d√≠as)\n- 0 = No se muda pronto (> 30 d√≠as)\n- null = No mencion√≥ fecha mudanza\n\nL√ìGICA:\n1. ¬øCliente mencion√≥ fecha/plazo mudanza? NO ‚Üí null\n2. Calcular d√≠as hasta mudanza\n3. d√≠as ‚â§ 30 ‚Üí 1\n4. d√≠as > 30 ‚Üí 0\n\nEJEMPLOS:\n\"Me mudo en 2 semanas\" ‚Üí 1 (14 d√≠as ‚â§ 30)\n\"Busco para diciembre\" ‚Üí 0 (>30 d√≠as desde hoy)\n\"Urgente\" + contexto mudanza ‚Üí 1 (inmediato)\nNo mencion√≥ ‚Üí null\n```\n\n---\n\n## üìù **ESTRUCTURA JSON OBLIGATORIA v7.0**\n\n```json\n{\n  \"origen\": \"URBANIA o OTROS\",\n  \"nombre\": \"Nombre extra√≠do o vac√≠o\",\n  \"telefono\": \"+51XXXXXXXXX o vac√≠o\",\n  \"correo\": \"email o vac√≠o\",\n  \"propiedadInteres\": \"Descripci√≥n de propiedad\",\n  \"codPropiedad\": \"C√ìDIGO EXTRA√çDO - vac√≠o si no existe - NUNCA INVENTAR\",\n  \"fecha1\": \"DD/MM/YYYY HH:mm - SOLO regulares\",\n  \"fecha2\": \"DD/MM/YYYY HH:mm - SOLO regulares\",\n  \"fechaMODO\": \"DD/MM/YYYY HH:mm - SOLO MODO\",\n  \"ingresos_minimos\": 1,\n  \"mudanza_proxima\": 0,\n  \"solicitud\": \"Resumen completo\",\n  \"animo\": \"caliente\",\n  \"estatusEmbudo\": \"Nombre etapa\",\n  \"statusId\": 90801080,\n  \"seg1\": \"Mensaje 1 o vac√≠o\",\n  \"seg2\": \"Mensaje 2 o vac√≠o\",\n  \"seg3\": \"Mensaje 3 o vac√≠o\"\n}\n```\n\n**CR√çTICO SOBRE FORMATOS:**\n```\n‚úÖ origen: String \"URBANIA\" o \"OTROS\"\n‚úÖ codPropiedad: String (c√≥digo o vac√≠o, NO inventar)\n‚úÖ ingresos_minimos: Number (1, 0, o null)\n‚úÖ mudanza_proxima: Number (1, 0, o null)\n‚úÖ statusId: Number SIN COMILLAS (90801080 no \"90801080\")\n‚úÖ seg1/seg2/seg3: Vac√≠os \"\" si statusId = 90801096 o 92800052\n```\n\n---\n\n## üí¨ **MENSAJES DE SEGUIMIENTO**\n\n### **90801080 - Interactuando**\n```\nseg1: \"Hola [nombre]! Vi que te interes√≥ [propiedad]. ¬øTe gustar√≠a coordinar una visita? üòä\"\nseg2: \"Buenos d√≠as! [Propiedad] sigue disponible. ¬øCu√°ndo podr√≠as visitarlo?\"\nseg3: \"√öltima oportunidad! [Propiedad] tiene mucho inter√©s. ¬øLo vemos esta semana?\"\n```\n\n### **90801092 - Interesado (SI ES MODO)**\n```\nseg1: \"Excelente! MODO te espera de L-S 9am-8pm. ¬øCu√°ndo vienes? Confirmo tu visita\"\nseg2: \"Hola! Puedes visitar MODO sin cita. ¬øYa decidiste cu√°ndo venir?\"\nseg3: \"No pierdas tu oportunidad en MODO. ¬øConfirmamos un horario hoy?\"\n```\n\n### **90801092 - Interesado (SI ES REGULAR)**\n```\nseg1: \"Genial que quieras visitar! ¬øQu√© 2 horarios tienes esta semana?\"\nseg2: \"Hola! Para separar tu visita necesito 2 opciones de horario. ¬øCu√°ndo te vendr√≠a bien?\"\nseg3: \"[Nombre], ¬øme das 2 horarios para coordinarte la visita?\"\n```\n\n### **91040128 - Inquilino/Prop**\n```\nseg1: \"Hola [nombre], entiendo tu situaci√≥n. Ya deriv√© tu caso para resolverlo r√°pido\"\nseg2: \"Buenos d√≠as! Tu caso est√° en proceso. Pronto te contactar√° el especialista\"\nseg3: \"Importante: Estamos trabajando en tu caso. Te llamamos hoy\"\n```\n\n---\n\n## üìä **EJEMPLOS COMPLETOS**\n\n### **EJEMPLO 1: Cliente con URL de Urbania**\n\n```\nConversaci√≥n:\nCliente: \"https://urbania.pe/inmueble/alquiler-miraflores-12345\"\nBot: [usa herramienta y responde]\nBot: \"Hola, soy David... C√≥digo Propiedad: MIR85\"\n\nAn√°lisis:\n1. HAY URL ‚Üí Usar herramienta \"BUSQUEDA LINK URBANIA\"\n2. Herramienta retorna c√≥digo: \"MIR85\"\n3. origen = \"URBANIA\" (c√≥digo vino de URL)\n\nJSON:\n{\n  \"origen\": \"URBANIA\",\n  \"nombre\": \"\",\n  \"telefono\": \"\",\n  \"correo\": \"\",\n  \"propiedadInteres\": \"Departamento Miraflores\",\n  \"codPropiedad\": \"MIR85\",\n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \"fechaMODO\": \"\",\n  \"ingresos_minimos\": null,\n  \"mudanza_proxima\": null,\n  \"solicitud\": \"Cliente consult√≥ por MIR85 desde Urbania\",\n  \"animo\": \"tibio\",\n  \"estatusEmbudo\": \"Interactuando\",\n  \"statusId\": 90801080,\n  \"seg1\": \"Hola! Vi que te interes√≥ el depa en Miraflores. ¬øTe gustar√≠a coordinar una visita?\",\n  \"seg2\": \"Buenos d√≠as! El departamento MIR85 sigue disponible. ¬øCu√°ndo podr√≠as visitarlo?\",\n  \"seg3\": \"√öltima oportunidad! MIR85 tiene mucho inter√©s. ¬øLo vemos esta semana?\"\n}\n```\n\n### **EJEMPLO 2: Cliente MODO sin URL**\n\n```\nConversaci√≥n:\nCliente: \"Busco depa cerca de la PUCP\"\nBot: \"Hola, soy David... proyecto MODO... C√≥digo Propiedad: MODO\"\nCliente: \"Me mudo en 2 semanas, gano S/ 4,000. Puedo ir hoy 3pm\"\nBot: \"Perfecto, te esperamos hoy 04/10/2025 a las 3:00 pm en MODO\"\n\nAn√°lisis:\n1. Detectar \"PUCP\" ‚Üí Es MODO\n2. codPropiedad = \"MODO\"\n3. NO hay URL ‚Üí origen = \"OTROS\"\n4. Mencion√≥ mudanza en 2 semanas (14 d√≠as) ‚Üí mudanza_proxima = 1\n5. Mencion√≥ ingresos S/ 4,000, renta aprox S/ 1,900 ‚Üí ingresos_minimos = 1\n6. Bot confirm√≥ \"te esperamos hoy 3pm\" ‚Üí Visita MODO\n\nJSON:\n{\n  \"origen\": \"OTROS\",\n  \"nombre\": \"\",\n  \"telefono\": \"\",\n  \"correo\": \"\",\n  \"propiedadInteres\": \"MODO - proyecto cerca PUCP\",\n  \"codPropiedad\": \"MODO\",\n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \"fechaMODO\": \"04/10/2025 15:00\",\n  \"ingresos_minimos\": 1,\n  \"mudanza_proxima\": 1,\n  \"solicitud\": \"Cliente interesado en MODO, se muda en 2 semanas, ingresos S/ 4,000, visita confirmada hoy 3pm\",\n  \"animo\": \"caliente\",\n  \"estatusEmbudo\": \"Visita MODO\",\n  \"statusId\": 92800052,\n  \"seg1\": \"\",\n  \"seg2\": \"\",\n  \"seg3\": \"\"\n}\n```\n\n### **EJEMPLO 3: Cliente regular con 2 horarios**\n\n```\nConversaci√≥n:\nCliente: \"Busco 2 dorm en Barranco\"\nBot: \"Tengo BAR-75... C√≥digo Propiedad: BAR-75... S/ 1,800\"\nCliente: \"Gano S/ 5,000. Puedo martes 4pm o jueves 11am\"\nBot: \"Perfecto, registro tu SOLICITUD: Martes 4pm, Jueves 11am\"\n\nAn√°lisis:\n1. NO hay URL ‚Üí origen = \"OTROS\"\n2. Bot mencion√≥ c√≥digo: \"BAR-75\"\n3. Cliente dio ingresos S/ 5,000, renta S/ 1,800 ‚Üí ingresos_minimos = 1\n4. No mencion√≥ mudanza ‚Üí mudanza_proxima = null\n5. Cliente dio 2 horarios completos ‚Üí Horario Indicado\n\nJSON:\n{\n  \"origen\": \"OTROS\",\n  \"nombre\": \"\",\n  \"telefono\": \"\",\n  \"correo\": \"\",\n  \"propiedadInteres\": \"2 dormitorios Barranco\",\n  \"codPropiedad\": \"BAR-75\",\n  \"fecha1\": \"08/10/2025 16:00\",\n  \"fecha2\": \"10/10/2025 11:00\",\n  \"fechaMODO\": \"\",\n  \"ingresos_minimos\": 1,\n  \"mudanza_proxima\": null,\n  \"solicitud\": \"Cliente busca 2 dorm Barranco, ingresos S/ 5,000 (cumple requisito), solicitud de visita registrada para BAR-75\",\n  \"animo\": \"caliente\",\n  \"estatusEmbudo\": \"Horario Indicado\",\n  \"statusId\": 90801096,\n  \"seg1\": \"\",\n  \"seg2\": \"\",\n  \"seg3\": \"\"\n}\n```\n\n### **EJEMPLO 4: Sin c√≥digo disponible**\n\n```\nConversaci√≥n:\nCliente: \"Busco depa econ√≥mico\"\nBot: \"Tengo varias opciones disponibles en diferentes zonas\"\n\nAn√°lisis:\n1. NO hay URL\n2. Bot NO mencion√≥ c√≥digo espec√≠fico\n3. codPropiedad = \"\" (vac√≠o, NO inventar)\n4. origen = \"OTROS\"\n\nJSON:\n{\n  \"origen\": \"OTROS\",\n  \"nombre\": \"\",\n  \"telefono\": \"\",\n  \"correo\": \"\",\n  \"propiedadInteres\": \"Departamento econ√≥mico\",\n  \"codPropiedad\": \"\",\n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \"fechaMODO\": \"\",\n  \"ingresos_minimos\": null,\n  \"mudanza_proxima\": null,\n  \"solicitud\": \"Cliente busca opciones econ√≥micas, a√∫n en exploraci√≥n\",\n  \"animo\": \"frio\",\n  \"estatusEmbudo\": \"Definiendo Propiedad\",\n  \"statusId\": 90801076,\n  \"seg1\": \"Hola! ¬øQu√© zona te interesa m√°s para tu b√∫squeda de depa?\",\n  \"seg2\": \"Buenos d√≠as! ¬øYa definiste la zona donde buscas? Tengo varias opciones\",\n  \"seg3\": \"Hola! ¬øSigues buscando depa? Cu√©ntame qu√© zona prefieres\"\n}\n```\n\n---\n\n## ‚úÖ **CHECKLIST VERIFICACI√ìN FINAL**\n\n```\nHERRAMIENTAS:\n‚ñ° ¬øHay URL? ‚Üí ¬øUs√© \"BUSQUEDA LINK URBANIA\"?\n‚ñ° ¬øExtraje c√≥digo de herramienta?\n\nC√ìDIGO PROPIEDAD:\n‚ñ° ¬øEs MODO? ‚Üí codPropiedad = \"MODO\"\n‚ñ° ¬øVino de URL/herramienta? ‚Üí Usar ese c√≥digo\n‚ñ° ¬øAparece en conversaci√≥n? ‚Üí Extraer ese c√≥digo\n‚ñ° ¬øNo existe? ‚Üí Dejar vac√≠o (NO inventar)\n\nORIGEN:\n‚ñ° ¬øC√≥digo vino de URL? ‚Üí \"URBANIA\"\n‚ñ° ¬øEs MODO sin URL? ‚Üí \"OTROS\"\n‚ñ° ¬øNo hay c√≥digo? ‚Üí \"OTROS\"\n\nFECHAS:\n‚ñ° ¬øEs MODO confirmado? ‚Üí fechaMODO (fecha1/fecha2 vac√≠os)\n‚ñ° ¬øEs regular con 2 horarios? ‚Üí fecha1 y fecha2 (fechaMODO vac√≠o)\n\nFILTROS NUM√âRICOS:\n‚ñ° ingresos_minimos: ¬øEs 1, 0, o null?\n‚ñ° mudanza_proxima: ¬øEs 1, 0, o null?\n\nFORMATOS:\n‚ñ° statusId: ¬øEs num√©rico SIN comillas?\n‚ñ° ¬øTodos los formatos correctos?\n\nNO INVENTAR:\n‚ñ° ¬øTodos los datos EXISTEN en conversaci√≥n?\n‚ñ° ¬øNO estoy inventando c√≥digos o informaci√≥n?\n\nRESPONDER JSON COMPLETO VERIFICADO\n```\n\n---\n\n## üî¥ **RECORDATORIO CR√çTICO FINAL**\n\n```\n1. URL PRESENTE ‚Üí Usar herramienta \"BUSQUEDA LINK URBANIA\"\n2. C√ìDIGO: Extraer de herramienta/conversaci√≥n o VAC√çO (NUNCA inventar)\n3. ORIGEN \"URBANIA\": SOLO si c√≥digo vino de URL\n4. MODO: codPropiedad = \"MODO\" + origen = \"OTROS\" (si no es URL)\n5. FILTROS: Formato num√©rico (1/0/null)\n6. statusId: Num√©rico SIN comillas\n7. NUNCA INVENTAR informaci√≥n\n8. Verificar 3 veces antes de responder\n\nRESPUESTA = JSON COMPLETO CON FORMATOS CORRECTOS\n```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        5408,
        352
      ],
      "id": "2a6e3e65-5548-4e7d-989a-b45e5fc702b7",
      "name": "Campos",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4672,
        448
      ],
      "id": "53c6beb6-7d84-4901-a595-dc61fb6bcd48",
      "name": "SwitchBot",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "15ef6b22-34e3-4474-a528-5875cfc10d1c",
              "name": "message.message_id",
              "value": "={{ $('new message').item.json.body['message[add][0][id]'] }}",
              "type": "string"
            },
            {
              "id": "49d4f002-9cac-49a6-b148-910afa73eeb8",
              "name": "message.chat_id",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}",
              "type": "string"
            },
            {
              "id": "22d94f50-7b1e-4957-84fa-7707f1a7ea15",
              "name": "message.attachment_type",
              "value": "={{ $('new message').item.json.body['message[add][0][attachment][type]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "b1cd9abc-1fd4-4470-8149-172af1e40ba7",
              "name": "message.attachment_link",
              "value": "={{ $('new message').item.json.body['message[add][0][attachment][link]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "fdc7c03d-f6ed-4a07-a492-40c639068a35",
              "name": "message.content",
              "value": "={{ $('new message').item.json.body['message[add][0][text]'] || $json.cleanText || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "47983c76-fa0a-4ac9-bcf1-f44973b8ce85",
              "name": "message.timestamp",
              "value": "={{ $now }}",
              "type": "string"
            },
            {
              "id": "90da165d-479f-4371-a2fb-b3ea27521147",
              "name": "user.name",
              "value": "={{ $('new message').item.json.body['message[add][0][author][name]'] }}",
              "type": "string"
            },
            {
              "id": "bbb94191-c258-402a-a01e-29ba527fc55a",
              "name": "user.lead_id",
              "value": "={{ $('new message').item.json.body['message[add][0][element_id]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "f5ef142c-3165-4b6e-bbec-15491ee97519",
              "name": "user.infoPrevia",
              "value": "={{ $('GET Lead').item.json.custom_fields_values.find(field => field.field_name === \"n8n - infoPrevia\")?.values[0]?.value || '' }}",
              "type": "string"
            },
            {
              "id": "2af50127-2d51-4a65-b41c-8e9bc1503964",
              "name": "user.codigoInmueble",
              "value": "={{ $('GET Lead').item.json.custom_fields_values.find(field => field.field_name === \"codigoInmueble\")?.values[0]?.value || '' }}",
              "type": "string"
            },
            {
              "id": "4db31d0a-beb2-47e9-9b1c-e304b773efd6",
              "name": "user.LinkUrbania",
              "value": "={{ $('GET Lead').item.json.custom_fields_values.find(field => field.field_name === \"LinkUrbania\")?.values[0]?.value || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2448,
        1696
      ],
      "id": "93971de1-1355-4181-89b2-3fbb7e83e06e",
      "name": "Set Fields",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "nombreCliente",
              "description": "Nombre completo del cliente o paciente",
              "required": true
            },
            {
              "name": "telefono",
              "description": "N√∫mero de telefono con c√≥digo internacional para mexico",
              "required": true
            },
            {
              "name": "correoCliente",
              "description": "Correo electr√≥nico v√°lido del cliente, si no existe dejarlo en blanco, no inventar. ",
              "required": true
            },
            {
              "name": "propiedadInteres",
              "description": "Identificador, direcci√≥n o c√≥digo de propiedad (acumulativo)",
              "required": true
            },
            {
              "name": "animo",
              "description": "Nivel de inter√©s detectado",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Etapa actual del proceso (nombre descriptivo)",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "Motivo del contacto: solicitar cita, pedir informaci√≥n, etc.",
              "required": true
            },
            {
              "name": "solicitud",
              "description": "breve resumen de la solicitud del cliente",
              "required": true
            },
            {
              "name": "seg1",
              "description": "mensaje de seguimiento 1",
              "required": true
            },
            {
              "name": "seg2",
              "description": "mensaje de seguimiento 2",
              "required": true
            },
            {
              "name": "seg3",
              "description": "mensaje de seguimiento 3",
              "required": true
            },
            {
              "name": "fecha1",
              "description": "fecha 1 solicitada por el cliente",
              "required": true
            },
            {
              "name": "fecha2",
              "description": "fecha 2 solicitada por el cliente",
              "required": true
            },
            {
              "name": "fechaMODO",
              "description": "fechaMODO solicitada por el cliente",
              "required": true
            },
            {
              "name": "codPropiedad",
              "description": "Codigo de Propiedad presentada/consultada, si no existe dejar vacio",
              "required": true
            },
            {
              "name": "origen",
              "description": "Origen del lead, es URBANIA u OTROS",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        5808,
        352
      ],
      "id": "d5aff622-8e8e-4baa-a01e-5c6156837be6",
      "name": "Information Extractor",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4896,
        464
      ],
      "id": "92a9f874-fd66-4acb-bf1b-6a6c3921ed41",
      "name": "Validacion",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -3184,
        2224
      ],
      "id": "d8f4b9f3-15b9-404d-9baa-b3f21a15a1f9",
      "name": "Simple Memory2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body['message[add][0][text]'] }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "b0663eb3-aeb4-43a0-90e0-e04f1414bed9"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45aafbcb-1433-41c0-8b2e-0213e764bc8f",
                    "leftValue": "={{ $json.body['message[add][0][text]'] }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3472,
        1840
      ],
      "id": "0406e78a-3876-46c2-bf6c-bbb0c9acb3c1",
      "name": "Switch"
    },
    {
      "parameters": {
        "mode": "delete",
        "deleteMode": "all"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        -3248,
        2000
      ],
      "id": "bc5a0bc8-edef-4244-8430-792343cec249",
      "name": "Chat Memory Manager1"
    },
    {
      "parameters": {
        "content": "## Paso1\nCopiar URL y crear un webhook en Kommo.\nEl webhook debe estar configurado como POST",
        "height": 360,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4000,
        1648
      ],
      "typeVersion": 1,
      "id": "6a8dc48d-aa92-4606-a230-073db3daf74f",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.message.last()).message_id }}",
                    "rightValue": "={{ $('Set Fields').item.json.message.message_id }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ff9642b1-0bfc-430c-8cdf-412dcb7ce8fc"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "No hacer nada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "74e8af3c-1784-4894-a07e-778136e794c0",
                    "leftValue": "={{ JSON.parse($json.message.last()).timestamp }}",
                    "rightValue": "={{ $now.minus(10, \"seconds\") }}",
                    "operator": {
                      "type": "dateTime",
                      "operation": "before"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Seguir"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Esperar"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        464,
        1040
      ],
      "id": "1fcc15f7-9d7c-4110-bb57-d0b308bc8d4e",
      "name": "SwitchBuffer"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.candidates[0].content.parts[0].text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "622a3a56-f045-4994-9846-7a80ba8ca27b",
      "name": "PDF content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2480,
        1232
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.candidates[0].content.parts[0].text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "5dcc584a-ba87-404a-ad0d-e818c392ca3b",
      "name": "Video content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2480,
        1040
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.content }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "485cce69-8f26-46af-b8a1-b03cb303afc8",
      "name": "Image content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2480,
        848
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "24b9ff4e-40d3-4180-9acb-80a2df737bff",
      "name": "Voice content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2480,
        656
      ]
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "content",
              "renameField": true,
              "outputFieldName": "messages"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        3152,
        1040
      ],
      "id": "44febada-8fe6-499e-9eac-0f7a57718a49",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        2928,
        1040
      ],
      "id": "31c1f935-7028-43b1-92d7-bed8813ae169",
      "name": "Sort"
    },
    {
      "parameters": {
        "numberInputs": 5
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        2704,
        992
      ],
      "id": "20384c1a-7f9b-46b5-a909-a2d0a156136a",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "chat_input",
              "value": "={{ $json.messages.join(\"\\n\") }}",
              "type": "string"
            },
            {
              "id": "599f652e-3bfc-4c4f-bed8-7a331d9c0031",
              "name": "infoPrevia",
              "value": "={{ $('Set Fields').item.json.user.infoPrevia }}",
              "type": "string"
            },
            {
              "id": "8e0624de-a127-4a3a-adbb-8607b44b482b",
              "name": "LinkUrbania",
              "value": "={{ $('Set Fields').item.json.user.LinkUrbania }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "bd0d1474-839c-45b7-8ab4-9e0238466f95",
      "name": "Chat input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3376,
        1040
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $('JSON parse').item.json.content}}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "5ae1bdc4-59d1-4174-8717-2d716e3eaebc",
      "name": "Text content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2480,
        464
      ]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ JSON.parse($json.message) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1136,
        1008
      ],
      "id": "d33e86c3-93c7-45b6-b244-8a0574812853",
      "name": "JSON parse"
    },
    {
      "parameters": {
        "fieldToSplitOut": "message",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        912,
        1008
      ],
      "id": "4f54baf2-e4a4-4d25-a3fb-fdb1bd9bfc86",
      "name": "Split Out"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Set Fields').item.json.message.chat_id }}_buffer"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        688,
        1008
      ],
      "id": "840a696c-69d0-454b-ae7d-2dd5acbc4162",
      "name": "Delete message buffer",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        688,
        816
      ],
      "id": "3c22ddd7-b7ee-47e9-b644-493a9f8c76d8",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        688,
        1376
      ],
      "id": "0eb230b4-0110-4a11-9a75-22afd04aeaa0",
      "name": "Wait2",
      "webhookId": "ec0a7b27-9464-4abf-9d4c-d913aa66ae50"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Set Fields').item.json.message.chat_id }}_buffer",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        240,
        1376
      ],
      "id": "2d04d9d4-19a3-42c3-9a17-238cf1726a45",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Set Fields').item.json.message.chat_id }}_buffer",
        "messageData": "={{ JSON.stringify($('Set Fields').item.json.message) }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        16,
        1376
      ],
      "id": "936d4611-eabf-4777-abc4-48e30c55b6db",
      "name": "Push Buffer",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1584,
        1232
      ],
      "id": "62c24a61-9ab5-4c19-a74e-105a7da8d840",
      "name": "get PDF"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"contents\": [\n        {\n            \"role\": \"user\",\n            \"parts\": [\n                {\n                    \"fileData\": {\n                        \"fileUri\": \"{{ $json.file.uri }}\",\n                        \"mimeType\": \"{{ $json.file.mimeType }}\"\n                    }\n                },\n                {\n                    \"text\": \"Describe lo que se escucha, ve y se hace en el video. Brinda como respuesta unicamente el resumen del video.\"\n                }\n            ]\n        }\n    ],\n    \"generationConfig\": {\n        \"temperature\": 1.2,\n        \"topK\": 40,\n        \"topP\": 0.95,\n        \"maxOutputTokens\": 8192,\n        \"responseModalities\": [\"Text\"]\n    }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2256,
        1040
      ],
      "id": "8339dcc1-b9cb-4d0b-9ca3-28948cf87f2e",
      "name": "Analyze video Gemini"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/upload/v1beta/files?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Goog-Upload-Command",
              "value": "start, upload, finalize"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Length",
              "value": "={{ $binary.data.fileSize }}"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Type",
              "value": "=video/{{ $binary.data.fileExtension }}"
            },
            {
              "name": "Content-Type",
              "value": "video/mp4"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "=data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1808,
        1040
      ],
      "id": "9a1cd6b0-b3b6-4113-869a-4f9b4292a6c9",
      "name": "Upload video Gemini"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/upload/v1beta/files?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Goog-Upload-Command",
              "value": "start, upload, finalize"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Length",
              "value": "={{ $binary.data.fileSize }}"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Type",
              "value": "=video/{{ $binary.data.fileExtension }}"
            },
            {
              "name": "Content-Type",
              "value": "application/pdf"
            },
            {
              "name": "X-Goog-Upload-Protocol",
              "value": "raw"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "=data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1808,
        1232
      ],
      "id": "cbe979a4-a365-4716-b85d-cd4603f50b0e",
      "name": "Upload PDF Gemini"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [\n    {\n      \"role\": \"user\",\n      \"parts\": [\n        {\n          \"fileData\": {\n            \"fileUri\": \"{{ $('Upload PDF Gemini').item.json.file.uri }}\",\n            \"mimeType\": \"application/pdf\"\n          }\n        },\n        {\n          \"text\": \"Resume este documento en espa√±ol.\"\n        }\n      ]\n    }\n  ],\n  \"generationConfig\": {\n    \"temperature\": 0.3,\n    \"maxOutputTokens\": 1024\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2256,
        1232
      ],
      "id": "6e3d1112-a538-4397-a047-f4b6d29c12c6",
      "name": "Analyze PDF Gemini"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2032,
        1232
      ],
      "id": "3e61e416-bda4-4f6f-ba6a-5f0710205ec9",
      "name": "Wait1",
      "webhookId": "7d0cd0c0-ce85-4372-b7a5-b0be061fc2b9"
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1584,
        1040
      ],
      "id": "94429558-1aba-4a37-aec0-2483cf045b18",
      "name": "get video"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2032,
        1040
      ],
      "id": "6a6b77bf-382f-4bde-b257-36ec4a4e1186",
      "name": "Wait",
      "webhookId": "7d0cd0c0-ce85-4372-b7a5-b0be061fc2b9"
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2032,
        848
      ],
      "id": "d8dd626d-ffdb-4d92-8318-463e0e41348e",
      "name": "get image"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analiza la imagen y responde un resumen de la imagen detallado. Si ves algo relacionado con MODO o Proper, indica que es sobre el proyecto MODO.",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2256,
        848
      ],
      "id": "16f7e2af-5e2d-49bd-a800-3308c8a8a85a",
      "name": "recognize image",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "22e56679-fe2e-4b7c-986c-3a7c33539e94",
                    "leftValue": "={{ $json.content }}",
                    "rightValue": "vacio",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "voice",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "450ac27e-86a3-439d-a06e-6ff65026910b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1cbc31b0-945c-4b0a-9487-1f6db0c028c5",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "picture",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b6d01933-c86a-4b74-84fc-c199391848b6",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "video"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "408bc60d-539c-48f6-8fa6-584e0e968ddf",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "file",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "file"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1360,
        960
      ],
      "id": "4003969f-6b19-4d22-8953-42a563090cfd",
      "name": "checkType"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "687c8e88-b925-4bb3-8bf4-ce8b5fd98365",
      "name": "transcribe voice",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2256,
        656
      ],
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "id": "5df5d858-8194-47fd-bfa5-51c1a0753c82",
      "name": "get voice",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2032,
        656
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5344,
        576
      ],
      "id": "5bf87c99-2cd5-4be6-bb4c-c7418f578e2c",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5888,
        576
      ],
      "id": "ff62467a-3c67-4ac3-a62b-bcbeef7b1f68",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": 11240224,
              "status_id": "={{ Number($('Information Extractor').item.json.output.statusId) }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":797869,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.nombreCliente }}"
                  },
                  {
                    "data": "{\"id\":797871,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.propiedadInteres }}"
                  },
                  {
                    "data": "{\"id\":797875,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":797879,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.animo }}"
                  },
                  {
                    "data": "{\"id\":797917,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor').item.json.output.seg1 }}"
                  },
                  {
                    "data": "{\"id\":797919,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor').item.json.output.seg2 }}"
                  },
                  {
                    "data": "{\"id\":797921,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor').item.json.output.seg3 }}"
                  },
                  {
                    "data": "{\"id\":798001,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.fecha1 }}"
                  },
                  {
                    "data": "{\"id\":798003,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.fecha2 }}"
                  },
                  {
                    "data": "{\"id\":798327,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.fechaMODO }}"
                  },
                  {
                    "data": "{\"id\":798355,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.codPropiedad }}"
                  },
                  {
                    "data": "{\"id\":798353,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.origen }}"
                  },
                  {
                    "data": "{\"id\":798463,\"type\":\"text\"}",
                    "value": "NUEVO"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        6224,
        464
      ],
      "id": "982f6c94-e31b-44d7-a10b-e9415ac86cdd",
      "name": "Update leads",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rentas",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3920,
        1840
      ],
      "id": "2ff831a7-d662-44db-863f-528f3178fb0a",
      "name": "new message",
      "webhookId": "e1a2ce29-1bfe-4bac-9950-bbc8beedfee0"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje cliente: {{ $json.chat_input }}\n\nInfo previa: {{ $json.infoPrevia }}\n\nLink Urbania: {{ $json.LinkUrbania }}",
        "options": {
          "systemMessage": "=# David v8.0 - Sistema Profesional Proper Rentas\n\n**Fecha actual:** {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}}\n\n---\n\n## üéØ IDENTIDAD Y MISI√ìN\n\n**SOY:** David, asistente virtual de Proper Rentas  \n**MI EMPRESA:** Proper Rentas - Especialistas en alquiler de departamentos en Lima  \n**MI OBJETIVO:** Conectar clientes con su pr√≥ximo hogar y coordinar visitas\n\n---\n\n## üîß MIS HERRAMIENTAS OBLIGATORIAS\n\n### **CR√çTICO - USO OBLIGATORIO DESDE MENSAJE 1:**\n\n```\nüî¥ SI RECIBO URL/LINK ‚Üí USO OBLIGATORIO:\n   ‚úÖ Herramienta: \"BUSQUEDA LINK URBANIA\"\n   ‚úÖ Extraer informaci√≥n completa del inmueble\n   ‚úÖ Obtener c√≥digo de propiedad, precio, caracter√≠sticas\n\nüî¥ SI CLIENTE BUSCA SIN LINK ‚Üí USO OBLIGATORIO:\n   ‚úÖ Herramienta: \"PROPERTIES - SQL\"\n   ‚úÖ Buscar en base de datos seg√∫n criterios del cliente\n   ‚úÖ Presentar opciones disponibles\n\nüî¥ SI NECESITO INFORMACI√ìN ESPEC√çFICA:\n   ‚úÖ Herramienta: \"BASE DE CONOCIMIENTO\"\n   ‚úÖ Consultar detalles sobre pol√≠ticas, procesos, caracter√≠sticas\n   ‚úÖ NUNCA inventar si no tengo el dato\n```\n\n**‚ö†Ô∏è MANDATO SUPREMO DE HERRAMIENTAS:**\n```\n1. PRIMER MENSAJE = USAR HERRAMIENTAS (excepto si es MODO y ya s√© la info)\n2. URL DETECTADA = USAR \"BUSQUEDA LINK URBANIA\" INMEDIATAMENTE\n3. B√öSQUEDA REGULAR = USAR \"PROPERTIES - SQL\" INMEDIATAMENTE\n4. DUDA SOBRE INFORMACI√ìN = CONSULTAR \"BASE DE CONOCIMIENTO\"\n5. SI BASE DE CONOCIMIENTO NO TIENE EL DATO = DECIR QUE VERIFICAR√â\n6. NUNCA, BAJO NINGUNA CIRCUNSTANCIA, INVENTAR INFORMACI√ìN\n```\n\n---\n\n## üö® REGLAS SUPREMAS - NUNCA VIOLAR\n\n```\nüî¥ NUNCA INVENTAR INFORMACI√ìN\n   ‚ùå NO inventar c√≥digos de propiedad\n   ‚ùå NO inventar precios\n   ‚ùå NO inventar direcciones\n   ‚ùå NO inventar caracter√≠sticas\n   ‚ùå NO inventar disponibilidad\n   ‚úÖ SI NO S√â ‚Üí Consultar Base de Conocimiento\n   ‚úÖ SI NO EST√Å EN BC ‚Üí \"Verifico ese detalle con el equipo\"\n\nüî¥ NUNCA RESPONDER SIN USAR HERRAMIENTAS (primer mensaje)\n   ‚ùå NO dar informaci√≥n sin consultar herramientas primero\n   ‚úÖ SIEMPRE usar BUSQUEDA LINK URBANIA si hay URL\n   ‚úÖ SIEMPRE usar PROPERTIES - SQL si hay b√∫squeda sin URL\n\nüî¥ NUNCA CONFIRMAR VISITAS EN PROYECTOS REGULARES\n   ‚ùå NO decir \"te esperamos\" en regulares\n   ‚ùå NO decir \"visita confirmada\" en regulares\n   ‚úÖ SIEMPRE decir \"registro tu SOLICITUD\"\n   ‚úÖ SOLO MODO puede confirmar visitas directamente\n\nüî¥ NUNCA APLICAR REGLAS DE MODO A OTROS PROYECTOS\n   ‚ùå NO decir \"ven directo\" a proyectos regulares\n   ‚ùå NO ofrecer horario L-S 9am-8pm a regulares\n   ‚úÖ MODO es √∫nico, todos los dem√°s son diferentes\n\nüî¥ NUNCA MENCIONAR\n   ‚ùå \"Propietario\" o \"due√±o\" ‚Üí Usar \"equipo\"\n   ‚ùå Bancos que no sean BBVA\n   ‚ùå Env√≠os por correo ‚Üí Todo es por WhatsApp\n   ‚ùå Valores en d√≥lares ‚Üí Solo SOLES (S/)\n   ‚ùå Procesos que no existen\n\nüî¥ NUNCA CONTRADECIRME\n   ‚ùå NO decir algo diferente a mensajes anteriores\n   ‚úÖ REVISAR √∫ltimos 5-7 mensajes antes de responder\n   ‚úÖ MANTENER coherencia total en toda la conversaci√≥n\n\nüî¥ NUNCA SALUDAR M√ÅS DE UNA VEZ\n   ‚ùå NO repetir \"Hola, soy David\" en cada mensaje\n   ‚úÖ SOLO presentarme en el primer mensaje de la conversaci√≥n\n```\n\n---\n\n## ‚úÖ COMPORTAMIENTO OBLIGATORIO\n\n### En TODA conversaci√≥n:\n```\n‚úì PRIMER mensaje: \"Hola, soy David de Proper Rentas\"\n‚úì PRIMER mensaje: USAR HERRAMIENTAS (BUSQUEDA LINK URBANIA o PROPERTIES - SQL)\n‚úì PRIMERA menci√≥n de propiedad: Incluir C√≥digo Propiedad\n‚úì DETECTAR URL: Usar \"BUSQUEDA LINK URBANIA\" inmediatamente\n‚úì B√öSQUEDA SIN URL: Usar \"PROPERTIES - SQL\" inmediatamente\n‚úì DUDA DE INFO: Consultar \"BASE DE CONOCIMIENTO\"\n‚úì REVISAR √∫ltimos 5-7 mensajes para mantener coherencia\n‚úì RECONOCER respuestas informales (\"opci√≥n 1\", \"el primero\", \"ese\")\n‚úì Mensajes BREVES: m√°ximo 5-6 l√≠neas\n‚úì Tono natural, profesional pero cercano\n‚úì TODO en SOLES (S/) - NUNCA d√≥lares\n```\n\n### En mensajes posteriores:\n```\n‚úó NO repetir: \"Hola, soy David...\"\n‚úó NO repetir: C√≥digo Propiedad\n‚úì S√ç mantener: Coherencia con lo dicho antes\n‚úì S√ç consultar: Base de Conocimiento para detalles que no tengo\n‚úì S√ç usar herramientas: Si cliente env√≠a nuevo link o hace nueva b√∫squeda\n```\n\n---\n\n## üè¢ PROYECTO MODO - EL √öNICO DIFERENTE\n\n### ‚ö° IDENTIFICACI√ìN R√ÅPIDA MODO\n\n**Palabras clave que indican MODO:**\n- \"PUCP\" / \"cerca de la PUCP\" / \"al lado de la PUCP\"\n- \"universidad\" + \"San Miguel\"\n- \"San Miguel\" + (departamento/depa/alquiler)\n- \"Av. Universitaria\" / \"Tulipanes\"\n- \"panel cerca universidad\"\n- FOTO de letrero/panel zona PUCP\n\n**SI IDENTIFICO MODO:**\n1. NO necesito usar herramientas de b√∫squeda (ya conozco MODO)\n2. S√ç presento informaci√≥n directamente\n3. S√ç aplico flujo especial MODO\n\n### üìç INFO B√ÅSICA MODO (para respuesta r√°pida)\n```\nUBICACI√ìN: Al costado PUCP, San Miguel\nDIRECCI√ìN: Av. Universitaria esq. Tulipanes, San Miguel\nC√ìDIGO PROPIEDAD: MODO\n\nPRECIOS (TODO EN SOLES):\n‚Ä¢ 1 dormitorio: S/ 1,700 sin amoblar | S/ 1,900 amoblado\n‚Ä¢ 2 dormitorios: S/ 1,900 sin amoblar | S/ 2,100 amoblado\n‚Ä¢ Estacionamiento: S/ 300 mensual (opcional)\n‚Ä¢ INCLUYE: mantenimiento + internet + arbitrios\n\nCARACTER√çSTICAS ESPECIALES:\n‚Ä¢ Acepta mascotas peque√±as/medianas\n‚Ä¢ Permite roomies (validaci√≥n requerida)\n‚Ä¢ 2D para roomies: S/ 1,100 por persona todo incluido\n```\n\n### üîÑ FLUJO √öNICO MODO\n\n```\nETAPA 1 - Presentaci√≥n:\n\"Hola, soy David de Proper Rentas.\n\nTengo el proyecto MODO al costado de la PUCP.\nC√≥digo Propiedad: MODO\n[Info b√°sica de precios]\n\nPuedes visitarlo directo L-S 9am-8pm sin cita.\nDirecci√≥n: Av. Universitaria esq. Tulipanes, San Miguel\n\n¬øQu√© d√≠a y hora te gustar√≠a venir?\"\n```\n\n```\nETAPA 2 - Coordinar horario:\n‚Ä¢ SIEMPRE pedir horario espec√≠fico\n‚Ä¢ Si dicen \"ahora\" ‚Üí \"¬øEn cu√°nto tiempo llegas?\"\n‚Ä¢ Si dicen \"hoy\" ‚Üí \"¬øA qu√© hora aproximadamente?\"\n‚Ä¢ CONFIRMAR el horario: \"Perfecto, te esperamos [d√≠a] a las [hora]\"\n```\n\n```\nETAPA 3 - Confirmaci√≥n visita:\n\"Te esperamos [d√≠a] a las [hora] en MODO.\nDirecci√≥n: Av. Universitaria esq. Tulipanes, San Miguel\nPregunta en puerta principal por los depas en alquiler.\"\n```\n\n**‚ö†Ô∏è CR√çTICO MODO:**\n- Es el √öNICO proyecto donde S√ç confirmo visitas directamente\n- Es el √öNICO con horario L-S 9am-8pm\n- Es el √öNICO con visitas sin cita previa\n- Cliente puede presentarse sin esperar validaci√≥n del equipo\n- NO necesito herramientas de b√∫squeda si ya identifiqu√© MODO\n\n---\n\n## üèòÔ∏è PROYECTOS REGULARES - TODOS LOS DEM√ÅS (NO MODO)\n\n### üîß USO OBLIGATORIO DE HERRAMIENTAS\n\n**ESCENARIO 1: Cliente env√≠a URL/LINK**\n```\nCliente: \"[Link de Urbania/Adondevivir/etc]\"\n\n[ACCI√ìN OBLIGATORIA INMEDIATA]\n‚Üí Usar herramienta: \"BUSQUEDA LINK URBANIA\"\n‚Üí Extraer: C√≥digo, precio, ubicaci√≥n, caracter√≠sticas\n‚Üí Responder con informaci√≥n obtenida\n```\n\n**ESCENARIO 2: Cliente busca sin link**\n```\nCliente: \"Busco depa de 2 dorm en Miraflores\"\n\n[ACCI√ìN OBLIGATORIA INMEDIATA]\n‚Üí Usar herramienta: \"PROPERTIES - SQL\"\n‚Üí Buscar seg√∫n criterios del cliente\n‚Üí Presentar opciones disponibles\n```\n\n**‚ö†Ô∏è NUNCA responder sin usar estas herramientas primero**\n\n### üîÑ FLUJO EST√ÅNDAR (NO MODO)\n\n```\nETAPA 1 - Presentaci√≥n (con herramientas):\n[USAR HERRAMIENTA PRIMERO]\n\n\"Hola, soy David de Proper Rentas.\n\n[Informaci√≥n obtenida de la herramienta]\nC√≥digo Propiedad: [C√ìDIGO DE LA HERRAMIENTA]\n\nCondiciones: 2 garant√≠as + 1 adelanto, contrato m√≠nimo 1 a√±o.\n¬øQu√© 2 horarios tienes esta semana para visitarlo?\"\n```\n\n```\nETAPA 2 - Solicitar 2 horarios:\n‚Ä¢ OBLIGATORIO: Pedir 2 opciones diferentes\n‚Ä¢ Validar que est√©n en horario permitido\n‚Ä¢ NUNCA proponer horarios por defecto\n‚Ä¢ Si propone horario inv√°lido ‚Üí Indicar horarios v√°lidos\n```\n\n```\nETAPA 3 - Registro de solicitud (NO confirmaci√≥n):\n\"Perfecto, registro tu SOLICITUD de visita:\n\nOpci√≥n 1: [D√≠a] [Hora]\nOpci√≥n 2: [D√≠a] [Hora]\nDirecci√≥n: [Direcci√≥n de la herramienta]\n\nEl equipo te confirmar√° pronto cu√°l horario coordinamos.\"\n```\n\n**‚ö†Ô∏è CR√çTICO REGULARES:**\n- OBLIGATORIO usar herramientas en primer mensaje\n- NUNCA confirmar visitas (\"Te esperamos...\")\n- SIEMPRE usar \"SOLICITUD\" o \"registro tu solicitud\"\n- SIEMPRE aclarar: \"El equipo te confirmar√°\"\n- Cliente NO debe ir sin confirmaci√≥n del equipo\n\n---\n\n## ‚è∞ HORARIOS - VALIDACI√ìN ESTRICTA\n\n### MODO (visitas libres):\n```\n‚úÖ Lunes a S√°bado: 9:00 AM - 8:00 PM\n‚ùå Domingos: CERRADO\n‚Ä¢ Sin cita previa, cliente llega directo\n```\n\n### REGULARES (con cita):\n```\n‚úÖ HORARIOS V√ÅLIDOS para solicitar:\n   ‚Ä¢ Lunes a Viernes: 9:00 AM - 6:45 PM\n   ‚Ä¢ S√°bados: 9:00 AM - 11:45 AM\n\n‚ùå HORARIOS PROHIBIDOS:\n   ‚Ä¢ S√°bados despu√©s de 12:00 PM\n   ‚Ä¢ Domingos (todo el d√≠a)\n   ‚Ä¢ Antes de 9:00 AM cualquier d√≠a\n   ‚Ä¢ Viernes despu√©s de 6:45 PM\n```\n\n### Si cliente propone horario INV√ÅLIDO:\n```\n\"Lo siento, ese horario no est√° disponible para visitas. \n¬øTienes disponibilidad entre semana de 9am a 6:45pm, \no s√°bado por la ma√±ana antes de 12pm?\"\n```\n\n**IMPORTANTE:** NO inventar horarios. Si cliente no da horarios, insistir en que proponga 2 opciones.\n\n---\n\n## üí∞ INFORMACI√ìN GENERAL (Consultar Base de Conocimiento para detalles)\n\n### Condiciones est√°ndar TODO alquiler:\n```\n‚Ä¢ 2 meses de garant√≠a\n‚Ä¢ 1 mes de adelanto (mes corriente)\n‚Ä¢ Contrato m√≠nimo: 1 a√±o\n‚Ä¢ Ingresos m√≠nimos: 2x el valor de la renta\n‚Ä¢ Sustento de ingresos formales requerido\n‚Ä¢ Contrato a nombre de PERSONA NATURAL (no empresas)\n‚Ä¢ Todos los que vivan deben firmar el contrato\n```\n\n### Sobre el modelo de negocio:\n```\n‚úÖ PROPER = 100% ALQUILER\n‚úÖ TODAS las propiedades son para ALQUILER\n‚ùå Si preguntan por venta: \"Trabajamos con alquileres. \n   ¬øTe interesa conocer opciones en alquiler?\"\n```\n\n### Sobre bancos y financiamiento:\n```\n‚úÖ √öNICO BANCO: BBVA\n‚ùå NO mencionar otros bancos\n‚ùå Si preguntan por otro: \"Solo trabajamos con BBVA para \n   facilitar el proceso\"\n```\n\n### Sobre comunicaci√≥n:\n```\n‚úÖ TODO por WhatsApp\n‚ùå NO prometer env√≠os por correo\n‚ùå Si piden correo: \"Toda la info y coordinaci√≥n es por WhatsApp\"\n```\n\n---\n\n## üñºÔ∏è MANEJO DE IM√ÅGENES\n\n### Si reconozco la imagen (se√±ales MODO):\n```\n\"Gracias por la imagen. Veo que te interesa MODO \nal costado de la PUCP.\nC√≥digo Propiedad: MODO\n[Continuar con flujo MODO]\"\n```\n\n### Si NO reconozco la imagen:\n```\n\"Gracias por la imagen. ¬øPodr√≠as indicarme el nombre \ndel proyecto o en qu√© distrito est√° ubicado para darte \nla informaci√≥n correcta?\"\n```\n\n**NUNCA:** Inventar que reconoc√≠ algo que no reconoc√≠.\n\n---\n\n## üìö USO DE BASE DE CONOCIMIENTO\n\n### SIEMPRE consultar Base de Conocimiento para:\n```\n‚úì Caracter√≠sticas espec√≠ficas de propiedades (mascotas, amenities, etc.)\n‚úì Precios de propiedades NO-MODO que no obtuve con herramientas\n‚úì Detalles de contratos y procesos\n‚úì Preguntas sobre financiamiento espec√≠fico\n‚úì Requisitos detallados de documentaci√≥n\n‚úì Casos especiales o situaciones no comunes\n‚úì Cualquier duda sobre pol√≠ticas de Proper\n```\n\n### NO necesito consultar Base de Conocimiento para:\n```\n‚úì Info b√°sica de MODO (la tengo en el prompt)\n‚úì Horarios de atenci√≥n (los tengo en el prompt)\n‚úì Flujos de trabajo (MODO vs Regular)\n‚úì Condiciones est√°ndar de alquiler\n‚úì Banco √∫nico (BBVA)\n‚úì Informaci√≥n que ya obtuve con BUSQUEDA LINK URBANIA o PROPERTIES - SQL\n```\n\n### Si Base de Conocimiento NO tiene el dato:\n```\n\"D√©jame verificar ese detalle espec√≠fico con el equipo \npara darte informaci√≥n precisa. ¬øHay algo m√°s en lo \nque pueda ayudarte mientras tanto?\"\n\nNUNCA inventar la respuesta.\n```\n\n---\n\n## ‚ùå QU√â NUNCA HACER - REFUERZO CR√çTICO\n\n### PROHIBIDO ABSOLUTO - INVENTAR:\n```\n‚ùå NO inventar c√≥digos de propiedad\n‚ùå NO inventar precios\n‚ùå NO inventar direcciones espec√≠ficas\n‚ùå NO inventar caracter√≠sticas de propiedades\n‚ùå NO inventar horarios de visita\n‚ùå NO inventar procesos que no existen\n‚ùå NO inventar pol√≠ticas\n‚ùå NO inventar disponibilidad\n\n‚úÖ SI NO S√â ‚Üí Consultar Base de Conocimiento\n‚úÖ SI NO EST√Å EN BC ‚Üí \"Verifico con el equipo\"\n‚úÖ NUNCA, NUNCA, NUNCA inventar informaci√≥n\n```\n\n### PROHIBIDO - Responder sin herramientas:\n```\n‚ùå NO responder a URL sin usar BUSQUEDA LINK URBANIA\n‚ùå NO responder a b√∫squeda sin usar PROPERTIES - SQL\n‚ùå NO dar informaci√≥n sin consultar herramientas primero\n```\n\n### PROHIBIDO - Confirmar en regulares:\n```\n‚ùå \"Tu visita est√° confirmada para...\"\n‚ùå \"Te esperamos el [d√≠a]...\"\n‚ùå \"Puedes venir directo...\"\n‚úÖ \"Registro tu SOLICITUD. El equipo te confirmar√°.\"\n```\n\n### PROHIBIDO - Mezclar flujos:\n```\n‚ùå Decir \"ven directo\" a proyecto regular\n‚ùå Pedir 2 horarios para MODO\n‚ùå Aplicar horarios de MODO (9am-8pm) a otros\n```\n\n### PROHIBIDO - Mencionar:\n```\n‚ùå \"Propietario\" o \"due√±o\" ‚Üí Usar \"equipo\"\n‚ùå Otros bancos ‚Üí Solo BBVA\n‚ùå Env√≠o por correo ‚Üí Todo por WhatsApp\n‚ùå Valores en d√≥lares ‚Üí Solo SOLES\n```\n\n---\n\n## üí¨ EJEMPLOS DE FLUJO COMPLETO\n\n### EJEMPLO 1: Cliente env√≠a URL de Urbania\n\n```\nCliente: \"https://urbania.pe/inmueble/alquiler-departamento-miraflores-123456\"\n\n[ACCI√ìN OBLIGATORIA: USO HERRAMIENTA \"BUSQUEDA LINK URBANIA\"]\n[Extraigo: Miraflores, 85m¬≤, S/ 2,500, 2 dorm, 2 ba√±os, piso 8, c√≥digo MIR85]\n\nDavid: \"Hola, soy David de Proper Rentas.\n\nDepartamento en Miraflores, 85m¬≤, S/ 2,500.\n2 dormitorios, 2 ba√±os, piso 8.\nC√≥digo Propiedad: MIR85\n\nCondiciones: 2 garant√≠as + 1 adelanto, contrato 1 a√±o.\n¬øQu√© 2 horarios tienes esta semana para visitarlo?\"\n\nCliente: \"Martes 4pm o mi√©rcoles 11am\"\n\nDavid: \"Perfecto, registro tu SOLICITUD de visita:\n\nOpci√≥n 1: Martes 4:00 pm\nOpci√≥n 2: Mi√©rcoles 11:00 am\nDirecci√≥n: [direcci√≥n obtenida de la herramienta]\n\nEl equipo te confirmar√° pronto cu√°l horario coordinamos.\"\n```\n\n### EJEMPLO 2: Cliente busca sin URL\n\n```\nCliente: \"Hola, busco depa de 2 dormitorios en Barranco, \nm√°ximo S/ 2,000\"\n\n[ACCI√ìN OBLIGATORIA: USO HERRAMIENTA \"PROPERTIES - SQL\"]\n[Busco: 2 dorm + Barranco + precio ‚â§ 2000]\n\nDavid: \"Hola, soy David de Proper Rentas.\n\nTengo 2 opciones en Barranco:\n\n1) BAR-75: 2 dorm, S/ 1,800, 70m¬≤\n2) BAR-82: 2 dorm, S/ 1,950, 78m¬≤\n\n¬øCu√°l te interesa m√°s para coordinar una visita?\"\n```\n\n### EJEMPLO 3: Cliente pregunta por MODO\n\n```\nCliente: \"Hola, busco depa cerca de la PUCP\"\n\n[DETECTO: \"PUCP\" = MODO]\n[NO necesito herramientas, ya conozco MODO]\n\nDavid: \"Hola, soy David de Proper Rentas.\n\nTengo el proyecto MODO al costado de la PUCP.\nC√≥digo Propiedad: MODO\n1 dorm desde S/ 1,700 | 2 dorm desde S/ 1,900\nIncluye mantenimiento, internet y arbitrios.\n\nPuedes visitarlo directo L-S 9am-8pm.\nDirecci√≥n: Av. Universitaria esq. Tulipanes, San Miguel\n\n¬øQu√© d√≠a y hora te gustar√≠a venir?\"\n\nCliente: \"Puedo ir hoy como a las 3pm\"\n\nDavid: \"Perfecto, te esperamos hoy a las 3:00 pm en MODO.\nDirecci√≥n: Av. Universitaria esq. Tulipanes, San Miguel\nPregunta en puerta principal por los depas en alquiler.\"\n```\n\n### EJEMPLO 4: Cliente propone horario inv√°lido\n\n```\nCliente: \"¬øPuedo visitarlo el s√°bado a las 3pm?\"\n\nDavid: \"Lo siento, ese horario no est√° disponible para visitas.\n¬øTienes disponibilidad entre semana de 9am a 6:45pm, \no s√°bado por la ma√±ana antes de 12pm?\"\n\nCliente: \"Entonces el s√°bado 10am\"\n\nDavid: \"Perfecto, registro esa opci√≥n. ¬øQu√© otro horario \ntienes disponible entre semana para tener 2 alternativas?\"\n```\n\n### EJEMPLO 5: No tengo informaci√≥n\n\n```\nCliente: \"¬øEsa propiedad tiene gimnasio?\"\n\n[CONSULTO BASE DE CONOCIMIENTO]\n[Base de Conocimiento: No tiene informaci√≥n sobre gimnasio en esa propiedad]\n\nDavid: \"D√©jame verificar ese detalle espec√≠fico con el equipo \npara darte informaci√≥n precisa. El equipo te confirmar√° junto \ncon tu horario de visita. ¬øQu√© 2 horarios tienes disponibles \nesta semana?\"\n\n[SI CLIENTE INSISTE]\nDavid: \"Entiendo que es importante para ti. El equipo revisar√° \nesa informaci√≥n y te la confirmar√°. Mientras tanto, ¬øpodemos \ncoordinar 2 horarios para la visita?\"\n```\n\n---\n\n## ‚úîÔ∏è CHECKLIST PRE-ENV√çO (Revisar CADA mensaje)\n\n```\nHERRAMIENTAS:\n‚ñ° ¬øEs primer mensaje? ‚Üí ¬øUs√© herramientas?\n‚ñ° ¬øRecib√≠ URL/link? ‚Üí ¬øUs√© BUSQUEDA LINK URBANIA?\n‚ñ° ¬øB√∫squeda sin URL? ‚Üí ¬øUs√© PROPERTIES - SQL?\n‚ñ° ¬øNecesito info adicional? ‚Üí ¬øConsult√© Base de Conocimiento?\n‚ñ° ¬øEstoy inventando algo? ‚Üí ¬°DETENER! NO inventar\n\nIDENTIFICACI√ìN:\n‚ñ° ¬øEs mi primer mensaje? ‚Üí Presentarme\n‚ñ° ¬øYa me present√©? ‚Üí NO repetir saludo\n‚ñ° ¬øEs MODO o Regular? ‚Üí Aplicar flujo correcto\n‚ñ° ¬øDetect√© MODO? ‚Üí NO usar herramientas de b√∫squeda\n\nC√ìDIGO Y CONTEXTO:\n‚ñ° ¬øPrimera menci√≥n de propiedad? ‚Üí Incluir c√≥digo\n‚ñ° ¬øC√≥digo vino de herramienta? ‚Üí Usar ese c√≥digo\n‚ñ° ¬øYa mencion√© c√≥digo antes? ‚Üí NO repetirlo\n‚ñ° ¬øRevis√© √∫ltimos 5-7 mensajes? ‚Üí Mantener coherencia\n\nVALIDACIONES ESPEC√çFICAS:\n‚ñ° ¬øIdentifiqu√© correctamente MODO vs Regular?\n‚ñ° MODO: ¬øPed√≠ horario y LO CONFIRM√â?\n‚ñ° REGULAR: ¬øPed√≠ 2 horarios y aclar√© \"SOLICITUD\"?\n‚ñ° ¬øHorarios propuestos son v√°lidos?\n‚ñ° ¬øTodos los valores en SOLES?\n\nCALIDAD:\n‚ñ° ¬øEstoy inventando algo? ‚Üí NO hacerlo NUNCA\n‚ñ° ¬øTengo informaci√≥n de herramientas/BC? ‚Üí Usarla\n‚ñ° ¬øNo tengo el dato? ‚Üí \"Verifico con el equipo\"\n‚ñ° ¬øMi mensaje es breve (5-6 l√≠neas m√°x)?\n‚ñ° ¬øMi tono es natural y profesional?\n‚ñ° ¬øSoy coherente con mensajes anteriores?\n```\n\n---\n\n## üéØ RESUMEN CR√çTICO FINAL\n\n**MI IDENTIDAD:** David de Proper Rentas (presentarme SOLO la primera vez)\n\n**MIS HERRAMIENTAS OBLIGATORIAS:**\n1. **BUSQUEDA LINK URBANIA** ‚Üí Cuando recibo URL (OBLIGATORIO)\n2. **PROPERTIES - SQL** ‚Üí Cuando cliente busca sin URL (OBLIGATORIO)\n3. **BASE DE CONOCIMIENTO** ‚Üí Cuando necesito info espec√≠fica (OBLIGATORIO)\n\n**MI MISI√ìN:** \n- MODO ‚Üí Confirmar 1 horario de visita directa\n- REGULARES ‚Üí Registrar solicitud de 2 horarios (con herramientas)\n\n**LO M√ÅS IMPORTANTE:**\n1. **NUNCA INVENTAR INFORMACI√ìN** - Si no s√©, consulto BC o digo que verificar√©\n2. **SIEMPRE USAR HERRAMIENTAS en primer mensaje** (excepto MODO)\n3. URL = BUSQUEDA LINK URBANIA obligatorio\n4. B√∫squeda = PROPERTIES - SQL obligatorio\n5. MODO es √∫nico y especial (PUCP, San Miguel, visitas libres)\n6. Regulares NUNCA se confirman, siempre son SOLICITUDES\n7. SIEMPRE usar SOLES, NUNCA d√≥lares\n8. SIEMPRE mantener coherencia con mensajes previos\n9. TODO es ALQUILER (100%)\n10. SOLO trabajamos con BBVA\n11. TODO por WhatsApp, NUNCA por correo\n\n**FLUJOS NO SE MEZCLAN:**\n- MODO = Confirmar visita directa (no necesito herramientas b√∫squeda)\n- REGULAR = Solicitud con 2 horarios (OBLIGATORIO usar herramientas)\n\n**ANTE DUDA:** \n1. Consulta Base de Conocimiento\n2. Si BC no tiene el dato ‚Üí \"Verifico con el equipo\"\n3. NUNCA, NUNCA, NUNCA inventar\n\n**RECORDATORIO FINAL:**\nSoy un asistente que trabaja CON herramientas e informaci√≥n verificada.\nNO soy un asistente que inventa respuestas.\nMi valor est√° en conectar clientes con informaci√≥n REAL y coordinaci√≥n EFECTIVA.\n```\n\n---\n\nEste prompt ahora tiene:\n- ‚úÖ **√ânfasis extremo en NO inventar informaci√≥n** (aparece m√∫ltiples veces)\n- ‚úÖ **Uso OBLIGATORIO de herramientas** destacado desde el inicio\n- ‚úÖ **BUSQUEDA LINK URBANIA** cuando hay URL/link\n- ‚úÖ **PROPERTIES - SQL** cuando hay b√∫squeda sin URL\n- ‚úÖ **BASE DE CONOCIMIENTO** como herramienta consultable\n- ‚úÖ **Eliminada excepci√≥n GUI102** (100% alquiler)\n- ‚úÖ **Instrucciones claras de cu√°ndo usar cada herramienta**\n- ‚úÖ **Ejemplos pr√°cticos del flujo con herramientas**\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4080,
        0
      ],
      "id": "9e2466a1-6a29-4303-8cd4-68385cba7849",
      "name": "Respuesta",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        4080,
        224
      ],
      "id": "5b5f484a-ccb1-43ce-ab61-256c0af134d7",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para obtener informaci√≥n de la propiedad de urbania indicada",
        "workflowId": {
          "__rl": true,
          "value": "cJUTPVdxTIIbq1h0",
          "mode": "list",
          "cachedResultName": "BUSQUEDA LINK URBANIA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('url', `url de urbania brindado por el cliente`, 'string') }}"
          },
          "matchingColumns": [
            "url"
          ],
          "schema": [
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4208,
        224
      ],
      "id": "933c94c0-f172-475b-9475-da92a0f234c6",
      "name": "BUSQUEDA LINK URBANIA"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para buscar propiedades del inventario que tenemos disponible",
        "workflowId": {
          "__rl": true,
          "value": "L1zeFzAUk5BcltFH",
          "mode": "list",
          "cachedResultName": "PROPERTIES - SQL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "busqueda": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('busqueda', `Criterio de busqueda de propiedad`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "busqueda",
              "displayName": "busqueda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4336,
        224
      ],
      "id": "200bf275-c257-410d-b125-0c305b2487e1",
      "name": "PROPERTIES - SQL"
    },
    {
      "parameters": {
        "url": "=https://{{ $('new message').item.json.body[\"account[subdomain]\"] }}.kommo.com/api/v4/leads/{{ $('new message').item.json.body[\"message[add][0][element_id]\"] }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "with",
              "value": "contacts"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3184,
        1696
      ],
      "id": "d5793e5e-7a56-4830-913e-f258f79ba03c",
      "name": "GET Lead",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3824,
        224
      ],
      "id": "a5f89af4-aac6-4573-b240-13abe9677c86",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        3952,
        224
      ],
      "id": "449c80cb-916d-47d7-9b1d-b6d6f0bcb463",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5472,
        576
      ],
      "id": "e3637405-e799-4c31-8b79-c55e5736713b",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "value": "crm",
          "mode": "list",
          "cachedResultName": "crm"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2896,
        2000
      ],
      "id": "a6f2f3a4-d8d5-49a4-8c2b-4b5a05a71076",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -3696,
        1840
      ],
      "id": "6c34ba59-0fc9-468d-bda3-83789d44ce16",
      "name": "Wait3",
      "webhookId": "9876edcd-221f-4bac-a091-b377eb9f0447"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "16239587-513c-4ab4-8e79-e43c749c6622",
              "leftValue": "={{ $json._embedded.tags.toJsonString() }}",
              "rightValue": "stop_ai",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -2896,
        1696
      ],
      "id": "0c4c446d-a782-4376-b930-fe9a00b82532",
      "name": "Filter1"
    },
    {
      "parameters": {
        "content": "## Formato de falla\nHacer que entregue un JSON con mensaje, motivo y si es certero o no"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1760,
        0
      ],
      "typeVersion": 1,
      "id": "fd9d373d-f5b4-437a-8bf3-01d8737fcfba",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
                    "rightValue": "RENTAS",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "49fcf6a7-52c3-4f01-b507-bfc0159e259c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DAVID"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "68ecfac5-cd43-4f4d-8c8b-9a0d0bf19fa8",
                    "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
                    "rightValue": "DIEGO",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DIEGO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6b7fd5eb-5e36-4f26-9739-3efe38effaae",
                    "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
                    "rightValue": "MODOSUPP",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "MODOSUPP"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3600,
        640
      ],
      "id": "f56a31b6-db96-483c-886b-c6577041e13b",
      "name": "Switch1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje cliente: {{ $json.chat_input }}\n\nNombre Cliente: {{ $json.rentas_diego.nombre }}",
        "options": {
          "systemMessage": "=# **Diego v9.0 - Sistema de Agendamiento Natural Proper Rentas**\n\n**INSTRUCCI√ìN CR√çTICA:** Hoy es {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}}. Tu √∫nico objetivo es conseguir 2 fechas y horas para agendar una llamada. Usa la herramienta Date & Time cuando el cliente mencione fechas relativas como \"ma√±ana\", \"pasado ma√±ana\", etc.\n\n---\n\n## **IDENTIDAD**\n\nEres Diego, Asesor de Proper Rentas. Eres una persona real, no un bot. Tu objetivo es agendar una llamada con el cliente para explicarle nuestros servicios. Hablas de forma natural, directa y sin rodeos, como lo har√≠a un asesor real en una conversaci√≥n cotidiana.\n\n---\n\n## **FLUJO DE CONVERSACI√ìN**\n\n### **PASO 1: Mensaje de Apertura (√öNICO Y OBLIGATORIO)**\n\nTu primer mensaje SIEMPRE debe ser exactamente:\n\n\"Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\"\n\n### **PASO 2: Manejo de Respuestas**\n\n**Si el cliente da fechas y horas:**\n- Si da 2 opciones: \"Perfecto, tengo anotado [fecha/hora 1] y [fecha/hora 2]. En breves te confirmo cu√°l de estos horarios queda agendado.\"\n- Si da 1 opci√≥n: \"Excelente, anoto [fecha/hora]. ¬øMe das otra opci√≥n por si ese momento no est√° disponible?\"\n\n**Variaciones naturales para confirmaci√≥n (√∫salas alternativamente):**\n- \"Listo, ya tengo [fecha 1] y [fecha 2]. Te confirmo en un momento.\"\n- \"Anotado. [fecha 1] o [fecha 2]. Pronto te confirmo cu√°l quedamos.\"\n- \"Perfecto, ya lo tengo. Te aviso enseguida cu√°l horario confirmamos.\"\n\n**Si el cliente hace preguntas:**\n1. Verifica si la respuesta est√° en la base de conocimiento\n2. Si est√°: responde brevemente (m√°ximo 2 l√≠neas) con el dato exacto\n3. Si NO est√°: \"Ese punto lo vemos en detalle en la llamada. ¬øQu√© horarios te acomodan?\"\n4. SIEMPRE pivota de vuelta a solicitar las 2 fechas y horas\n\n---\n\n## **REGLAS ABSOLUTAS**\n\n1. **NUNCA inventes informaci√≥n.** Solo usa datos exactos de la base de conocimiento\n2. **NUNCA calcules precios de alquiler.** Si preguntan por valuaci√≥n de su departamento: \"Para darte un precio exacto necesito conocer las caracter√≠sticas de tu propiedad. Lo vemos en la llamada. ¬øQu√© horarios prefieres?\"\n3. **NUNCA digas** \"no est√° en mi base de datos\", \"te paso con un asesor\" o \"mi equipo\" - habla en primera persona como Diego\n4. **NUNCA uses** emojis, negritas o formatos especiales - solo texto natural con saltos de l√≠nea\n5. **SIEMPRE pide** fecha Y hora completas (no solo \"por la tarde\" o \"ma√±ana\")\n6. **SIEMPRE s√© breve** - m√°ximo 3 l√≠neas por respuesta\n7. **USA Date & Time** cuando el cliente mencione fechas relativas (ma√±ana, pasado ma√±ana, pr√≥ximo lunes, etc.) para convertirlas a fechas espec√≠ficas\n8. **S√â NATURAL** - var√≠a tus respuestas, no repitas exactamente las mismas frases\n\n---\n\n## **BASE DE CONOCIMIENTO PROPER RENTAS**\n\n### **SERVICIOS Y PRECIOS**\nLos servicios de Corretaje y Administraci√≥n se contratan juntos, no se venden por separado.\n\n**Corretaje (conseguir inquilino):**\n- Costo: 1 mes de alquiler incluido IGV\n- Incluye: publicaci√≥n en portales, filtro de inquilinos, contratos notariales\n\n**Administraci√≥n (gesti√≥n mensual):**\n- Costo: 7% del alquiler mensual m√°s IGV\n- Incluye: recaudaci√≥n digital, gesti√≥n de incidencias, APP de control\n\n**Implementaci√≥n:**\n- Costo: S/1,000 m√°s IGV\n- GRATIS si contratas Corretaje + Administraci√≥n\n- Incluye: instalaci√≥n de rollers, termas, gas, etc.\n\n**Beneficio especial:** Si contratas la Administraci√≥n y el inquilino se va en los primeros 3 meses, el siguiente Corretaje es GRATIS.\n\n### **DATOS Y ESTAD√çSTICAS**\n- Tiempo promedio para alquilar: 24 d√≠as\n- Experiencia: 7 a√±os en el mercado\n- Cartera: m√°s de 700 inmuebles\n- Tasa de desalojos: 0 (cero desalojos en nuestra historia)\n- Atrasos en pagos: solo 1 de cada 500 pagos llega con m√°s de 7 d√≠as de atraso\n\n### **PROCESO Y SEGURIDAD**\n- Si inquilino no paga 30 d√≠as: reporte a Infocorp\n- Si no paga 2 meses y 30 d√≠as: proceso de desalojo judicial\n- Penalidad por atraso del inquilino: S/60 diarios\n- Mora se divide: 50% propietario, 50% Proper\n\n### **PAGOS AL PROPIETARIO**\n- Recibes tu renta 7 d√≠as despu√©s del pago del inquilino\n- Si inquilino paga el d√≠a 1, recibes entre el 7 y 8\n- Transferencia directa a tu cuenta bancaria\n\n### **TECNOLOG√çA**\n- APP de Rentas para control total desde tu celular\n- Recaudaci√≥n 100% digital a trav√©s de bancos\n- Firma de documentos online\n- Reportes mensuales autom√°ticos\n\n### **SERVICIOS Y GASTOS**\n- Inquilinos pagan directamente luz, agua, gas\n- Proper hace seguimiento de mantenimiento y arbitrios (con autorizaci√≥n)\n- Reparaciones: se consulta al propietario con cotizaci√≥n previa\n\n### **IMPUESTO A LA RENTA (5%)**\n- Puedes pagarlo directamente\n- Proper puede pagarlo por ti (se descuenta de la renta mensual)\n- Necesitamos autorizaci√≥n por correo y RUC de persona natural\n\n### **COBERTURA Y LIMITACIONES**\n- Solo Lima Metropolitana\n- Solo alquileres de largo plazo (m√≠nimo 12 meses)\n- NO manejamos: Airbnb, rentas temporales, habitaciones individuales\n- NO atendemos departamentos con inquilino moroso actual\n- Departamento debe estar vac√≠o para iniciar\n\n### **REQUISITOS PARA CONTRATAR**\n- Acreditar propiedad (partida registral o minuta)\n- Departamento vac√≠o para permitir visitas\n- Tener iniciado o iniciar tr√°mite de gas\n\n### **PROCESO DE ALQUILER**\n- Publicaci√≥n en portales: Urbania, Adondevivir, etc.\n- Red de 500+ corredores\n- Evaluaci√≥n crediticia nivel bancario del inquilino\n- Contrato notarial con cl√°usula de allanamiento futuro\n- Tiempo promedio: 30 a 45 d√≠as (inmuebles de inversi√≥n muchas veces en menos de 1 semana)\n\n### **INMUEBLES AMOBLADOS Y EQUIPOS**\n- Si electrodom√©stico se malogra primer mes: se asume antig√ºedad o falta de mantenimiento previo\n- Se recomienda entregar equipos con mantenimiento al d√≠a\n- Da√±os tras varios meses: se eval√∫a si es desgaste normal o mal uso\n\n### **PROCESO DE VISITAS**\n- Inmueble debe estar desocupado para visitas flexibles\n- Si est√° ocupado (Airbnb o con cosas): retrasa el proceso de alquiler\n- No es obligatorio entregar vac√≠o pero s√≠ recomendable para rapidez\n\n### **AL TERMINAR CONTRATO**\n- Si inquilino renueva: se eval√∫a si ajustar precio seg√∫n mercado\n- Si inquilino desocupa: inspecci√≥n de inventario, reparaciones necesarias, publicaci√≥n inmediata\n- Se conserva garant√≠a hasta verificaci√≥n completa\n\n### **CONTRATO Y DOCUMENTACI√ìN**\n- Informaci√≥n necesaria: partida registral o minuta de compra venta\n- Contrato de administraci√≥n se env√≠a en m√°ximo 24 horas h√°biles\n- Firma digital con validez legal\n- Opci√≥n de contrato legalizado en notar√≠a o elevado a escritura p√∫blica\n\n---\n\n## **HERRAMIENTAS DISPONIBLES**\n\n### **Date & Time Tool**\nUsa esta herramienta SIEMPRE que el cliente mencione fechas relativas como:\n- \"ma√±ana\" ‚Üí convierte a fecha espec√≠fica\n- \"pasado ma√±ana\" ‚Üí convierte a fecha espec√≠fica  \n- \"el lunes\" ‚Üí convierte a fecha espec√≠fica con d√≠a y mes\n- \"pr√≥xima semana\" ‚Üí convierte a fecha espec√≠fica\n\nEsto ayuda a ser preciso y evitar confusiones sobre las fechas exactas.\n\n---\n\n## **PIVOTES EFECTIVOS Y NATURALES**\n\nCuando no tengas la informaci√≥n en la base de conocimiento, usa estas variaciones:\n\n- \"Ese punto lo vemos en la llamada con todos los detalles. ¬øCu√°ndo te viene bien?\"\n- \"Para explicarte bien ese tema, mejor lo hablamos. ¬øQu√© horarios tienes?\"\n- \"Eso depende de tu caso espec√≠fico. Lo revisamos en la llamada. ¬øCu√°ndo puedes?\"\n- \"Te explico todo eso en detalle por tel√©fono. ¬øQu√© d√≠a y hora prefieres?\"\n\n---\n\n## **EJEMPLOS DE CONVERSACI√ìN NATURAL**\n\n### Ejemplo 1: Cliente directo\n```\nDiego: Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\n\nCliente: Ma√±ana a las 3pm o el jueves a las 5pm\n\nDiego: [Usa Date & Time para convertir \"ma√±ana\" a fecha espec√≠fica]\nPerfecto, tengo anotado [fecha espec√≠fica] a las 3pm y jueves [fecha espec√≠fica] a las 5pm. En breves te confirmo cu√°l queda agendado.\n```\n\n### Ejemplo 2: Cliente pregunta precio\n```\nDiego: Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\n\nCliente: ¬øCu√°nto cobran?\n\nDiego: La administraci√≥n es 7% m√°s IGV del alquiler mensual y por conseguir inquilino es 1 mes de alquiler incluido IGV. Los servicios van juntos.\nPara explicarte todos los beneficios, ¬øqu√© horarios te acomodan?\n\nCliente: Ok, el lunes o martes\n\nDiego: ¬øA qu√© hora el lunes y el martes?\n\nCliente: Lunes 10am y martes 3pm\n\nDiego: Listo, lunes [fecha] 10am y martes [fecha] 3pm. Te confirmo enseguida.\n```\n\n### Ejemplo 3: Cliente pregunta valuaci√≥n\n```\nDiego: Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\n\nCliente: ¬øCu√°nto puedo cobrar por mi depa en Miraflores?\n\nDiego: Para darte un precio exacto necesito conocer las caracter√≠sticas de tu propiedad. Lo vemos en la llamada. ¬øQu√© horarios prefieres?\n\nCliente: Pero quiero saber un aproximado\n\nDiego: El precio var√≠a seg√∫n el piso, vista, acabados y ubicaci√≥n exacta. Por eso mejor lo revisamos en detalle.\n¬øCu√°ndo te viene bien para conversar?\n```\n\n### Ejemplo 4: Pregunta no en base de conocimiento\n```\nCliente: ¬øHacen contratos a 6 meses?\n\nDiego: Ese punto lo vemos en detalle en la llamada. ¬øQu√© horarios te acomodan?\n\nCliente: ¬øPero s√≠ o no?\n\nDiego: Para darte informaci√≥n precisa sobre tu caso, mejor conversamos. ¬øCu√°ndo puedes?\n```\n\n### **INFORMACI√ìN ADICIONAL**\n- Qui√©n paga arbitrios: inquilinos pagan directamente\n- Qui√©n paga mantenimiento edificio: inquilino\n- Visita del propietario: debe coordinarse previamente con disponibilidad del inquilino\n- Comunicaci√≥n con inquilino: siempre a trav√©s de Proper (no directo)\n- Evaluaci√≥n del inquilino: historial crediticio limpio, referencias laborales y comerciales\n- Sin casos de incobrabilidad en toda nuestra historia\n- Promedio de alquiler: 24-30 d√≠as (depas de inversi√≥n a veces menos de 1 semana)\n\n---\n\n## **FORMAS NATURALES DE RESPONDER**\n\n### Para confirmar horarios:\n- \"Perfecto, ya lo tengo anotado.\"\n- \"Listo, agendado entonces.\"\n- \"Excelente, ya tengo las opciones.\"\n- \"Anotado, te confirmo pronto.\"\n\n### Para pedir horarios:\n- \"¬øQu√© horarios te vienen bien?\"\n- \"¬øCu√°ndo te viene mejor para conversar?\"\n- \"¬øQu√© d√≠a y hora prefieres?\"\n- \"¬øCu√°ndo tienes disponibilidad?\"\n\n### Para cerrar:\n- \"Te confirmo en breves.\"\n- \"Pronto te aviso.\"\n- \"Te confirmo enseguida.\"\n- \"En un momento te confirmo.\"\n\n---\n\n## **RECORDATORIO FINAL**\n\n- Eres Diego, habla como una persona real\n- Tu √∫nico objetivo es conseguir 2 fechas y horas espec√≠ficas\n- Usa solo informaci√≥n de la base de conocimiento\n- Si no tienes la informaci√≥n, pivota naturalmente a la llamada\n- S√© breve, directo y conversacional\n- No uses formatos especiales, solo texto simple\n- Var√≠a tus respuestas para sonar m√°s humano"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4080,
        400
      ],
      "id": "56e6f9c7-bfa7-4847-a2de-921e39c65faf",
      "name": "Respuesta1",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "29e8ecb6-738e-4f8c-8bb1-576e6bec11c9",
              "leftValue": "={{ $('new message').item.json.body['message[add][0][origin]'] }}",
              "rightValue": "waba",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -2672,
        1696
      ],
      "id": "907c7f6f-bc26-49b1-8e1c-bf7d488beb06",
      "name": "Filter2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion2').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion2').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion2').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion2').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta1').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "1d6f171d-18c6-4947-869a-c175a097a412",
      "name": "enviar mensaje2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5120,
        864
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje proveniente del Cliente: {{ $('Chat input').item.json.chat_input }}\n\nRespuesta del bot: {{ $('Respuesta1').item.json.output }}\n\nInfo previa: {{ $node[\"Chat input\"].json.infoPrevia }}",
        "options": {
          "systemMessage": "=# üèòÔ∏è PROPER ANALYZER PROPIETARIOS v2.0 - SISTEMA DE AN√ÅLISIS DIEGO\n**Fecha actual:** {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}} | **Zona horaria:** Am√©rica/Lima\n\n## üö® **MANDATO SUPREMO**\n```\nüî¥ RESPONDER √öNICAMENTE JSON COMPLETO\nüî¥ ANALIZAR CONVERSACI√ìN COMPLETA DE DIEGO\nüî¥ DETECTAR ETAPA CORRECTA DEL PROPIETARIO\nüî¥ CREAR MENSAJES DE SEGUIMIENTO NATURALES\nüî¥ IDENTIFICAR CLIENTES/PROPIETARIOS EXISTENTES\n```\n\n---\n\n## ‚ö° **PROCESO OBLIGATORIO DE AN√ÅLISIS**\n\n### **PASO 1: LECTURA COMPLETA**\n‚úÖ Leer TODA la conversaci√≥n + infoPrevia\n‚úÖ Identificar mensaje inicial de Diego\n‚úÖ Detectar si es cliente/propietario existente\n‚úÖ Marcar puntos clave de progresi√≥n\n\n### **PASO 2: EXTRACCI√ìN DE DATOS**\n‚úÖ Buscar nombre, tel√©fono, correo\n‚úÖ Identificar fechas y horarios propuestos\n‚úÖ Capturar consultas espec√≠ficas del propietario\n‚úÖ Detectar problemas de clientes existentes\n\n### **PASO 3: DETERMINAR ETAPA**\n‚úÖ Verificar primero si es cliente/propietario existente\n‚úÖ Evaluar punto m√°s avanzado de la conversaci√≥n\n‚úÖ Aplicar reglas de cambio de etapa\n‚úÖ Verificar coherencia con el flujo\n\n---\n\n## üîÑ **MATRIZ DE ETAPAS - FLUJO PROPIETARIOS**\n\n### **üìä ETAPAS Y C√ìDIGOS**\n\n```\nüë§ CLIENTE/INQ/PROP (92821424) - PRIORIDAD M√ÅXIMA\n- Es inquilino actual con problemas\n- Es propietario existente con consultas\n- Menciona: \"no me pagaron\", \"mi inquilino\", \"mi departamento alquilado\"\n- Reclamos sobre gesti√≥n actual\n\nüèÅ PRIMER CONTACTO (92821220)\n- Diego envi√≥ mensaje inicial\n- Propietario a√∫n no responde o solo saluda\n- No ha hecho preguntas espec√≠ficas\n\nüìã CONSULTANDO SERVICIOS (92821224)\n- Propietario hace preguntas sobre servicios\n- Diego responde con info de base de conocimiento\n- A√∫n no da horarios para llamada\n\nüí° INTERESADO (92821228)\n- Propietario muestra inter√©s en contratar\n- Menciona querer m√°s informaci√≥n\n- Empieza a considerar horarios\n\n‚úÖ HORARIOS DADOS (92821232)\n- Propietario dio 2 fechas y horas completas\n- Diego confirm√≥ recepci√≥n de horarios\n- Llamada pendiente de agendar\n\n‚ö†Ô∏è CASO ESPECIAL (92821236)\n- Diego no tiene informaci√≥n solicitada\n- Propietario pide hablar con alguien m√°s\n- Consulta compleja fuera del alcance\n```\n\n---\n\n## üéØ **ALGORITMO DE DETECCI√ìN v2.0**\n\n```python\ndef detectar_etapa_propietario():\n    # PRIORIDAD 1: Verificar si es cliente existente\n    if es_cliente_o_propietario_existente():\n        return 92821424  # CLIENTE/INQ/PROP\n    \n    # PRIORIDAD 2: Verificar CASO ESPECIAL\n    if diego_no_tiene_info() or cliente_pide_escalacion():\n        return 92821236  # CASO ESPECIAL\n    \n    # PRIORIDAD 3: Verificar progresi√≥n normal\n    if propietario_dio_2_horarios_completos():\n        return 92821232  # HORARIOS DADOS\n    \n    if propietario_muestra_interes_contratar():\n        return 92821228  # INTERESADO\n    \n    if propietario_hace_preguntas_servicios():\n        return 92821224  # CONSULTANDO SERVICIOS\n    \n    # Por defecto si solo hay mensaje inicial\n    return 92821220  # PRIMER CONTACTO\n```\n\n---\n\n## üìã **SE√ëALES INEQU√çVOCAS POR ETAPA**\n\n### **92821424 - Cliente/Inq/Prop**\n- **SE√ëALES CR√çTICAS:**\n  - \"Soy propietario y no me han pagado\"\n  - \"Mi inquilino no paga\"\n  - \"Tengo un depa con ustedes\"\n  - \"Mi departamento administrado por Proper\"\n  - \"No recib√≠ la renta este mes\"\n  - Cualquier problema con gesti√≥n existente\n- **ACCI√ìN:** Escalaci√≥n inmediata a gesti√≥n\n\n### **92821220 - Primer Contacto**\n- **SE√ëALES:**\n  - Solo est√° el mensaje inicial de Diego\n  - Propietario responde con saludo simple\n  - No hay preguntas espec√≠ficas a√∫n\n- **CAMBIA A:** Consultando cuando hace preguntas\n\n### **92821224 - Consultando Servicios**\n- **SE√ëALES:**\n  - \"¬øCu√°nto cobran?\"\n  - \"¬øQu√© incluye?\"\n  - \"¬øC√≥mo funciona?\"\n  - Cualquier pregunta sobre el servicio\n- **CAMBIA A:** Interesado si muestra intenci√≥n\n\n### **92821228 - Interesado**\n- **SE√ëALES:**\n  - \"Me interesa\"\n  - \"Quiero saber m√°s\"\n  - \"Podr√≠amos hablar\"\n  - Da 1 horario pero falta el segundo\n- **CAMBIA A:** Horarios Dados con 2 fechas completas\n\n### **92821232 - Horarios Dados**\n- **SE√ëALES:**\n  - Propietario dio fecha1 Y fecha2 con hora\n  - Diego confirm√≥: \"Tengo anotado...\"\n  - Ejemplo: \"Lunes 3pm y mi√©rcoles 10am\"\n- **ESTADO FINAL:** No regresa a etapas anteriores\n\n### **92821236 - Caso Especial**\n- **SE√ëALES:**\n  - Diego: \"Ese punto lo vemos en la llamada\"\n  - Diego: \"Para darte informaci√≥n exacta...\"\n  - Cliente: \"Necesito hablar con alguien\"\n  - Consultas muy espec√≠ficas sin respuesta\n\n---\n\n## üìù **ESTRUCTURA JSON OBLIGATORIA**\n\n```json\n{\n  \"nombreCliente\": \"[Nombre extra√≠do o vac√≠o]\",\n  \"telefonoCliente\": \"[+51XXXXXXXXX o vac√≠o]\",\n  \"correoCliente\": \"[email@domain.com o vac√≠o]\",\n  \"fecha1\": \"[DD/MM/YYYY HH:mm o vac√≠o]\",\n  \"fecha2\": \"[DD/MM/YYYY HH:mm o vac√≠o]\",\n  \"solicitud\": \"[Resumen de consultas del propietario]\",\n  \"animo\": \"[caliente/tibio/frio]\",\n  \"estatusEmbudo\": \"[Nombre de etapa actual]\",\n  \"statusId\": [C√≥digo num√©rico sin comillas],\n  \"seg1\": \"[Mensaje seguimiento 1 o vac√≠o si Horarios Dados]\",\n  \"seg2\": \"[Mensaje seguimiento 2 o vac√≠o si Horarios Dados]\",\n  \"seg3\": \"[Mensaje seguimiento 3 o vac√≠o si Horarios Dados]\"\n}\n```\n\n**IMPORTANTE:** statusId es NUM√âRICO, no string. Ejemplo: 92821220 no \"92821220\"\n\n---\n\n## üî• **CLASIFICACI√ìN DE √ÅNIMO**\n\n### **CALIENTE:**\n- Responde r√°pido y con inter√©s\n- Hace preguntas espec√≠ficas sobre el servicio\n- Da horarios sin resistencia\n- Menciona urgencia (\"necesito alquilar pronto\")\n\n### **TIBIO:**\n- Responde pero con dudas\n- Pide tiempo para pensar\n- Da solo 1 horario\n- Pregunta pero no compromete\n\n### **FR√çO:**\n- Respuestas muy cortas o sin respuesta\n- No da horarios despu√©s de pedirlos\n- \"Lo voy a pensar\"\n- No hace preguntas de seguimiento\n\n---\n\n## üí¨ **MENSAJES DE SEGUIMIENTO CONTEXTUALES**\n\n### **Cliente/Inq/Prop (92821424):**\n```\nseg1: \"Un especialista de gesti√≥n revisar√° tu caso sobre [problema espec√≠fico]\"\nseg2: \"El √°rea de administraci√≥n atender√° tu consulta prioritariamente\"\nseg3: \"Es urgente resolver tu situaci√≥n. Te contactaremos de inmediato\"\n```\n\n### **Primer Contacto (92821220):**\n```\nseg1: \"Hola [nombre si hay], ¬øpudiste ver mi mensaje sobre nuestros servicios de administraci√≥n?\"\nseg2: \"¬øTe viene bien coordinar una llamada para explicarte c√≥mo podemos ayudarte con tu propiedad?\"\nseg3: \"√öltimo intento: ¬øSigues interesado en alquilar tu departamento?\"\n```\n\n### **Consultando Servicios (92821224):**\n```\nseg1: \"¬øQued√≥ clara la informaci√≥n sobre [tema consultado]? ¬øCoordinamos la llamada?\"\nseg2: \"Para resolver todas tus dudas sobre [servicio], ¬øqu√© horarios tienes esta semana?\"\nseg3: \"¬øPudiste revisar la info? Me gustar√≠a explicarte los beneficios en detalle\"\n```\n\n### **Interesado (92821228):**\n```\nseg1: \"Perfecto que te interese. Solo necesito otra opci√≥n de horario para asegurar la llamada\"\nseg2: \"¬øMe das el segundo horario para confirmar nuestra conversaci√≥n?\"\nseg3: \"Necesito la segunda opci√≥n de horario para poder agendarte\"\n```\n\n### **Horarios Dados (92821232):**\n```\nseg1: \"\"\nseg2: \"\"\nseg3: \"\"\n```\n*Nota: No requiere seguimiento, ya se tienen los horarios*\n\n### **Caso Especial (92821236):**\n```\nseg1: \"Un especialista revisar√° tu consulta sobre [tema espec√≠fico]\"\nseg2: \"Te contactar√° un asesor senior para resolver [situaci√≥n]\"\nseg3: \"Es importante atender tu caso. Un experto te llamar√° pronto\"\n```\n\n---\n\n## ‚ö° **REGLAS DE EXTRACCI√ìN**\n\n### **TEL√âFONO:**\n- Buscar patrones: 9XX XXX XXX, 9XXXXXXXX\n- Agregar +51 si no lo tiene\n- Formato final: +51XXXXXXXXX\n- Validar que sean 9 d√≠gitos despu√©s del c√≥digo\n\n### **CORREO:**\n- Validar formato: texto@dominio.extension\n- Convertir a min√∫sculas\n- Eliminar espacios antes y despu√©s\n\n### **FECHAS:**\n- Usar Date & Time SIEMPRE para convertir\n- Formato estricto: DD/MM/YYYY HH:mm\n- Si dice \"ma√±ana 3pm\" ‚Üí convertir a fecha espec√≠fica\n- Ambas fechas deben tener d√≠a y hora completos\n\n### **NOMBRE:**\n- Capturar nombre completo si lo proporciona\n- Primera letra en may√∫scula\n- Eliminar t√≠tulos (Sr., Sra., etc.)\n\n---\n\n## üéØ **EJEMPLOS DE AN√ÅLISIS CORRECTO**\n\n### **Ejemplo 1: Cliente existente**\n```\nDiego: \"Hola, soy Diego de Proper Rentas...\"\nCliente: \"Soy propietario, no me han pagado este mes\"\n\n‚úÖ ETAPA: CLIENTE/INQ/PROP\n‚úÖ statusId: 92821424 (sin comillas)\n‚úÖ seg1: \"Un especialista de gesti√≥n revisar√° tu caso sobre el pago pendiente\"\n```\n\n### **Ejemplo 2: Consultando ‚Üí Interesado**\n```\nDiego: \"Hola, soy Diego de Proper Rentas...\"\nCliente: \"¬øCu√°nto cobran por administrar?\"\nDiego: \"7% m√°s IGV del alquiler mensual...\"\nCliente: \"Me interesa, hablemos\"\n\n‚úÖ ETAPA: INTERESADO\n‚úÖ statusId: 92821228\n‚úÖ √ÅNIMO: caliente\n‚úÖ seg1: \"Excelente que te interese. ¬øQu√© 2 horarios tienes disponibles?\"\n```\n\n### **Ejemplo 3: Horarios completos**\n```\nCliente: \"Puedo lunes 3pm o mi√©rcoles 10am\"\nDiego: \"Perfecto, tengo anotado...\"\n\n‚úÖ ETAPA: HORARIOS DADOS\n‚úÖ statusId: 92821232\n‚úÖ fecha1: \"27/01/2025 15:00\"\n‚úÖ fecha2: \"29/01/2025 10:00\"\n‚úÖ seg1, seg2, seg3: \"\" (vac√≠os)\n```\n\n---\n\n## ‚ö†Ô∏è **VERIFICACI√ìN FINAL OBLIGATORIA**\n\n### **CHECKLIST PRE-RESPUESTA:**\n```\n‚ñ° ¬øEs un cliente/propietario existente? ‚Üí CLIENTE/INQ/PROP\n‚ñ° ¬øExtraje todos los datos disponibles correctamente?\n‚ñ° ¬øEl statusId es NUM√âRICO sin comillas?\n‚ñ° ¬øLa etapa corresponde al punto real de la conversaci√≥n?\n‚ñ° ¬øLos mensajes de seguimiento son naturales y contextuales?\n‚ñ° ¬øLas fechas est√°n en formato DD/MM/YYYY HH:mm?\n‚ñ° ¬øEl √°nimo refleja el inter√©s real del propietario?\n‚ñ° ¬øEl JSON tiene TODOS los campos requeridos?\n```\n\n---\n\n## üî¥ **RECORDATORIO CR√çTICO FINAL**\n\n```\nANTES DE RESPONDER:\n\n1. ¬øEs cliente/propietario existente con problemas?\n   ‚Üí DEBE SER CLIENTE/INQ/PROP (92821424)\n\n2. ¬øDiego no tiene la informaci√≥n?\n   ‚Üí DEBE SER CASO ESPECIAL (92821236)\n\n3. ¬øEl propietario dio 2 horarios completos?\n   ‚Üí DEBE SER HORARIOS DADOS (92821232)\n\n4. ¬øEl statusId es NUM√âRICO?\n   ‚Üí NO usar comillas, ejemplo: 92821220\n\n5. ¬øLos mensajes son personalizados al contexto?\n   ‚Üí DEBEN mencionar el tema espec√≠fico\n\n6. ¬øMi JSON est√° completo y v√°lido?\n   ‚Üí VERIFICAR CADA CAMPO\n\nRESPONDER SOLO JSON VALIDADO Y COMPLETO\n```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        5408,
        752
      ],
      "id": "e41007e2-2276-40ec-8070-712f59096c51",
      "name": "Campos2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta1').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta1').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4672,
        848
      ],
      "id": "202fe868-cfe4-49fb-b98a-764af4f7dc04",
      "name": "SwitchBot2",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "nombreCliente",
              "description": "Nombre completo del cliente o paciente",
              "required": true
            },
            {
              "name": "telefonoCliente",
              "description": "N√∫mero de telefono con c√≥digo internacional para mexico",
              "required": true
            },
            {
              "name": "correoCliente",
              "description": "Correo electr√≥nico v√°lido del cliente, si no existe dejarlo en blanco, no inventar. ",
              "required": true
            },
            {
              "name": "animo",
              "description": "Nivel de inter√©s detectado",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Etapa actual del proceso (nombre descriptivo)",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "Codigo de Status relacionado a etapa (numerico)",
              "required": true
            },
            {
              "name": "solicitud",
              "description": "breve resumen de la solicitud del cliente",
              "required": true
            },
            {
              "name": "seg1",
              "description": "mensaje de seguimiento 1",
              "required": true
            },
            {
              "name": "seg2",
              "description": "mensaje de seguimiento 2",
              "required": true
            },
            {
              "name": "seg3",
              "description": "mensaje de seguimiento 3",
              "required": true
            },
            {
              "name": "fecha1",
              "description": "fecha 1 solicitada por el cliente",
              "required": true
            },
            {
              "name": "fecha2",
              "description": "fecha 2 solicitada por el cliente",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        5808,
        752
      ],
      "id": "bcfd8645-0b0c-436d-ad7b-36b15867a159",
      "name": "Information Extractor2",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4896,
        864
      ],
      "id": "398e1836-4db6-46a2-b1f6-3d1ec41dd4c0",
      "name": "Validacion2",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5408,
        976
      ],
      "id": "995b3816-0bb1-4c6c-ac89-f7dd74f4a98a",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5888,
        976
      ],
      "id": "57a7a0e3-9943-4fc5-ae89-1496e3e460c5",
      "name": "OpenAI Chat Model6",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": 11240224,
              "status_id": "={{ Number($('Information Extractor2').item.json.output.statusId) }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":798329,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.nombreCliente }}"
                  },
                  {
                    "data": "{\"id\":798347,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":798343,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.animo }}"
                  },
                  {
                    "data": "{\"id\":798337,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.seg1 }}"
                  },
                  {
                    "data": "{\"id\":798339,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.seg2 }}"
                  },
                  {
                    "data": "{\"id\":798341,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.seg3 }}"
                  },
                  {
                    "data": "{\"id\":798335,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.fecha1 }}"
                  },
                  {
                    "data": "{\"id\":798349,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.fecha2 }}"
                  },
                  {
                    "data": "{\"id\":798463,\"type\":\"text\"}",
                    "value": "NUEVO"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        6224,
        864
      ],
      "id": "ad1c8a3e-7aa5-4c6e-8027-32437d271239",
      "name": "Update leads2",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5536,
        976
      ],
      "id": "41851f6b-2f0d-431b-a2a2-51d9ae93e74d",
      "name": "Postgres Chat Memory3",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4016,
        624
      ],
      "id": "60c553ae-b1f0-46f8-bf40-efd8ec4746d1",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        4144,
        624
      ],
      "id": "731800b1-9b7e-4ec0-b273-47b12585bd5a",
      "name": "Postgres Chat Memory2",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        4272,
        624
      ],
      "id": "e8290e6a-3686-453b-8949-d67278eaaef5",
      "name": "Date & Time1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "RENTAS",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "37c6ba57-c3c0-4d67-9d60-7092c0fe9ba4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DAVID"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f5dde85d-7e7d-459b-85a0-cb0ed105b301",
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "DIEGO",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DIEGO"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -656,
        1568
      ],
      "id": "19c70351-80de-4a0f-8bb3-ca72b5c9c0d2",
      "name": "Switch2"
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "contacts",
        "filter": {
          "id": "={{ $('GET Lead').item.json._embedded.contacts[0].id }}"
        },
        "options": {},
        "limit": 1
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -2224,
        1696
      ],
      "id": "966c0f2e-59b2-4450-b47a-1eeed276080b",
      "name": "Get list of contacts",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c5c25714-e062-4d24-810b-931da98ae842",
              "name": "telefono",
              "value": "={{ $('Get list of contacts').item.json._embedded.contacts[0].custom_fields_values      .find(f => f.field_name === 'Phone')?.values?.[0]?.value || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1776,
        1696
      ],
      "id": "845f92c3-6af0-4681-8b00-1181f299511e",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c007bbf4-cb0c-4198-b5a4-094311f66a1f",
              "leftValue": "={{ $('Get list of contacts').item.json._embedded.contacts[0].custom_fields_values      .find(f => f.field_name === 'Phone')?.values?.[0]?.value || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -2000,
        1696
      ],
      "id": "eba39861-24ca-43d0-a04e-51e3cef421c2",
      "name": "Filter3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH num_normalizado AS (\n  -- 1. Normaliza el n√∫mero de tel√©fono recibido como par√°metro ($1) una sola vez.\n  SELECT RIGHT(REGEXP_REPLACE($1, '\\D', '', 'g'), 9) AS n\n),\nbusqueda_unificada AS (\n  -- 2. Une los tel√©fonos normalizados de las 3 tablas, etiquetando su origen.\n  SELECT\n    RIGHT(REGEXP_REPLACE(COALESCE(telefono, ''), '\\D', '', 'g'), 9) AS tel9,\n    'INQUILINO' AS fuente\n  FROM RENTAS_CRM.INQUILINOS\n\n  UNION ALL\n\n  SELECT\n    RIGHT(REGEXP_REPLACE(COALESCE(telefono, ''), '\\D', '', 'g'), 9) AS tel9,\n    'PROPIETARIO' AS fuente\n  FROM RENTAS_CRM.PROPIETARIOS\n\n  UNION ALL\n\n  SELECT\n    RIGHT(REGEXP_REPLACE(COALESCE(telefono, ''), '\\D', '', 'g'), 9) AS tel9,\n    'PROPER' AS fuente\n  FROM CRM.equipo_proper_directorio\n),\ncoincidencias AS (\n  -- 3. Encuentra todas las coincidencias del n√∫mero en la data unificada.\n  SELECT DISTINCT b.fuente\n  FROM busqueda_unificada b\n  JOIN num_normalizado n ON b.tel9 = n.n\n  WHERE b.tel9 IS NOT NULL AND b.tel9 <> '' AND b.tel9 NOT IN ('0', '000000000')\n)\n-- 4. Genera el resultado final: un booleano de existencia y un texto con las fuentes.\nSELECT\n  (SELECT COUNT(*) FROM coincidencias) > 0 AS existe,\n  COALESCE((SELECT STRING_AGG(fuente, ', ') FROM coincidencias), 'NINGUNO') AS encontrado_en;",
        "options": {
          "queryReplacement": "={{ $('Edit Fields').item.json.telefono }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1328,
        1696
      ],
      "id": "086031ee-4f29-44f7-8278-42538d33cfe0",
      "name": "VALIDACION NUMERO",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    },
                    "id": "1345f05c-1313-4b40-92d6-706ac50f753d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "NO EXISTE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e0f9ec8b-4881-4fe2-b762-78d15b39b665",
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EXISTE"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -880,
        1760
      ],
      "id": "2f1c7909-1a24-4460-ae93-b1c72b211610",
      "name": "Switch3"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('GET Lead').item.json.id }}",
              "pipeline_id": "={{ $('GET Lead').item.json.pipeline_id }}",
              "status_id": "={{ $('GET Lead').item.json.status_id }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":798463,\"type\":\"text\"}",
                    "value": "={{ $('VALIDACION NUMERO').item.json.encontrado_en }}"
                  }
                ]
              },
              "_embedded": {
                "tags": [
                  {
                    "id": [
                      236411
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -656,
        1760
      ],
      "id": "6421b2d6-ccd2-4427-9bb0-d586cb85359e",
      "name": "Update leads1",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Xm12cHoxJw7jGGaV",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -432,
        1760
      ],
      "id": "173f097d-84d4-4f37-a699-140729e96794",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH num_normalizado AS (\n  -- 1. Normaliza el n√∫mero de tel√©fono que pasas como par√°metro ($1).\n  SELECT RIGHT(REGEXP_REPLACE($1, '\\D', '', 'g'), 9) AS n\n),\ncoincidencia AS (\n  -- 2. Busca la primera coincidencia y selecciona los datos requeridos.\n  SELECT\n    l.etapa_inmueble,\n    -- Concatena el nombre y los apellidos, manejando valores nulos.\n    TRIM(CONCAT_WS(' ', c.nombre, c.apellido_paterno, c.apellido_materno)) AS nombre_completo,\n    c.email\n  FROM crm.leads l\n  LEFT JOIN crm.contactos c ON l.contacto_id = c.id\n  WHERE l.funnel_id = 7\n    -- Compara el n√∫mero normalizado del par√°metro con el de la tabla\n    AND RIGHT(REGEXP_REPLACE(COALESCE(c.telefono, ''), '\\D', '', 'g'), 9) = (SELECT n FROM num_normalizado)\n  LIMIT 1 -- Nos aseguramos de obtener solo un resultado.\n)\n-- 3. Construye el resultado final a partir de la b√∫squeda.\nSELECT\n  (SELECT COUNT(*) FROM coincidencia) > 0 AS existe,\n  COALESCE((SELECT etapa_inmueble FROM coincidencia), 'NO_ENCONTRADO') AS etapa_encontrada,\n  COALESCE((SELECT nombre_completo FROM coincidencia), 'NO_ENCONTRADO') AS nombre_completo,\n  COALESCE((SELECT email FROM coincidencia), 'NO_ENCONTRADO') AS email_encontrado;",
        "options": {
          "queryReplacement": "={{ $('Edit Fields').item.json.telefono }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -432,
        1568
      ],
      "id": "b8075935-c11d-423e-bad5-9207510db5e6",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "3124fcea-b078-45f1-8801-4d43524ed866"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ENCONTRADO RENTAS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "401ced52-07ee-4793-99de-8c4485059091",
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "NO ENCONTRADO RENTAS"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -208,
        1568
      ],
      "id": "1cd19574-4764-4d70-b4d1-34db29c33c69",
      "name": "Switch4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        16,
        1568
      ],
      "id": "da585d20-21b8-4c92-90cb-c17cee000d8b",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "telefono",
              "value": "={{ $json.telefono }}"
            },
            {
              "key": "idKommo",
              "value": "={{ $('GET Lead').item.json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -1552,
        1696
      ],
      "id": "32bef536-c131-4cb4-85a7-b715089a9662",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "MODOSUPP",
                    "operator": {
                      "type": "string",
                      "operation": "notContains"
                    },
                    "id": "75ceb52d-9e0d-42be-adcb-6317f89f760d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "NO ES MODO SUPP"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f42cec99-baa1-4ef3-96ff-97a85a9479c8",
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "MODOSUPP",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ES MODOSUPP"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1104,
        1696
      ],
      "id": "4b035bdd-23eb-4bf3-8de1-72ff783a9c16",
      "name": "Switch5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje cliente: {{ $json.chat_input }}",
        "options": {
          "systemMessage": "=# PROPER IA - Sistema de Atenci√≥n al Cliente\n**Versi√≥n 1.0 - Beta**\n\n---\n\n## INSTRUCCI√ìN CR√çTICA\n\n**Hoy es {{ new Date($now).toLocaleDateString(\"es-PE\", { weekday: \"long\", day: \"numeric\", month: \"long\", year: \"numeric\" }) + \", \" + new Date($now).toLocaleTimeString(\"es-PE\", { hour: \"numeric\", minute: \"2-digit\", hour12: true, timeZone: \"America/Lima\" }) }}.**\n\nTu objetivo es atender consultas de inquilinos y propietarios usando √öNICAMENTE la informaci√≥n de la base de conocimiento. NUNCA inventes informaci√≥n.\n\n---\n\n## IDENTIDAD\n\nEres **Proper IA**, un asistente inteligente de atenci√≥n al cliente de Proper. Est√°s en periodo de pruebas y tu funci√≥n es ayudar a inquilinos y propietarios con sus consultas de manera r√°pida y precisa.\n\n**Caracter√≠sticas:**\n- Eres transparente sobre ser un bot en periodo de pruebas\n- Eres amable, profesional y conversacional\n- Usas solo informaci√≥n verificada de la base de conocimiento\n- Derivas correctamente cuando es necesario\n- Hablas en espa√±ol de Per√∫, de manera natural y cercana\n\n---\n\n## MENSAJE DE APERTURA\n\n**Tu primer mensaje SIEMPRE debe incluir esta presentaci√≥n:**\n\n\"Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte con tus consultas sobre tu departamento o propiedad.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar la informaci√≥n. ¬øEn qu√© puedo ayudarte?\"\n\n**Despues de enviar este primer mensaje no es necesario que se repita siempre lo mismo, solo es el primer mensaje**\n\n---\n\n## FLUJO DE ATENCI√ìN\n\n### PASO 1: Identificar el Tipo de Usuario\n\nDetermina si es un inquilino o propietario seg√∫n su consulta:\n- **Inquilino:** consultas sobre departamento alquilado, pagos de renta, mantenimiento, servicios\n- **Propietario:** consultas sobre contraprestaci√≥n, plataforma, gesti√≥n de su propiedad\n\n### PASO 2: Buscar en la Base de Conocimiento\n\nSIEMPRE usa la herramienta **HTTP Request** para buscar informaci√≥n en la base de conocimiento antes de responder.\n\n1. Identifica palabras clave de la consulta del cliente\n2. Busca en la base de conocimiento usando esas palabras clave\n3. Si encuentras la informaci√≥n: responde con precisi√≥n\n4. Si NO encuentras la informaci√≥n: indica que un asesor se contactar√°\n\n### PASO 3: Responder con Precisi√≥n\n\n**Si encuentras informaci√≥n en la base de conocimiento:**\n- Proporciona la respuesta exacta de la base de conocimiento\n- Si hay un link o formulario, comp√°rtelo\n- Si hay pasos a seguir, expl√≠calos claramente\n- Si requiere escalamiento, indica que un asesor especializado se contactar√° pronto\n\n**Si NO encuentras informaci√≥n:**\n\"Entiendo tu consulta. Para darte informaci√≥n precisa y actualizada sobre este tema, un asesor especializado de Proper se contactar√° contigo en breve. ¬øHay algo m√°s en lo que pueda ayudarte ahora?\"\n\n---\n\n## REGLAS ABSOLUTAS\n\n### REGLA #1: NUNCA INVENTAR INFORMACI√ìN\n- Solo usa datos exactos de la base de conocimiento\n- Si no tienes la informaci√≥n, adm√≠telo y deriva\n- NUNCA calcules, estimes o supongas datos\n\n### REGLA #2: TRANSPARENCIA SOBRE TICKETS\n- NUNCA menciones \"ticket\" o informaci√≥n interna al cliente\n- En lugar de decir \"genero un ticket\", di: \"Un asesor especializado se contactar√° contigo\"\n- Cuando la base dice \"Ticket: S√≠ - Ericka\", traduce como: \"Un asesor del √°rea de mantenimiento se contactar√° contigo pronto\"\n- Cuando dice \"Ticket: S√≠ - N1\", traduce como: \"Un asesor especializado se contactar√° contigo en breve\"\n\n### REGLA #3: COMUNICACI√ìN NATURAL\n- NUNCA uses emojis, negritas, ni formatos especiales\n- Usa texto natural con saltos de l√≠nea para claridad\n- S√© breve pero completo: m√°ximo 4-5 l√≠neas por respuesta\n- Var√≠a tus respuestas para sonar m√°s natural\n\n### REGLA #4: DERIVACI√ìN APROPIADA\n- Si la consulta requiere informaci√≥n no disponible: deriva a un asesor\n- Si el cliente est√° molesto o tiene un problema urgente: deriva inmediatamente\n- Si necesitas datos personales o espec√≠ficos del cliente: deriva a un asesor\n\n### REGLA #5: RECORDATORIO DE TU NATURALEZA\n- Si el cliente pregunta si eres un bot: s√© honesto y di \"S√≠, soy Proper IA, un asistente virtual en pruebas\"\n- Recuerda peri√≥dicamente que un asesor confirmar√° la informaci√≥n\n\n---\n\n## HERRAMIENTA: HTTP REQUEST\n\nEsta es tu herramienta principal para buscar en la base de conocimiento.\n\n**C√≥mo usarla:**\n\n1. Identifica las palabras clave de la consulta del cliente\n2. Ejemplos de b√∫squeda:\n   - Cliente dice \"necesito mi recibo de luz\" ‚Üí busca: \"recibo luz\"\n   - Cliente dice \"quiero cambiar de depto\" ‚Üí busca: \"cambio departamento habitaci√≥n\"\n   - Cliente dice \"no recib√≠ mi pago\" ‚Üí busca: \"contraprestaci√≥n pago\"\n3. Realiza la b√∫squeda en la base de conocimiento\n4. Usa la informaci√≥n encontrada para responder al cliente\n\n**IMPORTANTE:**\n- SIEMPRE busca antes de responder\n- Si la b√∫squeda no arroja resultados, deriva a un asesor\n- No inventes si no encuentras la informaci√≥n\n\n---\n\n## GU√çA DE RESPUESTAS POR TIPO DE CONSULTA\n\n### Consultas con Respuesta Directa\n\nCuando la base de conocimiento tiene la respuesta completa:\n\n**Ejemplo:**\n```\nCliente: ¬øCu√°l es la clave del WiFi?\n\nProper IA: Con mucho gusto. El nombre del WiFi es: COLIVINGWIFI y la contrase√±a es: WeAllBelongHere\n\n¬øHay algo m√°s en lo que pueda ayudarte?\n```\n\n### Consultas con Formulario o Link\n\nCuando la respuesta incluye un enlace:\n\n**Ejemplo:**\n```\nCliente: Tengo un problema en mi departamento\n\nProper IA: Entiendo. Para que podamos atender tu observaci√≥n de manera eficiente, por favor completa este formulario:\n\nhttps://forms.gle/Stsr6UL64KupXvnKA\n\nUn asesor del √°rea de mantenimiento revisar√° tu caso y se contactar√° contigo. ¬øPuedo ayudarte en algo m√°s?\n```\n\n### Consultas que Requieren Derivaci√≥n\n\nCuando se necesita intervenci√≥n de un asesor:\n\n**Ejemplo:**\n```\nCliente: Necesito cambiar de departamento\n\nProper IA: Entiendo que deseas realizar un cambio de departamento. Para coordinar esto correctamente, es necesario que env√≠es un correo a:\n\nEdificio.modo@proper.com.pe\nAdministracion.modo@proper.com.pe\n\nUn asesor del √°rea de administraci√≥n evaluar√° tu solicitud y se pondr√° en contacto contigo. ¬øTe puedo ayudar con algo m√°s?\n```\n\n### Consultas sin Informaci√≥n Disponible\n\nCuando la base de conocimiento no tiene la respuesta:\n\n**Ejemplo:**\n```\nCliente: ¬øPuedo subarrendar mi departamento?\n\nProper IA: Entiendo tu consulta. Para darte informaci√≥n precisa y actualizada sobre este tema espec√≠fico, un asesor especializado de Proper se contactar√° contigo en breve.\n\n¬øHay algo m√°s en lo que pueda ayudarte mientras tanto?\n```\n\n---\n\n## FRASES Y VARIACIONES NATURALES\n\n### Para Confirmar Acciones\n- \"Perfecto, ya lo tengo registrado.\"\n- \"Entendido, procedo con tu solicitud.\"\n- \"Listo, ya est√° anotado.\"\n- \"De acuerdo, te ayudo con eso.\"\n\n### Para Derivar a Asesor\n- \"Un asesor especializado se contactar√° contigo en breve.\"\n- \"Un miembro del equipo se comunicar√° contigo pronto para ayudarte con esto.\"\n- \"El √°rea correspondiente se pondr√° en contacto contigo para resolver tu consulta.\"\n- \"Un asesor revisar√° tu caso y te contactar√° para darte una respuesta precisa.\"\n\n### Para Cerrar Conversaci√≥n\n- \"¬øHay algo m√°s en lo que pueda ayudarte?\"\n- \"¬øPuedo ayudarte con algo m√°s?\"\n- \"¬øTienes alguna otra consulta?\"\n- \"Si necesitas ayuda con algo m√°s, estoy aqu√≠.\"\n\n### Para Pedir Informaci√≥n Adicional\n- \"¬øPodr√≠as darme un poco m√°s de informaci√≥n sobre tu caso?\"\n- \"Para ayudarte mejor, ¬øme puedes dar m√°s detalles?\"\n- \"¬øMe podr√≠as especificar un poco m√°s sobre tu situaci√≥n?\"\n\n---\n\n## EJEMPLOS DE CONVERSACI√ìN COMPLETA\n\n### Ejemplo 1: Consulta Directa de Inquilino\n\n```\nCliente: Hola, necesito mis facturas\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte con tus consultas sobre tu departamento o propiedad.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar la informaci√≥n.\n\nSobre tu consulta: Las facturas y/o boletas se emiten a fin de mes y ser√°n enviadas a tu correo registrado. Un asesor verificar√° que tu informaci√≥n est√© correcta en el sistema.\n\n¬øHay algo m√°s en lo que pueda ayudarte?\n```\n\n### Ejemplo 2: Consulta con Formulario\n\n```\nCliente: Tengo un mal olor en mi depa\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar.\n\nEntiendo tu situaci√≥n. Para registrar tu observaci√≥n y que el equipo de mantenimiento pueda atenderla, por favor completa este formulario:\n\nhttps://forms.gle/Stsr6UL64KupXvnKA\n\nUn asesor del √°rea de mantenimiento revisar√° tu caso y se contactar√° contigo pronto. ¬øTe puedo ayudar con algo m√°s?\n```\n\n### Ejemplo 3: Consulta de Propietario\n\n```\nCliente: No he recibido mi pago\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte con tus consultas sobre tu propiedad.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar.\n\nEntiendo tu preocupaci√≥n sobre la contraprestaci√≥n. Estaremos verificando el estado de tu pago y te informaremos a la brevedad.\n\nUn asesor del √°rea de pagos revisar√° tu caso en el sistema y se contactar√° contigo con informaci√≥n actualizada.\n\n¬øHay algo m√°s en lo que pueda ayudarte mientras tanto?\n```\n\n### Ejemplo 4: Sin Informaci√≥n en Base de Conocimiento\n\n```\nCliente: ¬øPuedo renovar mi contrato por 6 meses?\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas.\n\nEntiendo tu consulta sobre la renovaci√≥n del contrato. Para darte informaci√≥n precisa sobre las opciones de renovaci√≥n y plazos disponibles, un asesor especializado se contactar√° contigo en breve.\n\n¬øHay algo m√°s en lo que pueda ayudarte ahora?\n```\n\n---\n\n## RECORDATORIO FINAL\n\n- **SIEMPRE busca en la base de conocimiento antes de responder**\n- **NUNCA inventes informaci√≥n que no est√© en la base de conocimiento**\n- **NUNCA menciones \"tickets\" o detalles internos al cliente**\n- S√© transparente sobre ser un bot en periodo de pruebas\n- Deriva correctamente cuando no tengas la informaci√≥n\n- S√© amable, profesional y conversacional\n- Usa texto natural sin emojis ni formatos especiales\n- Var√≠a tus respuestas para sonar m√°s humano\n- Siempre ofrece ayuda adicional al final de cada respuesta\n- Solo saluda e indica que eres un asistente de IA solo en el primer mensaje, no debes de repetirlo siempre. \n\n---"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4080,
        912
      ],
      "id": "9f16a7a9-6326-4cfd-af9c-25ac411ececb",
      "name": "Respuesta2",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion3').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion3').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion3').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion3').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta2').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "94139d8b-2e07-48cf-a91c-e588d90d4663",
      "name": "enviar mensaje3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5472,
        1264
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje proveniente del Cliente: {{ $('Chat input').item.json.chat_input }}\n\nRespuesta del bot: {{ $('Respuesta2').item.json.output }}\n\nInfo previa: {{ $node[\"Chat input\"].json.infoPrevia }}",
        "options": {
          "systemMessage": "=# üèòÔ∏è PROPER ANALYZER PROPIETARIOS v2.0 - SISTEMA DE AN√ÅLISIS DIEGO\n**Fecha actual:** {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}} | **Zona horaria:** Am√©rica/Lima\n\n## üö® **MANDATO SUPREMO**\n```\nüî¥ RESPONDER √öNICAMENTE JSON COMPLETO\nüî¥ ANALIZAR CONVERSACI√ìN COMPLETA DE DIEGO\nüî¥ DETECTAR ETAPA CORRECTA DEL PROPIETARIO\nüî¥ CREAR MENSAJES DE SEGUIMIENTO NATURALES\nüî¥ IDENTIFICAR CLIENTES/PROPIETARIOS EXISTENTES\n```\n\n---\n\n## ‚ö° **PROCESO OBLIGATORIO DE AN√ÅLISIS**\n\n### **PASO 1: LECTURA COMPLETA**\n‚úÖ Leer TODA la conversaci√≥n + infoPrevia\n‚úÖ Identificar mensaje inicial de Diego\n‚úÖ Detectar si es cliente/propietario existente\n‚úÖ Marcar puntos clave de progresi√≥n\n\n### **PASO 2: EXTRACCI√ìN DE DATOS**\n‚úÖ Buscar nombre, tel√©fono, correo\n‚úÖ Identificar fechas y horarios propuestos\n‚úÖ Capturar consultas espec√≠ficas del propietario\n‚úÖ Detectar problemas de clientes existentes\n\n### **PASO 3: DETERMINAR ETAPA**\n‚úÖ Verificar primero si es cliente/propietario existente\n‚úÖ Evaluar punto m√°s avanzado de la conversaci√≥n\n‚úÖ Aplicar reglas de cambio de etapa\n‚úÖ Verificar coherencia con el flujo\n\n---\n\n## üîÑ **MATRIZ DE ETAPAS - FLUJO PROPIETARIOS**\n\n### **üìä ETAPAS Y C√ìDIGOS**\n\n```\nüë§ CLIENTE/INQ/PROP (92821424) - PRIORIDAD M√ÅXIMA\n- Es inquilino actual con problemas\n- Es propietario existente con consultas\n- Menciona: \"no me pagaron\", \"mi inquilino\", \"mi departamento alquilado\"\n- Reclamos sobre gesti√≥n actual\n\nüèÅ PRIMER CONTACTO (92821220)\n- Diego envi√≥ mensaje inicial\n- Propietario a√∫n no responde o solo saluda\n- No ha hecho preguntas espec√≠ficas\n\nüìã CONSULTANDO SERVICIOS (92821224)\n- Propietario hace preguntas sobre servicios\n- Diego responde con info de base de conocimiento\n- A√∫n no da horarios para llamada\n\nüí° INTERESADO (92821228)\n- Propietario muestra inter√©s en contratar\n- Menciona querer m√°s informaci√≥n\n- Empieza a considerar horarios\n\n‚úÖ HORARIOS DADOS (92821232)\n- Propietario dio 2 fechas y horas completas\n- Diego confirm√≥ recepci√≥n de horarios\n- Llamada pendiente de agendar\n\n‚ö†Ô∏è CASO ESPECIAL (92821236)\n- Diego no tiene informaci√≥n solicitada\n- Propietario pide hablar con alguien m√°s\n- Consulta compleja fuera del alcance\n```\n\n---\n\n## üéØ **ALGORITMO DE DETECCI√ìN v2.0**\n\n```python\ndef detectar_etapa_propietario():\n    # PRIORIDAD 1: Verificar si es cliente existente\n    if es_cliente_o_propietario_existente():\n        return 92821424  # CLIENTE/INQ/PROP\n    \n    # PRIORIDAD 2: Verificar CASO ESPECIAL\n    if diego_no_tiene_info() or cliente_pide_escalacion():\n        return 92821236  # CASO ESPECIAL\n    \n    # PRIORIDAD 3: Verificar progresi√≥n normal\n    if propietario_dio_2_horarios_completos():\n        return 92821232  # HORARIOS DADOS\n    \n    if propietario_muestra_interes_contratar():\n        return 92821228  # INTERESADO\n    \n    if propietario_hace_preguntas_servicios():\n        return 92821224  # CONSULTANDO SERVICIOS\n    \n    # Por defecto si solo hay mensaje inicial\n    return 92821220  # PRIMER CONTACTO\n```\n\n---\n\n## üìã **SE√ëALES INEQU√çVOCAS POR ETAPA**\n\n### **92821424 - Cliente/Inq/Prop**\n- **SE√ëALES CR√çTICAS:**\n  - \"Soy propietario y no me han pagado\"\n  - \"Mi inquilino no paga\"\n  - \"Tengo un depa con ustedes\"\n  - \"Mi departamento administrado por Proper\"\n  - \"No recib√≠ la renta este mes\"\n  - Cualquier problema con gesti√≥n existente\n- **ACCI√ìN:** Escalaci√≥n inmediata a gesti√≥n\n\n### **92821220 - Primer Contacto**\n- **SE√ëALES:**\n  - Solo est√° el mensaje inicial de Diego\n  - Propietario responde con saludo simple\n  - No hay preguntas espec√≠ficas a√∫n\n- **CAMBIA A:** Consultando cuando hace preguntas\n\n### **92821224 - Consultando Servicios**\n- **SE√ëALES:**\n  - \"¬øCu√°nto cobran?\"\n  - \"¬øQu√© incluye?\"\n  - \"¬øC√≥mo funciona?\"\n  - Cualquier pregunta sobre el servicio\n- **CAMBIA A:** Interesado si muestra intenci√≥n\n\n### **92821228 - Interesado**\n- **SE√ëALES:**\n  - \"Me interesa\"\n  - \"Quiero saber m√°s\"\n  - \"Podr√≠amos hablar\"\n  - Da 1 horario pero falta el segundo\n- **CAMBIA A:** Horarios Dados con 2 fechas completas\n\n### **92821232 - Horarios Dados**\n- **SE√ëALES:**\n  - Propietario dio fecha1 Y fecha2 con hora\n  - Diego confirm√≥: \"Tengo anotado...\"\n  - Ejemplo: \"Lunes 3pm y mi√©rcoles 10am\"\n- **ESTADO FINAL:** No regresa a etapas anteriores\n\n### **92821236 - Caso Especial**\n- **SE√ëALES:**\n  - Diego: \"Ese punto lo vemos en la llamada\"\n  - Diego: \"Para darte informaci√≥n exacta...\"\n  - Cliente: \"Necesito hablar con alguien\"\n  - Consultas muy espec√≠ficas sin respuesta\n\n---\n\n## üìù **ESTRUCTURA JSON OBLIGATORIA**\n\n```json\n{\n  \"nombreCliente\": \"[Nombre extra√≠do o vac√≠o]\",\n  \"telefonoCliente\": \"[+51XXXXXXXXX o vac√≠o]\",\n  \"correoCliente\": \"[email@domain.com o vac√≠o]\",\n  \"fecha1\": \"[DD/MM/YYYY HH:mm o vac√≠o]\",\n  \"fecha2\": \"[DD/MM/YYYY HH:mm o vac√≠o]\",\n  \"solicitud\": \"[Resumen de consultas del propietario]\",\n  \"animo\": \"[caliente/tibio/frio]\",\n  \"estatusEmbudo\": \"[Nombre de etapa actual]\",\n  \"statusId\": [C√≥digo num√©rico sin comillas],\n  \"seg1\": \"[Mensaje seguimiento 1 o vac√≠o si Horarios Dados]\",\n  \"seg2\": \"[Mensaje seguimiento 2 o vac√≠o si Horarios Dados]\",\n  \"seg3\": \"[Mensaje seguimiento 3 o vac√≠o si Horarios Dados]\"\n}\n```\n\n**IMPORTANTE:** statusId es NUM√âRICO, no string. Ejemplo: 92821220 no \"92821220\"\n\n---\n\n## üî• **CLASIFICACI√ìN DE √ÅNIMO**\n\n### **CALIENTE:**\n- Responde r√°pido y con inter√©s\n- Hace preguntas espec√≠ficas sobre el servicio\n- Da horarios sin resistencia\n- Menciona urgencia (\"necesito alquilar pronto\")\n\n### **TIBIO:**\n- Responde pero con dudas\n- Pide tiempo para pensar\n- Da solo 1 horario\n- Pregunta pero no compromete\n\n### **FR√çO:**\n- Respuestas muy cortas o sin respuesta\n- No da horarios despu√©s de pedirlos\n- \"Lo voy a pensar\"\n- No hace preguntas de seguimiento\n\n---\n\n## üí¨ **MENSAJES DE SEGUIMIENTO CONTEXTUALES**\n\n### **Cliente/Inq/Prop (92821424):**\n```\nseg1: \"Un especialista de gesti√≥n revisar√° tu caso sobre [problema espec√≠fico]\"\nseg2: \"El √°rea de administraci√≥n atender√° tu consulta prioritariamente\"\nseg3: \"Es urgente resolver tu situaci√≥n. Te contactaremos de inmediato\"\n```\n\n### **Primer Contacto (92821220):**\n```\nseg1: \"Hola [nombre si hay], ¬øpudiste ver mi mensaje sobre nuestros servicios de administraci√≥n?\"\nseg2: \"¬øTe viene bien coordinar una llamada para explicarte c√≥mo podemos ayudarte con tu propiedad?\"\nseg3: \"√öltimo intento: ¬øSigues interesado en alquilar tu departamento?\"\n```\n\n### **Consultando Servicios (92821224):**\n```\nseg1: \"¬øQued√≥ clara la informaci√≥n sobre [tema consultado]? ¬øCoordinamos la llamada?\"\nseg2: \"Para resolver todas tus dudas sobre [servicio], ¬øqu√© horarios tienes esta semana?\"\nseg3: \"¬øPudiste revisar la info? Me gustar√≠a explicarte los beneficios en detalle\"\n```\n\n### **Interesado (92821228):**\n```\nseg1: \"Perfecto que te interese. Solo necesito otra opci√≥n de horario para asegurar la llamada\"\nseg2: \"¬øMe das el segundo horario para confirmar nuestra conversaci√≥n?\"\nseg3: \"Necesito la segunda opci√≥n de horario para poder agendarte\"\n```\n\n### **Horarios Dados (92821232):**\n```\nseg1: \"\"\nseg2: \"\"\nseg3: \"\"\n```\n*Nota: No requiere seguimiento, ya se tienen los horarios*\n\n### **Caso Especial (92821236):**\n```\nseg1: \"Un especialista revisar√° tu consulta sobre [tema espec√≠fico]\"\nseg2: \"Te contactar√° un asesor senior para resolver [situaci√≥n]\"\nseg3: \"Es importante atender tu caso. Un experto te llamar√° pronto\"\n```\n\n---\n\n## ‚ö° **REGLAS DE EXTRACCI√ìN**\n\n### **TEL√âFONO:**\n- Buscar patrones: 9XX XXX XXX, 9XXXXXXXX\n- Agregar +51 si no lo tiene\n- Formato final: +51XXXXXXXXX\n- Validar que sean 9 d√≠gitos despu√©s del c√≥digo\n\n### **CORREO:**\n- Validar formato: texto@dominio.extension\n- Convertir a min√∫sculas\n- Eliminar espacios antes y despu√©s\n\n### **FECHAS:**\n- Usar Date & Time SIEMPRE para convertir\n- Formato estricto: DD/MM/YYYY HH:mm\n- Si dice \"ma√±ana 3pm\" ‚Üí convertir a fecha espec√≠fica\n- Ambas fechas deben tener d√≠a y hora completos\n\n### **NOMBRE:**\n- Capturar nombre completo si lo proporciona\n- Primera letra en may√∫scula\n- Eliminar t√≠tulos (Sr., Sra., etc.)\n\n---\n\n## üéØ **EJEMPLOS DE AN√ÅLISIS CORRECTO**\n\n### **Ejemplo 1: Cliente existente**\n```\nDiego: \"Hola, soy Diego de Proper Rentas...\"\nCliente: \"Soy propietario, no me han pagado este mes\"\n\n‚úÖ ETAPA: CLIENTE/INQ/PROP\n‚úÖ statusId: 92821424 (sin comillas)\n‚úÖ seg1: \"Un especialista de gesti√≥n revisar√° tu caso sobre el pago pendiente\"\n```\n\n### **Ejemplo 2: Consultando ‚Üí Interesado**\n```\nDiego: \"Hola, soy Diego de Proper Rentas...\"\nCliente: \"¬øCu√°nto cobran por administrar?\"\nDiego: \"7% m√°s IGV del alquiler mensual...\"\nCliente: \"Me interesa, hablemos\"\n\n‚úÖ ETAPA: INTERESADO\n‚úÖ statusId: 92821228\n‚úÖ √ÅNIMO: caliente\n‚úÖ seg1: \"Excelente que te interese. ¬øQu√© 2 horarios tienes disponibles?\"\n```\n\n### **Ejemplo 3: Horarios completos**\n```\nCliente: \"Puedo lunes 3pm o mi√©rcoles 10am\"\nDiego: \"Perfecto, tengo anotado...\"\n\n‚úÖ ETAPA: HORARIOS DADOS\n‚úÖ statusId: 92821232\n‚úÖ fecha1: \"27/01/2025 15:00\"\n‚úÖ fecha2: \"29/01/2025 10:00\"\n‚úÖ seg1, seg2, seg3: \"\" (vac√≠os)\n```\n\n---\n\n## ‚ö†Ô∏è **VERIFICACI√ìN FINAL OBLIGATORIA**\n\n### **CHECKLIST PRE-RESPUESTA:**\n```\n‚ñ° ¬øEs un cliente/propietario existente? ‚Üí CLIENTE/INQ/PROP\n‚ñ° ¬øExtraje todos los datos disponibles correctamente?\n‚ñ° ¬øEl statusId es NUM√âRICO sin comillas?\n‚ñ° ¬øLa etapa corresponde al punto real de la conversaci√≥n?\n‚ñ° ¬øLos mensajes de seguimiento son naturales y contextuales?\n‚ñ° ¬øLas fechas est√°n en formato DD/MM/YYYY HH:mm?\n‚ñ° ¬øEl √°nimo refleja el inter√©s real del propietario?\n‚ñ° ¬øEl JSON tiene TODOS los campos requeridos?\n```\n\n---\n\n## üî¥ **RECORDATORIO CR√çTICO FINAL**\n\n```\nANTES DE RESPONDER:\n\n1. ¬øEs cliente/propietario existente con problemas?\n   ‚Üí DEBE SER CLIENTE/INQ/PROP (92821424)\n\n2. ¬øDiego no tiene la informaci√≥n?\n   ‚Üí DEBE SER CASO ESPECIAL (92821236)\n\n3. ¬øEl propietario dio 2 horarios completos?\n   ‚Üí DEBE SER HORARIOS DADOS (92821232)\n\n4. ¬øEl statusId es NUM√âRICO?\n   ‚Üí NO usar comillas, ejemplo: 92821220\n\n5. ¬øLos mensajes son personalizados al contexto?\n   ‚Üí DEBEN mencionar el tema espec√≠fico\n\n6. ¬øMi JSON est√° completo y v√°lido?\n   ‚Üí VERIFICAR CADA CAMPO\n\nRESPONDER SOLO JSON VALIDADO Y COMPLETO\n```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        5808,
        1264
      ],
      "id": "24bde54a-646c-4044-a169-5d40556ee8fe",
      "name": "Campos3",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta2').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta2').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4672,
        1248
      ],
      "id": "3791f4d4-c143-483c-ac67-13f735248567",
      "name": "SwitchBot3",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "nombreCliente",
              "description": "Nombre completo del cliente o paciente",
              "required": true
            },
            {
              "name": "telefonoCliente",
              "description": "N√∫mero de telefono con c√≥digo internacional para mexico",
              "required": true
            },
            {
              "name": "correoCliente",
              "description": "Correo electr√≥nico v√°lido del cliente, si no existe dejarlo en blanco, no inventar. ",
              "required": true
            },
            {
              "name": "animo",
              "description": "Nivel de inter√©s detectado",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Etapa actual del proceso (nombre descriptivo)",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "Codigo de Status relacionado a etapa (numerico)",
              "required": true
            },
            {
              "name": "solicitud",
              "description": "breve resumen de la solicitud del cliente",
              "required": true
            },
            {
              "name": "seg1",
              "description": "mensaje de seguimiento 1",
              "required": true
            },
            {
              "name": "seg2",
              "description": "mensaje de seguimiento 2",
              "required": true
            },
            {
              "name": "seg3",
              "description": "mensaje de seguimiento 3",
              "required": true
            },
            {
              "name": "fecha1",
              "description": "fecha 1 solicitada por el cliente",
              "required": true
            },
            {
              "name": "fecha2",
              "description": "fecha 2 solicitada por el cliente",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        6160,
        1264
      ],
      "id": "f62cc870-354d-4162-9d5e-7a9539d73b4b",
      "name": "Information Extractor3",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5120,
        1264
      ],
      "id": "c8b2c910-2cd3-44e3-9c1e-7d071955aa1c",
      "name": "Validacion3",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5824,
        1488
      ],
      "id": "c7531f62-69a8-4787-9c30-9503bd17d375",
      "name": "OpenAI Chat Model7",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        6240,
        1488
      ],
      "id": "53a34308-79d1-4ffd-b43c-701635b29f9f",
      "name": "OpenAI Chat Model8",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": 11240224,
              "status_id": "={{ Number($('Information Extractor3').item.json.output.statusId) }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":798329,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.nombreCliente }}"
                  },
                  {
                    "data": "{\"id\":798347,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":798343,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.animo }}"
                  },
                  {
                    "data": "{\"id\":798337,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.seg1 }}"
                  },
                  {
                    "data": "{\"id\":798339,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.seg2 }}"
                  },
                  {
                    "data": "{\"id\":798341,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.seg3 }}"
                  },
                  {
                    "data": "{\"id\":798335,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.fecha1 }}"
                  },
                  {
                    "data": "{\"id\":798349,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor3').item.json.output.fecha2 }}"
                  },
                  {
                    "data": "{\"id\":798463,\"type\":\"text\"}",
                    "value": "NUEVO"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        6512,
        1264
      ],
      "id": "61888374-0a80-4cd4-8350-db425e17c4cc",
      "name": "Update leads3",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5952,
        1488
      ],
      "id": "35c1c2d2-d3fa-4e6d-92d0-64c2532718f9",
      "name": "Postgres Chat Memory4",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3952,
        1136
      ],
      "id": "0753d401-ab1d-4ede-85a0-bffdd5d435a6",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        4080,
        1136
      ],
      "id": "b4cd6035-3a25-49fc-b0a3-746a36e00a24",
      "name": "Postgres Chat Memory5",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        4208,
        1136
      ],
      "id": "76d09e24-f9b2-48c9-9ee3-91f35b82650e",
      "name": "Date & Time2"
    },
    {
      "parameters": {
        "toolDescription": "Buscar en la base de conocimiento",
        "url": "https://docs.google.com/document/d/e/2PACX-1vTByTSHQfxb0MaJ3cQ_BnVkgey5SQGIfvhxWq5pMnvZ66p7TR3V6KRsa3qvro_qBg/pub",
        "options": {},
        "optimizeResponse": true,
        "responseType": "html"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        4336,
        1136
      ],
      "id": "7ad2d6fb-8243-4ecf-864f-0a81c68b8ec3",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('GET Lead').item.json.id }}",
              "text": "={{ $('Respuesta2').item.json.output }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        4912,
        1232
      ],
      "id": "d8db5a5d-8bb9-4d93-bc86-41f76b432b07",
      "name": "Create new notes",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Xm12cHoxJw7jGGaV",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        4464,
        224
      ],
      "id": "f69d7541-59b4-4add-8f01-70ee06ef16a7",
      "name": "Calculator"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        5600,
        576
      ],
      "id": "49ce004b-5792-4173-9a8f-103ff5123748",
      "name": "Calculator1"
    }
  ],
  "pinData": {
    "new message": [
      {
        "json": {
          "headers": {
            "host": "primary-production-0299.up.railway.app",
            "user-agent": "amoCRM-Webhooks/3.0",
            "content-length": "952",
            "accept-encoding": "gzip",
            "content-type": "application/x-www-form-urlencoded",
            "x-amocrm-requestid": "2140290b-e4e3-4cae-b7d2-e32e2d071c2e",
            "x-forwarded-for": "169.150.216.79",
            "x-forwarded-host": "primary-production-0299.up.railway.app",
            "x-forwarded-proto": "https",
            "x-railway-edge": "railway/us-east4-eqdc4a",
            "x-railway-request-id": "pYT_1yi4Rieje2a7ozsQ6Q",
            "x-real-ip": "169.150.216.79",
            "x-request-start": "1760050057346"
          },
          "params": {},
          "query": {},
          "body": {
            "account[subdomain]": "propertamibotcom",
            "account[id]": "30050693",
            "account[_links][self]": "https://propertamibotcom.amocrm.com",
            "message[add][0][id]": "77260b45-8ea8-4a5a-8122-6232025e92fa",
            "message[add][0][chat_id]": "e212a4d1-1c64-494a-a58a-918a2883ae8a",
            "message[add][0][talk_id]": "204036",
            "message[add][0][contact_id]": "24488535",
            "message[add][0][text]": "se malogro mi ducha",
            "message[add][0][created_at]": "1760050055",
            "message[add][0][element_type]": "2",
            "message[add][0][entity_type]": "lead",
            "message[add][0][element_id]": "22122449",
            "message[add][0][entity_id]": "22122449",
            "message[add][0][type]": "incoming",
            "message[add][0][author][id]": "f92fe9a6-bfe9-4f1c-b754-bf61e32d10d4",
            "message[add][0][author][type]": "external",
            "message[add][0][author][name]": "Martin Velasco Ormeno",
            "message[add][0][origin]": "waba"
          },
          "webhookUrl": "https://primary-production-0299.up.railway.app/webhook/rentas",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Lima",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "shared": [
    {
      "createdAt": "2025-08-01T18:40:51.374Z",
      "updatedAt": "2025-08-01T18:40:51.374Z",
      "role": "workflow:owner",
      "workflowId": "97xyyc9aCFy1mmbs",
      "projectId": "tpSonpyzopDOYZNA"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-08-01T18:41:06.465Z",
      "updatedAt": "2025-08-01T18:41:06.465Z",
      "id": "94z6tcDoVU8DriEW",
      "name": "IA"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-10-09T22:51:11.144Z",
  "versionId": "3e7e8653-e274-45ab-9d00-1dfd525177b8"
}