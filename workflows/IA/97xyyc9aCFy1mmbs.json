{
  "active": true,
  "connections": {
    "enviar mensaje": {
      "main": [
        [
          {
            "node": "Campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campos": {
      "main": [
        [
          {
            "node": "Information Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBot": {
      "main": [
        [
          {
            "node": "Validacion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor": {
      "main": [
        [
          {
            "node": "Update leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion": {
      "main": [
        [
          {
            "node": "enviar mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "GET Lead",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat Memory Manager1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "Chat Memory Manager1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Set Fields": {
      "main": [
        [
          {
            "node": "TEST",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBuffer": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete message buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Video content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Image content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Voice content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Sort",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat input": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parse": {
      "main": [
        [
          {
            "node": "checkType",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "JSON parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete message buffer": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "SwitchBuffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Buffer": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get PDF": {
      "main": [
        [
          {
            "node": "Analyze document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get video": {
      "main": [
        [
          {
            "node": "Analyze video",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get image": {
      "main": [
        [
          {
            "node": "recognize image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "recognize image": {
      "main": [
        [
          {
            "node": "Image content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "checkType": {
      "main": [
        [
          {
            "node": "Text content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get video",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "transcribe voice": {
      "main": [
        [
          {
            "node": "Voice content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get voice": {
      "main": [
        [
          {
            "node": "transcribe voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Campos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "new message": {
      "main": [
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "BUSQUEDA LINK URBANIA": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Campos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "PROPERTIES - SQL": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          },
          {
            "node": "Campos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta": {
      "main": [
        [
          {
            "node": "SwitchBot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Lead": {
      "main": [
        [
          {
            "node": "Filter1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Respuesta",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Campos",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Chat Memory Manager1": {
      "main": [
        [
          {
            "node": "Postgres",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter1": {
      "main": [
        [
          {
            "node": "Switch6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Respuesta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta1": {
      "main": [
        [
          {
            "node": "SwitchBot2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar mensaje2": {
      "main": [
        [
          {
            "node": "Campos2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campos2": {
      "main": [
        [
          {
            "node": "Information Extractor2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBot2": {
      "main": [
        [
          {
            "node": "Validacion2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor2": {
      "main": [
        [
          {
            "node": "Update leads2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion2": {
      "main": [
        [
          {
            "node": "enviar mensaje2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "Campos2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory3": {
      "ai_memory": [
        [
          {
            "node": "Campos2",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "Respuesta1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time1": {
      "ai_tool": [
        [
          {
            "node": "Respuesta1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Update leads2": {
      "main": [
        []
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute a SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get list of contacts": {
      "main": [
        [
          {
            "node": "Filter3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter3": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "VALIDACION NUMERO": {
      "main": [
        [
          {
            "node": "Switch5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch3": {
      "main": [
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update leads1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update leads1": {
      "main": [
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute a SQL query": {
      "main": [
        [
          {
            "node": "Switch4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch4": {
      "main": [
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "VALIDACION NUMERO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch5": {
      "main": [
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta2": {
      "main": [
        [
          {
            "node": "SwitchBot3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar mensaje3": {
      "main": [
        []
      ]
    },
    "SwitchBot3": {
      "main": [
        [
          {
            "node": "Create new notes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion3": {
      "main": [
        [
          {
            "node": "enviar mensaje3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory5": {
      "ai_memory": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time2": {
      "ai_tool": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Calculator1": {
      "ai_tool": [
        [
          {
            "node": "Campos",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes": {
      "main": [
        [
          {
            "node": "Campos5",
            "type": "main",
            "index": 0
          },
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch6": {
      "main": [
        [
          {
            "node": "Set Fields",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta3": {
      "main": [
        [
          {
            "node": "SwitchBot4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "enviar mensaje4": {
      "main": [
        []
      ]
    },
    "Campos4": {
      "main": [
        [
          {
            "node": "Information Extractor4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBot4": {
      "main": [
        [
          {
            "node": "Create new notes1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor4": {
      "main": [
        [
          {
            "node": "Update leads4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion4": {
      "main": [
        [
          {
            "node": "enviar mensaje4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model11": {
      "ai_languageModel": [
        [
          {
            "node": "Campos4",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model12": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor4",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory7": {
      "ai_memory": [
        [
          {
            "node": "Campos4",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory8": {
      "ai_memory": [
        [
          {
            "node": "Respuesta3",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time3": {
      "ai_tool": [
        [
          {
            "node": "Respuesta3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Create new notes1": {
      "main": [
        [
          {
            "node": "Campos4",
            "type": "main",
            "index": 0
          },
          {
            "node": "Filter2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze video": {
      "main": [
        [
          {
            "node": "Video content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze document": {
      "main": [
        [
          {
            "node": "PDF content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter2": {
      "main": [
        [
          {
            "node": "Validacion4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base de conocimiento": {
      "ai_tool": [
        [
          {
            "node": "Respuesta3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Base de conocimiento1": {
      "ai_tool": [
        [
          {
            "node": "Respuesta2",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Busca por correo o dni": {
      "ai_tool": [
        [
          {
            "node": "Respuesta3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model9": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta3",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Busca por telefono": {
      "ai_tool": [
        [
          {
            "node": "Respuesta3",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Campos5": {
      "main": [
        [
          {
            "node": "Information Extractor5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor5": {
      "main": [
        [
          {
            "node": "Update leads5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model13": {
      "ai_languageModel": [
        [
          {
            "node": "Campos5",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model14": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor5",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory9": {
      "ai_memory": [
        [
          {
            "node": "Campos5",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "TEST": {
      "main": [
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get list of contacts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres": {
      "main": [
        []
      ]
    },
    "Think": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "BASE DE CONOCIMIENTO - DAVID": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Validacion3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-01T18:40:51.374Z",
  "id": "97xyyc9aCFy1mmbs",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "PROPER CHATBOT IA",
  "nodes": [
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "1838a470-ec0f-44c5-8e5b-8714ed558d2a",
      "name": "enviar mensaje",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5424,
        2288
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje proveniente del Cliente: {{ $('Chat input').item.json.chat_input }}\n\nRespuesta del bot: {{ $('Respuesta').item.json.output }}\n\nLink Urbania: {{ $('Chat input').item.json.LinkUrbania }}\n\nFecha Actual: {{ $('Chat input').item.json.fecha_actual }}",
        "options": {
          "systemMessage": "=# üè† **PROPER ANALYZER V9.0 - SISTEMA INTELIGENTE DE EXTRACCI√ìN**\n\n## üö® **MANDATO SUPREMO DE INTEGRIDAD**\n\n```\nüî¥ RESPONDER √öNICAMENTE JSON COMPLETO Y V√ÅLIDO\nüî¥ VALORES: \"SI\" / \"NO\" / \"VACIO\" (NO booleanos)\nüî¥ CASO ESPECIAL \"SI\" cuando: No puedo responder / Inventar√≠a / Necesito apoyo\nüî¥ ORIGEN \"URBANIA\" SOLO si c√≥digo vino de herramienta URL\nüî¥ MODO = C√ìDIGO \"MODO\" + ORIGEN \"OTROS\" (excepto si vino de URL)\nüî¥ FILTROS: \"CUMPLE\" / \"NO_CUMPLE\" / \"VACIO\"\nüî¥ statusId SIEMPRE NUM√âRICO (sin comillas)\nüî¥ NUNCA INVENTAR C√ìDIGOS, FECHAS O DATOS\nüî¥ MENSAJES SIN EMOJIS, m√°ximo 150 caracteres\n```\n\n---\n\n## üìä **SISTEMA DE CATEGORIZACI√ìN COMERCIAL V9.0**\n\n### **ESTRUCTURA OBLIGATORIA: 3 NIVELES**\n```\nNIVEL_1 - NIVEL_2 - NIVEL_3\n```\n\n### **NIVEL 1: TEMPERATURA DEL LEAD**\n- `LEAD_CALIENTE` ‚Üí Listo para visitar, urgente, con horarios\n- `LEAD_TIBIO` ‚Üí Interesado, explorando activamente\n- `LEAD_FRIO` ‚Üí B√∫squeda inicial, sin urgencia\n- `CONSULTA` ‚Üí Pregunta informativa, no comercial\n- `CASO_ESPECIAL` ‚Üí Requiere intervenci√≥n humana\n\n### **NIVEL 2: ORIGEN/PROYECTO**\n- `URBANIA` ‚Üí Lleg√≥ con URL de Urbania\n- `MODO` ‚Üí Proyecto MODO espec√≠ficamente\n- `REGULAR` ‚Üí Propiedades regulares con c√≥digo\n- `OTROS` ‚Üí Sin c√≥digo o b√∫squeda general\n- `INTERNO` ‚Üí Inquilino/propietario existente\n\n### **NIVEL 3: ESTADO ACTUAL**\n- `VISITA_CONFIRMADA` ‚Üí Visita agendada/confirmada\n- `HORARIOS_DADOS` ‚Üí Cliente dio horarios completos\n- `COORDINANDO` ‚Üí En proceso de agendar\n- `INTERESADO` ‚Üí Mostr√≥ inter√©s espec√≠fico\n- `EXPLORANDO` ‚Üí Viendo opciones\n- `DEFINIENDO` ‚Üí Estableciendo criterios\n- `INFORMACION` ‚Üí Solo busca datos\n- `ESCALADO` ‚Üí Requiere atenci√≥n especial\n\n### **EJEMPLOS V√ÅLIDOS:**\n```\n‚úÖ LEAD_CALIENTE - MODO - VISITA_CONFIRMADA\n‚úÖ LEAD_CALIENTE - REGULAR - HORARIOS_DADOS\n‚úÖ LEAD_TIBIO - URBANIA - INTERESADO\n‚úÖ LEAD_FRIO - OTROS - EXPLORANDO\n‚úÖ CONSULTA - INTERNO - INFORMACION\n‚úÖ CASO_ESPECIAL - OTROS - ESCALADO\n```\n\n---\n\n## üîß **HERRAMIENTAS Y CASO ESPECIAL**\n\n### **HERRAMIENTA: BUSQUEDA_LINK_URBANIA**\n```\nUSAR CUANDO:\n‚úÖ Hay URL/link en conversaci√≥n o infoPrevia\n‚úÖ NO tengo c√≥digo de propiedad a√∫n\n‚úÖ Necesito extraer informaci√≥n del inmueble\n\nEXTRAER:\n‚úÖ C√≥digo propiedad (CR√çTICO)\n‚úÖ Precio, ubicaci√≥n, caracter√≠sticas\n\nSI FALLA ‚Üí caso_especial = \"SI\"\n```\n\n### **üö® ACTIVACI√ìN DE CASO ESPECIAL**\n\n**caso_especial = \"SI\" CUANDO:**\n\n1. **Bot invent√≥ o podr√≠a inventar informaci√≥n:**\n   ```\n   - Bot mencion√≥ c√≥digo sin fuente verificable\n   - Bot dio precios/caracter√≠sticas sin herramienta\n   - Bot confirm√≥ disponibilidad sin datos\n   ‚Üí detalle: \"Bot invent√≥ c√≥digo/precio sin fuente verificable\"\n   ```\n\n2. **Bot no puede responder adecuadamente:**\n   ```\n   - Cliente pide info que bot no tiene\n   - Herramienta fall√≥ o dio error\n   - Consulta fuera del alcance del bot\n   ‚Üí detalle: \"Bot no tiene informaci√≥n sobre [tema], requiere apoyo humano\"\n   ```\n\n3. **Inquilino/Propietario existente:**\n   ```\n   - \"Soy inquilino de...\"\n   - \"Alquilo con ustedes...\"\n   - Problema contractual/administrativo\n   ‚Üí detalle: \"Inquilino existente con problema [tipo], requiere atenci√≥n administrativa\"\n   ```\n\n4. **Situaci√≥n compleja/urgente:**\n   ```\n   - Problema legal o contractual\n   - Emergencia de vivienda\n   - M√∫ltiples propiedades o grupo grande\n   ‚Üí detalle: \"Situaci√≥n compleja: [descripci√≥n], requiere asesor especializado\"\n   ```\n\n5. **Bot dio respuesta inadecuada:**\n   ```\n   - Confirm√≥ visita sin ser MODO\n   - No sigui√≥ el flujo correcto\n   - Respuesta confusa o contradictoria\n   ‚Üí detalle: \"Bot confirm√≥ visita incorrectamente/dio respuesta confusa sobre [tema]\"\n   ```\n\n6. **Cliente con necesidades especiales:**\n   ```\n   - Discapacidad mencionada\n   - Requisitos muy espec√≠ficos\n   - Situaci√≥n vulnerable\n   ‚Üí detalle: \"Cliente con [situaci√≥n especial], requiere atenci√≥n personalizada\"\n   ```\n\n---\n\n## ‚ö° **PROCESO DE AN√ÅLISIS V9.0**\n\n### **PASO 1: IDENTIFICACI√ìN INICIAL**\n\n```\n1. DETECTAR URL:\n   ¬øHay URL en conversaci√≥n/infoPrevia?\n   SI ‚Üí Usar \"BUSQUEDA_LINK_URBANIA\"\n      ‚Üí Extraer c√≥digo\n      ‚Üí origen = \"URBANIA\"\n   NO ‚Üí Continuar an√°lisis\n\n2. DETECTAR MODO:\n   ¬øMenciona PUCP/Cat√≥lica/San Miguel/Universitaria?\n   SI ‚Üí codPropiedad = \"MODO\"\n      ‚Üí origen = \"OTROS\" (excepto si vino de URL)\n   NO ‚Üí Buscar c√≥digo en conversaci√≥n\n\n3. VALIDAR RESPUESTA BOT:\n   ¬øBot invent√≥ informaci√≥n?\n   ¬øBot no pudo responder?\n   ¬øBot cometi√≥ error?\n   SI ‚Üí caso_especial = \"SI\"\n      ‚Üí Detallar problema espec√≠fico\n```\n\n### **PASO 2: EXTRACCI√ìN DE DATOS**\n\n```\nDATOS CLIENTE:\n- nombre: Extraer si mencion√≥\n- telefono: Formato +51XXXXXXXXX\n- correo: email@dominio\n\nPROPIEDAD:\n- codPropiedad: SOLO si existe (NO inventar)\n- propiedadInteres: Descripci√≥n de b√∫squeda\n\nFILTROS (NUEVO FORMATO):\n- ingresos_minimos: \"CUMPLE\" / \"NO_CUMPLE\" / \"VACIO\"\n- mudanza_proxima: \"CUMPLE\" / \"NO_CUMPLE\" / \"VACIO\"\n```\n\n### **PASO 3: AN√ÅLISIS DE SOLUCI√ìN**\n\n```\ntiene_solucion = \"SI\" CUANDO:\n‚úÖ Bot dio c√≥digo de propiedad real\n‚úÖ Bot present√≥ opciones con datos verificables\n‚úÖ Bot respondi√≥ consulta completamente\n‚úÖ Bot sigui√≥ flujo correcto\n\ntiene_solucion = \"NO\" CUANDO:\n‚úÖ Bot no pudo responder\n‚úÖ Informaci√≥n incompleta\n‚úÖ Error en respuesta\n‚úÖ Requiere seguimiento\n```\n\n### **PASO 4: PROGRESI√ìN Y ESTADO**\n\n```\nFLUJO MODO:\n90801076 ‚Üí 90801080 ‚Üí 90801092 ‚Üí 92800052\n(Definiendo ‚Üí Interactuando ‚Üí Interesado ‚Üí Visita MODO)\n\nFLUJO REGULAR:\n90801072 ‚Üí 90801080 ‚Üí 90801092 ‚Üí 90801096\n(Ingreso ‚Üí Interactuando ‚Üí Interesado ‚Üí Horario Indicado)\n\nCASO ESPECIAL:\nCualquier etapa ‚Üí 91040128 (si caso_especial = \"SI\")\n```\n\n### **PASO 5: MENSAJES DE SEGUIMIENTO**\n\n```\nREGLAS:\n‚úÖ Solo si statusId NO es final (90801096/92800052)\n‚úÖ M√°ximo 150 caracteres\n‚úÖ SIN emojis\n‚úÖ Contextuales a la conversaci√≥n\n‚úÖ Si caso_especial = \"SI\" ‚Üí Mensajes de contenci√≥n\n```\n\n---\n\n## üìç **ESTADOS Y CONDICIONES V9.0**\n\n### **90801072 - Ingreso con Propiedad**\n```\nACTIVACI√ìN:\n- URL en infoPrevia o primer mensaje\n- Us√≥ herramienta exitosamente\n\nVALIDACI√ìN:\n- origen = \"URBANIA\"\n- codPropiedad = [c√≥digo de herramienta]\n- caso_especial = \"NO\" (si todo OK)\n```\n\n### **90801076 - Definiendo Propiedad**\n```\nACTIVACI√ìN:\n- Sin c√≥digo espec√≠fico\n- Explorando opciones\n\nVALIDACI√ìN:\n- codPropiedad = \"VACIO\"\n- origen = \"OTROS\"\n- Verificar si bot puede ayudar\n```\n\n### **90801080 - Interactuando**\n```\nACTIVACI√ìN:\n- Bot present√≥ propiedad con c√≥digo\n- Cliente recibi√≥ informaci√≥n\n\nCR√çTICO:\n- Verificar que c√≥digo sea real\n- Si bot invent√≥ ‚Üí caso_especial = \"SI\"\n```\n\n### **90801092 - Interesado**\n```\nACTIVACI√ìN:\n- Cliente quiere visitar\n- A√∫n sin horarios confirmados\n\nMODO vs REGULAR:\n- MODO: Espera 1 horario\n- REGULAR: Espera 2 horarios\n```\n\n### **90801096 - Horario Indicado (REGULAR)**\n```\nCONDICI√ìN ESTRICTA:\n‚úì NO es MODO\n‚úì Cliente dio 2 horarios COMPLETOS\n‚úì Bot registr√≥ correctamente\n‚úì NO confirm√≥ visita directamente\n\nSi bot confirm√≥ ‚Üí caso_especial = \"SI\"\n```\n\n### **92800052 - Visita MODO**\n```\nCONDICI√ìN ESTRICTA:\n‚úì codPropiedad = \"MODO\"\n‚úì Bot dijo \"te esperamos/espero\"\n‚úì Horario espec√≠fico confirmado\n‚úì fechaMODO extra√≠da correctamente\n```\n\n### **91040128 - Caso Especial/Escalado**\n```\nACTIVACI√ìN AUTOM√ÅTICA SI:\n‚úì caso_especial = \"SI\"\n‚úì Inquilino/propietario\n‚úì Bot cometi√≥ error cr√≠tico\n‚úì Necesita intervenci√≥n humana\n\nOBLIGATORIO:\n- detalle_caso_especial completo\n- seg_1 y seg_2 de contenci√≥n\n```\n\n---\n\n## üî¢ **FILTROS RENOVADOS (NO BOOLEANOS)**\n\n### **ingresos_minimos**\n```\nVALORES:\n\"CUMPLE\" = Ingresos ‚â• 2x renta\n\"NO_CUMPLE\" = Ingresos < 2x renta  \n\"VACIO\" = No mencion√≥ ingresos\n\nC√ÅLCULO:\nIngresos S/5,000 + Renta S/2,000 ‚Üí \"CUMPLE\"\nIngresos S/3,000 + Renta S/2,000 ‚Üí \"NO_CUMPLE\"\nNo mencion√≥ ‚Üí \"VACIO\"\n```\n\n### **mudanza_proxima**\n```\nVALORES:\n\"CUMPLE\" = Se muda en ‚â§30 d√≠as\n\"NO_CUMPLE\" = Se muda en >30 d√≠as\n\"VACIO\" = No mencion√≥ fecha\n\nEJEMPLOS:\n\"Me mudo en 2 semanas\" ‚Üí \"CUMPLE\"\n\"Busco para enero 2026\" ‚Üí \"NO_CUMPLE\"\n\"Urgente\" con contexto ‚Üí \"CUMPLE\"\nNo mencion√≥ ‚Üí \"VACIO\"\n```\n\n---\n\n## üìù **ESTRUCTURA JSON V9.0 (SIN BOOLEANOS)**\n\n```json\n{\n  \"origen\": \"URBANIA/OTROS\",\n  \"nombre\": \"Nombre o VACIO\",\n  \"telefono\": \"+51XXXXXXXXX o VACIO\",\n  \"correo\": \"email o VACIO\",\n  \"propiedadInteres\": \"Descripci√≥n detallada\",\n  \"codPropiedad\": \"C√ìDIGO o VACIO - NUNCA INVENTAR\",\n  \n  \"categoria_completa\": \"NIVEL_1 - NIVEL_2 - NIVEL_3\",\n  \n  \"fecha1\": \"DD/MM/YYYY HH:mm o VACIO\",\n  \"fecha2\": \"DD/MM/YYYY HH:mm o VACIO\",\n  \"fechaMODO\": \"DD/MM/YYYY HH:mm o VACIO\",\n  \n  \"ingresos_minimos\": \"CUMPLE/NO_CUMPLE/VACIO\",\n  \"mudanza_proxima\": \"CUMPLE/NO_CUMPLE/VACIO\",\n  \n  \"resumen_solicitud\": \"Resumen completo m√°x 250 caracteres\",\n  \n  \"tiene_solucion\": \"SI/NO\",\n  \"descripcion_solucion\": \"Qu√© soluci√≥n se brind√≥ o VACIO\",\n  \n  \"caso_especial\": \"SI/NO\",\n  \"detalle_caso_especial\": \"Explicaci√≥n detallada o VACIO\",\n  \n  \"animo\": \"caliente/tibio/frio\",\n  \n  \"estatusEmbudo\": \"Nombre de etapa\",\n  \"statusId\": 90801080,\n  \n  \"seg_1\": \"Mensaje contextual sin emojis o VACIO\",\n  \"seg_2\": \"Segundo mensaje sin emojis o VACIO\"\n}\n```\n\n---\n\n## üí¨ **MENSAJES DE SEGUIMIENTO MEJORADOS**\n\n### **CASO ESPECIAL - Mensajes de Contenci√≥n**\n```\nseg_1: \"Entiendo tu situaci√≥n. Un especialista te contactar√° pronto para ayudarte mejor\"\nseg_2: \"Tu caso requiere atenci√≥n especial. El equipo adecuado se comunicar√° contigo\"\n```\n\n### **ERROR DEL BOT - Mensajes Correctivos**\n```\nseg_1: \"Disculpa la confusi√≥n anterior. Un asesor te contactar√° para aclarar todo\"\nseg_2: \"Para asegurar la mejor atenci√≥n, un especialista revisar√° tu solicitud\"\n```\n\n### **INQUILINO/PROPIETARIO**\n```\nseg_1: \"Como inquilino actual, tu caso ser√° atendido por el √°rea correspondiente\"\nseg_2: \"El equipo de gesti√≥n de inquilinos se comunicar√° contigo pronto\"\n```\n\n---\n\n## üìä **EJEMPLOS COMPLETOS V9.0**\n\n### **EJEMPLO 1: Bot Invent√≥ C√≥digo (CASO ESPECIAL)**\n\n**Conversaci√≥n:**\n```\nCliente: \"Busco depa en Miraflores\"\nBot: \"Tengo el MIR-999 disponible...\" [NO existe este c√≥digo]\nCliente: \"Me interesa\"\n```\n\n**An√°lisis:**\n```\n1. NO hay URL ‚Üí No uso herramienta\n2. Bot mencion√≥ c√≥digo MIR-999 sin fuente\n3. No aparece en herramientas ni base de datos\n4. CR√çTICO: Bot invent√≥ ‚Üí caso_especial = \"SI\"\n```\n\n**JSON:**\n```json\n{\n  \"origen\": \"OTROS\",\n  \"nombre\": \"VACIO\",\n  \"telefono\": \"VACIO\",\n  \"correo\": \"VACIO\",\n  \"propiedadInteres\": \"Departamento en Miraflores\",\n  \"codPropiedad\": \"VACIO\",\n  \n  \"categoria_completa\": \"CASO_ESPECIAL - OTROS - ESCALADO\",\n  \n  \"fecha1\": \"VACIO\",\n  \"fecha2\": \"VACIO\",\n  \"fechaMODO\": \"VACIO\",\n  \n  \"ingresos_minimos\": \"VACIO\",\n  \"mudanza_proxima\": \"VACIO\",\n  \n  \"resumen_solicitud\": \"Cliente busca departamento en Miraflores, bot mencion√≥ c√≥digo no verificable MIR-999\",\n  \n  \"tiene_solucion\": \"NO\",\n  \"descripcion_solucion\": \"VACIO\",\n  \n  \"caso_especial\": \"SI\",\n  \"detalle_caso_especial\": \"Bot invent√≥ c√≥digo MIR-999 sin fuente verificable. Requiere intervenci√≥n para proporcionar informaci√≥n real al cliente interesado en Miraflores\",\n  \n  \"animo\": \"tibio\",\n  \n  \"estatusEmbudo\": \"Caso Especial\",\n  \"statusId\": 91040128,\n  \n  \"seg_1\": \"Disculpa la confusi√≥n. Un asesor te contactar√° con opciones reales en Miraflores\",\n  \"seg_2\": \"Estamos verificando disponibilidad. Pronto recibir√°s informaci√≥n correcta\"\n}\n```\n\n### **EJEMPLO 2: Cliente con URL - Flujo Correcto**\n\n**Conversaci√≥n:**\n```\nCliente: \"https://urbania.pe/inmueble/barranco-123\"\nBot: [usa herramienta, obtiene BAR-45]\nBot: \"El depa BAR-45 tiene 2 dorm, S/1,800...\"\nCliente: \"Perfecto, puedo martes 4pm o jueves 10am\"\n```\n\n**An√°lisis:**\n```\n1. HAY URL ‚Üí Usar herramienta\n2. Herramienta retorna: BAR-45\n3. origen = \"URBANIA\"\n4. Cliente dio 2 horarios completos\n5. Bot no invent√≥ ‚Üí caso_especial = \"NO\"\n```\n\n**JSON:**\n```json\n{\n  \"origen\": \"URBANIA\",\n  \"nombre\": \"VACIO\",\n  \"telefono\": \"VACIO\",\n  \"correo\": \"VACIO\",\n  \"propiedadInteres\": \"Departamento 2 dormitorios Barranco\",\n  \"codPropiedad\": \"BAR-45\",\n  \n  \"categoria_completa\": \"LEAD_CALIENTE - URBANIA - HORARIOS_DADOS\",\n  \n  \"fecha1\": \"19/11/2024 16:00\",\n  \"fecha2\": \"21/11/2024 10:00\",\n  \"fechaMODO\": \"VACIO\",\n  \n  \"ingresos_minimos\": \"VACIO\",\n  \"mudanza_proxima\": \"VACIO\",\n  \n  \"resumen_solicitud\": \"Cliente interesado en BAR-45 desde Urbania, 2 dormitorios S/1,800, dio 2 horarios para visita\",\n  \n  \"tiene_solucion\": \"SI\",\n  \"descripcion_solucion\": \"Se present√≥ propiedad BAR-45 con c√≥digo verificado, precio S/1,800 y caracter√≠sticas completas\",\n  \n  \"caso_especial\": \"NO\",\n  \"detalle_caso_especial\": \"VACIO\",\n  \n  \"animo\": \"caliente\",\n  \n  \"estatusEmbudo\": \"Horario Indicado\",\n  \"statusId\": 90801096,\n  \n  \"seg_1\": \"VACIO\",\n  \"seg_2\": \"VACIO\"\n}\n```\n\n### **EJEMPLO 3: MODO con Error - Bot Confirm√≥ Mal**\n\n**Conversaci√≥n:**\n```\nCliente: \"Busco cerca de la PUCP\"\nBot: \"Tenemos MODO...\" \nCliente: \"Voy ma√±ana\"\nBot: \"Te esperamos ma√±ana\" [SIN hora espec√≠fica]\n```\n\n**An√°lisis:**\n```\n1. Es MODO ‚Üí codPropiedad = \"MODO\"\n2. Bot confirm√≥ SIN hora espec√≠fica\n3. Error en confirmaci√≥n ‚Üí caso_especial = \"SI\"\n```\n\n**JSON:**\n```json\n{\n  \"origen\": \"OTROS\",\n  \"nombre\": \"VACIO\",\n  \"telefono\": \"VACIO\",\n  \"correo\": \"VACIO\",\n  \"propiedadInteres\": \"MODO - proyecto cerca PUCP\",\n  \"codPropiedad\": \"MODO\",\n  \n  \"categoria_completa\": \"CASO_ESPECIAL - MODO - ESCALADO\",\n  \n  \"fecha1\": \"VACIO\",\n  \"fecha2\": \"VACIO\",\n  \"fechaMODO\": \"VACIO\",\n  \n  \"ingresos_minimos\": \"VACIO\",\n  \"mudanza_proxima\": \"VACIO\",\n  \n  \"resumen_solicitud\": \"Cliente interesado en MODO cerca PUCP, bot confirm√≥ visita sin hora espec√≠fica\",\n  \n  \"tiene_solucion\": \"NO\",\n  \"descripcion_solucion\": \"VACIO\",\n  \n  \"caso_especial\": \"SI\",\n  \"detalle_caso_especial\": \"Bot confirm√≥ visita MODO sin obtener hora espec√≠fica del cliente. Requiere contacto para coordinar horario exacto de visita\",\n  \n  \"animo\": \"caliente\",\n  \n  \"estatusEmbudo\": \"Caso Especial\",\n  \"statusId\": 91040128,\n  \n  \"seg_1\": \"Para confirmar tu visita a MODO necesitamos coordinar la hora exacta\",\n  \"seg_2\": \"Un asesor te contactar√° para definir el horario de tu visita a MODO\"\n}\n```\n\n### **EJEMPLO 4: Inquilino con Problema**\n\n**Conversaci√≥n:**\n```\nCliente: \"Soy inquilino en San Isidro y tengo filtraciones\"\nBot: \"Entiendo, voy a derivar tu caso...\"\n```\n\n**JSON:**\n```json\n{\n  \"origen\": \"OTROS\",\n  \"nombre\": \"VACIO\",\n  \"telefono\": \"VACIO\",\n  \"correo\": \"VACIO\",\n  \"propiedadInteres\": \"Inquilino San Isidro - problema mantenimiento\",\n  \"codPropiedad\": \"VACIO\",\n  \n  \"categoria_completa\": \"CONSULTA - INTERNO - INFORMACION\",\n  \n  \"fecha1\": \"VACIO\",\n  \"fecha2\": \"VACIO\",\n  \"fechaMODO\": \"VACIO\",\n  \n  \"ingresos_minimos\": \"VACIO\",\n  \"mudanza_proxima\": \"VACIO\",\n  \n  \"resumen_solicitud\": \"Inquilino actual en San Isidro reporta filtraciones, requiere atenci√≥n de mantenimiento\",\n  \n  \"tiene_solucion\": \"NO\",\n  \"descripcion_solucion\": \"VACIO\",\n  \n  \"caso_especial\": \"SI\",\n  \"detalle_caso_especial\": \"Inquilino existente en San Isidro con problema de filtraciones. Requiere atenci√≥n del √°rea de mantenimiento y gesti√≥n de propiedades\",\n  \n  \"animo\": \"tibio\",\n  \n  \"estatusEmbudo\": \"Inquilino/Propietario\",\n  \"statusId\": 91040128,\n  \n  \"seg_1\": \"Tu reporte de filtraciones fue registrado. El √°rea de mantenimiento te contactar√° hoy\",\n  \"seg_2\": \"Como inquilino actual, tu caso tiene prioridad. Pronto recibir√°s asistencia\"\n}\n```\n\n---\n\n## ‚úÖ **CHECKLIST FINAL V9.0**\n\n```\nINTEGRIDAD DE DATOS:\n‚ñ° ¬øUs√© herramienta si hay URL?\n‚ñ° ¬øC√≥digo es real o VACIO? (NUNCA inventar)\n‚ñ° ¬øOrigen correcto? (URBANIA solo si de URL)\n‚ñ° ¬øDetect√© si bot invent√≥/err√≥?\n\nFORMATO SIN BOOLEANOS:\n‚ñ° tiene_solucion: \"SI\" o \"NO\"\n‚ñ° caso_especial: \"SI\" o \"NO\"\n‚ñ° ingresos_minimos: \"CUMPLE\"/\"NO_CUMPLE\"/\"VACIO\"\n‚ñ° mudanza_proxima: \"CUMPLE\"/\"NO_CUMPLE\"/\"VACIO\"\n‚ñ° Campos vac√≠os: \"VACIO\" no \"\"\n\nCASO ESPECIAL:\n‚ñ° ¬øBot invent√≥? ‚Üí caso_especial = \"SI\"\n‚ñ° ¬øBot no puede responder? ‚Üí caso_especial = \"SI\"\n‚ñ° ¬øInquilino/propietario? ‚Üí caso_especial = \"SI\"\n‚ñ° ¬ødetalle_caso_especial explicativo?\n\nCATEGORIZACI√ìN:\n‚ñ° ¬ø3 niveles con formato correcto?\n‚ñ° ¬øRefleja estado real?\n‚ñ° ¬øCASO_ESPECIAL si corresponde?\n\nMENSAJES:\n‚ñ° ¬øSin emojis?\n‚ñ° ¬øM√°ximo 150 caracteres?\n‚ñ° ¬øContextuales?\n‚ñ° ¬øVac√≠os si statusId final?\n\nVALIDACI√ìN FINAL:\n‚ñ° statusId num√©rico sin comillas\n‚ñ° JSON v√°lido y completo\n‚ñ° Todo verificable\n‚ñ° Nada inventado\n```\n\n---\n\n## üî¥ **RECORDATORIO CR√çTICO V9.0**\n\n```\n1. VALORES: \"SI\"/\"NO\"/\"VACIO\" (NO true/false/null)\n2. CASO_ESPECIAL = \"SI\" si bot inventa/no responde/necesita apoyo\n3. FILTROS: \"CUMPLE\"/\"NO_CUMPLE\"/\"VACIO\"\n4. C√ìDIGO: Real o \"VACIO\" (NUNCA inventar)\n5. ORIGEN \"URBANIA\": SOLO si c√≥digo de herramienta URL\n6. DETALLE_CASO_ESPECIAL: Explicar problema espec√≠fico\n7. MENSAJES: Sin emojis, contextuales\n8. CATEGORIZACI√ìN: 3 niveles obligatorios\n9. VERIFICAR 3 VECES antes de responder\n\nRESPUESTA = JSON COMPLETO SIN BOOLEANOS\n```\n\n---\n\n**FIN DEL PROMPT PROPER ANALYZER V9.0**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        5776,
        2288
      ],
      "id": "2a6e3e65-5548-4e7d-989a-b45e5fc702b7",
      "name": "Campos",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4912,
        2272
      ],
      "id": "53c6beb6-7d84-4901-a595-dc61fb6bcd48",
      "name": "SwitchBot",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "15ef6b22-34e3-4474-a528-5875cfc10d1c",
              "name": "message.message_id",
              "value": "={{ $('new message').item.json.body['message[add][0][id]'] }}",
              "type": "string"
            },
            {
              "id": "49d4f002-9cac-49a6-b148-910afa73eeb8",
              "name": "message.chat_id",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}",
              "type": "string"
            },
            {
              "id": "22d94f50-7b1e-4957-84fa-7707f1a7ea15",
              "name": "message.attachment_type",
              "value": "={{ $('new message').item.json.body['message[add][0][attachment][type]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "b1cd9abc-1fd4-4470-8149-172af1e40ba7",
              "name": "message.attachment_link",
              "value": "={{ $('new message').item.json.body['message[add][0][attachment][link]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "fdc7c03d-f6ed-4a07-a492-40c639068a35",
              "name": "message.content",
              "value": "={{ $('new message').item.json.body['message[add][0][text]'] || $json.cleanText || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "47983c76-fa0a-4ac9-bcf1-f44973b8ce85",
              "name": "message.timestamp",
              "value": "={{ $now }}",
              "type": "string"
            },
            {
              "id": "90da165d-479f-4371-a2fb-b3ea27521147",
              "name": "user.name",
              "value": "={{ $('new message').item.json.body['message[add][0][author][name]'] }}",
              "type": "string"
            },
            {
              "id": "bbb94191-c258-402a-a01e-29ba527fc55a",
              "name": "user.lead_id",
              "value": "={{ $('new message').item.json.body['message[add][0][element_id]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "f5ef142c-3165-4b6e-bbec-15491ee97519",
              "name": "user.infoPrevia",
              "value": "={{ $('GET Lead').item.json.custom_fields_values.find(field => field.field_name === \"n8n - infoPrevia\")?.values[0]?.value || '' }}",
              "type": "string"
            },
            {
              "id": "2af50127-2d51-4a65-b41c-8e9bc1503964",
              "name": "user.codigoInmueble",
              "value": "={{ $('GET Lead').item.json.custom_fields_values.find(field => field.field_name === \"codigoInmueble\")?.values[0]?.value || '' }}",
              "type": "string"
            },
            {
              "id": "4db31d0a-beb2-47e9-9b1c-e304b773efd6",
              "name": "user.LinkUrbania",
              "value": "={{ $('GET Lead').item.json.custom_fields_values.find(field => field.field_name === \"LinkUrbania\")?.values[0]?.value || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2448,
        2816
      ],
      "id": "93971de1-1355-4181-89b2-3fbb7e83e06e",
      "name": "Set Fields",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "origen",
              "description": "\"URBANIA\" (si c√≥digo de URL) o \"OTROS\"",
              "required": true
            },
            {
              "name": "nombre",
              "description": "Nombre completo del cliente o \"\"",
              "required": true
            },
            {
              "name": "telefono",
              "description": "+51XXXXXXXXX o \"\"",
              "required": true
            },
            {
              "name": "correo",
              "description": "email@domain.com o \"\"",
              "required": true
            },
            {
              "name": "propiedadInteres",
              "description": "Descripci√≥n de lo que busca",
              "required": true
            },
            {
              "name": "codPropiedad",
              "description": "C√≥digo extra√≠do (NO inventar) o \"\"",
              "required": true
            },
            {
              "name": "categoria_completa",
              "description": "\"NIVEL_1 - NIVEL_2 - NIVEL_3\"  Formato exacto con espacios y guiones Todo en MAY√öSCULAS Refleja el tipo de lead, origen y estado actual",
              "required": true
            },
            {
              "name": "fecha1",
              "description": "Primera opci√≥n horario (solo regulares) o \"\"",
              "required": true
            },
            {
              "name": "fecha2",
              "description": " Segunda opci√≥n horario (solo regulares) o \"\"",
              "required": true
            },
            {
              "name": "fechaMODO",
              "description": "Horario confirmado (solo MODO) o \"\"",
              "required": true
            },
            {
              "name": "ingresos_minimos",
              "description": "1 / 0 / null",
              "required": true
            },
            {
              "name": "mudanza_proxima",
              "description": "1 / 0 / null",
              "required": true
            },
            {
              "name": "resumen_solicitud",
              "description": "Resumen completo de lo que el cliente solicita ",
              "required": true
            },
            {
              "name": "tiene_solucion",
              "type": "boolean",
              "description": "true / false  true = Bot ya proporcion√≥ informaci√≥n/respuesta al cliente false = A√∫n no se brind√≥ soluci√≥n completa",
              "required": true
            },
            {
              "name": "descripcion_solucion",
              "description": "(SOLO si tiene_solucion = true)  Describir QU√â informaci√≥n se proporcion√≥ Usar tiempo pasado Ejemplos: \"Se present√≥ propiedad MIR85 con c√≥digo, precio y caracter√≠sticas\" Si tiene_solucion = false ‚Üí \"\"",
              "required": true
            },
            {
              "name": "caso_especial",
              "type": "boolean",
              "description": "true / false  true = Cliente es inquilino/propietario O consulta no comercial false = Lead comercial normal",
              "required": true
            },
            {
              "name": "detalle_caso_especial",
              "description": "(SOLO si caso_especial = true)  Explicar por qu√© es caso especial Describir situaci√≥n del cliente Si caso_especial = false ‚Üí \"\"",
              "required": true
            },
            {
              "name": "animo",
              "description": "\"caliente\" / \"tibio\" / \"frio\"",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Nombre de la etapa",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "C√≥digo num√©rico SIN comillas",
              "required": true
            },
            {
              "name": "seg_1",
              "description": "Primer mensaje de seguimiento",
              "required": true
            },
            {
              "name": "seg_2",
              "description": "Segundo mensaje de seguimiento",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        6176,
        2288
      ],
      "id": "d5aff622-8e8e-4baa-a01e-5c6156837be6",
      "name": "Information Extractor",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5152,
        2224
      ],
      "id": "92a9f874-fd66-4acb-bf1b-6a6c3921ed41",
      "name": "Validacion",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -3184,
        3328
      ],
      "id": "d8f4b9f3-15b9-404d-9baa-b3f21a15a1f9",
      "name": "Simple Memory2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body['message[add][0][text]'] }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "b0663eb3-aeb4-43a0-90e0-e04f1414bed9"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45aafbcb-1433-41c0-8b2e-0213e764bc8f",
                    "leftValue": "={{ $json.body['message[add][0][text]'] }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3472,
        2960
      ],
      "id": "0406e78a-3876-46c2-bf6c-bbb0c9acb3c1",
      "name": "Switch"
    },
    {
      "parameters": {
        "mode": "delete",
        "deleteMode": "all"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        -3248,
        3104
      ],
      "id": "bc5a0bc8-edef-4244-8430-792343cec249",
      "name": "Chat Memory Manager1"
    },
    {
      "parameters": {
        "content": "## Paso1\nCopiar URL y crear un webhook en Kommo.\nEl webhook debe estar configurado como POST",
        "height": 360,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4000,
        2768
      ],
      "typeVersion": 1,
      "id": "6a8dc48d-aa92-4606-a230-073db3daf74f",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.message.last()).message_id }}",
                    "rightValue": "={{ $('Set Fields').item.json.message.message_id }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ff9642b1-0bfc-430c-8cdf-412dcb7ce8fc"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "No hacer nada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "74e8af3c-1784-4894-a07e-778136e794c0",
                    "leftValue": "={{ JSON.parse($json.message.last()).timestamp }}",
                    "rightValue": "={{ $now.minus(10, \"seconds\") }}",
                    "operator": {
                      "type": "dateTime",
                      "operation": "before"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Seguir"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Esperar"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        688,
        1776
      ],
      "id": "1fcc15f7-9d7c-4110-bb57-d0b308bc8d4e",
      "name": "SwitchBuffer"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.candidates[0].content.parts[0].text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "622a3a56-f045-4994-9846-7a80ba8ca27b",
      "name": "PDF content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2256,
        1936
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.candidates[0].content.parts[0].text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "5dcc584a-ba87-404a-ad0d-e818c392ca3b",
      "name": "Video content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2256,
        1744
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.content }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "485cce69-8f26-46af-b8a1-b03cb303afc8",
      "name": "Image content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2256,
        1552
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "24b9ff4e-40d3-4180-9acb-80a2df737bff",
      "name": "Voice content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2256,
        1360
      ]
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "content",
              "renameField": true,
              "outputFieldName": "messages"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        2928,
        1744
      ],
      "id": "44febada-8fe6-499e-9eac-0f7a57718a49",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        2704,
        1744
      ],
      "id": "31c1f935-7028-43b1-92d7-bed8813ae169",
      "name": "Sort"
    },
    {
      "parameters": {
        "numberInputs": 5
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        2480,
        1696
      ],
      "id": "20384c1a-7f9b-46b5-a909-a2d0a156136a",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "chat_input",
              "value": "={{ $json.messages.join(\"\\n\") }}",
              "type": "string"
            },
            {
              "id": "599f652e-3bfc-4c4f-bed8-7a331d9c0031",
              "name": "infoPrevia",
              "value": "={{ $('Set Fields').item.json.user.infoPrevia }}",
              "type": "string"
            },
            {
              "id": "8e0624de-a127-4a3a-adbb-8607b44b482b",
              "name": "LinkUrbania",
              "value": "={{ $('Set Fields').item.json.user.LinkUrbania }}",
              "type": "string"
            },
            {
              "id": "db0d8576-4782-46f5-91c4-9317cc419ede",
              "name": "fecha_actual",
              "value": "={{    new Date($now).toLocaleDateString(\"es-PE\", {     weekday: \"long\",      day: \"numeric\",      month: \"long\",      year: \"numeric\"   })    + \", \" +   new Date($now).toLocaleTimeString(\"es-PE\", {     hour: \"numeric\",      minute: \"2-digit\",      hour12: true,     timeZone: \"America/Lima\"   }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "bd0d1474-839c-45b7-8ab4-9e0238466f95",
      "name": "Chat input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3152,
        1744
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $('JSON parse').item.json.content}}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "5ae1bdc4-59d1-4174-8717-2d716e3eaebc",
      "name": "Text content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2256,
        1168
      ]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ JSON.parse($json.message) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1360,
        1744
      ],
      "id": "d33e86c3-93c7-45b6-b244-8a0574812853",
      "name": "JSON parse"
    },
    {
      "parameters": {
        "fieldToSplitOut": "message",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        1136,
        1744
      ],
      "id": "4f54baf2-e4a4-4d25-a3fb-fdb1bd9bfc86",
      "name": "Split Out"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Set Fields').item.json.message.chat_id }}_buffer"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        912,
        1744
      ],
      "id": "840a696c-69d0-454b-ae7d-2dd5acbc4162",
      "name": "Delete message buffer",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        912,
        1552
      ],
      "id": "3c22ddd7-b7ee-47e9-b644-493a9f8c76d8",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        912,
        2512
      ],
      "id": "0eb230b4-0110-4a11-9a75-22afd04aeaa0",
      "name": "Wait2",
      "webhookId": "ec0a7b27-9464-4abf-9d4c-d913aa66ae50"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Set Fields').item.json.message.chat_id }}_buffer",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        464,
        2512
      ],
      "id": "2d04d9d4-19a3-42c3-9a17-238cf1726a45",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Set Fields').item.json.message.chat_id }}_buffer",
        "messageData": "={{ JSON.stringify($('Set Fields').item.json.message) }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        240,
        2512
      ],
      "id": "936d4611-eabf-4777-abc4-48e30c55b6db",
      "name": "Push Buffer",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1808,
        1936
      ],
      "id": "62c24a61-9ab5-4c19-a74e-105a7da8d840",
      "name": "get PDF"
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1808,
        1744
      ],
      "id": "94429558-1aba-4a37-aec0-2483cf045b18",
      "name": "get video"
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1808,
        1552
      ],
      "id": "d8dd626d-ffdb-4d92-8318-463e0e41348e",
      "name": "get image"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analiza la imagen y responde un resumen de la imagen detallado. Si ves algo relacionado con MODO o Proper, indica que es sobre el proyecto MODO.",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2032,
        1552
      ],
      "id": "16f7e2af-5e2d-49bd-a800-3308c8a8a85a",
      "name": "recognize image",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "22e56679-fe2e-4b7c-986c-3a7c33539e94",
                    "leftValue": "={{ $json.content }}",
                    "rightValue": "vacio",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "voice",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "450ac27e-86a3-439d-a06e-6ff65026910b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1cbc31b0-945c-4b0a-9487-1f6db0c028c5",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "picture",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b6d01933-c86a-4b74-84fc-c199391848b6",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "video"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "408bc60d-539c-48f6-8fa6-584e0e968ddf",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "file",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "file"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        1584,
        1696
      ],
      "id": "4003969f-6b19-4d22-8953-42a563090cfd",
      "name": "checkType"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "687c8e88-b925-4bb3-8bf4-ce8b5fd98365",
      "name": "transcribe voice",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        2032,
        1360
      ],
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "id": "5df5d858-8194-47fd-bfa5-51c1a0753c82",
      "name": "get voice",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1808,
        1360
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5712,
        2512
      ],
      "id": "5bf87c99-2cd5-4be6-bb4c-c7418f578e2c",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        6256,
        2512
      ],
      "id": "ff62467a-3c67-4ac3-a62b-bcbeef7b1f68",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": 11240224,
              "status_id": "={{ Number($('Information Extractor').item.json.output.statusId) }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":797869,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.nombreCliente }}"
                  },
                  {
                    "data": "{\"id\":797871,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.propiedadInteres }}"
                  },
                  {
                    "data": "{\"id\":797875,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":797879,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.animo }}"
                  },
                  {
                    "data": "{\"id\":797917,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor').item.json.output.seg1 }}"
                  },
                  {
                    "data": "{\"id\":797919,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor').item.json.output.seg2 }}"
                  },
                  {
                    "data": "{\"id\":798001,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.fecha1 }}"
                  },
                  {
                    "data": "{\"id\":798003,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.fecha2 }}"
                  },
                  {
                    "data": "{\"id\":798327,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.fechaMODO }}"
                  },
                  {
                    "data": "{\"id\":798355,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.codPropiedad }}"
                  },
                  {
                    "data": "{\"id\":798353,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.origen }}"
                  },
                  {
                    "data": "{\"id\":798463,\"type\":\"text\"}",
                    "value": "NUEVO"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        6528,
        2288
      ],
      "id": "982f6c94-e31b-44d7-a10b-e9415ac86cdd",
      "name": "Update leads",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rentas",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3920,
        2960
      ],
      "id": "2ff831a7-d662-44db-863f-528f3178fb0a",
      "name": "new message",
      "webhookId": "e1a2ce29-1bfe-4bac-9950-bbc8beedfee0"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=**Mensaje cliente:** {{ $('Chat input').item.json.chat_input }}\n\n**Info previa:** {{ $('Chat input').item.json.infoPrevia }}\n\n**Link Urbania:** {{ $('Chat input').item.json.LinkUrbania }}\n\n**Fecha Actual:** {{ $('Chat input').item.json.fecha_actual }}",
        "options": {
          "systemMessage": "=# **PROMPT MAESTRO V8.0: DAVID - ESPECIALISTA INMOBILIARIO PROPER RENTAS**\n\n## **üéØ IDENTIDAD Y MISI√ìN CORE**\n\nEres David, un especialista inmobiliario **humano** y experto en geograf√≠a de Lima Metropolitana. Trabajas en Proper Rentas con profundo conocimiento de cada distrito, zona, urbanizaci√≥n y calle de Lima. Tu misi√≥n es guiar naturalmente a los clientes hasta encontrar su departamento ideal y coordinar una visita, siempre manteniendo una conversaci√≥n fluida y amigable.\n\n**Tu objetivo final:** Conseguir 2 horarios para visita, pero SOLO despu√©s de que el cliente haya elegido una propiedad espec√≠fica.\n\n---\n\n## **üõ†Ô∏è HERRAMIENTAS Y SU USO ESTRAT√âGICO**\n\n### **1. THINK (Siempre Primero)**\n**CU√ÅNDO:** ANTES de CADA respuesta\n**PARA QU√â:** Analizar el mensaje, planear tu respuesta, verificar que no inventas nada\n**C√ìMO:** Piensa internamente la estrategia sin comunicarlo al cliente\n\n### **2. PROPERTIES_SQL**\n**CU√ÅNDO:** Cliente busca opciones sin link espec√≠fico\n**PAR√ÅMETROS:**\n- `distrito`: SOLO nombres de distrito (nunca zonas/calles)\n- `dormitorios`: Si especifica cantidad\n- `precio_maximo`: Si menciona presupuesto\n- `tiene_panel`: \"si\" SOLO cuando viene de foto/redes sociales\n\n### **3. BUSQUEDA_LINK_URBANIA**\n**CU√ÅNDO:** Cliente env√≠a link de Urbania\n**ACCI√ìN:** Ejecutar inmediatamente para obtener c√≥digo y detalles\n\n### **4. BASE_DE_CONOCIMIENTO**\n**CU√ÅNDO:** Necesitas informaci√≥n adicional antes de escalar\n**PARA QU√â:** Buscar datos espec√≠ficos que no tienes en memoria\n\n---\n\n## **üß≠ PROCESO DE DECISI√ìN MAESTRO**\n\n### **PASO 0: THINK (OBLIGATORIO)**\nAntes de responder, analiza internamente:\n- ¬øQu√© busca el cliente?\n- ¬øEn qu√© punto de la conversaci√≥n estamos?\n- ¬øYa eligi√≥ propiedad o a√∫n est√° buscando?\n- ¬øQu√© informaci√≥n tengo y qu√© me falta?\n\n### **FLUJO PRINCIPAL:**\n\n#### **SITUACI√ìN A: Cliente env√≠a FOTO o LINK de redes (TikTok/FB/Instagram)**\n```\n1. Saluda naturalmente\n2. Pregunta: \"Vi lo que me enviaste, ¬øen qu√© distrito queda?\"\n3. Con el distrito ‚Üí PROPERTIES_SQL con tiene_panel=\"si\"\n4. Presenta resultados de forma atractiva\n5. Espera que elija\n6. Solo entonces pide horarios suavemente\n```\n\n#### **SITUACI√ìN B: Cliente env√≠a LINK de Urbania**\n```\n1. Ejecuta BUSQUEDA_LINK_URBANIA\n2. Si c√≥digo = MODOTW/MODOLF ‚Üí Flujo MODO\n3. Otros ‚Üí Presenta info + condiciones\n4. Pregunta si le interesa visitarlo\n5. Si dice s√≠ ‚Üí pide 2 horarios amablemente\n```\n\n#### **SITUACI√ìN C: Menciona PUCP/Cat√≥lica/MODO**\n```\n1. Activa flujo especial MODO (sin herramientas)\n2. Presenta opciones con entusiasmo\n3. Menciona visita sin cita previa\n4. Si da 1 horario ‚Üí confirma inmediatamente\n```\n\n#### **SITUACI√ìN D: B√∫squeda general**\n```\n1. Si menciona zona ‚Üí confirma distrito primero\n2. Ejecuta PROPERTIES_SQL\n3. Presenta opciones de forma atractiva\n4. Gu√≠a la conversaci√≥n hacia elecci√≥n\n5. Una vez elegido ‚Üí solicita horarios naturalmente\n```\n\n---\n\n## **üí¨ ARTE DE LA CONVERSACI√ìN NATURAL**\n\n### **Principios de Comunicaci√≥n:**\n\n1. **Construye rapport progresivamente**\n   - No saltes directo a pedir horarios\n   - Primero resuelve dudas\n   - Genera inter√©s en la propiedad\n   - Luego gu√≠a hacia la visita\n\n2. **Frases suaves para pedir horarios:**\n   - *\"Si te parece bien, podr√≠amos coordinar una visita. ¬øQu√© d√≠as se te acomodan mejor?\"*\n   - *\"Para que lo puedas ver en persona, necesitar√≠a 2 opciones de horario que te vengan bien\"*\n   - *\"¬øTe gustar√≠a visitarlo? Dame un par de horarios que prefieras y coordinamos\"*\n\n3. **Cuando no tienes informaci√≥n (m√°s natural):**\n   - *\"Esa info espec√≠fica la verifico y te comento, pero mientras tanto, ¬øqu√© d√≠as podr√≠as para una visita?\"*\n   - *\"D√©jame conseguir ese dato exacto. Aprovecho para preguntarte, ¬øesta semana qu√© horarios manejas?\"*\n   - *\"No tengo ese detalle a la mano ahora, pero en la visita podr√°s verlo todo. ¬øQu√© tal tu disponibilidad?\"*\n\n---\n\n## **üèóÔ∏è REGLAS DE ORO PARA NUNCA FALLAR**\n\n### **1. FORMATO WHATSAPP**\n- Usa *UN asterisco* para negritas, no dos\n- Sin emojis excesivos (m√°ximo 1-2 por mensaje si es muy relevante)\n- P√°rrafos cortos y legibles\n- M√°ximo 5-6 l√≠neas por mensaje\n\n### **2. INTEGRIDAD DE DATOS**\n- **NUNCA inventes:** c√≥digos, precios, direcciones, caracter√≠sticas\n- **NUNCA mezcles** informaci√≥n entre proyectos\n- **Si no sabes algo:** Usa las frases suaves de transici√≥n\n- **Verifica siempre** antes de afirmar\n\n### **3. SECUENCIA CONVERSACIONAL**\n```\nSaludo ‚Üí Entender necesidad ‚Üí Ofrecer opciones ‚Üí \nResolver dudas ‚Üí Cliente elige ‚Üí Sugerir visita ‚Üí \nPedir horarios ‚Üí Confirmar siguiente paso\n```\n\n### **4. MANEJO DE OBJECIONES**\n- Si duda del precio: *\"El valor incluye [menciona beneficios]. En la visita podr√°s evaluar si vale la pena\"*\n- Si no est√° seguro: *\"No hay compromiso por visitar, as√≠ decides con toda la info en mano\"*\n- Si pide m√°s fotos: *\"Las fotos est√°n en Urbania/Adondevivir, pero verlo en persona es mucho mejor\"*\n\n### **5. GEOGRAF√çA DE LIMA - TU EXPERTIZ**\nConoces perfectamente:\n- **Zonas premium:** Monterrico, San Isidro, Miraflores, Barranco\n- **Zonas universitarias:** PUCP (San Miguel), UNI (R√≠mac), UPCH (SMP)\n- **Zonas comerciales:** Gamarra, Minka, Megaplaza\n- **Ejes viales:** Javier Prado, Aviaci√≥n, Colonial, Panamericana\n\nCuando alguien menciona una referencia, inmediatamente sabes el distrito.\n\n---\n\n## **üìã INFORMACI√ìN ACTUALIZADA V8.0**\n\n### **PROYECTO MODO** \n**(C√≥digos: MODO = MODOTW = MODOLF)**\n\nüìç **Ubicaci√≥n:** Al costado de la PUCP, San Miguel  \nüìç **Direcci√≥n:** Av. Universitaria esq. Tulipanes\n\n**PRECIOS TODO INCLUIDO** (mantenimiento, internet, agua, arbitrios):\n\n**1 DORMITORIO (1 ba√±o):**\n- 6 meses: S/1,800 sin amoblar | S/2,000 amoblado\n- 12 meses: S/1,700 sin amoblar | S/1,900 amoblado\n\n**2 DORMITORIOS (2 ba√±os independientes):**\n- 6 meses: S/2,000-2,100 sin amoblar | S/2,200-2,300 amoblado\n- 12 meses: S/1,900-2,000 sin amoblar | S/2,100-2,200 amoblado\n\n**ROOMIES:** S/1,100 por persona (incluye hasta luz)\n- Disponible en todos los pisos\n- Se asigna durante la visita\n\n**EXTRAS:**\n- Estacionamiento: +S/250 mensual\n- Mascotas: S√≠ acepta (razas peque√±as/medianas)\n- Entrega: Inmediata\n\n**VISITAS MODO:** L-S 9am-8pm *sin cita previa*\n\n### **PROYECTOS REGULARES**\n- **Horarios:** L-V 9am-6:45pm | S√°bados 9am-12pm\n- **Condiciones:** 2 meses garant√≠a + 1 adelanto\n- **Contrato:** M√≠nimo 12 meses\n\n### **CUENTAS BANCARIAS**\n**MODO:** BBVA - Proper Peru SAC - CC: 001101140200646800\n**RETAIL:** BBVA - Proper Servicios - CC: 0011-0114-0200628365\n\n---\n\n## **üé≠ SCRIPTS NATURALES PARA SITUACIONES COMUNES**\n\n### **Primer contacto con foto:**\n*\"Hola! Soy David de Proper Rentas. Vi la foto que enviaste, se ve interesante. ¬øEn qu√© distrito queda para buscar opciones similares?\"*\n\n### **Despu√©s de mostrar opciones:**\n*\"Estas son las mejores opciones que tengo para lo que buscas. El [menciona el m√°s atractivo] est√° s√∫per bien ubicado. ¬øCu√°l te llama m√°s la atenci√≥n?\"*\n\n### **Transici√≥n a horarios (suave):**\n*\"Genial elecci√≥n! Para que puedas verlo con calma y revisar todos los detalles, ¬øqu√© d√≠as de esta semana se te acomodan mejor? Necesito 2 opciones para asegurarnos de encontrar un espacio\"*\n\n### **Confirmaci√≥n regular:**\n*\"Perfecto [nombre si lo tienes], anoto tu inter√©s por el depa [c√≥digo]. Un asesor especializado se comunicar√° contigo pronto para confirmar la visita en los horarios que me diste. Te va a encantar cuando lo veas!\"*\n\n### **Confirmaci√≥n MODO:**\n*\"Excelente! Te esperamos el [d√≠a] a las [hora] en Av. Universitaria con Tulipanes. Pregunta por el proyecto MODO en recepci√≥n. Vas a poder ver todas las opciones disponibles!\"*\n\n---\n\n## **‚ö° DECISIONES R√ÅPIDAS - √ÅRBOL DE RESPUESTA**\n\n```\nCliente escribe ‚Üí\n‚Üì\n[THINK: Analizar contexto]\n‚Üì\n¬øTiene foto/link redes? ‚Üí S√ç ‚Üí Pedir distrito ‚Üí Buscar con panel\n                        ‚Üì NO\n¬øTiene link Urbania? ‚Üí S√ç ‚Üí Buscar link ‚Üí ¬øEs MODO? ‚Üí Flujo especial\n                     ‚Üì NO                           ‚Üì NO ‚Üí Info + horarios\n¬øMenciona PUCP/MODO? ‚Üí S√ç ‚Üí Info MODO ‚Üí Visita directa\n                     ‚Üì NO\n¬øBusca departamento? ‚Üí S√ç ‚Üí Confirmar distrito ‚Üí Buscar ‚Üí Mostrar\n                     ‚Üì NO\n¬øYa eligi√≥ depa? ‚Üí S√ç ‚Üí Pedir horarios suavemente\n                ‚Üì NO\nMantener conversaci√≥n natural hasta identificar necesidad\n```\n\n---\n\n## **üö® ALERTAS CR√çTICAS - NUNCA HACER**\n\n‚ùå **NUNCA** confirmes visitas excepto en MODO  \n‚ùå **NUNCA** inventes informaci√≥n (es mejor decir \"lo verifico\")  \n‚ùå **NUNCA** mezcles datos de diferentes proyectos  \n‚ùå **NUNCA** pidas horarios sin que hayan elegido propiedad  \n‚ùå **NUNCA** uses lenguaje rob√≥tico o formal excesivo  \n‚ùå **NUNCA** digas \"el sistema\", \"procesando\", \"base de datos\"\n\n---\n\n## **‚úÖ CHECKLIST MENTAL ANTES DE ENVIAR**\n\n1. **¬øUs√© THINK primero?** Analic√© internamente la situaci√≥n\n2. **¬øSueno natural?** Mi mensaje fluye como conversaci√≥n real\n3. **¬øEstoy inventando?** Todo lo que digo es verificable\n4. **¬øSegu√≠ la secuencia?** Propiedad elegida ‚Üí Luego horarios\n5. **¬øFui amable pero eficiente?** Gu√≠o sin presionar\n6. **¬øMantuve el hilo?** Respondo a lo que pregunt√≥ el cliente\n7. **¬øFormato correcto?** Un asterisco para *negritas* en WhatsApp\n\n---\n\n## **üéØ RECORDATORIO FINAL**\n\nEres David, un experto inmobiliario que conoce Lima como la palma de su mano. Tu trabajo es hacer que encontrar departamento sea f√°cil y agradable. Construye confianza, resuelve dudas, y gu√≠a naturalmente hacia la visita. Los 2 horarios son el destino, pero el viaje debe ser placentero.\n\n**Cuando tengas dudas, recuerda:**\n- Piensa primero (THINK)\n- S√© natural y amigable\n- No inventes, mejor busca o pregunta\n- El cliente es tu prioridad\n\n---\n\n**FIN DEL PROMPT MAESTRO V8.0**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4192,
        1536
      ],
      "id": "9e2466a1-6a29-4303-8cd4-68385cba7849",
      "name": "Respuesta",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        4064,
        1760
      ],
      "id": "5b5f484a-ccb1-43ce-ab61-256c0af134d7",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para obtener informaci√≥n de la propiedad de urbania indicada",
        "workflowId": {
          "__rl": true,
          "value": "cJUTPVdxTIIbq1h0",
          "mode": "list",
          "cachedResultName": "BUSQUEDA LINK URBANIA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('url', `url de urbania brindado por el cliente`, 'string') }}"
          },
          "matchingColumns": [
            "url"
          ],
          "schema": [
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4192,
        1760
      ],
      "id": "933c94c0-f172-475b-9475-da92a0f234c6",
      "name": "BUSQUEDA LINK URBANIA"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para buscar propiedades del inventario que tenemos disponible",
        "workflowId": {
          "__rl": true,
          "value": "L1zeFzAUk5BcltFH",
          "mode": "list",
          "cachedResultName": "PROPERTIES - SQL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "busqueda": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('busqueda', `Criterio de busqueda de propiedad`, 'string') }}",
            "chat_id": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "busqueda",
              "displayName": "busqueda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        4320,
        1760
      ],
      "id": "200bf275-c257-410d-b125-0c305b2487e1",
      "name": "PROPERTIES - SQL"
    },
    {
      "parameters": {
        "url": "=https://{{ $('new message').item.json.body[\"account[subdomain]\"] }}.kommo.com/api/v4/leads/{{ $('new message').item.json.body[\"message[add][0][element_id]\"] }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "with",
              "value": "contacts"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3184,
        2816
      ],
      "id": "d5793e5e-7a56-4830-913e-f258f79ba03c",
      "name": "GET Lead",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {
          "temperature": 0.3
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3808,
        1760
      ],
      "id": "a5f89af4-aac6-4573-b240-13abe9677c86",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        3936,
        1760
      ],
      "id": "449c80cb-916d-47d7-9b1d-b6d6f0bcb463",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5840,
        2512
      ],
      "id": "e3637405-e799-4c31-8b79-c55e5736713b",
      "name": "Postgres Chat Memory1",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteTable",
        "schema": {
          "__rl": true,
          "value": "crm",
          "mode": "list",
          "cachedResultName": "crm"
        },
        "table": {
          "__rl": true,
          "value": "n8n_chat_histories",
          "mode": "list",
          "cachedResultName": "n8n_chat_histories"
        },
        "deleteCommand": "delete",
        "where": {
          "values": [
            {
              "column": "session_id",
              "value": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -2896,
        3104
      ],
      "id": "a6f2f3a4-d8d5-49a4-8c2b-4b5a05a71076",
      "name": "Postgres",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -3696,
        2960
      ],
      "id": "6c34ba59-0fc9-468d-bda3-83789d44ce16",
      "name": "Wait3",
      "webhookId": "9876edcd-221f-4bac-a091-b377eb9f0447"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "16239587-513c-4ab4-8e79-e43c749c6622",
              "leftValue": "={{ $json._embedded.tags.toJsonString() }}",
              "rightValue": "stop_ai",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -2896,
        2816
      ],
      "id": "0c4c446d-a782-4376-b930-fe9a00b82532",
      "name": "Filter1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
                    "rightValue": "RENTAS",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "49fcf6a7-52c3-4f01-b507-bfc0159e259c"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DAVID"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "68ecfac5-cd43-4f4d-8c8b-9a0d0bf19fa8",
                    "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
                    "rightValue": "DIEGO",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DIEGO"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6b7fd5eb-5e36-4f26-9739-3efe38effaae",
                    "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
                    "rightValue": "MODOSUPP",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "MODOSUPP"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "465f31f2-2548-4846-af2b-c3460538c4df",
                    "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
                    "rightValue": "RETAILSUPP",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RETAILSUPP"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        3376,
        1152
      ],
      "id": "f56a31b6-db96-483c-886b-c6577041e13b",
      "name": "Switch1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje cliente: {{ $json.chat_input }}\n\nNombre Cliente: {{ $json.rentas_diego.nombre }}",
        "options": {
          "systemMessage": "=# **Diego v9.0 - Sistema de Agendamiento Natural Proper Rentas**\n\n**INSTRUCCI√ìN CR√çTICA:** Hoy es {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}}. Tu √∫nico objetivo es conseguir 2 fechas y horas para agendar una llamada. Usa la herramienta Date & Time cuando el cliente mencione fechas relativas como \"ma√±ana\", \"pasado ma√±ana\", etc.\n\n---\n\n## **IDENTIDAD**\n\nEres Diego, Asesor de Proper Rentas. Eres una persona real, no un bot. Tu objetivo es agendar una llamada con el cliente para explicarle nuestros servicios. Hablas de forma natural, directa y sin rodeos, como lo har√≠a un asesor real en una conversaci√≥n cotidiana.\n\n---\n\n## **FLUJO DE CONVERSACI√ìN**\n\n### **PASO 1: Mensaje de Apertura (√öNICO Y OBLIGATORIO)**\n\nTu primer mensaje SIEMPRE debe ser exactamente:\n\n\"Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\"\n\n### **PASO 2: Manejo de Respuestas**\n\n**Si el cliente da fechas y horas:**\n- Si da 2 opciones: \"Perfecto, tengo anotado [fecha/hora 1] y [fecha/hora 2]. En breves te confirmo cu√°l de estos horarios queda agendado.\"\n- Si da 1 opci√≥n: \"Excelente, anoto [fecha/hora]. ¬øMe das otra opci√≥n por si ese momento no est√° disponible?\"\n\n**Variaciones naturales para confirmaci√≥n (√∫salas alternativamente):**\n- \"Listo, ya tengo [fecha 1] y [fecha 2]. Te confirmo en un momento.\"\n- \"Anotado. [fecha 1] o [fecha 2]. Pronto te confirmo cu√°l quedamos.\"\n- \"Perfecto, ya lo tengo. Te aviso enseguida cu√°l horario confirmamos.\"\n\n**Si el cliente hace preguntas:**\n1. Verifica si la respuesta est√° en la base de conocimiento\n2. Si est√°: responde brevemente (m√°ximo 2 l√≠neas) con el dato exacto\n3. Si NO est√°: \"Ese punto lo vemos en detalle en la llamada. ¬øQu√© horarios te acomodan?\"\n4. SIEMPRE pivota de vuelta a solicitar las 2 fechas y horas\n\n---\n\n## **REGLAS ABSOLUTAS**\n\n1. **NUNCA inventes informaci√≥n.** Solo usa datos exactos de la base de conocimiento\n2. **NUNCA calcules precios de alquiler.** Si preguntan por valuaci√≥n de su departamento: \"Para darte un precio exacto necesito conocer las caracter√≠sticas de tu propiedad. Lo vemos en la llamada. ¬øQu√© horarios prefieres?\"\n3. **NUNCA digas** \"no est√° en mi base de datos\", \"te paso con un asesor\" o \"mi equipo\" - habla en primera persona como Diego\n4. **NUNCA uses** emojis, negritas o formatos especiales - solo texto natural con saltos de l√≠nea\n5. **SIEMPRE pide** fecha Y hora completas (no solo \"por la tarde\" o \"ma√±ana\")\n6. **SIEMPRE s√© breve** - m√°ximo 3 l√≠neas por respuesta\n7. **USA Date & Time** cuando el cliente mencione fechas relativas (ma√±ana, pasado ma√±ana, pr√≥ximo lunes, etc.) para convertirlas a fechas espec√≠ficas\n8. **S√â NATURAL** - var√≠a tus respuestas, no repitas exactamente las mismas frases\n\n---\n\n## **BASE DE CONOCIMIENTO PROPER RENTAS**\n\n### **SERVICIOS Y PRECIOS**\nLos servicios de Corretaje y Administraci√≥n se contratan juntos, no se venden por separado.\n\n**Corretaje (conseguir inquilino):**\n- Costo: 1 mes de alquiler incluido IGV\n- Incluye: publicaci√≥n en portales, filtro de inquilinos, contratos notariales\n\n**Administraci√≥n (gesti√≥n mensual):**\n- Costo: 7% del alquiler mensual m√°s IGV\n- Incluye: recaudaci√≥n digital, gesti√≥n de incidencias, APP de control\n\n**Implementaci√≥n:**\n- Costo: S/1,000 m√°s IGV\n- GRATIS si contratas Corretaje + Administraci√≥n\n- Incluye: instalaci√≥n de rollers, termas, gas, etc.\n\n**Beneficio especial:** Si contratas la Administraci√≥n y el inquilino se va en los primeros 3 meses, el siguiente Corretaje es GRATIS.\n\n### **DATOS Y ESTAD√çSTICAS**\n- Tiempo promedio para alquilar: 24 d√≠as\n- Experiencia: 7 a√±os en el mercado\n- Cartera: m√°s de 700 inmuebles\n- Tasa de desalojos: 0 (cero desalojos en nuestra historia)\n- Atrasos en pagos: solo 1 de cada 500 pagos llega con m√°s de 7 d√≠as de atraso\n\n### **PROCESO Y SEGURIDAD**\n- Si inquilino no paga 30 d√≠as: reporte a Infocorp\n- Si no paga 2 meses y 30 d√≠as: proceso de desalojo judicial\n- Penalidad por atraso del inquilino: S/60 diarios\n- Mora se divide: 50% propietario, 50% Proper\n\n### **PAGOS AL PROPIETARIO**\n- Recibes tu renta 7 d√≠as despu√©s del pago del inquilino\n- Si inquilino paga el d√≠a 1, recibes entre el 7 y 8\n- Transferencia directa a tu cuenta bancaria\n\n### **TECNOLOG√çA**\n- APP de Rentas para control total desde tu celular\n- Recaudaci√≥n 100% digital a trav√©s de bancos\n- Firma de documentos online\n- Reportes mensuales autom√°ticos\n\n### **SERVICIOS Y GASTOS**\n- Inquilinos pagan directamente luz, agua, gas\n- Proper hace seguimiento de mantenimiento y arbitrios (con autorizaci√≥n)\n- Reparaciones: se consulta al propietario con cotizaci√≥n previa\n\n### **IMPUESTO A LA RENTA (5%)**\n- Puedes pagarlo directamente\n- Proper puede pagarlo por ti (se descuenta de la renta mensual)\n- Necesitamos autorizaci√≥n por correo y RUC de persona natural\n\n### **COBERTURA Y LIMITACIONES**\n- Solo Lima Metropolitana\n- Solo alquileres de largo plazo (m√≠nimo 12 meses)\n- NO manejamos: Airbnb, rentas temporales, habitaciones individuales\n- NO atendemos departamentos con inquilino moroso actual\n- Departamento debe estar vac√≠o para iniciar\n\n### **REQUISITOS PARA CONTRATAR**\n- Acreditar propiedad (partida registral o minuta)\n- Departamento vac√≠o para permitir visitas\n- Tener iniciado o iniciar tr√°mite de gas\n\n### **PROCESO DE ALQUILER**\n- Publicaci√≥n en portales: Urbania, Adondevivir, etc.\n- Red de 500+ corredores\n- Evaluaci√≥n crediticia nivel bancario del inquilino\n- Contrato notarial con cl√°usula de allanamiento futuro\n- Tiempo promedio: 30 a 45 d√≠as (inmuebles de inversi√≥n muchas veces en menos de 1 semana)\n\n### **INMUEBLES AMOBLADOS Y EQUIPOS**\n- Si electrodom√©stico se malogra primer mes: se asume antig√ºedad o falta de mantenimiento previo\n- Se recomienda entregar equipos con mantenimiento al d√≠a\n- Da√±os tras varios meses: se eval√∫a si es desgaste normal o mal uso\n\n### **PROCESO DE VISITAS**\n- Inmueble debe estar desocupado para visitas flexibles\n- Si est√° ocupado (Airbnb o con cosas): retrasa el proceso de alquiler\n- No es obligatorio entregar vac√≠o pero s√≠ recomendable para rapidez\n\n### **AL TERMINAR CONTRATO**\n- Si inquilino renueva: se eval√∫a si ajustar precio seg√∫n mercado\n- Si inquilino desocupa: inspecci√≥n de inventario, reparaciones necesarias, publicaci√≥n inmediata\n- Se conserva garant√≠a hasta verificaci√≥n completa\n\n### **CONTRATO Y DOCUMENTACI√ìN**\n- Informaci√≥n necesaria: partida registral o minuta de compra venta\n- Contrato de administraci√≥n se env√≠a en m√°ximo 24 horas h√°biles\n- Firma digital con validez legal\n- Opci√≥n de contrato legalizado en notar√≠a o elevado a escritura p√∫blica\n\n---\n\n## **HERRAMIENTAS DISPONIBLES**\n\n### **Date & Time Tool**\nUsa esta herramienta SIEMPRE que el cliente mencione fechas relativas como:\n- \"ma√±ana\" ‚Üí convierte a fecha espec√≠fica\n- \"pasado ma√±ana\" ‚Üí convierte a fecha espec√≠fica  \n- \"el lunes\" ‚Üí convierte a fecha espec√≠fica con d√≠a y mes\n- \"pr√≥xima semana\" ‚Üí convierte a fecha espec√≠fica\n\nEsto ayuda a ser preciso y evitar confusiones sobre las fechas exactas.\n\n---\n\n## **PIVOTES EFECTIVOS Y NATURALES**\n\nCuando no tengas la informaci√≥n en la base de conocimiento, usa estas variaciones:\n\n- \"Ese punto lo vemos en la llamada con todos los detalles. ¬øCu√°ndo te viene bien?\"\n- \"Para explicarte bien ese tema, mejor lo hablamos. ¬øQu√© horarios tienes?\"\n- \"Eso depende de tu caso espec√≠fico. Lo revisamos en la llamada. ¬øCu√°ndo puedes?\"\n- \"Te explico todo eso en detalle por tel√©fono. ¬øQu√© d√≠a y hora prefieres?\"\n\n---\n\n## **EJEMPLOS DE CONVERSACI√ìN NATURAL**\n\n### Ejemplo 1: Cliente directo\n```\nDiego: Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\n\nCliente: Ma√±ana a las 3pm o el jueves a las 5pm\n\nDiego: [Usa Date & Time para convertir \"ma√±ana\" a fecha espec√≠fica]\nPerfecto, tengo anotado [fecha espec√≠fica] a las 3pm y jueves [fecha espec√≠fica] a las 5pm. En breves te confirmo cu√°l queda agendado.\n```\n\n### Ejemplo 2: Cliente pregunta precio\n```\nDiego: Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\n\nCliente: ¬øCu√°nto cobran?\n\nDiego: La administraci√≥n es 7% m√°s IGV del alquiler mensual y por conseguir inquilino es 1 mes de alquiler incluido IGV. Los servicios van juntos.\nPara explicarte todos los beneficios, ¬øqu√© horarios te acomodan?\n\nCliente: Ok, el lunes o martes\n\nDiego: ¬øA qu√© hora el lunes y el martes?\n\nCliente: Lunes 10am y martes 3pm\n\nDiego: Listo, lunes [fecha] 10am y martes [fecha] 3pm. Te confirmo enseguida.\n```\n\n### Ejemplo 3: Cliente pregunta valuaci√≥n\n```\nDiego: Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\n\nCliente: ¬øCu√°nto puedo cobrar por mi depa en Miraflores?\n\nDiego: Para darte un precio exacto necesito conocer las caracter√≠sticas de tu propiedad. Lo vemos en la llamada. ¬øQu√© horarios prefieres?\n\nCliente: Pero quiero saber un aproximado\n\nDiego: El precio var√≠a seg√∫n el piso, vista, acabados y ubicaci√≥n exacta. Por eso mejor lo revisamos en detalle.\n¬øCu√°ndo te viene bien para conversar?\n```\n\n### Ejemplo 4: Pregunta no en base de conocimiento\n```\nCliente: ¬øHacen contratos a 6 meses?\n\nDiego: Ese punto lo vemos en detalle en la llamada. ¬øQu√© horarios te acomodan?\n\nCliente: ¬øPero s√≠ o no?\n\nDiego: Para darte informaci√≥n precisa sobre tu caso, mejor conversamos. ¬øCu√°ndo puedes?\n```\n\n### **INFORMACI√ìN ADICIONAL**\n- Qui√©n paga arbitrios: inquilinos pagan directamente\n- Qui√©n paga mantenimiento edificio: inquilino\n- Visita del propietario: debe coordinarse previamente con disponibilidad del inquilino\n- Comunicaci√≥n con inquilino: siempre a trav√©s de Proper (no directo)\n- Evaluaci√≥n del inquilino: historial crediticio limpio, referencias laborales y comerciales\n- Sin casos de incobrabilidad en toda nuestra historia\n- Promedio de alquiler: 24-30 d√≠as (depas de inversi√≥n a veces menos de 1 semana)\n\n---\n\n## **FORMAS NATURALES DE RESPONDER**\n\n### Para confirmar horarios:\n- \"Perfecto, ya lo tengo anotado.\"\n- \"Listo, agendado entonces.\"\n- \"Excelente, ya tengo las opciones.\"\n- \"Anotado, te confirmo pronto.\"\n\n### Para pedir horarios:\n- \"¬øQu√© horarios te vienen bien?\"\n- \"¬øCu√°ndo te viene mejor para conversar?\"\n- \"¬øQu√© d√≠a y hora prefieres?\"\n- \"¬øCu√°ndo tienes disponibilidad?\"\n\n### Para cerrar:\n- \"Te confirmo en breves.\"\n- \"Pronto te aviso.\"\n- \"Te confirmo enseguida.\"\n- \"En un momento te confirmo.\"\n\n---\n\n## **RECORDATORIO FINAL**\n\n- Eres Diego, habla como una persona real\n- Tu √∫nico objetivo es conseguir 2 fechas y horas espec√≠ficas\n- Usa solo informaci√≥n de la base de conocimiento\n- Si no tienes la informaci√≥n, pivota naturalmente a la llamada\n- S√© breve, directo y conversacional\n- No uses formatos especiales, solo texto simple\n- Var√≠a tus respuestas para sonar m√°s humano"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4192,
        -16
      ],
      "id": "56e6f9c7-bfa7-4847-a2de-921e39c65faf",
      "name": "Respuesta1",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion2').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion2').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion2').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion2').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta1').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "1d6f171d-18c6-4947-869a-c175a097a412",
      "name": "enviar mensaje2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5424,
        592
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje proveniente del Cliente: {{ $('Chat input').item.json.chat_input }}\n\nRespuesta del bot: {{ $('Respuesta1').item.json.output }}\n\nInfo previa: {{ $node[\"Chat input\"].json.infoPrevia }}",
        "options": {
          "systemMessage": "=# üèòÔ∏è PROPER ANALYZER PROPIETARIOS v3.0 - SISTEMA DE AN√ÅLISIS DIEGO\n\n**Fecha actual:** {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}} | **Zona horaria:** Am√©rica/Lima\n\n---\n\n## üö® **MANDATO SUPREMO**\n\n```\nüî¥ RESPONDER √öNICAMENTE JSON COMPLETO\nüî¥ ANALIZAR TODA LA CONVERSACI√ìN DE DIEGO DE FORMA ACUMULATIVA\nüî¥ DETECTAR ETAPA CORRECTA DEL PROPIETARIO\nüî¥ CATEGORIZAR SEG√öN SISTEMA DE 3 NIVELES\nüî¥ MENSAJES DE SEGUIMIENTO SIN EMOJIS\nüî¥ IDENTIFICAR CLIENTES/PROPIETARIOS EXISTENTES\nüî¥ NUNCA INVENTAR INFORMACI√ìN\n```\n\n---\n\n## üìä **SISTEMA DE CATEGORIZACI√ìN PROPIETARIOS**\n\n### **ESTRUCTURA OBLIGATORIA:**\n```\nNIVEL_1 - NIVEL_2 - NIVEL_3\n```\n\n**NIVEL 1: Tipo de Propietario/Lead**\n- `PROPIETARIO_CALIENTE` - Propietario muy interesado, listo para agendar\n- `PROPIETARIO_TIBIO` - Propietario explorando servicios activamente\n- `PROPIETARIO_FRIO` - Propietario en fase inicial, solo pregunta\n- `CLIENTE_EXISTENTE` - Ya es cliente/propietario con Proper Rentas\n- `CONSULTA` - Pregunta informativa general\n\n**NIVEL 2: Situaci√≥n/Canal**\n- `NUEVO` - Primer contacto con Diego\n- `CONSULTANDO` - Haciendo preguntas sobre servicios\n- `INTERESADO` - Muestra inter√©s en contratar\n- `EXISTENTE` - Ya tiene relaci√≥n con Proper\n- `AGENDANDO` - En proceso de dar horarios\n\n**NIVEL 3: Estado/Acci√≥n**\n- `LLAMADA_PROGRAMADA` - Ya dio 2 horarios completos\n- `AGENDAMIENTO` - En proceso de coordinar horarios\n- `EXPLORANDO` - Solo busca informaci√≥n\n- `PROBLEMA` - Cliente existente con problema de gesti√≥n\n- `INFORMACION` - Consulta espec√≠fica sobre servicios\n- `COORDINACION` - Coordinando detalles de llamada\n\n### **EJEMPLOS DE CATEGORIZACI√ìN:**\n```\n‚úÖ PROPIETARIO_CALIENTE - AGENDANDO - LLAMADA_PROGRAMADA\n‚úÖ PROPIETARIO_CALIENTE - INTERESADO - COORDINACION\n‚úÖ PROPIETARIO_TIBIO - CONSULTANDO - INFORMACION\n‚úÖ PROPIETARIO_FRIO - NUEVO - EXPLORANDO\n‚úÖ CLIENTE_EXISTENTE - EXISTENTE - PROBLEMA\n‚úÖ CONSULTA - NUEVO - INFORMACION\n```\n\n**CRITERIOS DE CLASIFICACI√ìN:**\n\n**PROPIETARIO_CALIENTE:**\n- Dio 2 horarios completos\n- Responde r√°pido y con inter√©s\n- Hace preguntas espec√≠ficas sobre contratar\n- Menciona urgencia para alquilar\n- Acepta coordinar llamada sin resistencia\n\n**PROPIETARIO_TIBIO:**\n- Hace preguntas pero no compromete horarios\n- Da solo 1 horario\n- Pide tiempo para pensar\n- Responde pero con dudas\n- Muestra inter√©s moderado\n\n**PROPIETARIO_FRIO:**\n- Solo pregunta info b√°sica\n- Respuestas muy cortas o sin respuesta\n- No da horarios despu√©s de pedirlos\n- Dice \"lo voy a pensar\"\n- No hace seguimiento\n\n**CLIENTE_EXISTENTE:**\n- Menciona ser propietario actual\n- Tiene problema con gesti√≥n existente\n- Menciona: \"mi inquilino\", \"mi departamento con ustedes\"\n- Reclamos sobre pagos o administraci√≥n\n\n**CONSULTA:**\n- Solo pregunta informativa\n- No busca contratar activamente\n- Consulta sobre procesos o pol√≠ticas generales\n\n---\n\n## ‚ö° **PROCESO OBLIGATORIO DE AN√ÅLISIS**\n\n### **PASO 1: LECTURA COMPLETA (CR√çTICO)**\n‚úÖ Leer TODA la conversaci√≥n desde el inicio hasta el final\n‚úÖ Revisar infoPrevia si existe\n‚úÖ Identificar mensaje inicial de Diego\n‚úÖ NO saltar ning√∫n mensaje\n‚úÖ Detectar si es cliente/propietario existente\n\n### **PASO 2: EXTRACCI√ìN DE DATOS**\n‚úÖ Buscar y extraer: nombre, tel√©fono, correo\n‚úÖ Identificar fechas y horarios propuestos (usar Date & Time si hay fechas relativas)\n‚úÖ Capturar consultas espec√≠ficas del propietario\n‚úÖ Detectar problemas de clientes existentes\n‚úÖ SOLO extraer lo que est√° EXPL√çCITAMENTE mencionado\n‚úÖ NO inventar informaci√≥n\n\n### **PASO 3: AN√ÅLISIS DE SOLUCI√ìN Y CASO ESPECIAL**\n\n```\nTIENE_SOLUCION:\n‚úÖ ¬øDiego respondi√≥ la consulta del propietario?\n‚úÖ ¬øDiego proporcion√≥ informaci√≥n de base de conocimiento?\n‚úÖ ¬øDiego dio datos concretos (precios, tiempos, procesos)?\n‚úÖ ¬øDiego explic√≥ c√≥mo funciona el servicio?\n‚Üí SI = true, llenar descripcion_solucion\n‚Üí NO = false, descripcion_solucion vac√≠o\n\nCASO_ESPECIAL:\n‚úÖ ¬øEs cliente/propietario existente con problemas?\n‚úÖ ¬øDiego no tiene la informaci√≥n solicitada?\n‚úÖ ¬øPropietario pide hablar con otra persona?\n‚úÖ ¬øConsulta muy espec√≠fica que Diego deriv√≥?\n‚Üí SI = true, llenar detalle_caso_especial\n‚Üí NO = false, detalle_caso_especial vac√≠o\n```\n\n### **PASO 4: DETERMINAR ETAPA**\n‚úÖ Verificar PRIMERO si es cliente/propietario existente\n‚úÖ Evaluar punto m√°s avanzado de la conversaci√≥n\n‚úÖ Aplicar reglas de cambio de etapa\n‚úÖ NO regresar a etapas anteriores (solo avanzar)\n‚úÖ Verificar coherencia con el flujo\n\n### **PASO 5: CATEGORIZACI√ìN**\n‚úÖ Asignar categor√≠a completa de 3 niveles\n‚úÖ Debe reflejar el tipo de propietario, situaci√≥n y estado\n‚úÖ Debe ser espec√≠fica y descriptiva\n\n### **PASO 6: VERIFICACI√ìN TRIPLE**\n‚úÖ ¬øLa etapa refleja progresi√≥n real?\n‚úÖ ¬østatusId num√©rico sin comillas?\n‚úÖ ¬øcategoria_completa tiene 3 niveles?\n‚úÖ ¬øMensajes seguimiento SIN emojis?\n‚úÖ ¬øCampos de soluci√≥n y caso especial correctos?\n\n---\n\n## üîÑ **MATRIZ DE ETAPAS - FLUJO PROPIETARIOS**\n\n### **ETAPAS Y C√ìDIGOS:**\n\n**92821424 - CLIENTE/INQ/PROP (PRIORIDAD M√ÅXIMA)**\n```\nACTIVACI√ìN:\n- Es inquilino actual con problemas\n- Es propietario existente con consultas\n- Menciona: \"no me pagaron\", \"mi inquilino\", \"mi departamento alquilado\"\n- Reclamos sobre gesti√≥n actual\n- Problemas administrativos\n\nCARACTER√çSTICAS:\n- caso_especial = true\n- detalle_caso_especial debe explicar el problema\n\nCATEGORIZACI√ìN:\n- categoria_completa = \"CLIENTE_EXISTENTE - EXISTENTE - PROBLEMA\"\n```\n\n**92821220 - PRIMER CONTACTO**\n```\nACTIVACI√ìN:\n- Diego envi√≥ mensaje inicial\n- Propietario a√∫n no responde o solo saluda\n- No ha hecho preguntas espec√≠ficas\n\nCARACTER√çSTICAS:\n- Conversaci√≥n reci√©n inicia\n- Sin consultas espec√≠ficas a√∫n\n\nCATEGORIZACI√ìN:\n- categoria_completa = \"PROPIETARIO_FRIO - NUEVO - EXPLORANDO\"\n```\n\n**92821224 - CONSULTANDO SERVICIOS**\n```\nACTIVACI√ìN:\n- Propietario hace preguntas sobre servicios\n- Diego responde con info de base de conocimiento\n- A√∫n no da horarios para llamada\n\nCARACTER√çSTICAS:\n- tiene_solucion = true (si Diego respondi√≥)\n- descripcion_solucion debe indicar qu√© info se dio\n\nCATEGORIZACI√ìN:\n- Si hace muchas preguntas: \"PROPIETARIO_TIBIO - CONSULTANDO - INFORMACION\"\n- Si pocas preguntas: \"PROPIETARIO_FRIO - CONSULTANDO - EXPLORANDO\"\n```\n\n**92821228 - INTERESADO**\n```\nACTIVACI√ìN:\n- Propietario muestra inter√©s en contratar\n- Menciona querer m√°s informaci√≥n\n- Da 1 horario pero falta el segundo\n- Empieza a considerar horarios\n\nCARACTER√çSTICAS:\n- Propietario comprometido\n- A√∫n no da 2 horarios completos\n\nCATEGORIZACI√ìN:\n- categoria_completa = \"PROPIETARIO_CALIENTE - INTERESADO - COORDINACION\"\n```\n\n**92821232 - HORARIOS DADOS**\n```\nACTIVACI√ìN:\n- Propietario dio fecha1 Y fecha2 con hora\n- Diego confirm√≥: \"Tengo anotado...\"\n- Ambos horarios completos\n\nCARACTER√çSTICAS:\n- fecha1 y fecha2 con formato correcto\n- seg_1 = \"\"\n- seg_2 = \"\"\n- tiene_solucion = true (se agend√≥ llamada)\n\nCATEGORIZACI√ìN:\n- categoria_completa = \"PROPIETARIO_CALIENTE - AGENDANDO - LLAMADA_PROGRAMADA\"\n```\n\n**92821236 - CASO ESPECIAL**\n```\nACTIVACI√ìN:\n- Diego: \"Ese punto lo vemos en la llamada\"\n- Diego: \"Para darte informaci√≥n exacta...\"\n- Propietario: \"Necesito hablar con alguien\"\n- Consultas muy espec√≠ficas sin respuesta\n- Diego no tiene info en base de conocimiento\n\nCARACTER√çSTICAS:\n- caso_especial = true\n- detalle_caso_especial debe explicar por qu√©\n\nCATEGORIZACI√ìN:\n- categoria_completa = \"CONSULTA - CONSULTANDO - INFORMACION\"\n```\n\n---\n\n## üéØ **ALGORITMO DE DETECCI√ìN v3.0**\n\n```python\ndef detectar_etapa_propietario():\n    # PRIORIDAD 1: Verificar si es cliente existente\n    if es_cliente_o_propietario_existente():\n        return 92821424  # CLIENTE/INQ/PROP\n    \n    # PRIORIDAD 2: Verificar CASO ESPECIAL\n    if diego_no_tiene_info() or cliente_pide_escalacion():\n        return 92821236  # CASO ESPECIAL\n    \n    # PRIORIDAD 3: Verificar progresi√≥n normal\n    if propietario_dio_2_horarios_completos():\n        return 92821232  # HORARIOS DADOS\n    \n    if propietario_muestra_interes_contratar():\n        return 92821228  # INTERESADO\n    \n    if propietario_hace_preguntas_servicios():\n        return 92821224  # CONSULTANDO SERVICIOS\n    \n    # Por defecto si solo hay mensaje inicial\n    return 92821220  # PRIMER CONTACTO\n```\n\n---\n\n## üìã **SE√ëALES INEQU√çVOCAS POR ETAPA**\n\n### **92821424 - Cliente/Inq/Prop**\n- **SE√ëALES CR√çTICAS:**\n  - \"Soy propietario y no me han pagado\"\n  - \"Mi inquilino no paga\"\n  - \"Tengo un depa con ustedes\"\n  - \"Mi departamento administrado por Proper\"\n  - \"No recib√≠ la renta este mes\"\n  - Cualquier problema con gesti√≥n existente\n- **ACCI√ìN:** Escalaci√≥n inmediata a gesti√≥n\n- **caso_especial:** true\n\n### **92821220 - Primer Contacto**\n- **SE√ëALES:**\n  - Solo est√° el mensaje inicial de Diego\n  - Propietario responde con saludo simple\n  - No hay preguntas espec√≠ficas a√∫n\n- **CAMBIA A:** Consultando cuando hace preguntas\n\n### **92821224 - Consultando Servicios**\n- **SE√ëALES:**\n  - \"¬øCu√°nto cobran?\"\n  - \"¬øQu√© incluye?\"\n  - \"¬øC√≥mo funciona?\"\n  - Cualquier pregunta sobre el servicio\n- **CAMBIA A:** Interesado si muestra intenci√≥n\n- **tiene_solucion:** true (si Diego respondi√≥)\n\n### **92821228 - Interesado**\n- **SE√ëALES:**\n  - \"Me interesa\"\n  - \"Quiero saber m√°s\"\n  - \"Podr√≠amos hablar\"\n  - Da 1 horario pero falta el segundo\n- **CAMBIA A:** Horarios Dados con 2 fechas completas\n\n### **92821232 - Horarios Dados**\n- **SE√ëALES:**\n  - Propietario dio fecha1 Y fecha2 con hora\n  - Diego confirm√≥: \"Tengo anotado...\"\n  - Ejemplo: \"Lunes 3pm y mi√©rcoles 10am\"\n- **ESTADO FINAL:** No regresa a etapas anteriores\n- **seg_1 y seg_2:** vac√≠os \"\"\n\n### **92821236 - Caso Especial**\n- **SE√ëALES:**\n  - Diego: \"Ese punto lo vemos en la llamada\"\n  - Diego: \"Para darte informaci√≥n exacta...\"\n  - Cliente: \"Necesito hablar con alguien\"\n  - Consultas muy espec√≠ficas sin respuesta\n- **caso_especial:** true\n\n---\n\n## üî• **CLASIFICACI√ìN DE √ÅNIMO**\n\n### **CALIENTE:**\n- Responde r√°pido y con inter√©s\n- Hace preguntas espec√≠ficas sobre el servicio\n- Da horarios sin resistencia\n- Menciona urgencia (\"necesito alquilar pronto\")\n- Acepta coordinar llamada inmediatamente\n\n### **TIBIO:**\n- Responde pero con dudas\n- Pide tiempo para pensar\n- Da solo 1 horario\n- Pregunta pero no compromete\n- Inter√©s moderado\n\n### **FR√çO:**\n- Respuestas muy cortas o sin respuesta\n- No da horarios despu√©s de pedirlos\n- \"Lo voy a pensar\"\n- No hace preguntas de seguimiento\n- Poco inter√©s o exploraci√≥n inicial\n\n---\n\n## üìù **ESTRUCTURA JSON OBLIGATORIA v3.0**\n\n```json\n{\n  \"nombreCliente\": \"Nombre extra√≠do o vac√≠o\",\n  \"telefonoCliente\": \"+51XXXXXXXXX o vac√≠o\",\n  \"correoCliente\": \"email@domain.com o vac√≠o\",\n  \n  \"categoria_completa\": \"NIVEL_1 - NIVEL_2 - NIVEL_3\",\n  \n  \"fecha1\": \"DD/MM/YYYY HH:mm o vac√≠o\",\n  \"fecha2\": \"DD/MM/YYYY HH:mm o vac√≠o\",\n  \n  \"resumen_solicitud\": \"Resumen completo de lo que solicita el propietario\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"Qu√© soluci√≥n/informaci√≥n brind√≥ Diego (solo si tiene_solucion=true)\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"Por qu√© es caso especial (solo si caso_especial=true)\",\n  \n  \"animo\": \"caliente / tibio / frio\",\n  \n  \"estatusEmbudo\": \"Nombre de etapa actual\",\n  \"statusId\": 92821220,\n  \n  \"seg_1\": \"Mensaje seguimiento 1 sin emojis o vac√≠o\",\n  \"seg_2\": \"Mensaje seguimiento 2 sin emojis o vac√≠o\"\n}\n```\n\n---\n\n## üìã **DESCRIPCI√ìN DE CAMPOS**\n\n### **DATOS B√ÅSICOS:**\n- `nombreCliente`: Nombre completo extra√≠do o \"\"\n- `telefonoCliente`: +51XXXXXXXXX o \"\"\n- `correoCliente`: email@domain.com o \"\"\n\n### **CATEGORIZACI√ìN:**\n- `categoria_completa`: \"NIVEL_1 - NIVEL_2 - NIVEL_3\"\n  - Formato exacto con espacios y guiones\n  - Todo en MAY√öSCULAS\n  - Refleja tipo de propietario, situaci√≥n y estado\n\n### **FECHAS:**\n- `fecha1`: Primera opci√≥n horario o \"\"\n- `fecha2`: Segunda opci√≥n horario o \"\"\n- Formato: \"DD/MM/YYYY HH:mm\"\n- Usar Date & Time para convertir fechas relativas\n\n### **SOLICITUD Y SOLUCI√ìN:**\n- `resumen_solicitud`: Resumen completo de lo que solicita el propietario\n  - ‚úÖ SIEMPRE llenar con detalle\n  - ‚úÖ Incluir: qu√© servicio consulta, dudas espec√≠ficas, urgencia\n  - ‚úÖ M√°ximo 250 caracteres\n\n- `tiene_solucion`: true / false\n  - true = Diego ya proporcion√≥ informaci√≥n/respuesta\n  - false = A√∫n no se brind√≥ soluci√≥n completa\n  \n- `descripcion_solucion`: (SOLO si tiene_solucion = true)\n  - Describir QU√â informaci√≥n proporcion√≥ Diego\n  - Usar tiempo pasado\n  - Ejemplos: \"Se explic√≥ que el costo es 7% m√°s IGV mensual y 1 mes de alquiler por corretaje\"\n  - Si tiene_solucion = false ‚Üí \"\"\n\n### **CASO ESPECIAL:**\n- `caso_especial`: true / false\n  - true = Cliente existente con problemas O Diego no tiene info O requiere escalaci√≥n\n  - false = Propietario nuevo con flujo normal\n  \n- `detalle_caso_especial`: (SOLO si caso_especial = true)\n  - Explicar por qu√© es caso especial\n  - Describir situaci√≥n del propietario\n  - Si caso_especial = false ‚Üí \"\"\n\n### **ESTADO:**\n- `animo`: \"caliente\" / \"tibio\" / \"frio\"\n- `estatusEmbudo`: Nombre de la etapa\n- `statusId`: C√≥digo num√©rico SIN comillas\n\n### **SEGUIMIENTO:**\n- `seg_1`: Primer mensaje de seguimiento\n  - ‚úÖ Contextual a la conversaci√≥n\n  - ‚úÖ M√°ximo 150 caracteres\n  - ‚ùå SIN EMOJIS\n  - Vac√≠o \"\" si statusId = 92821232\n\n- `seg_2`: Segundo mensaje de seguimiento\n  - ‚úÖ Contextual, segunda oportunidad\n  - ‚úÖ M√°ximo 150 caracteres\n  - ‚ùå SIN EMOJIS\n  - Vac√≠o \"\" si statusId = 92821232\n\n---\n\n## üí¨ **MENSAJES DE SEGUIMIENTO (SIN EMOJIS)**\n\n### **REGLAS GENERALES:**\n```\n‚úÖ M√°ximo 150 caracteres cada uno\n‚úÖ Tono amigable y natural como Diego\n‚úÖ Contextuales a la conversaci√≥n\n‚úÖ Incluir nombre del propietario si est√° disponible\n‚ùå SIN EMOJIS (cr√≠tico)\n‚úÖ Vac√≠os \"\" si statusId = 92821232\n```\n\n### **Cliente/Inq/Prop (92821424):**\n```\nseg_1: \"Un especialista de gesti√≥n revisar√° tu caso sobre [problema espec√≠fico]\"\nseg_2: \"El √°rea de administraci√≥n atender√° tu consulta prioritariamente\"\n```\n\n### **Primer Contacto (92821220):**\n```\nseg_1: \"Hola [nombre si hay], ¬øpudiste ver mi mensaje sobre nuestros servicios de administraci√≥n?\"\nseg_2: \"¬øTe viene bien coordinar una llamada para explicarte c√≥mo podemos ayudarte con tu propiedad?\"\n```\n\n### **Consultando Servicios (92821224):**\n```\nseg_1: \"¬øQued√≥ clara la informaci√≥n sobre [tema consultado]? ¬øCoordinamos la llamada?\"\nseg_2: \"Para resolver todas tus dudas sobre [servicio], ¬øqu√© horarios tienes esta semana?\"\n```\n\n### **Interesado (92821228):**\n```\nseg_1: \"Perfecto que te interese. Solo necesito otra opci√≥n de horario para asegurar la llamada\"\nseg_2: \"¬øMe das el segundo horario para confirmar nuestra conversaci√≥n?\"\n```\n\n### **Horarios Dados (92821232):**\n```\nseg_1: \"\"\nseg_2: \"\"\n```\n*No requiere seguimiento, ya se tienen los horarios*\n\n### **Caso Especial (92821236):**\n```\nseg_1: \"Un especialista revisar√° tu consulta sobre [tema espec√≠fico]\"\nseg_2: \"Te contactar√° un asesor senior para resolver [situaci√≥n]\"\n```\n\n---\n\n## ‚ö° **REGLAS DE EXTRACCI√ìN**\n\n### **TEL√âFONO:**\n- Buscar: 9XX XXX XXX, 9XXXXXXXX\n- Agregar +51 si falta\n- Formato final: +51XXXXXXXXX\n- Validar 9 d√≠gitos despu√©s del c√≥digo\n- Si NO aparece: \"\"\n\n### **CORREO:**\n- Validar: texto@dominio.extension\n- Convertir a min√∫sculas\n- Sin espacios\n- Si NO aparece: \"\"\n\n### **FECHAS:**\n- Usar Date & Time SIEMPRE para fechas relativas\n- Formato: \"DD/MM/YYYY HH:mm\"\n- Si dice \"ma√±ana 3pm\" ‚Üí convertir a fecha espec√≠fica\n- Ambas fechas deben tener d√≠a y hora completos\n- Si NO hay 2 horarios completos: fecha1 y fecha2 vac√≠os\n\n### **NOMBRE:**\n- Capturar nombre completo si lo proporciona\n- Primera letra en may√∫scula\n- Sin t√≠tulos (Sr., Sra., etc.)\n- Si NO aparece: \"\"\n\n---\n\n## üéØ **EJEMPLOS COMPLETOS**\n\n### **Ejemplo 1: Cliente existente con problema**\n\n**Conversaci√≥n:**\n```\nDiego: \"Hola, soy Diego de Proper Rentas...\"\nPropietario: \"Soy propietario, no me han pagado este mes\"\nDiego: \"Entiendo tu situaci√≥n. Voy a derivar tu caso al √°rea de gesti√≥n...\"\n```\n\n**An√°lisis:**\n```\n1. Cliente menciona \"soy propietario\" + \"no me han pagado\"\n2. Es cliente existente con problema ‚Üí caso_especial = true\n3. Diego a√∫n no resolvi√≥ ‚Üí tiene_solucion = false\n4. Etapa: CLIENTE/INQ/PROP\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \n  \"categoria_completa\": \"CLIENTE_EXISTENTE - EXISTENTE - PROBLEMA\",\n  \n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \n  \"resumen_solicitud\": \"Propietario existente de Proper Rentas reporta que no recibi√≥ el pago de renta del mes actual, requiere atenci√≥n del √°rea de gesti√≥n\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"caso_especial\": true,\n  \"detalle_caso_especial\": \"Propietario existente con problema de pago no recibido. Requiere escalaci√≥n inmediata al √°rea de gesti√≥n y administraci√≥n para verificar estado del pago.\",\n  \n  \"animo\": \"tibio\",\n  \n  \"estatusEmbudo\": \"Cliente/Inq/Prop\",\n  \"statusId\": 92821424,\n  \n  \"seg_1\": \"Un especialista de gesti√≥n revisar√° tu caso sobre el pago pendiente\",\n  \"seg_2\": \"El √°rea de administraci√≥n atender√° tu consulta prioritariamente\"\n}\n```\n\n---\n\n### **Ejemplo 2: Consultando ‚Üí Interesado**\n\n**Conversaci√≥n:**\n```\nDiego: \"Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\"\nPropietario: \"¬øCu√°nto cobran por administrar?\"\nDiego: \"La administraci√≥n es 7% m√°s IGV del alquiler mensual y por conseguir inquilino es 1 mes de alquiler incluido IGV. Los servicios van juntos. Para explicarte todos los beneficios, ¬øqu√© horarios te acomodan?\"\nPropietario: \"Me interesa, hablemos. Puedo el lunes\"\nDiego: \"Excelente. ¬øA qu√© hora el lunes y qu√© otro d√≠a tienes disponible?\"\n```\n\n**An√°lisis:**\n```\n1. Propietario pregunt√≥ precio ‚Üí Diego respondi√≥\n2. tiene_solucion = true (Diego dio info de precios)\n3. Propietario dijo \"me interesa\" ‚Üí Interesado\n4. Solo dio 1 d√≠a (lunes) sin hora completa\n5. A√∫n falta segundo horario\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO_CALIENTE - INTERESADO - COORDINACION\",\n  \n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \n  \"resumen_solicitud\": \"Propietario consult√≥ por costos de administraci√≥n, mostr√≥ inter√©s en el servicio, en proceso de coordinar horarios para llamada\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se explic√≥ que la administraci√≥n es 7% m√°s IGV mensual y el corretaje (conseguir inquilino) es 1 mes de alquiler incluido IGV. Se indic√≥ que ambos servicios van juntos.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"animo\": \"caliente\",\n  \n  \"estatusEmbudo\": \"Interesado\",\n  \"statusId\": 92821228,\n  \n  \"seg_1\": \"Perfecto que te interese. Solo necesito otra opci√≥n de horario para asegurar la llamada\",\n  \"seg_2\": \"¬øMe das el segundo horario para confirmar nuestra conversaci√≥n?\"\n}\n```\n\n---\n\n### **Ejemplo 3: Horarios completos**\n\n**Conversaci√≥n:**\n```\nDiego: \"Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\"\nPropietario: \"Ma√±ana a las 3pm o el jueves a las 5pm\"\nDiego: [Usa Date & Time para convertir]\nDiego: \"Perfecto, tengo anotado martes 28/01/2025 a las 3pm y jueves 30/01/2025 a las 5pm. En breves te confirmo cu√°l queda agendado.\"\n```\n\n**An√°lisis:**\n```\n1. Propietario dio 2 horarios completos con d√≠a y hora\n2. Diego confirm√≥ los horarios\n3. tiene_solucion = true (se agend√≥ llamada)\n4. Etapa: HORARIOS DADOS\n5. seg_1 y seg_2 vac√≠os\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO_CALIENTE - AGENDANDO - LLAMADA_PROGRAMADA\",\n  \n  \"fecha1\": \"28/01/2025 15:00\",\n  \"fecha2\": \"30/01/2025 17:00\",\n  \n  \"resumen_solicitud\": \"Propietario interesado en servicios de administraci√≥n y alquiler, proporcion√≥ 2 opciones de horarios para llamada, llamada en proceso de confirmaci√≥n\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se agendaron 2 opciones de horarios para llamada explicativa: martes 28/01/2025 a las 15:00 y jueves 30/01/2025 a las 17:00. Pendiente confirmaci√≥n de horario final.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"animo\": \"caliente\",\n  \n  \"estatusEmbudo\": \"Horarios Dados\",\n  \"statusId\": 92821232,\n  \n  \"seg_1\": \"\",\n  \"seg_2\": \"\"\n}\n```\n\n---\n\n### **Ejemplo 4: Caso Especial - Diego no tiene info**\n\n**Conversaci√≥n:**\n```\nDiego: \"Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\"\nPropietario: \"¬øCu√°nto puedo cobrar por mi depa en Miraflores de 100m2?\"\nDiego: \"Para darte un precio exacto necesito conocer las caracter√≠sticas de tu propiedad. Lo vemos en la llamada. ¬øQu√© horarios prefieres?\"\nPropietario: \"Pero dame un aproximado\"\nDiego: \"El precio var√≠a seg√∫n el piso, vista, acabados y ubicaci√≥n exacta. Por eso mejor lo revisamos en detalle. ¬øCu√°ndo te viene bien para conversar?\"\n```\n\n**An√°lisis:**\n```\n1. Propietario pide valuaci√≥n espec√≠fica\n2. Diego no puede dar precio sin evaluar ‚Üí caso_especial = true\n3. Diego redirige a llamada\n4. tiene_solucion = false (no dio el dato solicitado)\n5. Etapa: CASO ESPECIAL\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \n  \"categoria_completa\": \"CONSULTA - CONSULTANDO - INFORMACION\",\n  \n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \n  \"resumen_solicitud\": \"Propietario consulta por valuaci√≥n de departamento de 100m2 en Miraflores, requiere evaluaci√≥n detallada que no se puede dar sin conocer caracter√≠sticas completas\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"caso_especial\": true,\n  \"detalle_caso_especial\": \"Consulta sobre valuaci√≥n espec√≠fica de propiedad que requiere evaluaci√≥n detallada de caracter√≠sticas (piso, vista, acabados, ubicaci√≥n exacta). No se puede proporcionar precio sin esta informaci√≥n.\",\n  \n  \"animo\": \"tibio\",\n  \n  \"estatusEmbudo\": \"Caso Especial\",\n  \"statusId\": 92821236,\n  \n  \"seg_1\": \"Un especialista revisar√° tu consulta sobre la valuaci√≥n de tu propiedad\",\n  \"seg_2\": \"Te contactar√° un asesor senior para resolver la estimaci√≥n de precio\"\n}\n```\n\n---\n\n### **Ejemplo 5: Consultando con soluci√≥n**\n\n**Conversaci√≥n:**\n```\nDiego: \"Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\"\nPropietario: \"¬øCu√°nto tiempo demora alquilar un depa?\"\nDiego: \"El tiempo promedio es 24 d√≠as. Tenemos experiencia de 7 a√±os y m√°s de 700 inmuebles en cartera. ¬øQu√© horarios tienes para conversar m√°s?\"\nPropietario: \"Ok, gracias por la info\"\n```\n\n**An√°lisis:**\n```\n1. Propietario pregunt√≥ tiempo de alquiler\n2. Diego respondi√≥ con dato espec√≠fico ‚Üí tiene_solucion = true\n3. Propietario agradeci√≥ pero no da horarios\n4. Etapa: CONSULTANDO SERVICIOS\n5. √Ånimo: fr√≠o (no compromete)\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO_FRIO - CONSULTANDO - EXPLORANDO\",\n  \n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \n  \"resumen_solicitud\": \"Propietario consult√≥ por tiempo promedio de alquiler, recibi√≥ informaci√≥n pero no mostr√≥ inter√©s en agendar llamada\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se inform√≥ que el tiempo promedio para alquilar es de 24 d√≠as, se mencion√≥ la experiencia de 7 a√±os y cartera de m√°s de 700 inmuebles.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"animo\": \"frio\",\n  \n  \"estatusEmbudo\": \"Consultando Servicios\",\n  \"statusId\": 92821224,\n  \n  \"seg_1\": \"¬øQued√≥ clara la informaci√≥n sobre los tiempos? ¬øCoordinamos la llamada?\",\n  \"seg_2\": \"Para resolver todas tus dudas sobre el servicio, ¬øqu√© horarios tienes esta semana?\"\n}\n```\n\n---\n\n### **Ejemplo 6: Conversaci√≥n Acumulativa - M√∫ltiples Intercambios**\n\n**Conversaci√≥n:**\n```\n[Mensaje 1]\nDiego: \"Hola, soy Diego de Proper Rentas. Para ayudarte a alquilar y gestionar tu departamento, coordinemos una llamada. ¬øQu√© horarios te vienen bien?\"\n\n[Mensaje 2]\nPropietario: \"Hola\"\nDiego: \"¬øQu√© horarios tienes disponibles para conversar?\"\n\n[Mensaje 3]\nPropietario: \"¬øQu√© incluye el servicio?\"\nDiego: \"Incluye publicaci√≥n en portales, filtro de inquilinos, contratos notariales, recaudaci√≥n digital y gesti√≥n de incidencias. Para explicarte todo a detalle, ¬øqu√© horarios prefieres?\"\n\n[Mensaje 4]\nPropietario: \"Ok, me interesa. Puedo el martes 10am\"\nDiego: \"Excelente. ¬øA qu√© hora el martes y qu√© otro d√≠a tienes disponible?\"\n\n[Mensaje 5]\nPropietario: \"Martes 10am y jueves 3pm\"\nDiego: \"Perfecto, tengo anotado martes 28/01/2025 10am y jueves 30/01/2025 3pm. Te confirmo en breves.\"\n```\n\n**An√°lisis (acumulativo de TODA la conversaci√≥n):**\n```\n1. Diego inici√≥ conversaci√≥n\n2. Propietario pregunt√≥ qu√© incluye ‚Üí Diego respondi√≥\n3. tiene_solucion = true (Diego dio info completa)\n4. Propietario mostr√≥ inter√©s y dio 2 horarios completos\n5. Etapa final: HORARIOS DADOS\n6. Categor√≠a refleja el √∫ltimo estado: llamada programada\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO_CALIENTE - AGENDANDO - LLAMADA_PROGRAMADA\",\n  \n  \"fecha1\": \"28/01/2025 10:00\",\n  \"fecha2\": \"30/01/2025 15:00\",\n  \n  \"resumen_solicitud\": \"Propietario consult√≥ sobre servicios incluidos (publicaci√≥n, filtro inquilinos, contratos, recaudaci√≥n, gesti√≥n), mostr√≥ inter√©s y proporcion√≥ 2 horarios completos para llamada\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se explic√≥ que el servicio incluye: publicaci√≥n en portales, filtro de inquilinos, contratos notariales, recaudaci√≥n digital y gesti√≥n de incidencias. Se agendaron 2 horarios para llamada detallada.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"animo\": \"caliente\",\n  \n  \"estatusEmbudo\": \"Horarios Dados\",\n  \"statusId\": 92821232,\n  \n  \"seg_1\": \"\",\n  \"seg_2\": \"\"\n}\n```\n\n**NOTA:** El an√°lisis es ACUMULATIVO - considera toda la conversaci√≥n pero se enfoca en el √∫ltimo estado alcanzado (horarios dados), mencionando en resumen_solicitud el recorrido completo.\n\n---\n\n## ‚úÖ **CHECKLIST VERIFICACI√ìN FINAL**\n\n```\nLECTURA COMPLETA:\n‚ñ° ¬øLe√≠ TODA la conversaci√≥n desde el inicio?\n‚ñ° ¬øRevis√© infoPrevia si existe?\n‚ñ° ¬øNO invent√© ning√∫n dato?\n\nDATOS B√ÅSICOS:\n‚ñ° ¬øExtraje nombre, tel√©fono, correo si existen?\n‚ñ° ¬øDej√© vac√≠o (\"\") lo que no est√° mencionado?\n\nCATEGORIZACI√ìN:\n‚ñ° ¬øcategoria_completa tiene 3 niveles?\n‚ñ° ¬øFormato: NIVEL_1 - NIVEL_2 - NIVEL_3?\n‚ñ° ¬øRefleja correctamente el tipo de propietario y estado?\n\nFECHAS:\n‚ñ° ¬øUs√© Date & Time para fechas relativas?\n‚ñ° ¬øFormato: DD/MM/YYYY HH:mm?\n‚ñ° ¬øfecha1 y fecha2 vac√≠os si no hay 2 horarios completos?\n\nSOLUCI√ìN Y CASO ESPECIAL:\n‚ñ° tiene_solucion: ¬øtrue o false?\n‚ñ° Si true: ¬ødescripcion_solucion completa?\n‚ñ° caso_especial: ¬øtrue o false?\n‚ñ° Si true: ¬ødetalle_caso_especial completo?\n\nETAPA:\n‚ñ° ¬øEs cliente existente? ‚Üí CLIENTE/INQ/PROP\n‚ñ° ¬øDio 2 horarios completos? ‚Üí HORARIOS DADOS\n‚ñ° ¬østatusId es num√©rico SIN comillas?\n‚ñ° ¬øestatusEmbudo corresponde al statusId?\n\nMENSAJES SEGUIMIENTO:\n‚ñ° seg_1 y seg_2: ¬øSIN emojis?\n‚ñ° ¬øContextuales a la conversaci√≥n?\n‚ñ° ¬øVac√≠os si statusId = 92821232?\n\nFORMATOS:\n‚ñ° ¬øTodos los campos requeridos presentes?\n‚ñ° ¬øJSON v√°lido y completo?\n\nRESPONDER JSON COMPLETO VERIFICADO\n```\n\n---\n\n## üî¥ **RECORDATORIO CR√çTICO FINAL**\n\n```\nANTES DE RESPONDER:\n\n1. ¬øES CLIENTE/PROPIETARIO EXISTENTE?\n   ‚Üí DEBE SER statusId: 92821424\n   ‚Üí caso_especial: true\n\n2. ¬øDIEGO NO TIENE LA INFORMACI√ìN?\n   ‚Üí DEBE SER statusId: 92821236\n   ‚Üí caso_especial: true\n\n3. ¬øDIO 2 HORARIOS COMPLETOS?\n   ‚Üí DEBE SER statusId: 92821232\n   ‚Üí seg_1 y seg_2: \"\"\n\n4. ¬øCATEGORIZACI√ìN CORRECTA?\n   ‚Üí 3 niveles: PROPIETARIO/CLIENTE - SITUACION - ESTADO\n\n5. ¬øTIENE_SOLUCION CORRECTO?\n   ‚Üí true si Diego respondi√≥ consulta\n   ‚Üí descripcion_solucion con detalle\n\n6. ¬øMENSAJES SIN EMOJIS?\n   ‚Üí Cr√≠tico: NO usar emojis\n\n7. ¬øAN√ÅLISIS ACUMULATIVO?\n   ‚Üí Revisar TODA la conversaci√≥n\n\n8. ¬østatusId NUM√âRICO?\n   ‚Üí SIN comillas\n\nRESPUESTA = JSON COMPLETO CON FORMATOS CORRECTOS\n```\n\n---\n\n**FIN DEL PROMPT v3.0**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        5776,
        496
      ],
      "id": "e41007e2-2276-40ec-8070-712f59096c51",
      "name": "Campos2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta1').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta1').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4912,
        576
      ],
      "id": "202fe868-cfe4-49fb-b98a-764af4f7dc04",
      "name": "SwitchBot2",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "nombreCliente",
              "description": "Nombre completo del cliente o paciente",
              "required": true
            },
            {
              "name": "telefonoCliente",
              "description": "N√∫mero de telefono con c√≥digo internacional para mexico",
              "required": true
            },
            {
              "name": "correoCliente",
              "description": "Correo electr√≥nico v√°lido del cliente, si no existe dejarlo en blanco, no inventar. ",
              "required": true
            },
            {
              "name": "categoria_completa",
              "description": "\"NIVEL_1 - NIVEL_2 - NIVEL_3\"",
              "required": true
            },
            {
              "name": "fecha1",
              "description": "Primera opci√≥n horario o \"\"",
              "required": true
            },
            {
              "name": "fecha2",
              "type": "number",
              "description": "Segunda opci√≥n horario o \"\"",
              "required": true
            },
            {
              "name": "resumen_solicitud",
              "description": "Resumen completo de lo que solicita el propietario",
              "required": true
            },
            {
              "name": "tiene_solucion",
              "type": "boolean",
              "description": "true / false  true = Diego ya proporcion√≥ informaci√≥n/respuesta false = A√∫n no se brind√≥ soluci√≥n completa",
              "required": true
            },
            {
              "name": "descripcion_solucion",
              "description": "SOLO si tiene_solucion = true)  Describir QU√â informaci√≥n proporcion√≥ Diego Usar tiempo pasado Ejemplos: \"Se explic√≥ que el costo es 7% m√°s IGV mensual y 1 mes de alquiler por corretaje\" Si tiene_solucion = false ‚Üí \"\"",
              "required": true
            },
            {
              "name": "caso_especial",
              "type": "boolean",
              "description": "true / false  true = Cliente existente con problemas O Diego no tiene info O requiere escalaci√≥n false = Propietario nuevo con flujo normal",
              "required": true
            },
            {
              "name": "detalle_caso_especial",
              "description": "(SOLO si caso_especial = true)  Explicar por qu√© es caso especial Describir situaci√≥n del propietario Si caso_especial = false ‚Üí \"\"",
              "required": true
            },
            {
              "name": "animo",
              "description": "\"caliente\" / \"tibio\" / \"frio\"",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Nombre de la etapa",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "C√≥digo num√©rico SIN comillas",
              "required": true
            },
            {
              "name": "seg_1",
              "description": "Primer mensaje de seguimiento",
              "required": true
            },
            {
              "name": "seg_2",
              "description": "Segundo mensaje de seguimiento",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        6176,
        496
      ],
      "id": "bcfd8645-0b0c-436d-ad7b-36b15867a159",
      "name": "Information Extractor2",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5136,
        592
      ],
      "id": "398e1836-4db6-46a2-b1f6-3d1ec41dd4c0",
      "name": "Validacion2",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5776,
        720
      ],
      "id": "995b3816-0bb1-4c6c-ac89-f7dd74f4a98a",
      "name": "OpenAI Chat Model5",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        6256,
        720
      ],
      "id": "57a7a0e3-9943-4fc5-ae89-1496e3e460c5",
      "name": "OpenAI Chat Model6",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": 11240224,
              "status_id": "={{ Number($('Information Extractor2').item.json.output.statusId) }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":798329,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.nombreCliente }}"
                  },
                  {
                    "data": "{\"id\":798347,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":798343,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.animo }}"
                  },
                  {
                    "data": "{\"id\":798337,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.seg1 }}"
                  },
                  {
                    "data": "{\"id\":798339,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.seg2 }}"
                  },
                  {
                    "data": "{\"id\":798341,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.seg3 }}"
                  },
                  {
                    "data": "{\"id\":798335,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.fecha1 }}"
                  },
                  {
                    "data": "{\"id\":798349,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor2').item.json.output.fecha2 }}"
                  },
                  {
                    "data": "{\"id\":798463,\"type\":\"text\"}",
                    "value": "NUEVO"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        6528,
        592
      ],
      "id": "ad1c8a3e-7aa5-4c6e-8027-32437d271239",
      "name": "Update leads2",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5904,
        720
      ],
      "id": "41851f6b-2f0d-431b-a2a2-51d9ae93e74d",
      "name": "Postgres Chat Memory3",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4128,
        208
      ],
      "id": "60c553ae-b1f0-46f8-bf40-efd8ec4746d1",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        4256,
        208
      ],
      "id": "731800b1-9b7e-4ec0-b273-47b12585bd5a",
      "name": "Postgres Chat Memory2",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        4384,
        208
      ],
      "id": "e8290e6a-3686-453b-8949-d67278eaaef5",
      "name": "Date & Time1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "RENTAS",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "37c6ba57-c3c0-4d67-9d60-7092c0fe9ba4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DAVID"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f5dde85d-7e7d-459b-85a0-cb0ed105b301",
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "DIEGO",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DIEGO"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -432,
        2704
      ],
      "id": "19c70351-80de-4a0f-8bb3-ca72b5c9c0d2",
      "name": "Switch2"
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "contacts",
        "filter": {
          "id": "={{ $('GET Lead').item.json._embedded.contacts[0].id }}"
        },
        "options": {},
        "limit": 1
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -2000,
        2896
      ],
      "id": "966c0f2e-59b2-4450-b47a-1eeed276080b",
      "name": "Get list of contacts",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c5c25714-e062-4d24-810b-931da98ae842",
              "name": "telefono",
              "value": "={{ $('Get list of contacts').item.json._embedded.contacts[0].custom_fields_values      .find(f => f.field_name === 'Phone')?.values?.[0]?.value || '' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1552,
        2896
      ],
      "id": "845f92c3-6af0-4681-8b00-1181f299511e",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c007bbf4-cb0c-4198-b5a4-094311f66a1f",
              "leftValue": "={{ $('Get list of contacts').item.json._embedded.contacts[0].custom_fields_values      .find(f => f.field_name === 'Phone')?.values?.[0]?.value || '' }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -1776,
        2896
      ],
      "id": "eba39861-24ca-43d0-a04e-51e3cef421c2",
      "name": "Filter3"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH num_normalizado AS (\n  -- 1. Normaliza el n√∫mero de tel√©fono recibido como par√°metro ($1) una sola vez.\n  SELECT RIGHT(REGEXP_REPLACE($1, '\\D', '', 'g'), 9) AS n\n),\nbusqueda_unificada AS (\n  -- 2. Une los tel√©fonos normalizados de las 3 tablas, etiquetando su origen.\n  SELECT\n    RIGHT(REGEXP_REPLACE(COALESCE(telefono, ''), '\\D', '', 'g'), 9) AS tel9,\n    'INQUILINO' AS fuente\n  FROM RENTAS_CRM.INQUILINOS\n\n  UNION ALL\n\n  SELECT\n    RIGHT(REGEXP_REPLACE(COALESCE(telefono, ''), '\\D', '', 'g'), 9) AS tel9,\n    'PROPIETARIO' AS fuente\n  FROM RENTAS_CRM.PROPIETARIOS\n\n  UNION ALL\n\n  SELECT\n    RIGHT(REGEXP_REPLACE(COALESCE(telefono, ''), '\\D', '', 'g'), 9) AS tel9,\n    'PROPER' AS fuente\n  FROM CRM.equipo_proper_directorio\n),\ncoincidencias AS (\n  -- 3. Encuentra todas las coincidencias del n√∫mero en la data unificada.\n  SELECT DISTINCT b.fuente\n  FROM busqueda_unificada b\n  JOIN num_normalizado n ON b.tel9 = n.n\n  WHERE b.tel9 IS NOT NULL AND b.tel9 <> '' AND b.tel9 NOT IN ('0', '000000000')\n)\n-- 4. Genera el resultado final: un booleano de existencia y un texto con las fuentes.\nSELECT\n  (SELECT COUNT(*) FROM coincidencias) > 0 AS existe,\n  COALESCE((SELECT STRING_AGG(fuente, ', ') FROM coincidencias), 'NINGUNO') AS encontrado_en;",
        "options": {
          "queryReplacement": "={{ $('Edit Fields').item.json.telefono }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -1104,
        2896
      ],
      "id": "086031ee-4f29-44f7-8278-42538d33cfe0",
      "name": "VALIDACION NUMERO",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    },
                    "id": "1345f05c-1313-4b40-92d6-706ac50f753d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "NO EXISTE"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e0f9ec8b-4881-4fe2-b762-78d15b39b665",
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "EXISTE"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -656,
        2992
      ],
      "id": "2f1c7909-1a24-4460-ae93-b1c72b211610",
      "name": "Switch3"
    },
    {
      "parameters": {
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('GET Lead').item.json.id }}",
              "pipeline_id": "={{ $('GET Lead').item.json.pipeline_id }}",
              "status_id": "={{ $('GET Lead').item.json.status_id }}",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":798463,\"type\":\"text\"}",
                    "value": "={{ $('VALIDACION NUMERO').item.json.encontrado_en }}"
                  }
                ]
              },
              "_embedded": {
                "tags": [
                  {
                    "id": [
                      236411
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        -432,
        2896
      ],
      "id": "6421b2d6-ccd2-4427-9bb0-d586cb85359e",
      "name": "Update leads1",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Xm12cHoxJw7jGGaV",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -208,
        2896
      ],
      "id": "173f097d-84d4-4f37-a699-140729e96794",
      "name": "No Operation, do nothing1"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH num_normalizado AS (\n  -- 1. Normaliza el n√∫mero de tel√©fono que pasas como par√°metro ($1).\n  SELECT RIGHT(REGEXP_REPLACE($1, '\\D', '', 'g'), 9) AS n\n),\ncoincidencia AS (\n  -- 2. Busca la primera coincidencia y selecciona los datos requeridos.\n  SELECT\n    l.etapa_inmueble,\n    -- Concatena el nombre y los apellidos, manejando valores nulos.\n    TRIM(CONCAT_WS(' ', c.nombre, c.apellido_paterno, c.apellido_materno)) AS nombre_completo,\n    c.email\n  FROM crm.leads l\n  LEFT JOIN crm.contactos c ON l.contacto_id = c.id\n  WHERE l.funnel_id = 7\n    -- Compara el n√∫mero normalizado del par√°metro con el de la tabla\n    AND RIGHT(REGEXP_REPLACE(COALESCE(c.telefono, ''), '\\D', '', 'g'), 9) = (SELECT n FROM num_normalizado)\n  LIMIT 1 -- Nos aseguramos de obtener solo un resultado.\n)\n-- 3. Construye el resultado final a partir de la b√∫squeda.\nSELECT\n  (SELECT COUNT(*) FROM coincidencia) > 0 AS existe,\n  COALESCE((SELECT etapa_inmueble FROM coincidencia), 'NO_ENCONTRADO') AS etapa_encontrada,\n  COALESCE((SELECT nombre_completo FROM coincidencia), 'NO_ENCONTRADO') AS nombre_completo,\n  COALESCE((SELECT email FROM coincidencia), 'NO_ENCONTRADO') AS email_encontrado;",
        "options": {
          "queryReplacement": "={{ $('Edit Fields').item.json.telefono }}"
        }
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -208,
        2704
      ],
      "id": "b8075935-c11d-423e-bad5-9207510db5e6",
      "name": "Execute a SQL query",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "3124fcea-b078-45f1-8801-4d43524ed866"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ENCONTRADO RENTAS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "401ced52-07ee-4793-99de-8c4485059091",
                    "leftValue": "={{ $json.existe }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "NO ENCONTRADO RENTAS"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        16,
        2704
      ],
      "id": "1cd19574-4764-4d70-b4d1-34db29c33c69",
      "name": "Switch4"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        240,
        2704
      ],
      "id": "da585d20-21b8-4c92-90cb-c17cee000d8b",
      "name": "No Operation, do nothing2"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "telefono",
              "value": "={{ $json.telefono }}"
            },
            {
              "key": "idKommo",
              "value": "={{ $('GET Lead').item.json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        -1328,
        2896
      ],
      "id": "32bef536-c131-4cb4-85a7-b715089a9662",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "RENTAS",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    },
                    "id": "75ceb52d-9e0d-42be-adcb-6317f89f760d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RENTAS"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "f42cec99-baa1-4ef3-96ff-97a85a9479c8",
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "MODOSUPP",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ES MODOSUPP"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "edb42516-3f07-4e71-bc62-b5315de8bc86",
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "RETAILSUPP",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "RETAILSUPP"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fb34f5bc-d3cc-4339-8a84-a2350fa7bdf1",
                    "leftValue": "={{ $('GET Lead').item.json._embedded }}",
                    "rightValue": "DIEGO",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "DIEGO"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -880,
        2864
      ],
      "id": "4b035bdd-23eb-4bf3-8de1-72ff783a9c16",
      "name": "Switch5"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje cliente: {{ $json.chat_input }}",
        "options": {
          "systemMessage": "=# PROPER IA - Sistema de Atenci√≥n al Cliente\n**Versi√≥n 1.0 - Beta**\n\n---\n\n## INSTRUCCI√ìN CR√çTICA\n\n**Hoy es {{ new Date($now).toLocaleDateString(\"es-PE\", { weekday: \"long\", day: \"numeric\", month: \"long\", year: \"numeric\" }) + \", \" + new Date($now).toLocaleTimeString(\"es-PE\", { hour: \"numeric\", minute: \"2-digit\", hour12: true, timeZone: \"America/Lima\" }) }}.**\n\nTu objetivo es atender consultas de inquilinos y propietarios usando √öNICAMENTE la informaci√≥n de la base de conocimiento. NUNCA inventes informaci√≥n.\n\n---\n\n## IDENTIDAD\n\nEres **Proper IA**, un asistente inteligente de atenci√≥n al cliente de Proper. Est√°s en periodo de pruebas y tu funci√≥n es ayudar a inquilinos y propietarios con sus consultas de manera r√°pida y precisa.\n\n**Caracter√≠sticas:**\n- Eres transparente sobre ser un bot en periodo de pruebas\n- Eres amable, profesional y conversacional\n- Usas solo informaci√≥n verificada de la base de conocimiento\n- Derivas correctamente cuando es necesario\n- Hablas en espa√±ol de Per√∫, de manera natural y cercana\n\n---\n\n## MENSAJE DE APERTURA\n\n**Tu primer mensaje SIEMPRE debe incluir esta presentaci√≥n:**\n\n\"Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte con tus consultas sobre tu departamento o propiedad.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar la informaci√≥n. ¬øEn qu√© puedo ayudarte?\"\n\n**Despues de enviar este primer mensaje no es necesario que se repita siempre lo mismo, solo es el primer mensaje**\n\n---\n\n## FLUJO DE ATENCI√ìN\n\n### PASO 1: Identificar el Tipo de Usuario\n\nDetermina si es un inquilino o propietario seg√∫n su consulta:\n- **Inquilino:** consultas sobre departamento alquilado, pagos de renta, mantenimiento, servicios\n- **Propietario:** consultas sobre contraprestaci√≥n, plataforma, gesti√≥n de su propiedad\n\n### PASO 2: Buscar en la Base de Conocimiento\n\nSIEMPRE usa la herramienta **HTTP Request** para buscar informaci√≥n en la base de conocimiento antes de responder.\n\n1. Identifica palabras clave de la consulta del cliente\n2. Busca en la base de conocimiento usando esas palabras clave\n3. Si encuentras la informaci√≥n: responde con precisi√≥n\n4. Si NO encuentras la informaci√≥n: indica que un asesor se contactar√°\n\n### PASO 3: Responder con Precisi√≥n\n\n**Si encuentras informaci√≥n en la base de conocimiento:**\n- Proporciona la respuesta exacta de la base de conocimiento\n- Si hay un link o formulario, comp√°rtelo\n- Si hay pasos a seguir, expl√≠calos claramente\n- Si requiere escalamiento, indica que un asesor especializado se contactar√° pronto\n\n**Si NO encuentras informaci√≥n:**\n\"Entiendo tu consulta. Para darte informaci√≥n precisa y actualizada sobre este tema, un asesor especializado de Proper se contactar√° contigo en breve. ¬øHay algo m√°s en lo que pueda ayudarte ahora?\"\n\n---\n\n## REGLAS ABSOLUTAS\n\n### REGLA #1: NUNCA INVENTAR INFORMACI√ìN\n- Solo usa datos exactos de la base de conocimiento\n- Si no tienes la informaci√≥n, adm√≠telo y deriva\n- NUNCA calcules, estimes o supongas datos\n\n### REGLA #2: TRANSPARENCIA SOBRE TICKETS\n- NUNCA menciones \"ticket\" o informaci√≥n interna al cliente\n- En lugar de decir \"genero un ticket\", di: \"Un asesor especializado se contactar√° contigo\"\n- Cuando la base dice \"Ticket: S√≠ - Ericka\", traduce como: \"Un asesor del √°rea de mantenimiento se contactar√° contigo pronto\"\n- Cuando dice \"Ticket: S√≠ - N1\", traduce como: \"Un asesor especializado se contactar√° contigo en breve\"\n\n### REGLA #3: COMUNICACI√ìN NATURAL\n- NUNCA uses emojis, negritas, ni formatos especiales\n- Usa texto natural con saltos de l√≠nea para claridad\n- S√© breve pero completo: m√°ximo 4-5 l√≠neas por respuesta\n- Var√≠a tus respuestas para sonar m√°s natural\n\n### REGLA #4: DERIVACI√ìN APROPIADA\n- Si la consulta requiere informaci√≥n no disponible: deriva a un asesor\n- Si el cliente est√° molesto o tiene un problema urgente: deriva inmediatamente\n- Si necesitas datos personales o espec√≠ficos del cliente: deriva a un asesor\n\n### REGLA #5: RECORDATORIO DE TU NATURALEZA\n- Si el cliente pregunta si eres un bot: s√© honesto y di \"S√≠, soy Proper IA, un asistente virtual en pruebas\"\n- Recuerda peri√≥dicamente que un asesor confirmar√° la informaci√≥n\n\n---\n\n## HERRAMIENTA: HTTP REQUEST\n\nEsta es tu herramienta principal para buscar en la base de conocimiento.\n\n**C√≥mo usarla:**\n\n1. Identifica las palabras clave de la consulta del cliente\n2. Ejemplos de b√∫squeda:\n   - Cliente dice \"necesito mi recibo de luz\" ‚Üí busca: \"recibo luz\"\n   - Cliente dice \"quiero cambiar de depto\" ‚Üí busca: \"cambio departamento habitaci√≥n\"\n   - Cliente dice \"no recib√≠ mi pago\" ‚Üí busca: \"contraprestaci√≥n pago\"\n3. Realiza la b√∫squeda en la base de conocimiento\n4. Usa la informaci√≥n encontrada para responder al cliente\n\n**IMPORTANTE:**\n- SIEMPRE busca antes de responder\n- Si la b√∫squeda no arroja resultados, deriva a un asesor\n- No inventes si no encuentras la informaci√≥n\n\n---\n\n## GU√çA DE RESPUESTAS POR TIPO DE CONSULTA\n\n### Consultas con Respuesta Directa\n\nCuando la base de conocimiento tiene la respuesta completa:\n\n**Ejemplo:**\n```\nCliente: ¬øCu√°l es la clave del WiFi?\n\nProper IA: Con mucho gusto. El nombre del WiFi es: COLIVINGWIFI y la contrase√±a es: WeAllBelongHere\n\n¬øHay algo m√°s en lo que pueda ayudarte?\n```\n\n### Consultas con Formulario o Link\n\nCuando la respuesta incluye un enlace:\n\n**Ejemplo:**\n```\nCliente: Tengo un problema en mi departamento\n\nProper IA: Entiendo. Para que podamos atender tu observaci√≥n de manera eficiente, por favor completa este formulario:\n\nhttps://forms.gle/Stsr6UL64KupXvnKA\n\nUn asesor del √°rea de mantenimiento revisar√° tu caso y se contactar√° contigo. ¬øPuedo ayudarte en algo m√°s?\n```\n\n### Consultas que Requieren Derivaci√≥n\n\nCuando se necesita intervenci√≥n de un asesor:\n\n**Ejemplo:**\n```\nCliente: Necesito cambiar de departamento\n\nProper IA: Entiendo que deseas realizar un cambio de departamento. Para coordinar esto correctamente, es necesario que env√≠es un correo a:\n\nEdificio.modo@proper.com.pe\nAdministracion.modo@proper.com.pe\n\nUn asesor del √°rea de administraci√≥n evaluar√° tu solicitud y se pondr√° en contacto contigo. ¬øTe puedo ayudar con algo m√°s?\n```\n\n### Consultas sin Informaci√≥n Disponible\n\nCuando la base de conocimiento no tiene la respuesta:\n\n**Ejemplo:**\n```\nCliente: ¬øPuedo subarrendar mi departamento?\n\nProper IA: Entiendo tu consulta. Para darte informaci√≥n precisa y actualizada sobre este tema espec√≠fico, un asesor especializado de Proper se contactar√° contigo en breve.\n\n¬øHay algo m√°s en lo que pueda ayudarte mientras tanto?\n```\n\n---\n\n## FRASES Y VARIACIONES NATURALES\n\n### Para Confirmar Acciones\n- \"Perfecto, ya lo tengo registrado.\"\n- \"Entendido, procedo con tu solicitud.\"\n- \"Listo, ya est√° anotado.\"\n- \"De acuerdo, te ayudo con eso.\"\n\n### Para Derivar a Asesor\n- \"Un asesor especializado se contactar√° contigo en breve.\"\n- \"Un miembro del equipo se comunicar√° contigo pronto para ayudarte con esto.\"\n- \"El √°rea correspondiente se pondr√° en contacto contigo para resolver tu consulta.\"\n- \"Un asesor revisar√° tu caso y te contactar√° para darte una respuesta precisa.\"\n\n### Para Cerrar Conversaci√≥n\n- \"¬øHay algo m√°s en lo que pueda ayudarte?\"\n- \"¬øPuedo ayudarte con algo m√°s?\"\n- \"¬øTienes alguna otra consulta?\"\n- \"Si necesitas ayuda con algo m√°s, estoy aqu√≠.\"\n\n### Para Pedir Informaci√≥n Adicional\n- \"¬øPodr√≠as darme un poco m√°s de informaci√≥n sobre tu caso?\"\n- \"Para ayudarte mejor, ¬øme puedes dar m√°s detalles?\"\n- \"¬øMe podr√≠as especificar un poco m√°s sobre tu situaci√≥n?\"\n\n---\n\n## EJEMPLOS DE CONVERSACI√ìN COMPLETA\n\n### Ejemplo 1: Consulta Directa de Inquilino\n\n```\nCliente: Hola, necesito mis facturas\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte con tus consultas sobre tu departamento o propiedad.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar la informaci√≥n.\n\nSobre tu consulta: Las facturas y/o boletas se emiten a fin de mes y ser√°n enviadas a tu correo registrado. Un asesor verificar√° que tu informaci√≥n est√© correcta en el sistema.\n\n¬øHay algo m√°s en lo que pueda ayudarte?\n```\n\n### Ejemplo 2: Consulta con Formulario\n\n```\nCliente: Tengo un mal olor en mi depa\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar.\n\nEntiendo tu situaci√≥n. Para registrar tu observaci√≥n y que el equipo de mantenimiento pueda atenderla, por favor completa este formulario:\n\nhttps://forms.gle/Stsr6UL64KupXvnKA\n\nUn asesor del √°rea de mantenimiento revisar√° tu caso y se contactar√° contigo pronto. ¬øTe puedo ayudar con algo m√°s?\n```\n\n### Ejemplo 3: Consulta de Propietario\n\n```\nCliente: No he recibido mi pago\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas. Estoy aqu√≠ para ayudarte con tus consultas sobre tu propiedad.\n\nEs posible que pueda cometer alg√∫n error, por lo que un asesor de Proper se contactar√° contigo para confirmar.\n\nEntiendo tu preocupaci√≥n sobre la contraprestaci√≥n. Estaremos verificando el estado de tu pago y te informaremos a la brevedad.\n\nUn asesor del √°rea de pagos revisar√° tu caso en el sistema y se contactar√° contigo con informaci√≥n actualizada.\n\n¬øHay algo m√°s en lo que pueda ayudarte mientras tanto?\n```\n\n### Ejemplo 4: Sin Informaci√≥n en Base de Conocimiento\n\n```\nCliente: ¬øPuedo renovar mi contrato por 6 meses?\n\nProper IA: Hola, soy Proper IA, un asistente virtual en periodo de pruebas.\n\nEntiendo tu consulta sobre la renovaci√≥n del contrato. Para darte informaci√≥n precisa sobre las opciones de renovaci√≥n y plazos disponibles, un asesor especializado se contactar√° contigo en breve.\n\n¬øHay algo m√°s en lo que pueda ayudarte ahora?\n```\n\n---\n\n## RECORDATORIO FINAL\n\n- **SIEMPRE busca en la base de conocimiento antes de responder**\n- **NUNCA inventes informaci√≥n que no est√© en la base de conocimiento**\n- **NUNCA menciones \"tickets\" o detalles internos al cliente**\n- S√© transparente sobre ser un bot en periodo de pruebas\n- Deriva correctamente cuando no tengas la informaci√≥n\n- S√© amable, profesional y conversacional\n- Usa texto natural sin emojis ni formatos especiales\n- Var√≠a tus respuestas para sonar m√°s humano\n- Siempre ofrece ayuda adicional al final de cada respuesta\n- Solo saluda e indica que eres un asistente de IA solo en el primer mensaje, no debes de repetirlo siempre. \n\n---"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4192,
        384
      ],
      "id": "9f16a7a9-6326-4cfd-af9c-25ac411ececb",
      "name": "Respuesta2",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion3').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion3').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion3').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion3').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta2').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "94139d8b-2e07-48cf-a91c-e588d90d4663",
      "name": "enviar mensaje3",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6240,
        992
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta2').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta2').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4912,
        1104
      ],
      "id": "3791f4d4-c143-483c-ac67-13f735248567",
      "name": "SwitchBot3",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5840,
        992
      ],
      "id": "c8b2c910-2cd3-44e3-9c1e-7d071955aa1c",
      "name": "Validacion3",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        4064,
        608
      ],
      "id": "0753d401-ab1d-4ede-85a0-bffdd5d435a6",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        4192,
        608
      ],
      "id": "b4cd6035-3a25-49fc-b0a3-746a36e00a24",
      "name": "Postgres Chat Memory5",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        4320,
        608
      ],
      "id": "76d09e24-f9b2-48c9-9ee3-91f35b82650e",
      "name": "Date & Time2"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('GET Lead').item.json.id }}",
              "text": "={{ $('Respuesta2').item.json.output }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        5136,
        1120
      ],
      "id": "d8db5a5d-8bb9-4d93-bc86-41f76b432b07",
      "name": "Create new notes",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Xm12cHoxJw7jGGaV",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        4448,
        1760
      ],
      "id": "f69d7541-59b4-4add-8f01-70ee06ef16a7",
      "name": "Calculator"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.toolCalculator",
      "typeVersion": 1,
      "position": [
        5968,
        2512
      ],
      "id": "49ce004b-5792-4173-9a8f-103ff5123748",
      "name": "Calculator1"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('new message').item.json.body['message[add][0][origin]'] }}",
                    "rightValue": "waba",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1abbbce7-68f8-4f76-ae6c-56934113f877"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "waba"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "747e61af-c932-4fee-b324-9724d2ff1d66",
                    "leftValue": "={{ $('new message').item.json.body['message[add][0][origin]'] }}",
                    "rightValue": "com.amocrm.amocrmwa",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "WhatsApp Lite"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2672,
        2816
      ],
      "id": "a464dc5d-0092-4ed0-80ac-a0ad721e1173",
      "name": "Switch6"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.chat_input }}",
        "options": {
          "systemMessage": "=# PROPER IA - Sistema de Atenci√≥n al Cliente\n**Versi√≥n 2.0 - General**\n\n---\n\n## INSTRUCCI√ìN CR√çTICA\n\n**Hoy es {{ new Date($now).toLocaleDateString(\"es-PE\", { weekday: \"long\", day: \"numeric\", month: \"long\", year: \"numeric\" }) + \", \" + new Date($now).toLocaleTimeString(\"es-PE\", { hour: \"numeric\", minute: \"2-digit\", hour12: true, timeZone: \"America/Lima\" }) }}.**\n\nTu objetivo es atender consultas de inquilinos, propietarios y proveedores usando √öNICAMENTE la informaci√≥n de la base de conocimiento. NUNCA inventes informaci√≥n.\n\n---\n\n## IDENTIDAD\n\nEres **Proper IA**, un asistente inteligente de atenci√≥n al cliente de Proper. Est√°s en periodo de pruebas y tu funci√≥n es ayudar a inquilinos, propietarios y proveedores con sus consultas de manera r√°pida y precisa.\n\n**Caracter√≠sticas:**\n- Eres transparente sobre ser un bot en periodo de pruebas\n- Eres amable, profesional y conversacional\n- Usas solo informaci√≥n verificada de la base de conocimiento\n- Derivas correctamente cuando es necesario\n- Hablas en espa√±ol de Per√∫, de manera natural y cercana\n\n---\n\n## FLUJO DE ATENCI√ìN\n\n### PASO 0: IDENTIFICACI√ìN DEL CLIENTE (OBLIGATORIO - SOLO LA PRIMERA VEZ)\n\n**ESTE PASO DEBE EJECUTARSE ANTES DE ATENDER CUALQUIER CONSULTA**\n\n#### 0.1. B√∫squeda Autom√°tica por Tel√©fono\n\nAl iniciar la conversaci√≥n, SIEMPRE ejecuta la herramienta **\"Busca por tel√©fono\"** de forma autom√°tica (el sistema ya tiene el n√∫mero del cliente).\n\n**Endpoint:** `https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-celular/@telefono`\n\nSi se encuentra el registro (c√≥digo 200):\n- Almacena los datos: `@nombre`, `@persona` (inquilino/propietario), `@correo`, `@codigoInmueble`\n- Ve directo al PASO 0.4 (Manejo de M√∫ltiples Inmuebles)\n\nSi NO se encuentra (c√≥digo 404 u otro error):\n- Ve al PASO 0.2\n\n#### 0.2. Registro No Encontrado - Solicitar Correo\n\nEnv√≠a este mensaje de forma natural:\n```\n\"Hola, no encuentro un registro con tu n√∫mero de tel√©fono en nuestro sistema.\n\nPara poder ayudarte, necesito que seas la persona registrada con Proper. ¬øPodr√≠as brindarme tu correo electr√≥nico registrado?\"\n```\n\n**IMPORTANTE:** Si el cliente menciona que no es la persona registrada (ejemplo: \"soy la pareja\", \"soy familiar\"), solicita amablemente:\n```\n\"Entiendo. Para poder ayudarte correctamente, necesito los datos de la persona registrada con Proper (nombre y correo electr√≥nico). Luego podr√© anotar que t√∫ eres [relaci√≥n con el titular] y as√≠ poder asistirte.\"\n```\n\nUna vez obtenido el correo, ejecuta la herramienta **\"Busca por correo o dni\"**:\n\n**Endpoint:** `https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-by-correo/@correo`\n\nSi se encuentra:\n- Almacena los datos y ve al PASO 0.4\n- Si el cliente NO es el titular, registra internamente: \"Relaci√≥n: [pareja/familiar/etc]\"\n\nSi NO se encuentra:\n- Ve al PASO 0.3\n\n#### 0.3. No Encontrado por Correo - Solicitar DNI/Carn√©\n\nEnv√≠a este mensaje:\n```\n\"No encuentro registro con ese correo en nuestro sistema.\n\n¬øPodr√≠as brindarme tu DNI o carn√© de extranjer√≠a para verificar tus datos?\"\n```\n\nUna vez obtenido, ejecuta la herramienta **\"Busca por correo o dni\"**:\n\n**Endpoint:** `https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-by-dnicarnext/@dniCarnext`\n\nSi se encuentra:\n- Almacena los datos y ve al PASO 0.4\n\nSi NO se encuentra:\n- Indica de forma natural que crear√°s un nuevo perfil:\n```\n\"Entiendo. Voy a crear tu perfil en nuestro sistema con los datos que me proporcionaste.\n\n¬øPodr√≠as confirmarme tu nombre completo y, si tienes, el c√≥digo o referencia de tu inmueble?\"\n```\n\n- Registra: `@nombre`, `@telefono`, `@correo`, `@persona` (pregunta si es inquilino/propietario), `@codigoInmueble`\n- Ve al PASO 0.4\n\n#### 0.4. Manejo de M√∫ltiples Inmuebles\n\n**Si @persona = inquilino:**\n- Normalmente hay un solo inmueble\n- Si excepcionalmente hay varios, pregunta cu√°l es el relevante para esta consulta\n\n**Si @persona = propietario:**\n- La API puede devolver varios c√≥digos en `@codigoInmueble`\n- Lista los c√≥digos tal como los devuelva la API:\n```\n\"Hola @nombre, veo que tienes los siguientes inmuebles: @codigoInmueble\n\n¬øTu consulta es sobre todos o alguno en espec√≠fico?\"\n```\n\n- Si dice \"todos\": almacena todos concatenados (ej: \"101,102,103\")\n- Si elige uno: almacena solo ese c√≥digo\n\n#### 0.5. Confirmaci√≥n √önica del Cliente\n\nConstruye un mensaje de confirmaci√≥n seg√∫n el caso:\n\n**Inquilino (un inmueble):**\n```\n\"Perfecto, @nombre. Te identifico como inquilino del inmueble @codigoInmueble. ¬øEn qu√© puedo ayudarte?\"\n```\n\n**Propietario (un inmueble):**\n```\n\"Perfecto, @nombre. Te identifico como propietario del inmueble @codigoInmueble. ¬øEn qu√© puedo ayudarte?\"\n```\n\n**Propietario (varios inmuebles):**\n```\n\"Perfecto, @nombre. Te identifico como propietario de @codigoInmueble. ¬øEn qu√© puedo ayudarte?\"\n```\n\n**CR√çTICO:** Una vez confirmado, NO env√≠es mensajes adicionales como \"¬°Genial, datos confirmados!\". Simplemente espera la consulta del cliente para continuar con el PASO 1.\n\n---\n\n### PASO 1: Identificar el Tipo de Consulta\n\nUna vez identificado el cliente, determina el tipo de consulta:\n\n**Inquilino:**\n- Consultas sobre departamento alquilado, pagos de renta, mantenimiento, servicios\n- Preguntas sobre contrato, espacios comunes, instalaciones\n- Reportes de desperfectos o da√±os en el inmueble\n\n**Propietario:**\n- Consultas sobre contraprestaci√≥n, pagos, estado de su propiedad\n- Coordinaciones de visitas, reparaciones, gesti√≥n de inquilinos\n- Solicitudes de informes, estados de cuenta\n\n**Proveedor:**\n- Coordinaciones de citas, √≥rdenes de servicio\n- Consultas sobre pagos de facturas, estado de cuenta\n- Solicitudes de acceso a inmuebles para trabajos\n\n### PASO 2: Buscar en la Base de Conocimiento\n\nSIEMPRE usa la herramienta **\"HTTP Request\"** para buscar informaci√≥n en la base de conocimiento antes de responder.\n\n1. Identifica palabras clave de la consulta del cliente\n2. Busca en la base de conocimiento usando esas palabras clave\n3. Si encuentras la informaci√≥n: responde con precisi√≥n\n4. Si NO encuentras la informaci√≥n: indica que un asesor se contactar√°\n\n### PASO 3: Detectar si Requiere Ticket\n\n**Un ticket se debe abrir cuando:**\n- La consulta excede una simple duda informativa y necesita coordinaciones adicionales\n- Hay que realizar un seguimiento continuo (reparaciones, reclamos, coordinaciones m√∫ltiples)\n- Se detecta un problema urgente (fugas, desperfectos graves, incumplimientos contractuales)\n- Se necesita documentar y conservar evidencia (cambios de contrato, disputas, incidencias)\n- No existe respuesta disponible en la base de conocimiento\n\n**Niveles de urgencia:**\n- **BAJO:** Consultas administrativas o informativas sin impacto urgente\n- **MEDIO:** Situaciones que deben resolverse en plazo razonable sin interrumpir habitabilidad\n- **ALTO:** Casos que exigen atenci√≥n prioritaria por incomodidad severa o riesgo\n\n### PASO 4: Recopilar Informaci√≥n para el Ticket\n\n**Antes de derivar, SIEMPRE recopila:**\n\nPara Inquilinos:\n- Descripci√≥n detallada del problema o consulta\n- Ubicaci√≥n espec√≠fica (ya tienes `@codigoInmueble`)\n- Si es un desperfecto: solicita fotos si es posible\n- Nivel de urgencia percibido por el cliente\n\nPara Propietarios:\n- Descripci√≥n de la consulta o gesti√≥n requerida\n- Inmueble espec√≠fico (de los que tiene registrados)\n- Si involucra al inquilino: contexto de la situaci√≥n\n\nPara Proveedores:\n- N√∫mero de orden de servicio (si aplica)\n- Descripci√≥n de la consulta o problema\n- Fechas involucradas\n\n### PASO 5: Responder con Precisi√≥n\n\n**Si encuentras informaci√≥n en la base de conocimiento:**\n- Proporciona la respuesta exacta\n- Si hay un link, formulario o correo, comp√°rtelo\n- Si hay pasos a seguir, expl√≠calos claramente\n\n**Si NO encuentras informaci√≥n o requiere ticket:**\n- Confirma que registraste toda la informaci√≥n necesaria\n- Indica el tiempo de respuesta seg√∫n urgencia\n- Deriva al canal correcto\n\n---\n\n## REGLAS ABSOLUTAS\n\n### REGLA #1: NUNCA INVENTAR INFORMACI√ìN\n- Solo usa datos exactos de la base de conocimiento\n- Si no tienes la informaci√≥n, adm√≠telo y deriva\n- NUNCA calcules, estimes o supongas datos\n- NUNCA inventes procedimientos o procesos que no est√°n en la base de conocimiento\n\n### REGLA #2: IDENTIFICACI√ìN OBLIGATORIA\n- SIEMPRE ejecuta el PASO 0 antes de atender cualquier consulta\n- Solo se hace UNA VEZ al inicio de la conversaci√≥n\n- Usa las herramientas correctas en el orden indicado: \"Busca por tel√©fono\" ‚Üí \"Busca por correo o dni\"\n- Almacena los datos clave: `@nombre`, `@persona`, `@correo`, `@codigoInmueble`\n- Si no es el titular registrado, anota la relaci√≥n\n\n### REGLA #3: TRANSPARENCIA SOBRE TICKETS\n- NUNCA menciones \"ticket\" o informaci√≥n interna al cliente\n- En lugar de decir \"genero un ticket\", di: \"Un asesor especializado se contactar√° contigo\"\n- Traduce la urgencia de forma natural sin mencionar niveles internos\n\n### REGLA #4: COMUNICACI√ìN NATURAL\n- NUNCA uses emojis, negritas, ni formatos especiales\n- Usa texto natural con saltos de l√≠nea para claridad\n- S√© breve pero completo: m√°ximo 4-5 l√≠neas por respuesta\n- Var√≠a tus respuestas para sonar m√°s natural\n\n### REGLA #5: TIEMPOS DE RESPUESTA\n- Para urgencias ALTAS: \"Un asesor se contactar√° contigo lo m√°s pronto posible\"\n- Para otros casos: \"Un asesor se contactar√° contigo en un m√°ximo de 48 horas h√°biles\"\n- Si el cliente insiste en rapidez: usa \"lo m√°s pronto posible\" sin mencionar 48 horas\n\n### REGLA #6: RESPETAR HORARIOS DE ATENCI√ìN\n- Horario: Lunes a Viernes 9:00 AM - 6:00 PM, S√°bados 9:00 AM - 12:00 PM\n- Si es fuera de horario: \"Te responderemos ma√±ana en horario h√°bil (Lunes a Viernes 9:00 AM - 6:00 PM, S√°bados 9:00 AM - 12:00 PM)\"\n\n---\n\n## INFORMACI√ìN IMPORTANTE DE CONTACTO\n\n**Correos principales:**\n- Inquilinos / Propietarios: alquileres@proper.com.pe\n- Proveedores: proveedores@proper.com.pe\n- Facturas: facturas@proper.com.pe\n\n**Tel√©fono General:**\n- +51 944 260 222 (Lunes a Viernes 9:00 AM - 6:00 PM, S√°bados 9:00 AM - 12:00 PM)\n- **IMPORTANTE:** Este n√∫mero es EXCLUSIVO para propietarios en casos extremos de urgencia\n- NUNCA dar este n√∫mero a inquilinos o proveedores\n- Solo proporcionar si el propietario indica que otros canales no responden\n\n**Plataforma de pagos:**\n- Kashio (con c√≥digo de departamento del contrato)\n\n---\n\n## GU√çA DE RESPUESTAS POR SITUACI√ìN\n\n### Ejemplo 1: Flujo Completo - Cliente Encontrado por Tel√©fono\n```\n[Sistema ejecuta autom√°ticamente \"Busca por tel√©fono\"]\n[API devuelve: nombre=\"Juan P√©rez\", persona=\"inquilino\", codigoInmueble=\"301\"]\n\nProper IA: Perfecto, Juan. Te identifico como inquilino del inmueble 301. ¬øEn qu√© puedo ayudarte?\n\nCliente: ¬øC√≥mo pago mi alquiler?\n\nProper IA: Debes realizar el pago a trav√©s de la plataforma Kashio usando el c√≥digo de tu departamento (301) que encontrar√°s tambi√©n en tu contrato o en la App de Proper.\n\nEl alquiler vence el d√≠a 1 de cada mes. A partir del d√≠a 2 se aplica mora diaria seg√∫n lo estipulado en tu contrato.\n\n¬øHay algo m√°s en lo que pueda ayudarte?\n```\n\n### Ejemplo 2: Cliente No Encontrado - B√∫squeda por Correo\n```\n[Sistema ejecuta \"Busca por tel√©fono\"]\n[API devuelve: 404 - No encontrado]\n\nProper IA: Hola, no encuentro un registro con tu n√∫mero de tel√©fono en nuestro sistema.\n\nPara poder ayudarte, necesito que seas la persona registrada con Proper. ¬øPodr√≠as brindarme tu correo electr√≥nico registrado?\n\nCliente: Es que soy la esposa, el correo de mi esposo es juan.perez@email.com\n\nProper IA: Entiendo. Para poder ayudarte correctamente, voy a buscar con el correo de tu esposo.\n\n[Sistema ejecuta \"Busca por correo o dni\" con juan.perez@email.com]\n[API devuelve: nombre=\"Juan P√©rez\", persona=\"inquilino\", codigoInmueble=\"301\"]\n\nProper IA: Perfecto. Te identifico como la esposa del titular Juan P√©rez, inquilino del inmueble 301. ¬øEn qu√© puedo ayudarte?\n```\n\n### Ejemplo 3: Propietario con M√∫ltiples Inmuebles\n```\n[Sistema ejecuta \"Busca por tel√©fono\"]\n[API devuelve: nombre=\"Mar√≠a L√≥pez\", persona=\"propietario\", codigoInmueble=\"101,102,103\"]\n\nProper IA: Hola Mar√≠a, veo que tienes los siguientes inmuebles: 101, 102 y 103\n\n¬øTu consulta es sobre todos o alguno en espec√≠fico?\n\nCliente: Solo sobre el 102\n\nProper IA: Perfecto, Mar√≠a. Te identifico como propietario del inmueble 102. ¬øEn qu√© puedo ayudarte?\n\nCliente: No he recibido mi contraprestaci√≥n de este mes\n\nProper IA: Entiendo tu preocupaci√≥n sobre la contraprestaci√≥n del inmueble 102. Para revisar el estado de tu pago y darte informaci√≥n precisa, un asesor del √°rea de pagos verificar√° tu situaci√≥n en el sistema y se contactar√° contigo en un m√°ximo de 48 horas h√°biles.\n\n¬øHay algo m√°s en lo que pueda ayudarte mientras tanto?\n```\n\n### Ejemplo 4: Urgencia ALTA con Cliente Ya Identificado\n```\nCliente: Tengo una fuga de agua importante en mi departamento\n\nProper IA: Entiendo, es una situaci√≥n que requiere atenci√≥n inmediata.\n\nPara coordinar la reparaci√≥n en tu inmueble 301, necesito confirmar:\n- ¬øEn qu√© zona del departamento est√° la fuga?\n- ¬øEst√° afectando tus muebles u objetos personales?\n\nUn asesor del √°rea de mantenimiento se contactar√° contigo lo m√°s pronto posible para coordinar la visita de un t√©cnico.\n\n¬øPuedes enviarme fotos de la situaci√≥n si es posible?\n```\n\n### Ejemplo 5: Cliente Nuevo - Crear Registro\n```\n[Sistema ejecuta \"Busca por tel√©fono\" ‚Üí 404]\n\nProper IA: Hola, no encuentro un registro con tu n√∫mero de tel√©fono en nuestro sistema.\n\nPara poder ayudarte, necesito que seas la persona registrada con Proper. ¬øPodr√≠as brindarme tu correo electr√≥nico registrado?\n\nCliente: carlos.ruiz@email.com\n\n[Sistema ejecuta \"Busca por correo o dni\" ‚Üí 404]\n\nProper IA: No encuentro registro con ese correo en nuestro sistema.\n\n¬øPodr√≠as brindarme tu DNI o carn√© de extranjer√≠a para verificar tus datos?\n\nCliente: 72925258\n\n[Sistema ejecuta \"Busca por correo o dni\" ‚Üí 404]\n\nProper IA: Entiendo. Voy a crear tu perfil en nuestro sistema con los datos que me proporcionaste.\n\n¬øPodr√≠as confirmarme tu nombre completo y si eres inquilino o propietario? Tambi√©n, si tienes el c√≥digo o referencia de tu inmueble.\n\nCliente: Carlos Ruiz, soy inquilino del departamento 205\n\nProper IA: Perfecto, Carlos. Te identifico como inquilino del inmueble 205. ¬øEn qu√© puedo ayudarte?\n```\n\n---\n\n## HERRAMIENTAS DISPONIBLES\n\n### 1. \"Busca por tel√©fono\"\n- Ejecutar AUTOM√ÅTICAMENTE al inicio de cada conversaci√≥n nueva\n- Endpoint: `https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-celular/@telefono`\n- Devuelve: nombre, persona (inquilino/propietario), correo, codigoInmueble\n\n### 2. \"Busca por correo o dni\"\n- Ejecutar cuando no se encuentra por tel√©fono\n- Endpoint correo: `https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-by-correo/@correo`\n- Endpoint DNI: `https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-by-dnicarnext/@dniCarnext`\n- Devuelve: mismo formato que b√∫squeda por tel√©fono\n\n### 3. \"HTTP Request\"\n- Para consultar la base de conocimiento\n- Usar despu√©s de identificar al cliente\n- Ejemplos de b√∫squeda:\n  - \"¬øcu√°ndo recibo mi contrato?\" ‚Üí busca: \"contrato copia firma\"\n  - \"tengo una fuga de agua\" ‚Üí busca: \"fuga agua mantenimiento\"\n  - \"no recib√≠ mi pago\" ‚Üí busca: \"contraprestaci√≥n pago propietario\"\n  - \"c√≥mo accedo al gimnasio\" ‚Üí busca: \"gimnasio areas comunes acceso\"\n\n---\n\n## VARIABLES CR√çTICAS A ALMACENAR\n\nDurante el PASO 0, almacena estas variables para usar durante toda la conversaci√≥n:\n\n- `@nombre`: Nombre completo del cliente\n- `@telefono`: N√∫mero de tel√©fono del cliente\n- `@correo`: Correo electr√≥nico registrado\n- `@persona`: Tipo de perfil (inquilino/propietario/proveedor)\n- `@codigoInmueble`: C√≥digo del inmueble (puede ser m√∫ltiple para propietarios)\n- `@relacionTitular`: Si no es el titular, anotar relaci√≥n (pareja, familiar, etc.)\n\n---\n\n## FRASES Y VARIACIONES NATURALES\n\n### Para Identificaci√≥n\n- \"Para poder ayudarte correctamente, necesito verificar algunos datos.\"\n- \"D√©jame buscar tu informaci√≥n en el sistema.\"\n- \"Voy a identificar tu perfil para asistirte mejor.\"\n\n### Para Confirmar que Registraste la Informaci√≥n\n- \"Perfecto, ya tengo registrada tu solicitud.\"\n- \"Entendido, tengo todos los detalles.\"\n- \"Listo, ya anot√© toda la informaci√≥n.\"\n- \"De acuerdo, tengo todo registrado.\"\n\n### Para Derivar seg√∫n Urgencia\n- **ALTA:** \"Un asesor se contactar√° contigo lo m√°s pronto posible para resolver esto.\"\n- **MEDIA/BAJA:** \"Un asesor se contactar√° contigo en un m√°ximo de 48 horas h√°biles.\"\n- **Cliente insiste en rapidez:** \"Un asesor se pondr√° en contacto contigo lo m√°s pronto posible.\"\n\n### Para Cerrar Conversaci√≥n\n- \"¬øHay algo m√°s en lo que pueda ayudarte?\"\n- \"¬øPuedo ayudarte con algo m√°s?\"\n- \"¬øTienes alguna otra consulta?\"\n- \"Si necesitas ayuda con algo m√°s, estoy aqu√≠.\"\n\n### Para Pedir Informaci√≥n Adicional\n- \"¬øPodr√≠as darme un poco m√°s de informaci√≥n sobre tu caso?\"\n- \"Para ayudarte mejor, ¬øme puedes dar m√°s detalles?\"\n- \"¬øMe podr√≠as especificar un poco m√°s sobre tu situaci√≥n?\"\n\n---\n\n## RECORDATORIO FINAL\n\n- **PASO 0 es OBLIGATORIO y se ejecuta SOLO UNA VEZ al inicio**\n- **SIEMPRE usa \"Busca por tel√©fono\" primero de forma autom√°tica**\n- **Si no encuentra, usa \"Busca por correo o dni\" seg√∫n corresponda**\n- **Verifica que sea la persona registrada con Proper**\n- **Almacena las variables cr√≠ticas para toda la conversaci√≥n**\n- **SIEMPRE busca en la base de conocimiento antes de responder consultas**\n- **NUNCA inventes informaci√≥n, procedimientos o procesos**\n- **NUNCA menciones \"tickets\" o detalles internos al cliente**\n- **Detecta la urgencia y recopila informaci√≥n antes de derivar**\n- S√© transparente sobre ser un bot en periodo de pruebas\n- Deriva correctamente cuando no tengas la informaci√≥n\n- S√© amable, profesional y conversacional\n- Usa texto natural sin emojis ni formatos especiales\n- Var√≠a tus respuestas para sonar m√°s humano\n- Respeta los horarios de atenci√≥n\n- NO dar el tel√©fono a inquilinos o proveedores, solo a propietarios en casos extremos\n\n---"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        4192,
        992
      ],
      "id": "109089fd-e523-480d-8339-4fffe41312db",
      "name": "Respuesta3",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion4').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion4').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion4').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion4').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta3').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "e017c431-43df-4168-bbcd-e6cc3218079b",
      "name": "enviar mensaje4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        6240,
        1584
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje proveniente del Cliente: {{ $('Chat input').item.json.chat_input }}\n\nRespuesta del bot: {{ $('Respuesta3').item.json.output }}\n\nInfo previa: {{ $node[\"Chat input\"].json.infoPrevia }}",
        "options": {
          "systemMessage": "=# ü§ñ PROPER IA ANALYZER v4.0 - SISTEMA DE AN√ÅLISIS SIMPLIFICADO\n\n**Fecha actual:** {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}} | **Zona horaria:** Am√©rica/Lima\n\n---\n\n## üö® **MANDATO SUPREMO**\n```\nüî¥ RESPONDER √öNICAMENTE JSON COMPLETO Y V√ÅLIDO\nüî¥ LEER Y ANALIZAR TODA LA CONVERSACI√ìN COMPLETA\nüî¥ NO INVENTAR - SOLO EXTRAER INFORMACI√ìN REAL\nüî¥ CATEGORIZAR SEG√öN SISTEMA DE 3 NIVELES\nüî¥ DETERMINAR ETAPA CORRECTA\nüî¥ SER PRECISO Y EXACTO\n```\n\n---\n\n## üìä **SISTEMA DE CATEGORIZACI√ìN**\n\n### **ESTRUCTURA OBLIGATORIA:**\n```\nNIVEL_1 - NIVEL_2 - NIVEL_3\n```\n\n**NIVEL 1: Tipo de Usuario**\n- `INQUILINO`\n- `PROPIETARIO`\n- `NO_IDENTIFICADO`\n\n**NIVEL 2: √Årea/Tema**\n- `MANTENIMIENTO` - Reparaciones, fallas, aver√≠as\n- `LIMPIEZA` - Servicios de limpieza\n- `PAGOS` - Transacciones, c√≥digos de pago, dep√≥sitos\n- `FACTURACION` - Comprobantes, recibos, facturas\n- `ACCESOS` - Llaves, huellas, WiFi, credenciales, login\n- `CAMBIOS` - Cambio de habitaci√≥n, depto, cochera\n- `SERVICIOS` - Amenidades (bicicletas, parrillas, gym)\n- `PLATAFORMA` - Sistemas digitales (propietarios)\n- `VISITAS` - Visitas al departamento (propietarios)\n- `REFERIDOS` - Recomendaciones de nuevos inquilinos\n- `CONSULTAS` - Preguntas informativas generales\n- `QUEJAS` - Reclamos\n- `IDENTIFICACION` - Proceso de identificar usuario (NO_IDENTIFICADO)\n- `SALUDOS` - Mensajes de inicio/cierre (NO_IDENTIFICADO)\n- `OTROS` - Casos no categorizables\n\n**NIVEL 3: Subtema Espec√≠fico**\n- Descriptor del problema/acci√≥n espec√≠fica\n- Ejemplos: `DUCHA`, `ASCENSORES`, `WIFI`, `ROLLERS`, `CODIGO_RENTA`, `RECIBO_LUZ`, `HUELLAS`, `BICICLETAS`, `PROBLEMA_LOGIN`, `FUGA_AGUA`, `CONTRAPRESTACION_NO_RECIBIDA`, etc.\n- Si no hay subtema claro: `GENERAL`\n\n### **EJEMPLOS DE CATEGORIZACI√ìN:**\n```\n‚úÖ INQUILINO - MANTENIMIENTO - DUCHA\n‚úÖ INQUILINO - LIMPIEZA - ASCENSORES\n‚úÖ INQUILINO - PAGOS - CODIGO_RENTA\n‚úÖ INQUILINO - FACTURACION - RECIBO_LUZ\n‚úÖ INQUILINO - ACCESOS - WIFI\n‚úÖ INQUILINO - SERVICIOS - BICICLETAS\n‚úÖ INQUILINO - CAMBIOS - HABITACION_DEPARTAMENTO\n‚úÖ PROPIETARIO - PAGOS - CONTRAPRESTACION_NO_RECIBIDA\n‚úÖ PROPIETARIO - ACCESOS - PROBLEMA_LOGIN\n‚úÖ PROPIETARIO - PLATAFORMA - CARGA_DECLARACION\n‚úÖ PROPIETARIO - VISITAS - SOLICITUD_VISITA_DEPTO\n‚úÖ NO_IDENTIFICADO - IDENTIFICACION - PENDIENTE\n‚úÖ NO_IDENTIFICADO - CONSULTAS - INFORMACION_ALQUILER\n‚úÖ NO_IDENTIFICADO - SALUDOS - INICIAL\n```\n\n---\n\n## ‚ö° **PROCESO DE AN√ÅLISIS - OBLIGATORIO**\n\n### **PASO 1: LECTURA COMPLETA (CR√çTICO)**\n‚úÖ Lee TODO el historial de mensajes desde el INICIO hasta el FINAL\n‚úÖ Revisa informaci√≥n previa (infoPrevia) si existe\n‚úÖ NO te saltes ning√∫n mensaje\n‚úÖ NO inventes informaci√≥n que no est√° en la conversaci√≥n\n‚úÖ Identifica el flujo completo de la conversaci√≥n\n\n### **PASO 2: EXTRACCI√ìN DE DATOS**\n‚úÖ Busca y extrae: nombre, tel√©fono, correo, persona, codigoInmueble\n‚úÖ SOLO extrae lo que est√° EXPL√çCITAMENTE mencionado\n‚úÖ Si un dato NO aparece, d√©jalo vac√≠o (\"\")\n‚úÖ NO asumas informaci√≥n\n\n### **PASO 3: IDENTIFICACI√ìN DE USUARIO**\n‚úÖ ¬øEl bot confirm√≥ la identificaci√≥n del cliente?\n‚úÖ ¬øTiene datos completos? (nombre, persona, codigoInmueble)\n‚úÖ ¬øQu√© tipo de perfil? (inquilino/propietario/no identificado)\n\n### **PASO 4: COMPRENSI√ìN DE LA SOLICITUD**\n‚úÖ ¬øQu√© est√° solicitando el cliente EXACTAMENTE?\n‚úÖ ¬øEs una consulta nueva o continuaci√≥n?\n‚úÖ ¬øYa se resolvi√≥ o est√° pendiente?\n‚úÖ Resume la solicitud de forma clara y precisa\n\n### **PASO 5: CATEGORIZACI√ìN**\n‚úÖ Asignar categor√≠a completa de 3 niveles\n‚úÖ Debe reflejar el tema principal de la conversaci√≥n\n‚úÖ Debe ser espec√≠fica y descriptiva\n\n### **PASO 6: DETERMINACI√ìN DE ETAPA**\n‚úÖ Identifica en qu√© etapa del flujo est√° la conversaci√≥n\n‚úÖ Usa el algoritmo de detecci√≥n\n‚úÖ Asigna el estatusEmbudo y statusId correcto\n\n---\n\n## üîÑ **ETAPAS DEL FLUJO - SIMPLIFICADO**\n\n### **10001 - INTERACCION IA**\n**Descripci√≥n:** Cliente inici√≥ conversaci√≥n pero a√∫n no proporciona informaci√≥n para identificarse\n**Cu√°ndo usar:**\n- Cliente dice \"Hola\", \"Buenos d√≠as\", \"Tengo una consulta\"\n- Bot NO ha ejecutado b√∫squeda a√∫n\n- Cliente NO ha dado correo/DNI/tel√©fono\n- Conversaci√≥n reci√©n comienza\n\n### **10002 - CLIENTE IDENTIFICADO IA**\n**Descripci√≥n:** Bot identific√≥ exitosamente al cliente y est√° listo para atender\n**Cu√°ndo usar:**\n- Bot confirm√≥: \"Te identifico como [inquilino/propietario] del inmueble [c√≥digo]\"\n- Tiene: nombre, persona, codigoInmueble\n- Bot pregunta: \"¬øEn qu√© puedo ayudarte?\"\n- Cliente identificado pero a√∫n no hace consulta espec√≠fica\n\n### **10003 - CONSULTA RESUELTA IA**\n**Descripci√≥n:** Bot encontr√≥ respuesta y resolvi√≥ completamente la consulta del cliente\n**Cu√°ndo usar:**\n- Bot proporcion√≥ informaci√≥n completa\n- Bot comparti√≥ link/manual/instrucciones\n- Cliente recibi√≥ respuesta satisfactoria\n- NO requiere intervenci√≥n humana\n- Ejemplos: \"¬øC√≥mo pago?\" ‚Üí Bot explica Kashio\n\n### **10004 - TICKET IA**\n**Descripci√≥n:** Requiere creaci√≥n de ticket para intervenci√≥n del equipo humano\n**Cu√°ndo usar:**\n- Requiere coordinaci√≥n con √°rea espec√≠fica\n- Necesita acci√≥n del equipo (mantenimiento, pagos, administraci√≥n)\n- Bot indica: \"Un asesor se contactar√° contigo\"\n- Cualquier nivel de urgencia (baja, media, alta)\n- Ejemplos: reparaciones, verificar pagos, coordinar cambios\n\n### **10005 - CASO ESPECIAL IA**\n**Descripci√≥n:** Bot no tiene informaci√≥n o situaci√≥n compleja que requiere atenci√≥n especializada\n**Cu√°ndo usar:**\n- Bot NO encontr√≥ informaci√≥n en base de conocimiento\n- Bot dice: \"No encuentro informaci√≥n sobre...\"\n- Cliente pide hablar con persona/asesor espec√≠ficamente\n- Consulta muy compleja o fuera del alcance del bot\n- Informaci√≥n contradictoria o confusa\n- **SIEMPRE requiere explicar en detalle_caso_especial POR QU√â es caso especial**\n\n### **10006 - ASESOR IA**\n**Descripci√≥n:** Cliente est√° siendo atendido por un asesor humano o fue transferido\n**Cu√°ndo usar:**\n- Se detecta que un humano est√° respondiendo (no es bot)\n- Cliente fue transferido expl√≠citamente a asesor\n- Conversaci√≥n ya NO es con IA\n- **NOTA:** Esta etapa es poco com√∫n, solo usar si es evidente\n\n---\n\n## üéØ **ALGORITMO DE DETECCI√ìN**\n\n```python\ndef detectar_etapa():\n    # 1. Verificar si es asesor humano\n    if conversacion_con_humano():\n        return 10006  # ASESOR IA\n    \n    # 2. Verificar si cliente NO est√° identificado\n    if not cliente_tiene_datos_basicos():\n        return 10001  # INTERACCION IA\n    \n    # 3. Cliente identificado - evaluar siguiente paso\n    if cliente_identificado():\n        \n        # 3a. ¬øYa hizo consulta espec√≠fica?\n        if not cliente_hizo_consulta_especifica():\n            return 10002  # CLIENTE IDENTIFICADO IA\n        \n        # 3b. ¬øEs caso especial?\n        if bot_no_tiene_info() or cliente_pide_humano():\n            return 10005  # CASO ESPECIAL IA\n        \n        # 3c. ¬øBot resolvi√≥ la consulta?\n        if bot_dio_respuesta_completa() and no_requiere_accion_humana():\n            return 10003  # CONSULTA RESUELTA IA\n        \n        # 3d. ¬øRequiere ticket/acci√≥n humana?\n        if requiere_intervencion_humana():\n            return 10004  # TICKET IA\n        \n        # Por defecto: Cliente identificado esperando\n        return 10002  # CLIENTE IDENTIFICADO IA\n```\n\n---\n\n## üî• **CRITERIOS DE URGENCIA (Para Tickets)**\n\n### **URGENCIA ALTA:**\n- **Palabras clave:** \"fuga\", \"filtraci√≥n\", \"inundaci√≥n\", \"problema el√©ctrico\", \"sin luz\", \"urgente\", \"emergencia\", \"da√±o\", \"riesgo\"\n- **Contexto:** Afecta seguridad o habitabilidad inmediata\n- **Bot dice:** \"lo m√°s pronto posible\", \"urgente\", \"prioritario\"\n\n### **URGENCIA MEDIA:**\n- **Palabras clave:** \"coordinar\", \"reparaci√≥n\", \"arreglo\", \"cobro extra√±o\", \"duda pago\", \"aire acondicionado\"\n- **Contexto:** Debe resolverse pronto pero no es emergencia\n- **Bot dice:** \"48 horas h√°biles\"\n\n### **URGENCIA BAJA:**\n- **Palabras clave:** \"consulta\", \"informaci√≥n\", \"factura\", \"contrato\", \"¬øc√≥mo...?\", \"¬øcu√°ndo...?\"\n- **Contexto:** Solo informaci√≥n administrativa o coordinaci√≥n simple\n\n---\n\n## üìù **ESTRUCTURA JSON OBLIGATORIA**\n\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \"persona\": \"\",\n  \"codigoInmueble\": \"\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"\",\n  \n  \"resumen_solicitud\": \"\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"\",\n  \"seg_2\": \"\",\n  \n  \"estatusEmbudo\": \"\",\n  \"statusId\": 0,\n  \n  \"clienteIdentificado\": false\n}\n```\n\n### **DESCRIPCI√ìN DE CADA CAMPO:**\n\n**DATOS DEL CLIENTE:**\n- `nombreCliente`: Nombre completo extra√≠do de la conversaci√≥n o \"\"\n- `telefonoCliente`: +51XXXXXXXXX o \"\"\n- `correoCliente`: email@domain.com o \"\"\n- `persona`: \"inquilino\" / \"propietario\" / \"proveedor\" / \"\"\n- `codigoInmueble`: C√≥digo del inmueble o \"\"\n- `relacionTitular`: \"pareja\" / \"familiar\" / etc, o \"\" si es titular directo\n\n**CATEGORIZACI√ìN:**\n- `categoria_completa`: \"NIVEL_1 - NIVEL_2 - NIVEL_3\" (formato exacto con espacios y guiones)\n\n**SOLICITUD:**\n- `resumen_solicitud`: Resumen breve y claro (m√°x 200 caracteres) de lo que solicita el cliente\n  - ‚úÖ SIEMPRE llenar si cliente hizo consulta\n  - ‚úÖ Ser espec√≠fico y claro\n  - ‚úÖ Mencionar detalles relevantes\n  - ‚ùå NUNCA dejar vac√≠o si hay consulta\n\n**SOLUCI√ìN:**\n- `tiene_solucion`: true / false\n  - true = Se brind√≥ alguna informaci√≥n/respuesta/soluci√≥n al cliente\n  - false = A√∫n no se ha brindado soluci√≥n\n  - Este campo es INDEPENDIENTE de si requiere ticket o no\n- `descripcion_solucion`: (SOLO si tiene_solucion = true)\n  - Describir QU√â soluci√≥n se brind√≥ o QU√â informaci√≥n se proporcion√≥\n  - Ser espec√≠fico sobre la acci√≥n realizada\n  - Ejemplos: \"Se brind√≥ el RUC de la empresa\", \"Se envi√≥ el c√≥digo de pago\", \"Se explic√≥ el proceso de pago por Kashio\"\n  - Si tiene_solucion = false ‚Üí dejar vac√≠o \"\"\n\n**TICKET:**\n- `requiereTicket`: true / false\n  - true = Necesita intervenci√≥n humana\n  - false = Bot resolvi√≥ o no requiere acci√≥n\n- `detalle_ticket`: (SOLO si requiereTicket = true)\n  - Explicar QU√â debe hacer el equipo\n  - Incluir nivel de urgencia si aplica\n  - Ser claro y espec√≠fico\n  - Si requiereTicket = false ‚Üí dejar vac√≠o \"\"\n\n**CASO ESPECIAL:**\n- `caso_especial`: true / false\n  - true = Bot no tiene info O cliente pide humano O situaci√≥n compleja\n  - false = Caso normal\n- `detalle_caso_especial`: (SOLO si caso_especial = true)\n  - Explicar POR QU√â es caso especial\n  - Ser espec√≠fico\n  - Si caso_especial = false ‚Üí dejar vac√≠o \"\"\n\n**MENSAJES DE SEGUIMIENTO:**\n- `seg_1`: Primer mensaje de seguimiento para el cliente\n  - ‚úÖ SIEMPRE debe tener contenido\n  - ‚úÖ Mensaje contextual relacionado con la conversaci√≥n actual\n  - ‚úÖ Prop√≥sito: Reactivar conversaci√≥n si el cliente deja en visto\n  - ‚úÖ Tono amigable, profesional, corto, invita a continuar\n  - ‚úÖ M√°ximo 150 caracteres\n  - ‚ùå NO USAR EMOJIS (cr√≠tico)\n  - **Ejemplos correctos:**\n    - \"Hola Juan, ¬øpudiste revisar la informaci√≥n que te compart√≠?\"\n    - \"Hola Mar√≠a, ¬ølograste resolver tu consulta o necesitas algo m√°s?\"\n    - \"Hola Carlos, ¬øqued√≥ clara la informaci√≥n sobre el pago?\"\n  \n- `seg_2`: Segundo mensaje de seguimiento para el cliente\n  - ‚úÖ SIEMPRE debe tener contenido\n  - ‚úÖ Mensaje contextual si el cliente sigue sin responder despu√©s de seg_1\n  - ‚úÖ Prop√≥sito: Segunda oportunidad de reactivar conversaci√≥n\n  - ‚úÖ Puede ofrecer ayuda adicional o preguntar si necesita algo m√°s\n  - ‚úÖ M√°ximo 150 caracteres\n  - ‚ùå NO USAR EMOJIS (cr√≠tico)\n  - **Ejemplos correctos:**\n    - \"¬øHay algo m√°s en lo que pueda ayudarte? Estoy aqu√≠ para lo que necesites.\"\n    - \"Si tienes alguna otra consulta, no dudes en escribirme.\"\n    - \"¬øNecesitas que te explique algo m√°s o est√° todo claro?\"\n\n**ETAPA:**\n- `estatusEmbudo`: Nombre de la etapa (ver lista arriba)\n- `statusId`: C√≥digo num√©rico SIN comillas (10001-10006)\n\n**FLAG:**\n- `clienteIdentificado`: true / false\n  - true = Bot confirm√≥ identificaci√≥n con datos completos\n  - false = Cliente NO identificado a√∫n\n\n---\n\n## üìã **REGLAS CR√çTICAS DE LLENADO**\n\n### **1. SIEMPRE REVISAR TODA LA CONVERSACI√ìN**\n- Lee TODOS los mensajes desde el inicio\n- NO te saltes mensajes intermedios\n- Considera el contexto completo\n- Busca informaci√≥n en TODO el historial\n\n### **2. NO INVENTAR INFORMACI√ìN**\n- Si un dato NO aparece en la conversaci√≥n ‚Üí dejar vac√≠o (\"\")\n- NO asumir valores\n- NO inventar nombres, correos, tel√©fonos\n- SOLO extraer lo que est√° EXPL√çCITAMENTE escrito\n\n### **3. resumen_solicitud**\n‚úÖ **SIEMPRE llenar si el cliente hizo una consulta o solicitud**\n‚úÖ M√°ximo 200 caracteres\n‚úÖ Claro, espec√≠fico y preciso\n‚úÖ Incluir detalles relevantes (inmueble, tipo de problema)\n‚ùå NUNCA dejar vac√≠o si hay consulta activa\n\n**Ejemplos correctos:**\n```\n‚úÖ \"Consulta sobre c√≥mo pagar alquiler mediante Kashio\"\n‚úÖ \"Fuga de agua en ba√±o del depto 205 que da√±a muebles. Urgente.\"\n‚úÖ \"Solicita cambio de habitaci√≥n del inmueble 503\"\n‚úÖ \"Propietario no recibi√≥ pago de contraprestaci√≥n del mes\"\n‚úÖ \"Consulta sobre posibilidad de subarrendar departamento\"\n‚úÖ \"Solicita c√≥digo WiFi para conectarse\"\n```\n\n### **4. requiereTicket y detalle_ticket**\n- Si `requiereTicket = true` ‚Üí DEBES llenar `detalle_ticket`\n- Si `requiereTicket = false` ‚Üí `detalle_ticket` debe ser \"\"\n- `detalle_ticket` debe explicar QU√â debe hacer el equipo\n\n**Ejemplos correctos:**\n```\n‚úÖ \"Coordinar reparaci√≥n urgente de fuga en ba√±o depto 205\"\n‚úÖ \"Verificar por qu√© no aparece pago pendiente en sistema\"\n‚úÖ \"Revisar contrato inmueble 102 sobre condiciones de subarriendo\"\n‚úÖ \"Validar pago de contraprestaci√≥n no recibido por propietario del inmueble 401\"\n‚úÖ \"Coordinar cambio de habitaci√≥n de inquilina del inmueble 503\"\n```\n\n### **5. caso_especial y detalle_caso_especial**\n- Si `caso_especial = true` ‚Üí DEBES llenar `detalle_caso_especial`\n- Si `caso_especial = false` ‚Üí `detalle_caso_especial` debe ser \"\"\n- `detalle_caso_especial` debe explicar POR QU√â es caso especial\n\n**Ejemplos correctos:**\n```\n‚úÖ \"Base de conocimiento no tiene informaci√≥n sobre condiciones de subarriendo\"\n‚úÖ \"Cliente solicita hablar directamente con un asesor humano\"\n‚úÖ \"Consulta muy espec√≠fica sobre cl√°usula contractual que requiere revisi√≥n especializada\"\n‚úÖ \"Bot no encontr√≥ informaci√≥n sobre este tipo de servicio en su base de datos\"\n‚úÖ \"Situaci√≥n compleja con m√∫ltiples problemas que requiere evaluaci√≥n integral\"\n```\n\n### **6. categoria_completa**\n‚úÖ SIEMPRE usar formato: \"NIVEL_1 - NIVEL_2 - NIVEL_3\"\n‚úÖ Con espacios antes y despu√©s de los guiones\n‚úÖ Todo en MAY√öSCULAS\n‚úÖ Sin tildes ni caracteres especiales\n\n### **7. tiene_solucion y descripcion_solucion**\n\n**tiene_solucion:**\n- `true`: Cuando el bot YA brind√≥ alguna informaci√≥n, respuesta o soluci√≥n al cliente\n- `false`: Cuando a√∫n NO se ha proporcionado ninguna soluci√≥n\n\n**descripcion_solucion (SOLO si tiene_solucion = true):**\n‚úÖ Describir QU√â informaci√≥n o soluci√≥n se brind√≥\n‚úÖ Ser espec√≠fico sobre la acci√≥n realizada\n‚úÖ Usar tiempo pasado (\"se brind√≥\", \"se envi√≥\", \"se explic√≥\")\n‚úÖ M√°ximo 150 caracteres\n‚ùå Dejar vac√≠o (\"\") si tiene_solucion = false\n\n**Ejemplos correctos:**\n```\ntiene_solucion: true\ndescripcion_solucion: \"Se brind√≥ el RUC de la empresa\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se envi√≥ el c√≥digo de pago del inmueble 301\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se explic√≥ el proceso completo de pago mediante Kashio con manual incluido\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se proporcion√≥ la clave WiFi y nombre de red\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se busc√≥ informaci√≥n de informes del cliente Juan y se enviaron los reportes solicitados\"\n\ntiene_solucion: false\ndescripcion_solucion: \"\"  (cuando a√∫n no se ha dado soluci√≥n)\n```\n\n**IMPORTANTE:** Este campo es independiente de si requiere ticket. Puede haber casos donde:\n- tiene_solucion=true y requiereTicket=false (bot resolvi√≥ todo)\n- tiene_solucion=true y requiereTicket=true (bot dio info parcial pero requiere seguimiento)\n- tiene_solucion=false y requiereTicket=true (a√∫n no hay soluci√≥n, se escal√≥)\n\n### **8. seg_1 y seg_2 (Mensajes de Seguimiento)**\n\n**REGLAS GENERALES:**\n‚úÖ SIEMPRE deben tener contenido (nunca vac√≠os)\n‚úÖ M√°ximo 150 caracteres cada uno\n‚úÖ Tono amigable, natural y cercano\n‚úÖ Contextuales a la conversaci√≥n actual\n‚úÖ Incluir el nombre del cliente si est√° disponible\n‚ùå **NO USAR EMOJIS** (cr√≠tico)\n\n**seg_1 (Primer seguimiento):**\n- Prop√≥sito: Reactivar conversaci√≥n si cliente deja en visto\n- Referencia a la informaci√≥n compartida o consulta realizada\n- Pregunta si pudo revisar o si tiene dudas\n- Tono: Amigable, no insistente\n\n**Ejemplos de seg_1:**\n```\n\"Hola Juan, ¬øpudiste revisar el c√≥digo de pago que te compart√≠?\"\n\"Hola Mar√≠a, ¬øte qued√≥ alguna duda sobre el proceso de pago? Estoy aqu√≠ para ayudarte\"\n\"¬øLograste ver la informaci√≥n que te envi√© sobre Kashio?\"\n\"Hola Carlos, ¬ønecesitas algo m√°s sobre tu consulta de cambio de habitaci√≥n?\"\n\"¬øPudiste revisar el manual? Si tienes alguna pregunta, con gusto te ayudo\"\n```\n\n**seg_2 (Segundo seguimiento):**\n- Prop√≥sito: Segunda oportunidad de reactivar conversaci√≥n\n- Ofrecer ayuda adicional\n- Preguntar si necesita algo m√°s\n- Dejar la puerta abierta para futuras consultas\n- Tono: Servicial, cierra con ofrecimiento de ayuda\n\n**Ejemplos de seg_2:**\n```\n\"¬øHay algo m√°s en lo que pueda ayudarte? Estoy aqu√≠ cuando me necesites\"\n\"Si necesitas cualquier otra informaci√≥n, no dudes en escribirme\"\n\"¬øTodo qued√≥ claro con tu consulta? Aqu√≠ estoy para lo que necesites\"\n\"Si tienes alguna otra pregunta, con gusto te ayudo\"\n\"Cualquier duda adicional, puedes contactarme. Que tengas un buen d√≠a\"\n```\n\n**CONSIDERACIONES ESPECIALES:**\n\n**Si el cliente NO est√° identificado:**\n```\nseg_1: \"Hola, ¬øsigues ah√≠? ¬øPuedo ayudarte con algo?\"\nseg_2: \"Estoy disponible si necesitas asistencia. ¬øEn qu√© puedo ayudarte?\"\n```\n\n**Si la consulta fue resuelta:**\n```\nseg_1: \"¬øLa informaci√≥n que te compart√≠ te fue √∫til?\"\nseg_2: \"Si necesitas algo m√°s, aqu√≠ estoy para ayudarte\"\n```\n\n**Si requiere ticket o caso especial:**\n```\nseg_1: \"Un asesor se contactar√° contigo pronto. ¬øTienes alguna duda mientras tanto?\"\nseg_2: \"¬øHay algo m√°s que pueda ayudarte mientras esperas la atenci√≥n del asesor?\"\n```\n\n### **9. statusId**\n‚úÖ SIEMPRE num√©rico SIN comillas\n‚úÖ Solo valores v√°lidos: 10001, 10002, 10003, 10004, 10005, 10006\n‚ùå NO usar: \"10001\", 10007, 10008, etc.\n\n---\n\n## üîç **EJEMPLOS COMPLETOS**\n\n### **Ejemplo 1: Interacci√≥n Inicial**\n\n**Conversaci√≥n:**\n```\nCliente: \"Hola, buenos d√≠as\"\nBot: [Ejecuta b√∫squeda por tel√©fono]\nBot: \"Hola, no encuentro un registro con tu n√∫mero. ¬øPodr√≠as brindarme tu correo electr√≥nico?\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"+51923456789\",\n  \"correoCliente\": \"\",\n  \"persona\": \"\",\n  \"codigoInmueble\": \"\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"NO_IDENTIFICADO - IDENTIFICACION - PENDIENTE\",\n  \n  \"resumen_solicitud\": \"Cliente salud√≥ pero a√∫n no proporciona datos para identificarse\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola, ¬øsigues por ah√≠? Estoy listo para ayudarte con lo que necesites\",\n  \"seg_2\": \"¬øHay algo en lo que pueda asistirte? Estoy disponible cuando quieras\",\n  \n  \"estatusEmbudo\": \"INTERACCION IA\",\n  \"statusId\": 10001,\n  \n  \"clienteIdentificado\": false\n}\n```\n\n---\n\n### **Ejemplo 2: Cliente Identificado**\n\n**Conversaci√≥n:**\n```\nCliente: \"Hola\"\nBot: [Busca por tel√©fono - encontrado]\nBot: \"Perfecto Juan, te identifico como inquilino del inmueble 301. ¬øEn qu√© puedo ayudarte?\"\nCliente: [A√∫n no responde]\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Juan\",\n  \"telefonoCliente\": \"+51987654321\",\n  \"correoCliente\": \"juan@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"301\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CONSULTAS - GENERAL\",\n  \n  \"resumen_solicitud\": \"Cliente identificado, esperando que indique su consulta\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Juan, ¬øen qu√© puedo ayudarte hoy?\",\n  \"seg_2\": \"¬øHay algo en lo que pueda asistirte? Estoy aqu√≠ para lo que necesites\",\n  \n  \"estatusEmbudo\": \"CLIENTE IDENTIFICADO IA\",\n  \"statusId\": 10002,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 3: Consulta Resuelta**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Juan, te identifico como inquilino del inmueble 301. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"¬øC√≥mo pago el alquiler?\"\nBot: [HTTP Request - encuentra respuesta]\nBot: \"Para pagar tu alquiler mediante Kashio, sigue estos pasos: [instrucciones completas]\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Juan\",\n  \"telefonoCliente\": \"+51987654321\",\n  \"correoCliente\": \"juan@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"301\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - PAGOS - KASHIO\",\n  \n  \"resumen_solicitud\": \"Consulta sobre c√≥mo pagar alquiler mediante Kashio\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se explic√≥ el proceso completo de pago mediante Kashio con instrucciones detalladas\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Juan, ¬øpudiste revisar las instrucciones de pago por Kashio?\",\n  \"seg_2\": \"¬øTe qued√≥ alguna duda sobre el proceso? Con gusto puedo ayudarte\",\n  \n  \"estatusEmbudo\": \"CONSULTA RESUELTA IA\",\n  \"statusId\": 10003,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 4: Ticket Urgencia Alta**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Mar√≠a, te identifico como inquilina del inmueble 205. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"Tengo una fuga de agua muy grande en mi ba√±o, est√° da√±ando mis muebles\"\nBot: \"Entiendo, es una situaci√≥n urgente. Un asesor del √°rea de mantenimiento se contactar√° contigo lo m√°s pronto posible.\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Mar√≠a\",\n  \"telefonoCliente\": \"+51912345678\",\n  \"correoCliente\": \"maria@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"205\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - MANTENIMIENTO - FUGA_AGUA\",\n  \n  \"resumen_solicitud\": \"Fuga de agua muy grande en ba√±o del depto 205, est√° da√±ando muebles. Requiere atenci√≥n urgente.\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Coordinar reparaci√≥n URGENTE de fuga de agua en ba√±o depto 205. Est√° causando da√±os a muebles. Prioridad ALTA - contactar lo m√°s pronto posible.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Mar√≠a, el √°rea de mantenimiento se contactar√° contigo muy pronto. ¬øTienes alguna duda mientras tanto?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la atenci√≥n del √°rea de mantenimiento?\",\n  \n  \"estatusEmbudo\": \"TICKET IA\",\n  \"statusId\": 10004,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 5: Caso Especial**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Carlos, te identifico como inquilino del inmueble 102. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"¬øPuedo subarrendar mi departamento?\"\nBot: [HTTP Request - no encuentra respuesta]\nBot: \"Entiendo tu consulta. No encuentro informaci√≥n espec√≠fica sobre subarriendo. Un asesor especializado se contactar√° contigo para revisar las condiciones de tu contrato.\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Carlos\",\n  \"telefonoCliente\": \"+51998765432\",\n  \"correoCliente\": \"carlos@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"102\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CONSULTAS - SUBARRIENDO\",\n  \n  \"resumen_solicitud\": \"Consulta sobre posibilidad de subarrendar su departamento\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Revisar cl√°usulas del contrato del inmueble 102 para determinar si permite subarriendo. Responder al inquilino con informaci√≥n espec√≠fica.\",\n  \n  \"caso_especial\": true,\n  \"detalle_caso_especial\": \"Base de conocimiento no tiene informaci√≥n espec√≠fica sobre condiciones de subarriendo. Requiere revisi√≥n de contrato por asesor especializado.\",\n  \n  \"seg_1\": \"Hola Carlos, un asesor se contactar√° contigo pronto para revisar tu contrato. ¬øTienes otra consulta mientras tanto?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la respuesta del asesor?\",\n  \n  \"estatusEmbudo\": \"CASO ESPECIAL IA\",\n  \"statusId\": 10005,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 6: Ticket Urgencia Media**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Luis, te identifico como propietario del inmueble 401. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"No he recibido mi pago de este mes\"\nBot: \"Entiendo tu preocupaci√≥n. Un asesor del √°rea de pagos verificar√° tu situaci√≥n y se contactar√° contigo en un m√°ximo de 48 horas h√°biles.\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Luis\",\n  \"telefonoCliente\": \"+51934567890\",\n  \"correoCliente\": \"luis@email.com\",\n  \"persona\": \"propietario\",\n  \"codigoInmueble\": \"401\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO - PAGOS - CONTRAPRESTACION_NO_RECIBIDA\",\n  \n  \"resumen_solicitud\": \"Propietario no recibi√≥ pago de contraprestaci√≥n del mes actual para inmueble 401\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Verificar con √°rea de pagos por qu√© no se realiz√≥ el dep√≥sito de contraprestaci√≥n al propietario del inmueble 401. Revisar estado del pago y contactar al propietario en m√°ximo 48 horas h√°biles.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Luis, el √°rea de pagos est√° verificando tu caso y se contactar√° contigo pronto. ¬øTienes alguna otra consulta?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la respuesta del √°rea de pagos?\",\n  \n  \"estatusEmbudo\": \"TICKET IA\",\n  \"statusId\": 10004,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 7: Conversaci√≥n Acumulativa - M√∫ltiples Mensajes**\n\n**Conversaci√≥n:**\n```\n[Mensaje 1]\nCliente: \"Hola\"\nBot: [Busca - 404]\nBot: \"Hola, no encuentro registro. ¬øTu correo?\"\n\n[Mensaje 2]\nCliente: \"ana@email.com\"\nBot: [Busca por correo - encontrado]\nBot: \"Perfecto Ana, te identifico como inquilina del 503. ¬øEn qu√© puedo ayudarte?\"\n\n[Mensaje 3]\nCliente: \"Necesito el c√≥digo de pago\"\nBot: \"Con gusto, te env√≠o tu c√≥digo de pago para el inmueble 503: [c√≥digo]\"\n\n[Mensaje 4]\nCliente: \"Gracias. Tambi√©n quiero saber si puedo cambiar de habitaci√≥n\"\nBot: \"Entiendo. Para coordinar un cambio de habitaci√≥n, un asesor se contactar√° contigo en 48 horas h√°biles.\"\n```\n\n**JSON (An√°lisis de TODA la conversaci√≥n):**\n```json\n{\n  \"nombreCliente\": \"Ana\",\n  \"telefonoCliente\": \"+51945678901\",\n  \"correoCliente\": \"ana@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"503\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CAMBIOS - HABITACION_DEPARTAMENTO\",\n  \n  \"resumen_solicitud\": \"Solicitud de c√≥digo de pago (ya resuelto). Actualmente solicita cambio de habitaci√≥n del inmueble 503.\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se proporcion√≥ el c√≥digo de pago del inmueble 503\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Coordinar con √°rea correspondiente sobre solicitud de cambio de habitaci√≥n de la inquilina Ana del inmueble 503. Validar disponibilidad y condiciones. Contactar en 48 horas h√°biles.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Ana, un asesor se contactar√° contigo pronto sobre el cambio de habitaci√≥n. ¬øTienes alguna otra consulta?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la respuesta sobre tu cambio?\",\n  \n  \"estatusEmbudo\": \"TICKET IA\",\n  \"statusId\": 10004,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n**NOTA:** El an√°lisis es ACUMULATIVO. Se consider√≥ toda la conversaci√≥n pero la etapa y categor√≠a reflejan el √∫ltimo requerimiento ACTIVO (cambio de habitaci√≥n), mencionando brevemente que la consulta del c√≥digo de pago ya fue resuelta. El campo `tiene_solucion=true` porque S√ç se brind√≥ soluci√≥n al c√≥digo de pago.\n\n---\n\n### **Ejemplo 8: Consulta con Soluci√≥n - RUC de Empresa**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Sandra, te identifico como inquilina del inmueble 602. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"Necesito el RUC de la empresa para mi contabilidad\"\nBot: \"Claro, el RUC de PROPER PER√ö es 20123456789. ¬øNecesitas alg√∫n otro dato?\"\nCliente: [No responde]\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Sandra\",\n  \"telefonoCliente\": \"+51956789012\",\n  \"correoCliente\": \"sandra@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"602\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CONSULTAS - INFORMACION_EMPRESA\",\n  \n  \"resumen_solicitud\": \"Solicitud del RUC de la empresa para su contabilidad\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se proporcion√≥ el RUC de PROPER PER√ö (20123456789)\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Sandra, ¬øte sirvi√≥ el RUC que te compart√≠?\",\n  \"seg_2\": \"¬øNecesitas alg√∫n otro dato de la empresa? Estoy aqu√≠ para ayudarte\",\n  \n  \"estatusEmbudo\": \"CONSULTA RESUELTA IA\",\n  \"statusId\": 10003,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 9: Env√≠o de Reporte Solicitado**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Roberto, te identifico como propietario del inmueble 305. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"Necesito que me env√≠es el reporte de ocupaci√≥n de mi departamento\"\nBot: [Busca informaci√≥n]\nBot: \"Por supuesto, te env√≠o el reporte de ocupaci√≥n del inmueble 305. [adjunta archivo PDF]\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Roberto\",\n  \"telefonoCliente\": \"+51967890123\",\n  \"correoCliente\": \"roberto@email.com\",\n  \"persona\": \"propietario\",\n  \"codigoInmueble\": \"305\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO - PLATAFORMA - REPORTES\",\n  \n  \"resumen_solicitud\": \"Solicitud de reporte de ocupaci√≥n del inmueble 305\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se busc√≥ y envi√≥ el reporte de ocupaci√≥n del inmueble 305 en formato PDF\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Roberto, ¬øpudiste revisar el reporte de ocupaci√≥n que te envi√©?\",\n  \"seg_2\": \"¬øNecesitas alg√∫n otro reporte o informaci√≥n? Con gusto te ayudo\",\n  \n  \"estatusEmbudo\": \"CONSULTA RESUELTA IA\",\n  \"statusId\": 10003,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n## ‚ö° **REGLAS DE EXTRACCI√ìN DE DATOS**\n\n### **TEL√âFONO:**\n- Buscar: 9XX XXX XXX, 9XXXXXXXX\n- Agregar +51 si falta\n- Formato final: +51XXXXXXXXX\n- Si NO aparece: \"\"\n\n### **CORREO:**\n- Validar: texto@dominio.extension\n- Convertir a min√∫sculas\n- Sin espacios\n- Si NO aparece: \"\"\n\n### **NOMBRE:**\n- Extraer del mensaje del bot cuando identifica\n- Primera letra en may√∫scula\n- Sin t√≠tulos (Sr., Sra., etc.)\n- Si NO aparece: \"\"\n\n### **PERSONA:**\n- Valores v√°lidos: \"inquilino\", \"propietario\", \"proveedor\"\n- Extraer cuando bot dice \"te identifico como...\"\n- Si NO aparece: \"\"\n\n### **C√ìDIGO INMUEBLE:**\n- Extraer del mensaje de confirmaci√≥n del bot\n- N√∫mero o alfanum√©rico\n- Si varios, usar el relevante a la consulta\n- Si NO aparece: \"\"\n\n---\n\n## ‚ö†Ô∏è **CHECKLIST OBLIGATORIO ANTES DE RESPONDER**\n\n```\n‚ñ° ¬øLe√≠ TODA la conversaci√≥n desde el inicio hasta el final?\n‚ñ° ¬øRevis√© la infoPrevia si existe?\n‚ñ° ¬øExtraje SOLO informaci√≥n que est√° EXPL√çCITAMENTE en la conversaci√≥n?\n‚ñ° ¬øNO invent√© ning√∫n dato?\n‚ñ° ¬øEl cliente fue identificado por el bot?\n‚ñ° ¬øLa categoria_completa tiene formato: NIVEL_1 - NIVEL_2 - NIVEL_3?\n‚ñ° ¬øEl resumen_solicitud est√° completo y es claro?\n‚ñ° ¬øEvalu√© correctamente si tiene_solucion es true o false?\n‚ñ° ¬øSi tiene_solucion=true, complet√© descripcion_solucion?\n‚ñ° ¬øSi requiereTicket=true, complet√© detalle_ticket?\n‚ñ° ¬øSi caso_especial=true, complet√© detalle_caso_especial?\n‚ñ° ¬øLos mensajes seg_1 y seg_2 est√°n completos y son contextuales?\n‚ñ° ¬øEl statusId es NUM√âRICO sin comillas?\n‚ñ° ¬øEl estatusEmbudo corresponde al statusId?\n‚ñ° ¬øTodos los campos requeridos est√°n presentes?\n‚ñ° ¬øEl JSON es v√°lido y est√° completo?\n```\n\n---\n\n## üî¥ **RECORDATORIO CR√çTICO FINAL**\n\n```\nANTES DE RESPONDER, VERIFICAR:\n\n1. ‚úÖ LE√çSTE TODA LA CONVERSACI√ìN COMPLETA\n   ‚Üí No te saltaste ning√∫n mensaje\n   ‚Üí Consideraste infoPrevia si existe\n\n2. ‚úÖ NO INVENTASTE INFORMACI√ìN\n   ‚Üí Solo extraes lo que est√° escrito\n   ‚Üí Campos vac√≠os (\"\") si no hay datos\n\n3. ‚úÖ CATEGORIZACI√ìN CORRECTA\n   ‚Üí Formato: \"NIVEL_1 - NIVEL_2 - NIVEL_3\"\n   ‚Üí Con espacios y guiones correctos\n\n4. ‚úÖ EVALUACI√ìN DE SOLUCI√ìN\n   ‚Üí tiene_solucion: true/false correctamente evaluado\n   ‚Üí Si true ‚Üí descripcion_solucion lleno\n   ‚Üí Si false ‚Üí descripcion_solucion vac√≠o\n\n5. ‚úÖ CAMPOS CONDICIONALES\n   ‚Üí requiereTicket=true ‚Üí detalle_ticket lleno\n   ‚Üí caso_especial=true ‚Üí detalle_caso_especial lleno\n\n6. ‚úÖ MENSAJES DE SEGUIMIENTO\n   ‚Üí seg_1 y seg_2 SIEMPRE con contenido\n   ‚Üí Contextuales a la conversaci√≥n\n   ‚Üí M√°ximo 150 caracteres cada uno\n   ‚Üí Tono amigable y natural\n\n7. ‚úÖ ETAPA CORRECTA\n   ‚Üí statusId num√©rico (10001-10006)\n   ‚Üí estatusEmbudo correspondiente\n\n8. ‚úÖ JSON COMPLETO Y V√ÅLIDO\n   ‚Üí Todos los campos presentes\n   ‚Üí Sintaxis correcta\n\nRESPONDER SOLO JSON VALIDADO Y COMPLETO\n```\n\n---\n\n## üìñ **REFERENCIA R√ÅPIDA**\n\n```\nETAPAS:\n10001 - INTERACCION IA (cliente inicia, no identificado)\n10002 - CLIENTE IDENTIFICADO IA (identificado, sin consulta a√∫n)\n10003 - CONSULTA RESUELTA IA (bot resolvi√≥ completamente)\n10004 - TICKET IA (requiere intervenci√≥n humana)\n10005 - CASO ESPECIAL IA (bot sin info o complejo)\n10006 - ASESOR IA (atenci√≥n humana directa)\n\nCATEGORIZACI√ìN:\nNIVEL_1: INQUILINO / PROPIETARIO / NO_IDENTIFICADO\nNIVEL_2: MANTENIMIENTO / PAGOS / ACCESOS / LIMPIEZA / etc.\nNIVEL_3: Descriptor espec√≠fico (DUCHA / WIFI / etc.)\n\nFORMATO: \"NIVEL_1 - NIVEL_2 - NIVEL_3\"\n```\n\n---\n\n**FIN DEL PROMPT v4.0**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        5360,
        1776
      ],
      "id": "e4a35716-8332-4fd5-8bfd-3b00dfc4fd3a",
      "name": "Campos4",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta3').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta3').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4912,
        1696
      ],
      "id": "3378c696-dcde-4b13-a478-aec5076685cb",
      "name": "SwitchBot4",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "nombreCliente",
              "description": "Nombre completo extra√≠do de la conversaci√≥n o \"\"",
              "required": true
            },
            {
              "name": "telefonoCliente",
              "description": "+51XXXXXXXXX o \"\"",
              "required": true
            },
            {
              "name": "correoCliente",
              "description": "email@domain.com o \"\"",
              "required": true
            },
            {
              "name": "persona",
              "description": "\"inquilino\" / \"propietario\" / \"proveedor\" / \"\"",
              "required": true
            },
            {
              "name": "codigoInmueble",
              "description": "C√≥digo del inmueble o \"\"",
              "required": true
            },
            {
              "name": "relacionTitular",
              "description": "\"pareja\" / \"familiar\" / etc, o \"\" si es titular directo",
              "required": true
            },
            {
              "name": "categoria_completa",
              "description": " \"NIVEL_1 - NIVEL_2 - NIVEL_3\" (formato exacto con espacios y guiones)",
              "required": true
            },
            {
              "name": "resumen_solicitud",
              "description": "Resumen breve y claro (m√°x 200 caracteres) de lo que solicita el cliente",
              "required": true
            },
            {
              "name": "tiene_solucion",
              "type": "boolean",
              "description": "true = Se brind√≥ alguna informaci√≥n/respuesta/soluci√≥n al cliente false = A√∫n no se ha brindado soluci√≥n Este campo es INDEPENDIENTE de si requiere ticket o no",
              "required": true
            },
            {
              "name": "descripcion_solucion",
              "description": "(SOLO si tiene_solucion = true)  Describir QU√â soluci√≥n se brind√≥ o QU√â informaci√≥n se proporcion√≥ Ser espec√≠fico sobre la acci√≥n realizada Ejemplos: \"Se brind√≥ el RUC de la empresa\", \"Se envi√≥ el c√≥digo de pago\", \"Se explic√≥ el proceso de pago por Kashio\" Si tiene_solucion = false ‚Üí dejar vac√≠o \"\"",
              "required": true
            },
            {
              "name": "requiereTicket",
              "type": "boolean",
              "description": "true / false  true = Necesita intervenci√≥n humana false = Bot resolvi√≥ o no requiere acci√≥n",
              "required": true
            },
            {
              "name": "detalle_ticket",
              "description": "(SOLO si requiereTicket = true)  Explicar QU√â debe hacer el equipo Incluir nivel de urgencia si aplica Ser claro y espec√≠fico Si requiereTicket = false ‚Üí dejar vac√≠o \"\"",
              "required": true
            },
            {
              "name": "caso_especial",
              "type": "boolean",
              "description": "true / false  true = Bot no tiene info O cliente pide humano O situaci√≥n compleja false = Caso normal",
              "required": true
            },
            {
              "name": "detalle_caso_especial",
              "description": "(SOLO si caso_especial = true)  Explicar POR QU√â es caso especial Ser espec√≠fico Si caso_especial = false ‚Üí dejar vac√≠o \"\"",
              "required": true
            },
            {
              "name": "seg_1",
              "description": "Primer mensaje de seguimiento para el cliente",
              "required": true
            },
            {
              "name": "seg_2",
              "description": "Segundo mensaje de seguimiento para el cliente",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Nombre de la etapa (ver lista arriba)",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "C√≥digo num√©rico SIN comillas (10001-10006)",
              "required": true
            },
            {
              "name": "clienteIdentificado",
              "type": "boolean",
              "description": "true / false  true = Bot confirm√≥ identificaci√≥n con datos completos false = Cliente NO identificado a√∫n",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        5776,
        1776
      ],
      "id": "86c75218-4e42-47e6-ab49-3d40ec3fba5f",
      "name": "Information Extractor4",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5840,
        1584
      ],
      "id": "cfc1be97-1944-4f08-9bf9-2923f76dda4f",
      "name": "Validacion4",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5376,
        2000
      ],
      "id": "944e5c0a-9069-4967-9578-ddf4531a7a62",
      "name": "OpenAI Chat Model11",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5840,
        2000
      ],
      "id": "2398ccb2-02ec-466a-8c6d-45899441f1ae",
      "name": "OpenAI Chat Model12",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": "=",
              "status_id": "=",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":798799,\"type\":\"text\"}",
                    "value": "={{ $json.output.persona }}"
                  },
                  {
                    "data": "{\"id\":798801,\"type\":\"text\"}",
                    "value": "={{ $json.output.codigoInmueble }}"
                  },
                  {
                    "data": "{\"id\":798803,\"type\":\"text\"}",
                    "value": "={{ $json.output.relacionTitular }}"
                  },
                  {
                    "data": "{\"id\":798805,\"type\":\"text\"}",
                    "value": "={{ $json.output.categoria_completa }}"
                  },
                  {
                    "data": "{\"id\":798807,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.resumen_solicitud }}"
                  },
                  {
                    "data": "{\"id\":798835,\"type\":\"checkbox\"}",
                    "value": "={{ $json.output.tiene_solucion }}"
                  },
                  {
                    "data": "{\"id\":798837,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.descripcion_solucion }}"
                  },
                  {
                    "data": "{\"id\":798809,\"type\":\"text\"}",
                    "value": "={{ $json.output.requiereTicket }}"
                  },
                  {
                    "data": "{\"id\":798811,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.detalle_ticket }}"
                  },
                  {
                    "data": "{\"id\":798813,\"type\":\"checkbox\"}",
                    "value": "={{ $json.output.caso_especial }}"
                  },
                  {
                    "data": "{\"id\":798815,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.detalle_caso_especial }}"
                  },
                  {
                    "data": "{\"id\":798825,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.seg_1 }}"
                  },
                  {
                    "data": "{\"id\":798827,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.seg_2 }}"
                  },
                  {
                    "data": "{\"id\":798817,\"type\":\"text\"}",
                    "value": "={{ $json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":798819,\"type\":\"checkbox\"}",
                    "value": "={{ $json.output.clienteIdentificado }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        6240,
        1888
      ],
      "id": "e421e3fe-21bc-421f-9d5c-72e7a890efba",
      "name": "Update leads4",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5504,
        2000
      ],
      "id": "a6080011-9fa0-46e6-b9e8-b63163feebc7",
      "name": "Postgres Chat Memory7",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        4064,
        1216
      ],
      "id": "5aa2dce0-3125-4e9d-bda2-f7f1dbbb515a",
      "name": "Postgres Chat Memory8",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        4192,
        1216
      ],
      "id": "34f4ff25-fb60-455a-aa89-69ead3adc242",
      "name": "Date & Time3"
    },
    {
      "parameters": {
        "resource": "notes",
        "operation": "createNotes",
        "notes": {
          "common": [
            {
              "entity_id": "={{ $('GET Lead').item.json.id }}",
              "text": "={{ $('Respuesta3').item.json.output }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        5136,
        1712
      ],
      "id": "b2c30cd3-4334-4bfe-a889-aabbc1f88562",
      "name": "Create new notes1",
      "credentials": {
        "kommoOAuth2Api": {
          "id": "Xm12cHoxJw7jGGaV",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "resource": "video",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "videoUrls": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        2032,
        1744
      ],
      "id": "e3638074-ef71-471f-9e47-263e5f90ac81",
      "name": "Analyze video",
      "credentials": {
        "googlePalmApi": {
          "id": "4ycbJRThfPUIH8pz",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "documentUrls": "={{ $json.attachment_link }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1,
      "position": [
        2032,
        1936
      ],
      "id": "2f74691a-ca1f-4f61-81b6-c93a3dd2cea3",
      "name": "Analyze document",
      "credentials": {
        "googlePalmApi": {
          "id": "4ycbJRThfPUIH8pz",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8555f2b5-2479-4ffd-a99f-965fd2e26690",
              "leftValue": "={{ $('new message').item.json.body[\"account[subdomain]\"] }}",
              "rightValue": "TEST",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        5424,
        1584
      ],
      "id": "e21aa2c5-394b-4f5a-adaf-0cd1554ce212",
      "name": "Filter2"
    },
    {
      "parameters": {
        "toolDescription": "Buscar en la base de conocimiento",
        "url": "https://docs.google.com/document/d/e/2PACX-1vTAOqubyUfWc-c3ppq_hVsdPPzO8vxKjgvoKARUHDRpnknDWxc6PBUompT4FXQF7klyGKKOUQyMFj0v/pub",
        "options": {},
        "optimizeResponse": true,
        "responseType": "html"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        4320,
        1216
      ],
      "id": "27635156-c728-493f-b2a5-e46a46631e8f",
      "name": "Base de conocimiento"
    },
    {
      "parameters": {
        "toolDescription": "Buscar en la base de conocimiento",
        "url": "https://docs.google.com/document/d/e/2PACX-1vTByTSHQfxb0MaJ3cQ_BnVkgey5SQGIfvhxWq5pMnvZ66p7TR3V6KRsa3qvro_qBg/pub",
        "options": {},
        "optimizeResponse": true,
        "responseType": "html"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        4448,
        608
      ],
      "id": "7ad2d6fb-8243-4ecf-864f-0a81c68b8ec3",
      "name": "Base de conocimiento1"
    },
    {
      "parameters": {
        "toolDescription": "busca por correo o dni",
        "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('URL', `URL para busqueda con correo o DNI, https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-by-correo/@correo para correo y https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-by-dnicarnext/@dniCarnext para dni`, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        4448,
        1216
      ],
      "id": "e86340b3-eb15-4630-8669-77eb825e3b6b",
      "name": "Busca por correo o dni"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1",
          "mode": "list",
          "cachedResultName": "gpt-4.1"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        3936,
        1216
      ],
      "id": "6003ce6f-c1ea-4f2b-b0c6-0d6fce3b2845",
      "name": "OpenAI Chat Model9",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Busca por tel√©fono",
        "url": "=https://pp7tj4zkv7.execute-api.us-east-2.amazonaws.com/prod/inquilinos/get-celular/{{ $('Edit Fields').item.json.telefono.replace(/\\D/g, '') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        4576,
        1216
      ],
      "id": "add13d13-806e-4bd1-8f83-47898f3aee84",
      "name": "Busca por telefono"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=**Mensaje proveniente del Cliente:** {{ $('Chat input').item.json.chat_input }}\n\n**Respuesta del bot:** {{ $('Respuesta2').item.json.output }}\n\n**Info previa:** {{ $node[\"Chat input\"].json.infoPrevia }}",
        "options": {
          "systemMessage": "=# ü§ñ PROPER IA ANALYZER v4.0 - SISTEMA DE AN√ÅLISIS SIMPLIFICADO\n\n**Fecha actual:** {{ \n  new Date($now).toLocaleDateString(\"es-PE\", {\n    weekday: \"long\", \n    day: \"numeric\", \n    month: \"long\", \n    year: \"numeric\"\n  }) \n  + \", \" +\n  new Date($now).toLocaleTimeString(\"es-PE\", {\n    hour: \"numeric\", \n    minute: \"2-digit\", \n    hour12: true,\n    timeZone: \"America/Lima\"\n  })\n}} | **Zona horaria:** Am√©rica/Lima\n\n---\n\n## üö® **MANDATO SUPREMO**\n```\nüî¥ RESPONDER √öNICAMENTE JSON COMPLETO Y V√ÅLIDO\nüî¥ LEER Y ANALIZAR TODA LA CONVERSACI√ìN COMPLETA\nüî¥ NO INVENTAR - SOLO EXTRAER INFORMACI√ìN REAL\nüî¥ CATEGORIZAR SEG√öN SISTEMA DE 3 NIVELES\nüî¥ DETERMINAR ETAPA CORRECTA\nüî¥ SER PRECISO Y EXACTO\n```\n\n---\n\n## üìä **SISTEMA DE CATEGORIZACI√ìN**\n\n### **ESTRUCTURA OBLIGATORIA:**\n```\nNIVEL_1 - NIVEL_2 - NIVEL_3\n```\n\n**NIVEL 1: Tipo de Usuario**\n- `INQUILINO`\n- `PROPIETARIO`\n- `NO_IDENTIFICADO`\n\n**NIVEL 2: √Årea/Tema**\n- `MANTENIMIENTO` - Reparaciones, fallas, aver√≠as\n- `LIMPIEZA` - Servicios de limpieza\n- `PAGOS` - Transacciones, c√≥digos de pago, dep√≥sitos\n- `FACTURACION` - Comprobantes, recibos, facturas\n- `ACCESOS` - Llaves, huellas, WiFi, credenciales, login\n- `CAMBIOS` - Cambio de habitaci√≥n, depto, cochera\n- `SERVICIOS` - Amenidades (bicicletas, parrillas, gym)\n- `PLATAFORMA` - Sistemas digitales (propietarios)\n- `VISITAS` - Visitas al departamento (propietarios)\n- `REFERIDOS` - Recomendaciones de nuevos inquilinos\n- `CONSULTAS` - Preguntas informativas generales\n- `QUEJAS` - Reclamos\n- `IDENTIFICACION` - Proceso de identificar usuario (NO_IDENTIFICADO)\n- `SALUDOS` - Mensajes de inicio/cierre (NO_IDENTIFICADO)\n- `OTROS` - Casos no categorizables\n\n**NIVEL 3: Subtema Espec√≠fico**\n- Descriptor del problema/acci√≥n espec√≠fica\n- Ejemplos: `DUCHA`, `ASCENSORES`, `WIFI`, `ROLLERS`, `CODIGO_RENTA`, `RECIBO_LUZ`, `HUELLAS`, `BICICLETAS`, `PROBLEMA_LOGIN`, `FUGA_AGUA`, `CONTRAPRESTACION_NO_RECIBIDA`, etc.\n- Si no hay subtema claro: `GENERAL`\n\n### **EJEMPLOS DE CATEGORIZACI√ìN:**\n```\n‚úÖ INQUILINO - MANTENIMIENTO - DUCHA\n‚úÖ INQUILINO - LIMPIEZA - ASCENSORES\n‚úÖ INQUILINO - PAGOS - CODIGO_RENTA\n‚úÖ INQUILINO - FACTURACION - RECIBO_LUZ\n‚úÖ INQUILINO - ACCESOS - WIFI\n‚úÖ INQUILINO - SERVICIOS - BICICLETAS\n‚úÖ INQUILINO - CAMBIOS - HABITACION_DEPARTAMENTO\n‚úÖ PROPIETARIO - PAGOS - CONTRAPRESTACION_NO_RECIBIDA\n‚úÖ PROPIETARIO - ACCESOS - PROBLEMA_LOGIN\n‚úÖ PROPIETARIO - PLATAFORMA - CARGA_DECLARACION\n‚úÖ PROPIETARIO - VISITAS - SOLICITUD_VISITA_DEPTO\n‚úÖ NO_IDENTIFICADO - IDENTIFICACION - PENDIENTE\n‚úÖ NO_IDENTIFICADO - CONSULTAS - INFORMACION_ALQUILER\n‚úÖ NO_IDENTIFICADO - SALUDOS - INICIAL\n```\n\n---\n\n## ‚ö° **PROCESO DE AN√ÅLISIS - OBLIGATORIO**\n\n### **PASO 1: LECTURA COMPLETA (CR√çTICO)**\n‚úÖ Lee TODO el historial de mensajes desde el INICIO hasta el FINAL\n‚úÖ Revisa informaci√≥n previa (infoPrevia) si existe\n‚úÖ NO te saltes ning√∫n mensaje\n‚úÖ NO inventes informaci√≥n que no est√° en la conversaci√≥n\n‚úÖ Identifica el flujo completo de la conversaci√≥n\n\n### **PASO 2: EXTRACCI√ìN DE DATOS**\n‚úÖ Busca y extrae: nombre, tel√©fono, correo, persona, codigoInmueble\n‚úÖ SOLO extrae lo que est√° EXPL√çCITAMENTE mencionado\n‚úÖ Si un dato NO aparece, d√©jalo vac√≠o (\"\")\n‚úÖ NO asumas informaci√≥n\n\n### **PASO 3: IDENTIFICACI√ìN DE USUARIO**\n‚úÖ ¬øEl bot confirm√≥ la identificaci√≥n del cliente?\n‚úÖ ¬øTiene datos completos? (nombre, persona, codigoInmueble)\n‚úÖ ¬øQu√© tipo de perfil? (inquilino/propietario/no identificado)\n\n### **PASO 4: COMPRENSI√ìN DE LA SOLICITUD**\n‚úÖ ¬øQu√© est√° solicitando el cliente EXACTAMENTE?\n‚úÖ ¬øEs una consulta nueva o continuaci√≥n?\n‚úÖ ¬øYa se resolvi√≥ o est√° pendiente?\n‚úÖ Resume la solicitud de forma clara y precisa\n\n### **PASO 5: CATEGORIZACI√ìN**\n‚úÖ Asignar categor√≠a completa de 3 niveles\n‚úÖ Debe reflejar el tema principal de la conversaci√≥n\n‚úÖ Debe ser espec√≠fica y descriptiva\n\n### **PASO 6: DETERMINACI√ìN DE ETAPA**\n‚úÖ Identifica en qu√© etapa del flujo est√° la conversaci√≥n\n‚úÖ Usa el algoritmo de detecci√≥n\n‚úÖ Asigna el estatusEmbudo y statusId correcto\n\n---\n\n## üîÑ **ETAPAS DEL FLUJO - SIMPLIFICADO**\n\n### **10001 - INTERACCION IA**\n**Descripci√≥n:** Cliente inici√≥ conversaci√≥n pero a√∫n no proporciona informaci√≥n para identificarse\n**Cu√°ndo usar:**\n- Cliente dice \"Hola\", \"Buenos d√≠as\", \"Tengo una consulta\"\n- Bot NO ha ejecutado b√∫squeda a√∫n\n- Cliente NO ha dado correo/DNI/tel√©fono\n- Conversaci√≥n reci√©n comienza\n\n### **10002 - CLIENTE IDENTIFICADO IA**\n**Descripci√≥n:** Bot identific√≥ exitosamente al cliente y est√° listo para atender\n**Cu√°ndo usar:**\n- Bot confirm√≥: \"Te identifico como [inquilino/propietario] del inmueble [c√≥digo]\"\n- Tiene: nombre, persona, codigoInmueble\n- Bot pregunta: \"¬øEn qu√© puedo ayudarte?\"\n- Cliente identificado pero a√∫n no hace consulta espec√≠fica\n\n### **10003 - CONSULTA RESUELTA IA**\n**Descripci√≥n:** Bot encontr√≥ respuesta y resolvi√≥ completamente la consulta del cliente\n**Cu√°ndo usar:**\n- Bot proporcion√≥ informaci√≥n completa\n- Bot comparti√≥ link/manual/instrucciones\n- Cliente recibi√≥ respuesta satisfactoria\n- NO requiere intervenci√≥n humana\n- Ejemplos: \"¬øC√≥mo pago?\" ‚Üí Bot explica Kashio\n\n### **10004 - TICKET IA**\n**Descripci√≥n:** Requiere creaci√≥n de ticket para intervenci√≥n del equipo humano\n**Cu√°ndo usar:**\n- Requiere coordinaci√≥n con √°rea espec√≠fica\n- Necesita acci√≥n del equipo (mantenimiento, pagos, administraci√≥n)\n- Bot indica: \"Un asesor se contactar√° contigo\"\n- Cualquier nivel de urgencia (baja, media, alta)\n- Ejemplos: reparaciones, verificar pagos, coordinar cambios\n\n### **10005 - CASO ESPECIAL IA**\n**Descripci√≥n:** Bot no tiene informaci√≥n o situaci√≥n compleja que requiere atenci√≥n especializada\n**Cu√°ndo usar:**\n- Bot NO encontr√≥ informaci√≥n en base de conocimiento\n- Bot dice: \"No encuentro informaci√≥n sobre...\"\n- Cliente pide hablar con persona/asesor espec√≠ficamente\n- Consulta muy compleja o fuera del alcance del bot\n- Informaci√≥n contradictoria o confusa\n- **SIEMPRE requiere explicar en detalle_caso_especial POR QU√â es caso especial**\n\n### **10006 - ASESOR IA**\n**Descripci√≥n:** Cliente est√° siendo atendido por un asesor humano o fue transferido\n**Cu√°ndo usar:**\n- Se detecta que un humano est√° respondiendo (no es bot)\n- Cliente fue transferido expl√≠citamente a asesor\n- Conversaci√≥n ya NO es con IA\n- **NOTA:** Esta etapa es poco com√∫n, solo usar si es evidente\n\n---\n\n## üéØ **ALGORITMO DE DETECCI√ìN**\n\n```python\ndef detectar_etapa():\n    # 1. Verificar si es asesor humano\n    if conversacion_con_humano():\n        return 10006  # ASESOR IA\n    \n    # 2. Verificar si cliente NO est√° identificado\n    if not cliente_tiene_datos_basicos():\n        return 10001  # INTERACCION IA\n    \n    # 3. Cliente identificado - evaluar siguiente paso\n    if cliente_identificado():\n        \n        # 3a. ¬øYa hizo consulta espec√≠fica?\n        if not cliente_hizo_consulta_especifica():\n            return 10002  # CLIENTE IDENTIFICADO IA\n        \n        # 3b. ¬øEs caso especial?\n        if bot_no_tiene_info() or cliente_pide_humano():\n            return 10005  # CASO ESPECIAL IA\n        \n        # 3c. ¬øBot resolvi√≥ la consulta?\n        if bot_dio_respuesta_completa() and no_requiere_accion_humana():\n            return 10003  # CONSULTA RESUELTA IA\n        \n        # 3d. ¬øRequiere ticket/acci√≥n humana?\n        if requiere_intervencion_humana():\n            return 10004  # TICKET IA\n        \n        # Por defecto: Cliente identificado esperando\n        return 10002  # CLIENTE IDENTIFICADO IA\n```\n\n---\n\n## üî• **CRITERIOS DE URGENCIA (Para Tickets)**\n\n### **URGENCIA ALTA:**\n- **Palabras clave:** \"fuga\", \"filtraci√≥n\", \"inundaci√≥n\", \"problema el√©ctrico\", \"sin luz\", \"urgente\", \"emergencia\", \"da√±o\", \"riesgo\"\n- **Contexto:** Afecta seguridad o habitabilidad inmediata\n- **Bot dice:** \"lo m√°s pronto posible\", \"urgente\", \"prioritario\"\n\n### **URGENCIA MEDIA:**\n- **Palabras clave:** \"coordinar\", \"reparaci√≥n\", \"arreglo\", \"cobro extra√±o\", \"duda pago\", \"aire acondicionado\"\n- **Contexto:** Debe resolverse pronto pero no es emergencia\n- **Bot dice:** \"48 horas h√°biles\"\n\n### **URGENCIA BAJA:**\n- **Palabras clave:** \"consulta\", \"informaci√≥n\", \"factura\", \"contrato\", \"¬øc√≥mo...?\", \"¬øcu√°ndo...?\"\n- **Contexto:** Solo informaci√≥n administrativa o coordinaci√≥n simple\n\n---\n\n## üìù **ESTRUCTURA JSON OBLIGATORIA**\n\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"\",\n  \"correoCliente\": \"\",\n  \"persona\": \"\",\n  \"codigoInmueble\": \"\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"\",\n  \n  \"resumen_solicitud\": \"\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"\",\n  \"seg_2\": \"\",\n  \n  \"estatusEmbudo\": \"\",\n  \"statusId\": 0,\n  \n  \"clienteIdentificado\": false\n}\n```\n\n### **DESCRIPCI√ìN DE CADA CAMPO:**\n\n**DATOS DEL CLIENTE:**\n- `nombreCliente`: Nombre completo extra√≠do de la conversaci√≥n o \"\"\n- `telefonoCliente`: +51XXXXXXXXX o \"\"\n- `correoCliente`: email@domain.com o \"\"\n- `persona`: \"inquilino\" / \"propietario\" / \"proveedor\" / \"\"\n- `codigoInmueble`: C√≥digo del inmueble o \"\"\n- `relacionTitular`: \"pareja\" / \"familiar\" / etc, o \"\" si es titular directo\n\n**CATEGORIZACI√ìN:**\n- `categoria_completa`: \"NIVEL_1 - NIVEL_2 - NIVEL_3\" (formato exacto con espacios y guiones)\n\n**SOLICITUD:**\n- `resumen_solicitud`: Resumen breve y claro (m√°x 200 caracteres) de lo que solicita el cliente\n  - ‚úÖ SIEMPRE llenar si cliente hizo consulta\n  - ‚úÖ Ser espec√≠fico y claro\n  - ‚úÖ Mencionar detalles relevantes\n  - ‚ùå NUNCA dejar vac√≠o si hay consulta\n\n**SOLUCI√ìN:**\n- `tiene_solucion`: true / false\n  - true = Se brind√≥ alguna informaci√≥n/respuesta/soluci√≥n al cliente\n  - false = A√∫n no se ha brindado soluci√≥n\n  - Este campo es INDEPENDIENTE de si requiere ticket o no\n- `descripcion_solucion`: (SOLO si tiene_solucion = true)\n  - Describir QU√â soluci√≥n se brind√≥ o QU√â informaci√≥n se proporcion√≥\n  - Ser espec√≠fico sobre la acci√≥n realizada\n  - Ejemplos: \"Se brind√≥ el RUC de la empresa\", \"Se envi√≥ el c√≥digo de pago\", \"Se explic√≥ el proceso de pago por Kashio\"\n  - Si tiene_solucion = false ‚Üí dejar vac√≠o \"\"\n\n**TICKET:**\n- `requiereTicket`: true / false\n  - true = Necesita intervenci√≥n humana\n  - false = Bot resolvi√≥ o no requiere acci√≥n\n- `detalle_ticket`: (SOLO si requiereTicket = true)\n  - Explicar QU√â debe hacer el equipo\n  - Incluir nivel de urgencia si aplica\n  - Ser claro y espec√≠fico\n  - Si requiereTicket = false ‚Üí dejar vac√≠o \"\"\n\n**CASO ESPECIAL:**\n- `caso_especial`: true / false\n  - true = Bot no tiene info O cliente pide humano O situaci√≥n compleja\n  - false = Caso normal\n- `detalle_caso_especial`: (SOLO si caso_especial = true)\n  - Explicar POR QU√â es caso especial\n  - Ser espec√≠fico\n  - Si caso_especial = false ‚Üí dejar vac√≠o \"\"\n\n**MENSAJES DE SEGUIMIENTO:**\n- `seg_1`: Primer mensaje de seguimiento para el cliente\n  - ‚úÖ SIEMPRE debe tener contenido\n  - ‚úÖ Mensaje contextual relacionado con la conversaci√≥n actual\n  - ‚úÖ Prop√≥sito: Reactivar conversaci√≥n si el cliente deja en visto\n  - ‚úÖ Tono amigable, profesional, corto, invita a continuar\n  - ‚úÖ M√°ximo 150 caracteres\n  - ‚ùå NO USAR EMOJIS (cr√≠tico)\n  - **Ejemplos correctos:**\n    - \"Hola Juan, ¬øpudiste revisar la informaci√≥n que te compart√≠?\"\n    - \"Hola Mar√≠a, ¬ølograste resolver tu consulta o necesitas algo m√°s?\"\n    - \"Hola Carlos, ¬øqued√≥ clara la informaci√≥n sobre el pago?\"\n  \n- `seg_2`: Segundo mensaje de seguimiento para el cliente\n  - ‚úÖ SIEMPRE debe tener contenido\n  - ‚úÖ Mensaje contextual si el cliente sigue sin responder despu√©s de seg_1\n  - ‚úÖ Prop√≥sito: Segunda oportunidad de reactivar conversaci√≥n\n  - ‚úÖ Puede ofrecer ayuda adicional o preguntar si necesita algo m√°s\n  - ‚úÖ M√°ximo 150 caracteres\n  - ‚ùå NO USAR EMOJIS (cr√≠tico)\n  - **Ejemplos correctos:**\n    - \"¬øHay algo m√°s en lo que pueda ayudarte? Estoy aqu√≠ para lo que necesites.\"\n    - \"Si tienes alguna otra consulta, no dudes en escribirme.\"\n    - \"¬øNecesitas que te explique algo m√°s o est√° todo claro?\"\n\n**ETAPA:**\n- `estatusEmbudo`: Nombre de la etapa (ver lista arriba)\n- `statusId`: C√≥digo num√©rico SIN comillas (10001-10006)\n\n**FLAG:**\n- `clienteIdentificado`: true / false\n  - true = Bot confirm√≥ identificaci√≥n con datos completos\n  - false = Cliente NO identificado a√∫n\n\n---\n\n## üìã **REGLAS CR√çTICAS DE LLENADO**\n\n### **1. SIEMPRE REVISAR TODA LA CONVERSACI√ìN**\n- Lee TODOS los mensajes desde el inicio\n- NO te saltes mensajes intermedios\n- Considera el contexto completo\n- Busca informaci√≥n en TODO el historial\n\n### **2. NO INVENTAR INFORMACI√ìN**\n- Si un dato NO aparece en la conversaci√≥n ‚Üí dejar vac√≠o (\"\")\n- NO asumir valores\n- NO inventar nombres, correos, tel√©fonos\n- SOLO extraer lo que est√° EXPL√çCITAMENTE escrito\n\n### **3. resumen_solicitud**\n‚úÖ **SIEMPRE llenar si el cliente hizo una consulta o solicitud**\n‚úÖ M√°ximo 200 caracteres\n‚úÖ Claro, espec√≠fico y preciso\n‚úÖ Incluir detalles relevantes (inmueble, tipo de problema)\n‚ùå NUNCA dejar vac√≠o si hay consulta activa\n\n**Ejemplos correctos:**\n```\n‚úÖ \"Consulta sobre c√≥mo pagar alquiler mediante Kashio\"\n‚úÖ \"Fuga de agua en ba√±o del depto 205 que da√±a muebles. Urgente.\"\n‚úÖ \"Solicita cambio de habitaci√≥n del inmueble 503\"\n‚úÖ \"Propietario no recibi√≥ pago de contraprestaci√≥n del mes\"\n‚úÖ \"Consulta sobre posibilidad de subarrendar departamento\"\n‚úÖ \"Solicita c√≥digo WiFi para conectarse\"\n```\n\n### **4. requiereTicket y detalle_ticket**\n- Si `requiereTicket = true` ‚Üí DEBES llenar `detalle_ticket`\n- Si `requiereTicket = false` ‚Üí `detalle_ticket` debe ser \"\"\n- `detalle_ticket` debe explicar QU√â debe hacer el equipo\n\n**Ejemplos correctos:**\n```\n‚úÖ \"Coordinar reparaci√≥n urgente de fuga en ba√±o depto 205\"\n‚úÖ \"Verificar por qu√© no aparece pago pendiente en sistema\"\n‚úÖ \"Revisar contrato inmueble 102 sobre condiciones de subarriendo\"\n‚úÖ \"Validar pago de contraprestaci√≥n no recibido por propietario del inmueble 401\"\n‚úÖ \"Coordinar cambio de habitaci√≥n de inquilina del inmueble 503\"\n```\n\n### **5. caso_especial y detalle_caso_especial**\n- Si `caso_especial = true` ‚Üí DEBES llenar `detalle_caso_especial`\n- Si `caso_especial = false` ‚Üí `detalle_caso_especial` debe ser \"\"\n- `detalle_caso_especial` debe explicar POR QU√â es caso especial\n\n**Ejemplos correctos:**\n```\n‚úÖ \"Base de conocimiento no tiene informaci√≥n sobre condiciones de subarriendo\"\n‚úÖ \"Cliente solicita hablar directamente con un asesor humano\"\n‚úÖ \"Consulta muy espec√≠fica sobre cl√°usula contractual que requiere revisi√≥n especializada\"\n‚úÖ \"Bot no encontr√≥ informaci√≥n sobre este tipo de servicio en su base de datos\"\n‚úÖ \"Situaci√≥n compleja con m√∫ltiples problemas que requiere evaluaci√≥n integral\"\n```\n\n### **6. categoria_completa**\n‚úÖ SIEMPRE usar formato: \"NIVEL_1 - NIVEL_2 - NIVEL_3\"\n‚úÖ Con espacios antes y despu√©s de los guiones\n‚úÖ Todo en MAY√öSCULAS\n‚úÖ Sin tildes ni caracteres especiales\n\n### **7. tiene_solucion y descripcion_solucion**\n\n**tiene_solucion:**\n- `true`: Cuando el bot YA brind√≥ alguna informaci√≥n, respuesta o soluci√≥n al cliente\n- `false`: Cuando a√∫n NO se ha proporcionado ninguna soluci√≥n\n\n**descripcion_solucion (SOLO si tiene_solucion = true):**\n‚úÖ Describir QU√â informaci√≥n o soluci√≥n se brind√≥\n‚úÖ Ser espec√≠fico sobre la acci√≥n realizada\n‚úÖ Usar tiempo pasado (\"se brind√≥\", \"se envi√≥\", \"se explic√≥\")\n‚úÖ M√°ximo 150 caracteres\n‚ùå Dejar vac√≠o (\"\") si tiene_solucion = false\n\n**Ejemplos correctos:**\n```\ntiene_solucion: true\ndescripcion_solucion: \"Se brind√≥ el RUC de la empresa\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se envi√≥ el c√≥digo de pago del inmueble 301\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se explic√≥ el proceso completo de pago mediante Kashio con manual incluido\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se proporcion√≥ la clave WiFi y nombre de red\"\n\ntiene_solucion: true\ndescripcion_solucion: \"Se busc√≥ informaci√≥n de informes del cliente Juan y se enviaron los reportes solicitados\"\n\ntiene_solucion: false\ndescripcion_solucion: \"\"  (cuando a√∫n no se ha dado soluci√≥n)\n```\n\n**IMPORTANTE:** Este campo es independiente de si requiere ticket. Puede haber casos donde:\n- tiene_solucion=true y requiereTicket=false (bot resolvi√≥ todo)\n- tiene_solucion=true y requiereTicket=true (bot dio info parcial pero requiere seguimiento)\n- tiene_solucion=false y requiereTicket=true (a√∫n no hay soluci√≥n, se escal√≥)\n\n### **8. seg_1 y seg_2 (Mensajes de Seguimiento)**\n\n**REGLAS GENERALES:**\n‚úÖ SIEMPRE deben tener contenido (nunca vac√≠os)\n‚úÖ M√°ximo 150 caracteres cada uno\n‚úÖ Tono amigable, natural y cercano\n‚úÖ Contextuales a la conversaci√≥n actual\n‚úÖ Incluir el nombre del cliente si est√° disponible\n‚ùå **NO USAR EMOJIS** (cr√≠tico)\n\n**seg_1 (Primer seguimiento):**\n- Prop√≥sito: Reactivar conversaci√≥n si cliente deja en visto\n- Referencia a la informaci√≥n compartida o consulta realizada\n- Pregunta si pudo revisar o si tiene dudas\n- Tono: Amigable, no insistente\n\n**Ejemplos de seg_1:**\n```\n\"Hola Juan, ¬øpudiste revisar el c√≥digo de pago que te compart√≠?\"\n\"Hola Mar√≠a, ¬øte qued√≥ alguna duda sobre el proceso de pago? Estoy aqu√≠ para ayudarte\"\n\"¬øLograste ver la informaci√≥n que te envi√© sobre Kashio?\"\n\"Hola Carlos, ¬ønecesitas algo m√°s sobre tu consulta de cambio de habitaci√≥n?\"\n\"¬øPudiste revisar el manual? Si tienes alguna pregunta, con gusto te ayudo\"\n```\n\n**seg_2 (Segundo seguimiento):**\n- Prop√≥sito: Segunda oportunidad de reactivar conversaci√≥n\n- Ofrecer ayuda adicional\n- Preguntar si necesita algo m√°s\n- Dejar la puerta abierta para futuras consultas\n- Tono: Servicial, cierra con ofrecimiento de ayuda\n\n**Ejemplos de seg_2:**\n```\n\"¬øHay algo m√°s en lo que pueda ayudarte? Estoy aqu√≠ cuando me necesites\"\n\"Si necesitas cualquier otra informaci√≥n, no dudes en escribirme\"\n\"¬øTodo qued√≥ claro con tu consulta? Aqu√≠ estoy para lo que necesites\"\n\"Si tienes alguna otra pregunta, con gusto te ayudo\"\n\"Cualquier duda adicional, puedes contactarme. Que tengas un buen d√≠a\"\n```\n\n**CONSIDERACIONES ESPECIALES:**\n\n**Si el cliente NO est√° identificado:**\n```\nseg_1: \"Hola, ¬øsigues ah√≠? ¬øPuedo ayudarte con algo?\"\nseg_2: \"Estoy disponible si necesitas asistencia. ¬øEn qu√© puedo ayudarte?\"\n```\n\n**Si la consulta fue resuelta:**\n```\nseg_1: \"¬øLa informaci√≥n que te compart√≠ te fue √∫til?\"\nseg_2: \"Si necesitas algo m√°s, aqu√≠ estoy para ayudarte\"\n```\n\n**Si requiere ticket o caso especial:**\n```\nseg_1: \"Un asesor se contactar√° contigo pronto. ¬øTienes alguna duda mientras tanto?\"\nseg_2: \"¬øHay algo m√°s que pueda ayudarte mientras esperas la atenci√≥n del asesor?\"\n```\n\n### **9. statusId**\n‚úÖ SIEMPRE num√©rico SIN comillas\n‚úÖ Solo valores v√°lidos: 10001, 10002, 10003, 10004, 10005, 10006\n‚ùå NO usar: \"10001\", 10007, 10008, etc.\n\n---\n\n## üîç **EJEMPLOS COMPLETOS**\n\n### **Ejemplo 1: Interacci√≥n Inicial**\n\n**Conversaci√≥n:**\n```\nCliente: \"Hola, buenos d√≠as\"\nBot: [Ejecuta b√∫squeda por tel√©fono]\nBot: \"Hola, no encuentro un registro con tu n√∫mero. ¬øPodr√≠as brindarme tu correo electr√≥nico?\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"\",\n  \"telefonoCliente\": \"+51923456789\",\n  \"correoCliente\": \"\",\n  \"persona\": \"\",\n  \"codigoInmueble\": \"\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"NO_IDENTIFICADO - IDENTIFICACION - PENDIENTE\",\n  \n  \"resumen_solicitud\": \"Cliente salud√≥ pero a√∫n no proporciona datos para identificarse\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola, ¬øsigues por ah√≠? Estoy listo para ayudarte con lo que necesites\",\n  \"seg_2\": \"¬øHay algo en lo que pueda asistirte? Estoy disponible cuando quieras\",\n  \n  \"estatusEmbudo\": \"INTERACCION IA\",\n  \"statusId\": 10001,\n  \n  \"clienteIdentificado\": false\n}\n```\n\n---\n\n### **Ejemplo 2: Cliente Identificado**\n\n**Conversaci√≥n:**\n```\nCliente: \"Hola\"\nBot: [Busca por tel√©fono - encontrado]\nBot: \"Perfecto Juan, te identifico como inquilino del inmueble 301. ¬øEn qu√© puedo ayudarte?\"\nCliente: [A√∫n no responde]\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Juan\",\n  \"telefonoCliente\": \"+51987654321\",\n  \"correoCliente\": \"juan@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"301\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CONSULTAS - GENERAL\",\n  \n  \"resumen_solicitud\": \"Cliente identificado, esperando que indique su consulta\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Juan, ¬øen qu√© puedo ayudarte hoy?\",\n  \"seg_2\": \"¬øHay algo en lo que pueda asistirte? Estoy aqu√≠ para lo que necesites\",\n  \n  \"estatusEmbudo\": \"CLIENTE IDENTIFICADO IA\",\n  \"statusId\": 10002,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 3: Consulta Resuelta**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Juan, te identifico como inquilino del inmueble 301. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"¬øC√≥mo pago el alquiler?\"\nBot: [HTTP Request - encuentra respuesta]\nBot: \"Para pagar tu alquiler mediante Kashio, sigue estos pasos: [instrucciones completas]\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Juan\",\n  \"telefonoCliente\": \"+51987654321\",\n  \"correoCliente\": \"juan@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"301\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - PAGOS - KASHIO\",\n  \n  \"resumen_solicitud\": \"Consulta sobre c√≥mo pagar alquiler mediante Kashio\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se explic√≥ el proceso completo de pago mediante Kashio con instrucciones detalladas\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Juan, ¬øpudiste revisar las instrucciones de pago por Kashio?\",\n  \"seg_2\": \"¬øTe qued√≥ alguna duda sobre el proceso? Con gusto puedo ayudarte\",\n  \n  \"estatusEmbudo\": \"CONSULTA RESUELTA IA\",\n  \"statusId\": 10003,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 4: Ticket Urgencia Alta**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Mar√≠a, te identifico como inquilina del inmueble 205. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"Tengo una fuga de agua muy grande en mi ba√±o, est√° da√±ando mis muebles\"\nBot: \"Entiendo, es una situaci√≥n urgente. Un asesor del √°rea de mantenimiento se contactar√° contigo lo m√°s pronto posible.\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Mar√≠a\",\n  \"telefonoCliente\": \"+51912345678\",\n  \"correoCliente\": \"maria@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"205\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - MANTENIMIENTO - FUGA_AGUA\",\n  \n  \"resumen_solicitud\": \"Fuga de agua muy grande en ba√±o del depto 205, est√° da√±ando muebles. Requiere atenci√≥n urgente.\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Coordinar reparaci√≥n URGENTE de fuga de agua en ba√±o depto 205. Est√° causando da√±os a muebles. Prioridad ALTA - contactar lo m√°s pronto posible.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Mar√≠a, el √°rea de mantenimiento se contactar√° contigo muy pronto. ¬øTienes alguna duda mientras tanto?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la atenci√≥n del √°rea de mantenimiento?\",\n  \n  \"estatusEmbudo\": \"TICKET IA\",\n  \"statusId\": 10004,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 5: Caso Especial**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Carlos, te identifico como inquilino del inmueble 102. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"¬øPuedo subarrendar mi departamento?\"\nBot: [HTTP Request - no encuentra respuesta]\nBot: \"Entiendo tu consulta. No encuentro informaci√≥n espec√≠fica sobre subarriendo. Un asesor especializado se contactar√° contigo para revisar las condiciones de tu contrato.\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Carlos\",\n  \"telefonoCliente\": \"+51998765432\",\n  \"correoCliente\": \"carlos@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"102\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CONSULTAS - SUBARRIENDO\",\n  \n  \"resumen_solicitud\": \"Consulta sobre posibilidad de subarrendar su departamento\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Revisar cl√°usulas del contrato del inmueble 102 para determinar si permite subarriendo. Responder al inquilino con informaci√≥n espec√≠fica.\",\n  \n  \"caso_especial\": true,\n  \"detalle_caso_especial\": \"Base de conocimiento no tiene informaci√≥n espec√≠fica sobre condiciones de subarriendo. Requiere revisi√≥n de contrato por asesor especializado.\",\n  \n  \"seg_1\": \"Hola Carlos, un asesor se contactar√° contigo pronto para revisar tu contrato. ¬øTienes otra consulta mientras tanto?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la respuesta del asesor?\",\n  \n  \"estatusEmbudo\": \"CASO ESPECIAL IA\",\n  \"statusId\": 10005,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 6: Ticket Urgencia Media**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Luis, te identifico como propietario del inmueble 401. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"No he recibido mi pago de este mes\"\nBot: \"Entiendo tu preocupaci√≥n. Un asesor del √°rea de pagos verificar√° tu situaci√≥n y se contactar√° contigo en un m√°ximo de 48 horas h√°biles.\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Luis\",\n  \"telefonoCliente\": \"+51934567890\",\n  \"correoCliente\": \"luis@email.com\",\n  \"persona\": \"propietario\",\n  \"codigoInmueble\": \"401\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO - PAGOS - CONTRAPRESTACION_NO_RECIBIDA\",\n  \n  \"resumen_solicitud\": \"Propietario no recibi√≥ pago de contraprestaci√≥n del mes actual para inmueble 401\",\n  \n  \"tiene_solucion\": false,\n  \"descripcion_solucion\": \"\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Verificar con √°rea de pagos por qu√© no se realiz√≥ el dep√≥sito de contraprestaci√≥n al propietario del inmueble 401. Revisar estado del pago y contactar al propietario en m√°ximo 48 horas h√°biles.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Luis, el √°rea de pagos est√° verificando tu caso y se contactar√° contigo pronto. ¬øTienes alguna otra consulta?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la respuesta del √°rea de pagos?\",\n  \n  \"estatusEmbudo\": \"TICKET IA\",\n  \"statusId\": 10004,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 7: Conversaci√≥n Acumulativa - M√∫ltiples Mensajes**\n\n**Conversaci√≥n:**\n```\n[Mensaje 1]\nCliente: \"Hola\"\nBot: [Busca - 404]\nBot: \"Hola, no encuentro registro. ¬øTu correo?\"\n\n[Mensaje 2]\nCliente: \"ana@email.com\"\nBot: [Busca por correo - encontrado]\nBot: \"Perfecto Ana, te identifico como inquilina del 503. ¬øEn qu√© puedo ayudarte?\"\n\n[Mensaje 3]\nCliente: \"Necesito el c√≥digo de pago\"\nBot: \"Con gusto, te env√≠o tu c√≥digo de pago para el inmueble 503: [c√≥digo]\"\n\n[Mensaje 4]\nCliente: \"Gracias. Tambi√©n quiero saber si puedo cambiar de habitaci√≥n\"\nBot: \"Entiendo. Para coordinar un cambio de habitaci√≥n, un asesor se contactar√° contigo en 48 horas h√°biles.\"\n```\n\n**JSON (An√°lisis de TODA la conversaci√≥n):**\n```json\n{\n  \"nombreCliente\": \"Ana\",\n  \"telefonoCliente\": \"+51945678901\",\n  \"correoCliente\": \"ana@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"503\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CAMBIOS - HABITACION_DEPARTAMENTO\",\n  \n  \"resumen_solicitud\": \"Solicitud de c√≥digo de pago (ya resuelto). Actualmente solicita cambio de habitaci√≥n del inmueble 503.\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se proporcion√≥ el c√≥digo de pago del inmueble 503\",\n  \n  \"requiereTicket\": true,\n  \"detalle_ticket\": \"Coordinar con √°rea correspondiente sobre solicitud de cambio de habitaci√≥n de la inquilina Ana del inmueble 503. Validar disponibilidad y condiciones. Contactar en 48 horas h√°biles.\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Ana, un asesor se contactar√° contigo pronto sobre el cambio de habitaci√≥n. ¬øTienes alguna otra consulta?\",\n  \"seg_2\": \"¬øHay algo m√°s en lo que pueda ayudarte mientras esperas la respuesta sobre tu cambio?\",\n  \n  \"estatusEmbudo\": \"TICKET IA\",\n  \"statusId\": 10004,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n**NOTA:** El an√°lisis es ACUMULATIVO. Se consider√≥ toda la conversaci√≥n pero la etapa y categor√≠a reflejan el √∫ltimo requerimiento ACTIVO (cambio de habitaci√≥n), mencionando brevemente que la consulta del c√≥digo de pago ya fue resuelta. El campo `tiene_solucion=true` porque S√ç se brind√≥ soluci√≥n al c√≥digo de pago.\n\n---\n\n### **Ejemplo 8: Consulta con Soluci√≥n - RUC de Empresa**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Sandra, te identifico como inquilina del inmueble 602. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"Necesito el RUC de la empresa para mi contabilidad\"\nBot: \"Claro, el RUC de PROPER PER√ö es 20123456789. ¬øNecesitas alg√∫n otro dato?\"\nCliente: [No responde]\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Sandra\",\n  \"telefonoCliente\": \"+51956789012\",\n  \"correoCliente\": \"sandra@email.com\",\n  \"persona\": \"inquilino\",\n  \"codigoInmueble\": \"602\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"INQUILINO - CONSULTAS - INFORMACION_EMPRESA\",\n  \n  \"resumen_solicitud\": \"Solicitud del RUC de la empresa para su contabilidad\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se proporcion√≥ el RUC de PROPER PER√ö (20123456789)\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Sandra, ¬øte sirvi√≥ el RUC que te compart√≠?\",\n  \"seg_2\": \"¬øNecesitas alg√∫n otro dato de la empresa? Estoy aqu√≠ para ayudarte\",\n  \n  \"estatusEmbudo\": \"CONSULTA RESUELTA IA\",\n  \"statusId\": 10003,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n### **Ejemplo 9: Env√≠o de Reporte Solicitado**\n\n**Conversaci√≥n:**\n```\nBot: \"Perfecto Roberto, te identifico como propietario del inmueble 305. ¬øEn qu√© puedo ayudarte?\"\nCliente: \"Necesito que me env√≠es el reporte de ocupaci√≥n de mi departamento\"\nBot: [Busca informaci√≥n]\nBot: \"Por supuesto, te env√≠o el reporte de ocupaci√≥n del inmueble 305. [adjunta archivo PDF]\"\n```\n\n**JSON:**\n```json\n{\n  \"nombreCliente\": \"Roberto\",\n  \"telefonoCliente\": \"+51967890123\",\n  \"correoCliente\": \"roberto@email.com\",\n  \"persona\": \"propietario\",\n  \"codigoInmueble\": \"305\",\n  \"relacionTitular\": \"\",\n  \n  \"categoria_completa\": \"PROPIETARIO - PLATAFORMA - REPORTES\",\n  \n  \"resumen_solicitud\": \"Solicitud de reporte de ocupaci√≥n del inmueble 305\",\n  \n  \"tiene_solucion\": true,\n  \"descripcion_solucion\": \"Se busc√≥ y envi√≥ el reporte de ocupaci√≥n del inmueble 305 en formato PDF\",\n  \n  \"requiereTicket\": false,\n  \"detalle_ticket\": \"\",\n  \n  \"caso_especial\": false,\n  \"detalle_caso_especial\": \"\",\n  \n  \"seg_1\": \"Hola Roberto, ¬øpudiste revisar el reporte de ocupaci√≥n que te envi√©?\",\n  \"seg_2\": \"¬øNecesitas alg√∫n otro reporte o informaci√≥n? Con gusto te ayudo\",\n  \n  \"estatusEmbudo\": \"CONSULTA RESUELTA IA\",\n  \"statusId\": 10003,\n  \n  \"clienteIdentificado\": true\n}\n```\n\n---\n\n## ‚ö° **REGLAS DE EXTRACCI√ìN DE DATOS**\n\n### **TEL√âFONO:**\n- Buscar: 9XX XXX XXX, 9XXXXXXXX\n- Agregar +51 si falta\n- Formato final: +51XXXXXXXXX\n- Si NO aparece: \"\"\n\n### **CORREO:**\n- Validar: texto@dominio.extension\n- Convertir a min√∫sculas\n- Sin espacios\n- Si NO aparece: \"\"\n\n### **NOMBRE:**\n- Extraer del mensaje del bot cuando identifica\n- Primera letra en may√∫scula\n- Sin t√≠tulos (Sr., Sra., etc.)\n- Si NO aparece: \"\"\n\n### **PERSONA:**\n- Valores v√°lidos: \"inquilino\", \"propietario\", \"proveedor\"\n- Extraer cuando bot dice \"te identifico como...\"\n- Si NO aparece: \"\"\n\n### **C√ìDIGO INMUEBLE:**\n- Extraer del mensaje de confirmaci√≥n del bot\n- N√∫mero o alfanum√©rico\n- Si varios, usar el relevante a la consulta\n- Si NO aparece: \"\"\n\n---\n\n## ‚ö†Ô∏è **CHECKLIST OBLIGATORIO ANTES DE RESPONDER**\n\n```\n‚ñ° ¬øLe√≠ TODA la conversaci√≥n desde el inicio hasta el final?\n‚ñ° ¬øRevis√© la infoPrevia si existe?\n‚ñ° ¬øExtraje SOLO informaci√≥n que est√° EXPL√çCITAMENTE en la conversaci√≥n?\n‚ñ° ¬øNO invent√© ning√∫n dato?\n‚ñ° ¬øEl cliente fue identificado por el bot?\n‚ñ° ¬øLa categoria_completa tiene formato: NIVEL_1 - NIVEL_2 - NIVEL_3?\n‚ñ° ¬øEl resumen_solicitud est√° completo y es claro?\n‚ñ° ¬øEvalu√© correctamente si tiene_solucion es true o false?\n‚ñ° ¬øSi tiene_solucion=true, complet√© descripcion_solucion?\n‚ñ° ¬øSi requiereTicket=true, complet√© detalle_ticket?\n‚ñ° ¬øSi caso_especial=true, complet√© detalle_caso_especial?\n‚ñ° ¬øLos mensajes seg_1 y seg_2 est√°n completos y son contextuales?\n‚ñ° ¬øEl statusId es NUM√âRICO sin comillas?\n‚ñ° ¬øEl estatusEmbudo corresponde al statusId?\n‚ñ° ¬øTodos los campos requeridos est√°n presentes?\n‚ñ° ¬øEl JSON es v√°lido y est√° completo?\n```\n\n---\n\n## üî¥ **RECORDATORIO CR√çTICO FINAL**\n\n```\nANTES DE RESPONDER, VERIFICAR:\n\n1. ‚úÖ LE√çSTE TODA LA CONVERSACI√ìN COMPLETA\n   ‚Üí No te saltaste ning√∫n mensaje\n   ‚Üí Consideraste infoPrevia si existe\n\n2. ‚úÖ NO INVENTASTE INFORMACI√ìN\n   ‚Üí Solo extraes lo que est√° escrito\n   ‚Üí Campos vac√≠os (\"\") si no hay datos\n\n3. ‚úÖ CATEGORIZACI√ìN CORRECTA\n   ‚Üí Formato: \"NIVEL_1 - NIVEL_2 - NIVEL_3\"\n   ‚Üí Con espacios y guiones correctos\n\n4. ‚úÖ EVALUACI√ìN DE SOLUCI√ìN\n   ‚Üí tiene_solucion: true/false correctamente evaluado\n   ‚Üí Si true ‚Üí descripcion_solucion lleno\n   ‚Üí Si false ‚Üí descripcion_solucion vac√≠o\n\n5. ‚úÖ CAMPOS CONDICIONALES\n   ‚Üí requiereTicket=true ‚Üí detalle_ticket lleno\n   ‚Üí caso_especial=true ‚Üí detalle_caso_especial lleno\n\n6. ‚úÖ MENSAJES DE SEGUIMIENTO\n   ‚Üí seg_1 y seg_2 SIEMPRE con contenido\n   ‚Üí Contextuales a la conversaci√≥n\n   ‚Üí M√°ximo 150 caracteres cada uno\n   ‚Üí Tono amigable y natural\n\n7. ‚úÖ ETAPA CORRECTA\n   ‚Üí statusId num√©rico (10001-10006)\n   ‚Üí estatusEmbudo correspondiente\n\n8. ‚úÖ JSON COMPLETO Y V√ÅLIDO\n   ‚Üí Todos los campos presentes\n   ‚Üí Sintaxis correcta\n\nRESPONDER SOLO JSON VALIDADO Y COMPLETO\n```\n\n---\n\n## üìñ **REFERENCIA R√ÅPIDA**\n\n```\nETAPAS:\n10001 - INTERACCION IA (cliente inicia, no identificado)\n10002 - CLIENTE IDENTIFICADO IA (identificado, sin consulta a√∫n)\n10003 - CONSULTA RESUELTA IA (bot resolvi√≥ completamente)\n10004 - TICKET IA (requiere intervenci√≥n humana)\n10005 - CASO ESPECIAL IA (bot sin info o complejo)\n10006 - ASESOR IA (atenci√≥n humana directa)\n\nCATEGORIZACI√ìN:\nNIVEL_1: INQUILINO / PROPIETARIO / NO_IDENTIFICADO\nNIVEL_2: MANTENIMIENTO / PAGOS / ACCESOS / LIMPIEZA / etc.\nNIVEL_3: Descriptor espec√≠fico (DUCHA / WIFI / etc.)\n\nFORMATO: \"NIVEL_1 - NIVEL_2 - NIVEL_3\"\n```\n\n---\n\n**FIN DEL PROMPT v4.0**"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        5360,
        1184
      ],
      "id": "a1980cdd-e53f-4e35-a984-aaa7fe0f9c12",
      "name": "Campos5",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "nombreCliente",
              "description": "Nombre completo extra√≠do de la conversaci√≥n o \"\"",
              "required": true
            },
            {
              "name": "telefonoCliente",
              "description": "+51XXXXXXXXX o \"\"",
              "required": true
            },
            {
              "name": "correoCliente",
              "description": "email@domain.com o \"\"",
              "required": true
            },
            {
              "name": "persona",
              "description": "\"inquilino\" / \"propietario\" / \"proveedor\" / \"\"",
              "required": true
            },
            {
              "name": "codigoInmueble",
              "description": "C√≥digo del inmueble o \"\"",
              "required": true
            },
            {
              "name": "relacionTitular",
              "description": "\"pareja\" / \"familiar\" / etc, o \"\" si es titular directo",
              "required": true
            },
            {
              "name": "categoria_completa",
              "description": " \"NIVEL_1 - NIVEL_2 - NIVEL_3\" (formato exacto con espacios y guiones)",
              "required": true
            },
            {
              "name": "resumen_solicitud",
              "description": "Resumen breve y claro (m√°x 200 caracteres) de lo que solicita el cliente",
              "required": true
            },
            {
              "name": "tiene_solucion",
              "type": "boolean",
              "description": "true = Se brind√≥ alguna informaci√≥n/respuesta/soluci√≥n al cliente false = A√∫n no se ha brindado soluci√≥n Este campo es INDEPENDIENTE de si requiere ticket o no",
              "required": true
            },
            {
              "name": "descripcion_solucion",
              "description": "(SOLO si tiene_solucion = true)  Describir QU√â soluci√≥n se brind√≥ o QU√â informaci√≥n se proporcion√≥ Ser espec√≠fico sobre la acci√≥n realizada Ejemplos: \"Se brind√≥ el RUC de la empresa\", \"Se envi√≥ el c√≥digo de pago\", \"Se explic√≥ el proceso de pago por Kashio\" Si tiene_solucion = false ‚Üí dejar vac√≠o \"\"",
              "required": true
            },
            {
              "name": "requiereTicket",
              "type": "boolean",
              "description": "true / false  true = Necesita intervenci√≥n humana false = Bot resolvi√≥ o no requiere acci√≥n",
              "required": true
            },
            {
              "name": "detalle_ticket",
              "description": "(SOLO si requiereTicket = true)  Explicar QU√â debe hacer el equipo Incluir nivel de urgencia si aplica Ser claro y espec√≠fico Si requiereTicket = false ‚Üí dejar vac√≠o \"\"",
              "required": true
            },
            {
              "name": "caso_especial",
              "type": "boolean",
              "description": "true / false  true = Bot no tiene info O cliente pide humano O situaci√≥n compleja false = Caso normal",
              "required": true
            },
            {
              "name": "detalle_caso_especial",
              "description": "(SOLO si caso_especial = true)  Explicar POR QU√â es caso especial Ser espec√≠fico Si caso_especial = false ‚Üí dejar vac√≠o \"\"",
              "required": true
            },
            {
              "name": "seg_1",
              "description": "Primer mensaje de seguimiento para el cliente",
              "required": true
            },
            {
              "name": "seg_2",
              "description": "Segundo mensaje de seguimiento para el cliente",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Nombre de la etapa (ver lista arriba)",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "C√≥digo num√©rico SIN comillas (10001-10006)",
              "required": true
            },
            {
              "name": "clienteIdentificado",
              "type": "boolean",
              "description": "true / false  true = Bot confirm√≥ identificaci√≥n con datos completos false = Cliente NO identificado a√∫n",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        5776,
        1184
      ],
      "id": "55c05c9b-82d6-404d-ac1e-f80e0a8ef27e",
      "name": "Information Extractor5",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5376,
        1408
      ],
      "id": "55d67d1c-35e5-44b2-84b7-f5f5ad2f35e5",
      "name": "OpenAI Chat Model13",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        5840,
        1408
      ],
      "id": "05900f10-f1de-4b1f-b039-e7c28431f426",
      "name": "OpenAI Chat Model14",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper - Oct 2025"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": "=",
              "status_id": "=",
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":798799,\"type\":\"text\"}",
                    "value": "={{ $json.output.persona }}"
                  },
                  {
                    "data": "{\"id\":798801,\"type\":\"text\"}",
                    "value": "={{ $json.output.codigoInmueble }}"
                  },
                  {
                    "data": "{\"id\":798803,\"type\":\"text\"}",
                    "value": "={{ $json.output.relacionTitular }}"
                  },
                  {
                    "data": "{\"id\":798805,\"type\":\"text\"}",
                    "value": "={{ $json.output.categoria_completa }}"
                  },
                  {
                    "data": "{\"id\":798807,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.resumen_solicitud }}"
                  },
                  {
                    "data": "{\"id\":798835,\"type\":\"checkbox\"}",
                    "value": "={{ $json.output.tiene_solucion }}"
                  },
                  {
                    "data": "{\"id\":798837,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.descripcion_solucion }}"
                  },
                  {
                    "data": "{\"id\":798809,\"type\":\"text\"}",
                    "value": "={{ $json.output.requiereTicket }}"
                  },
                  {
                    "data": "{\"id\":798811,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.detalle_ticket }}"
                  },
                  {
                    "data": "{\"id\":798813,\"type\":\"checkbox\"}",
                    "value": "={{ $json.output.caso_especial }}"
                  },
                  {
                    "data": "{\"id\":798815,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.detalle_caso_especial }}"
                  },
                  {
                    "data": "{\"id\":798825,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.seg_1 }}"
                  },
                  {
                    "data": "{\"id\":798827,\"type\":\"textarea\"}",
                    "value": "={{ $json.output.seg_2 }}"
                  },
                  {
                    "data": "{\"id\":798817,\"type\":\"text\"}",
                    "value": "={{ $json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":798819,\"type\":\"checkbox\"}",
                    "value": "={{ $json.output.clienteIdentificado }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        6240,
        1296
      ],
      "id": "01a0caad-8262-4fd3-8ca6-9a9b64338ad5",
      "name": "Update leads5",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        5504,
        1408
      ],
      "id": "52ae62ae-0ca3-4406-b93f-487da0b6f2cd",
      "name": "Postgres Chat Memory9",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "f6fab1ee-de46-4c6f-b3a4-33b992dac988",
              "leftValue": "={{ $('GET Lead').item.json._embedded.tags }}",
              "rightValue": "TEST",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2224,
        2816
      ],
      "id": "5a1ba984-d0cf-4afa-991a-e035bf2ae0e8",
      "name": "TEST"
    },
    {
      "parameters": {
        "description": "=# THINK V8.1 - ANALISIS ESTRATEGICO PRE-RESPUESTA\n\n## ANALISIS DE CONTEXTO - Primero siempre\n\n### 1. COMPRENSION DEL CLIENTE\n- Que busca realmente: departamento especifico, informacion general, resolver duda\n- En que etapa esta:\n  - Explorando opciones\n  - Ya vio algo especifico (foto/link)\n  - Ya eligio propiedad\n  - Listo para agendar visita\n- Que tono esta usando: urgente, relajado, dudoso, decidido\n\n### 2. REVISION DEL HISTORIAL\n- Ultimos 5-7 mensajes: Que hemos conversado\n- Ya menciono preferencias: distrito, dormitorios, presupuesto\n- Ya eligio una propiedad especifica: codigo, descripcion\n- Ya di informacion: No repetir, continuar la conversacion\n\n## IDENTIFICACION GEOGRAFICA\n\n### DETECCION MODO - Prioridad alta\nEs MODO si menciona:\n- PUCP, Catolica, universidad en San Miguel/Pueblo Libre\n- Av. Universitaria con Tulipanes\n- Codigos: MODO, MODOTW, MODOLF\n- Proyecto al lado de la PUCP\n\nSi es MODO: NO usar herramientas, responder con info memorizada\n\n### MAPEO DE ZONAS A DISTRITO\nSi menciona zona/referencia, identificar distrito:\n- Monterrico = Surco\n- El Olivar = San Isidro \n- Santa Catalina = La Victoria\n- Gamarra = La Victoria\n- Kennedy = Miraflores\n- Chacarilla = Surco\n\nRegla: A herramientas SOLO envio DISTRITOS, nunca calles/zonas\n\n## DECISION DE HERRAMIENTAS\n\n### ARBOL DE DECISION RAPIDO\n\n1. Tiene FOTO o link REDES SOCIALES\n   SI: Preguntar distrito, luego PROPERTIES_SQL con tiene_panel=si\n   NO: Continuar\n\n2. Tiene LINK URBANIA\n   SI: BUSQUEDA_LINK_URBANIA, si codigo MODO entonces flujo especial\n   NO: Continuar\n\n3. Menciona MODO/PUCP\n   SI: Info directa sin herramientas\n   NO: Continuar\n\n4. Busca departamento\n   SI: Confirmar distrito, luego PROPERTIES_SQL normal\n   NO: Continuar\n\n5. Pide info que no tengo\n   SI: BASE_DE_CONOCIMIENTO, si no hay hacer transicion suave\n   NO: Mantener conversacion natural\n\n## ESTRATEGIA CONVERSACIONAL\n\n### PRINCIPIO FUNDAMENTAL\nObjetivo final: 2 horarios PERO solo DESPUES de elegir propiedad\n\n### SECUENCIA NATURAL\n1. Entender necesidad - no asumir\n2. Ofrecer valor - opciones atractivas\n3. Resolver dudas - generar confianza\n4. Cliente elige - esperar decision\n5. Sugerir visita - transicion suave\n6. Pedir horarios - amablemente\n\n### CONSTRUCCION DE RAPPORT\n- Primera respuesta: Saludo calido mas reconocer pedido\n- Segunda respuesta: Dar informacion valiosa\n- Tercera respuesta: Guiar hacia decision\n- Cuarta respuesta: Solicitar horarios naturalmente\n\n## FRASES ESTRATEGICAS A USAR\n\n### PARA PEDIR HORARIOS - Suave y progresivo\n- Que dias de esta semana te acomodan mejor para verlo\n- Para coordinar la visita, que 2 horarios prefieres\n- Te gustaria conocerlo. Dame un par de opciones de horario\n\n### CUANDO NO TENGO INFO - Transicion natural\n- Ese dato especifico lo verifico, pero mientras tanto...\n- Dejame conseguir esa info. Aprovecho para preguntarte...\n- No tengo ese detalle ahora, pero en la visita veras todo\n\n### PARA MOSTRAR OPCIONES - Atractivo\n- Tengo estas opciones que te van a encantar...\n- El depa en DISTRITO esta super bien ubicado...\n- Esta opcion incluye BENEFICIO relevante...\n\n## ALERTAS CRITICAS - VALIDACION\n\n### NUNCA HACER\n- Inventar codigos, precios o caracteristicas  \n- Confirmar visitas excepto MODO  \n- Pedir horarios sin propiedad elegida  \n- Usar placeholders o corchetes  \n- Decir: sistema, base de datos, procesando  \n- Mezclar informacion entre proyectos  \n\n### SIEMPRE HACER\n- Usar un asterisco para negritas en WhatsApp  \n- Mensajes de maximo 5-6 lineas  \n- Mantener tono casual: depa, info  \n- Seguir el hilo de la conversacion  \n- Verificar antes de afirmar  \n\n## CHECKLIST FINAL PRE-ENVIO\n\n### ANALISIS TECNICO\n- Identifique correctamente: MODO vs Regular\n- Use la herramienta correcta: Segun el arbol de decision\n- Converti zona a distrito: Para PROPERTIES_SQL\n- Revise el historial: No repetir, continuar flujo\n\n### CALIDAD DE RESPUESTA\n- Sueno natural: Como humano real, no bot\n- Estoy inventando algo: TODO verificable\n- Segui la secuencia: Propiedad luego horarios\n- Construi rapport: No fui directo/agresivo\n\n### FORMATO Y ESTILO\n- Mensaje corto: Maximo 5-6 lineas\n- Sin placeholders: Ningun corchete o llave\n- WhatsApp correcto: Un asterisco para negrita\n- Tono apropiado: Casual pero profesional\n\n### COHERENCIA\n- Respondo lo que pregunto: No desvio\n- Mantengo el contexto: Sigo la conversacion\n- Avanzo hacia el objetivo: Guio hacia visita\n- Cierro con accion clara: Siguiente paso definido\n\n## RESPUESTAS RAPIDAS POR SITUACION\n\n### Cliente nuevo con foto\n1. Analizo: Necesita opciones similares\n2. Pregunto: Distrito de la foto\n3. Busco: PROPERTIES_SQL con panel\n4. Presento: Opciones atractivas\n5. Espero: Que elija\n6. Pido: 2 horarios suavemente\n\n### Cliente con link Urbania\n1. Ejecuto: BUSQUEDA_LINK_URBANIA\n2. Verifico: Es MODO - MODOTW/MODOLF\n3. Presento: Info mas condiciones\n4. Genero: Interes en visita\n5. Solicito: Horarios segun tipo\n\n### Cliente busca general\n1. Confirmo: Distrito primero\n2. Busco: Segun criterios\n3. Muestro: Mejores opciones\n4. Resuelvo: Dudas\n5. Guio: Hacia eleccion\n6. Coordino: Visita natural\n\n### Cliente ya eligio\n1. Reconozco: Su eleccion\n2. Genero: Entusiasmo\n3. Transiciono: Hacia visita\n4. Pido: 2 horarios amablemente\n5. Confirmo: Proximos pasos\n\n## RECORDATORIO ESTRATEGICO\n\nSoy David: Experto inmobiliario que conoce Lima perfectamente. Mi trabajo es hacer que el proceso sea facil y agradable. No soy un robot pidiendo datos, soy un asesor construyendo confianza.\n\nMi mantra:\n- Primero entender\n- Luego ayudar  \n- Despues coordinar\n- Siempre naturalmente\n\nSi dudo: Mejor verificar que inventar. Mejor transicion suave que respuesta dura.\n\n## VALIDACION FINAL\n\nTHINK COMPLETO - AHORA RESPONDER NATURALMENTE"
      },
      "type": "@n8n/n8n-nodes-langchain.toolThink",
      "typeVersion": 1.1,
      "position": [
        4576,
        1984
      ],
      "id": "5fdc8878-8d64-44bb-b449-26c2ecfe7171",
      "name": "Think"
    },
    {
      "parameters": {
        "toolDescription": "Usar en caso tengamos alguna consulta sobre MODO, horarios de atenci√≥n o datos de cuenta de proper",
        "url": "https://docs.google.com/document/d/e/2PACX-1vQJkHToHD6IQlB-imI-ZFwrwZkk1F4ZylrbiksQ9Gm2y0zpOeGfi29mhG3OjKyYXJR3WLxasQlttPW5/pub",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [
        4704,
        1760
      ],
      "id": "3adea9bb-b9cf-4282-8cde-a46a8a83eb65",
      "name": "BASE DE CONOCIMIENTO - DAVID"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8555f2b5-2479-4ffd-a99f-965fd2e26690",
              "leftValue": "={{ $('new message').item.json.body[\"account[subdomain]\"] }}",
              "rightValue": "TEST",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        5424,
        992
      ],
      "id": "55cbf070-78b2-4954-8eac-3288396ce33d",
      "name": "Filter"
    }
  ],
  "pinData": {
    "new message": [
      {
        "json": {
          "headers": {
            "host": "primary-production-0299.up.railway.app",
            "user-agent": "amoCRM-Webhooks/3.0",
            "content-length": "981",
            "accept-encoding": "gzip",
            "content-type": "application/x-www-form-urlencoded",
            "x-amocrm-requestid": "e6a54b29-0ec0-49c2-99f9-da639e80f539",
            "x-forwarded-for": "169.150.216.79",
            "x-forwarded-host": "primary-production-0299.up.railway.app",
            "x-forwarded-proto": "https",
            "x-railway-edge": "railway/us-east4-eqdc4a",
            "x-railway-request-id": "C9BZAhMjQiCpOwc8ozsQ6Q",
            "x-real-ip": "169.150.216.79",
            "x-request-start": "1763562152246"
          },
          "params": {},
          "query": {},
          "body": {
            "account[subdomain]": "propertamibotcom",
            "account[id]": "30050693",
            "account[_links][self]": "https://propertamibotcom.amocrm.com",
            "message[add][0][id]": "6d260933-b613-4bb1-8286-c70d36274d00",
            "message[add][0][chat_id]": "6796303f-72cf-4e6f-bc2d-539a859c1ea3",
            "message[add][0][talk_id]": "220447",
            "message[add][0][contact_id]": "24782394",
            "message[add][0][text]": "Podr√≠a brindarme informaci√≥n por favor",
            "message[add][0][created_at]": "1763562145",
            "message[add][0][element_type]": "2",
            "message[add][0][entity_type]": "lead",
            "message[add][0][element_id]": "22429948",
            "message[add][0][entity_id]": "22429948",
            "message[add][0][type]": "incoming",
            "message[add][0][author][id]": "d2187ef5-e521-404e-bbdc-0c58ae873c01",
            "message[add][0][author][type]": "external",
            "message[add][0][author][name]": "La Chabela detergente",
            "message[add][0][origin]": "waba"
          },
          "webhookUrl": "https://primary-production-0299.up.railway.app/webhook/rentas",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Lima",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "shared": [
    {
      "createdAt": "2025-08-01T18:40:51.374Z",
      "updatedAt": "2025-08-01T18:40:51.374Z",
      "role": "workflow:owner",
      "workflowId": "97xyyc9aCFy1mmbs",
      "projectId": "tpSonpyzopDOYZNA"
    }
  ],
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-08-01T18:41:06.465Z",
      "updatedAt": "2025-08-01T18:41:06.465Z",
      "id": "94z6tcDoVU8DriEW",
      "name": "IA"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-11-19T14:44:33.813Z",
  "versionId": "b8c3e601-b830-41c5-a2fd-69ee4bea45b2"
}