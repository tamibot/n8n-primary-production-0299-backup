{
  "active": true,
  "connections": {
    "enviar mensaje": {
      "main": [
        [
          {
            "node": "Update leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Campos": {
      "main": [
        [
          {
            "node": "Information Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBot": {
      "main": [
        [
          {
            "node": "Validacion",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter": {
      "main": [
        [
          {
            "node": "Set Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor": {
      "main": [
        [
          {
            "node": "SwitchBot",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validacion": {
      "main": [
        [
          {
            "node": "enviar mensaje",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "GET Lead",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Chat Memory Manager1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory2": {
      "ai_memory": [
        [
          {
            "node": "Chat Memory Manager1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Set Fields": {
      "main": [
        [
          {
            "node": "Push Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SwitchBuffer": {
      "main": [
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Delete message buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "Video content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "Image content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Voice content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Sort",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Chat input": {
      "main": [
        [
          {
            "node": "Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text content": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "JSON parse": {
      "main": [
        [
          {
            "node": "checkType",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Split Out": {
      "main": [
        [
          {
            "node": "JSON parse",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete message buffer": {
      "main": [
        [
          {
            "node": "Split Out",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis": {
      "main": [
        [
          {
            "node": "SwitchBuffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Push Buffer": {
      "main": [
        [
          {
            "node": "Redis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get PDF": {
      "main": [
        [
          {
            "node": "Upload PDF Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze video Gemini": {
      "main": [
        [
          {
            "node": "Video content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload video Gemini": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upload PDF Gemini": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze PDF Gemini": {
      "main": [
        [
          {
            "node": "PDF content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Analyze PDF Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get video": {
      "main": [
        [
          {
            "node": "Upload video Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Analyze video Gemini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get image": {
      "main": [
        [
          {
            "node": "recognize image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "recognize image": {
      "main": [
        [
          {
            "node": "Image content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "checkType": {
      "main": [
        [
          {
            "node": "Text content",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get voice",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get image",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get video",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "get PDF",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "transcribe voice": {
      "main": [
        [
          {
            "node": "Voice content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get voice": {
      "main": [
        [
          {
            "node": "transcribe voice",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Campos",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "new message": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "BUSQUEDA LINK URBANIA": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "PROPERTIES - SQL": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta": {
      "main": [
        [
          {
            "node": "Campos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Lead": {
      "main": [
        [
          {
            "node": "Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "Respuesta",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "Campos",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-01T18:40:51.374Z",
  "id": "97xyyc9aCFy1mmbs",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "RENTAS IA",
  "nodes": [
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "29e8ecb6-738e-4f8c-8bb1-576e6bec11c9",
              "leftValue": "={{ $('new message').item.json.body['message[add][0][origin]'] }}",
              "rightValue": "waba",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "2b4ab1f5-9898-4795-95ea-aaaa31a04cae",
              "leftValue": "={{ $json._embedded.tags }}",
              "rightValue": "stop_ai",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            },
            {
              "id": "9a5e4625-cdcb-496c-8c2b-36b73b513e19",
              "leftValue": "={{ $json._embedded.tags }}",
              "rightValue": "RENTAS",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -3104,
        500
      ],
      "id": "316666bc-2247-43ca-866b-f6080cf5d975",
      "name": "Filter"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://amojo.kommo.com/v1/chats/{{ $('Validacion').item.json.response.chats.session.account.id }}/{{ $('new message').item.json.body['message[add][0][chat_id]'] }}/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            },
            {
              "name": "Content-Type",
              "value": "application/x-www-form-urlencoded"
            },
            {
              "name": "X-Auth-Token",
              "value": "={{ $('Validacion').item.json.response.chats.session.access_token }}"
            },
            {
              "name": "chatId",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "silent",
              "value": "false"
            },
            {
              "name": "priority",
              "value": "low"
            },
            {
              "name": "crm_entity[id]",
              "value": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}"
            },
            {
              "name": "crm_entity[type]",
              "value": "={{ $('new message').item.json.body['message[add][0][element_type]'] }}"
            },
            {
              "name": "persona_name",
              "value": "={{ $('Validacion').item.json.response.chats.session.user.name }}"
            },
            {
              "name": "persona_avatar",
              "value": "={{ $('Validacion').item.json.response.chats.session.user.avatar }}"
            },
            {
              "name": "text",
              "value": "={{ $('Respuesta').item.json.output }}"
            },
            {
              "name": "recipient_id",
              "value": "={{ $('new message').item.json.body['message[add][0][author][id]'] }}"
            },
            {
              "name": "group_id"
            },
            {
              "name": "crm_dialog_id",
              "value": "={{ $('new message').item.json.body['message[add][0][talk_id]'] }}"
            },
            {
              "name": "crm_contact_id",
              "value": "={{ $('new message').item.json.body['message[add][0][contact_id]'] }}"
            },
            {
              "name": "crm_account_id",
              "value": "={{ $('new message').item.json.body['account[id]'] }}"
            },
            {
              "name": "skip_link_shortener",
              "value": "false"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "id": "1838a470-ec0f-44c5-8e5b-8714ed558d2a",
      "name": "enviar mensaje",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2728,
        350
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje proveniente del Cliente: {{ $('Chat input').item.json.chat_input }}\n\nRespuesta del bot: {{ $node[\"Respuesta\"].json.output }}\n\nInfo previa: {{ $node[\"Chat input\"].json.infoPrevia }}",
        "options": {
          "systemMessage": "=# üè† PROPER ANALYZER v2.0 - SISTEMA DE AN√ÅLISIS Y SEGUIMIENTO\n**Fecha actual:** {{ $now }} | **Zona horaria:** Am√©rica/Lima\n\n## üö® **INSTRUCCI√ìN CR√çTICA ABSOLUTA**\n**RESPONDER √öNICAMENTE CON JSON ESTRUCTURADO. PROHIBIDO CUALQUIER TEXTO FUERA DEL JSON.**\n\n---\n\n## üéØ **MISI√ìN PRINCIPAL**\nAnalizar conversaciones entre DAVID (bot Proper Rentas) y clientes para:\n1. Extraer informaci√≥n acumulativa de toda la conversaci√≥n\n2. Categorizar el estado del embudo seg√∫n progresi√≥n\n3. Generar mensajes de seguimiento personalizados\n4. Devolver TODO en formato JSON estructurado\n\n## üìä **PRINCIPIOS FUNDAMENTALES**\n\n### **ACUMULACI√ìN PERMANENTE**\n```\n‚úÖ TODA informaci√≥n es acumulativa\n‚úÖ Los datos NUNCA se pierden entre mensajes\n‚úÖ Las etapas SOLO avanzan seg√∫n el flujo\n‚úÖ Cada mensaje AGREGA informaci√≥n al estado anterior\n‚úÖ REVISAR SIEMPRE TODA LA CONVERSACI√ìN\n```\n\n### **PROHIBICIONES ABSOLUTAS**\n```\n‚ùå NUNCA inventar informaci√≥n no mencionada\n‚ùå NUNCA retroceder en las etapas del embudo\n‚ùå NUNCA asumir datos (correos, tel√©fonos, nombres)\n‚ùå NUNCA responder con texto fuera del JSON\n```\n\n---\n\n## üîÑ **FLUJO DE EMBUDO OBLIGATORIO**\n\n```\nINICIO ‚Üí DEFINIENDO ‚Üí INTERACTUANDO ‚Üí INTERESADO ‚Üí HORARIO INDICADO\n```\n\n### **90801072 - Ingreso con Propiedad**\n- **Activaci√≥n:** SOLO al inicio SI hay enlace URL o c√≥digo de propiedad previo\n- **Contexto:** Cliente llega con propiedad espec√≠fica identificada\n- **Siguiente:** Interactuando (90801080)\n\n### **90801076 - Definiendo Propiedad**\n- **Activaci√≥n:** Cliente busca sin propiedad definida\n- **Contexto:** Bot pregunta distrito, dormitorios, presupuesto\n- **Siguiente:** Interactuando cuando define propiedad\n\n### **90801080 - Interactuando**\n- **Activaci√≥n:** Propiedad definida, cliente hace consultas\n- **Contexto:** Intercambio de informaci√≥n sobre la propiedad\n- **Siguiente:** Interesado cuando confirma querer visitar\n\n### **90801084 - Caso Especial**\n- **Activaci√≥n:** Solicitud fuera del alcance del bot\n- **Contexto:** Requiere asesor humano\n- **Puede activarse desde cualquier etapa**\n\n### **90801092 - Interesado**\n- **Activaci√≥n:** Cliente confirma inter√©s y desea visitar\n- **Contexto:** Bot solicita 2 horarios de preferencia\n- **Siguiente:** Horario Indicado cuando da los 2 horarios\n\n### **90801096 - Horario Indicado**\n- **Activaci√≥n:** Cliente proporcion√≥ 2 opciones de horario\n- **Requisito:** AMBAS fechas deben estar presentes\n- **Final del flujo del bot**\n\n---\n\n## üìã **CAMPOS JSON OBLIGATORIOS**\n\n```json\n{\n  \"nombre\": \"[Nombre completo o vac√≠o]\",\n  \"telefono\": \"[+51XXXXXXXXX o vac√≠o]\",\n  \"correo\": \"[email@dominio.com o vac√≠o]\",\n  \"propiedadInteres\": \"[Identificador/direcci√≥n acumulativo]\",\n  \"fecha1\": \"[DD/MM/YYYY HH:mm Lima o vac√≠o]\",\n  \"fecha2\": \"[DD/MM/YYYY HH:mm Lima o vac√≠o]\",\n  \"fechaConfirmada\": \"[Solo si asesor confirma o vac√≠o]\",\n  \"solicitud\": \"[Resumen narrativo acumulativo de TODO]\",\n  \"animo\": \"[caliente/tibio/frio]\",\n  \"estatusEmbudo\": \"[Nombre descriptivo de la etapa]\",\n  \"statusId\": \"[90801072/90801076/90801080/90801084/90801092/90801096]\",\n  \"seg1\": \"[Mensaje seguimiento 1 - corto y directo]\",\n  \"seg2\": \"[Mensaje seguimiento 2 - genera urgencia]\",\n  \"seg3\": \"[Mensaje seguimiento 3 - √∫ltimo intento]\"\n}\n```\n\n---\n\n## üéØ **L√ìGICA DE CATEGORIZACI√ìN POR PROGRESI√ìN**\n\n### **An√°lisis secuencial obligatorio:**\n1. Leer TODA la conversaci√≥n desde el inicio\n2. Identificar punto de partida (con/sin propiedad)\n3. Seguir progresi√≥n natural del flujo\n4. Asignar etapa seg√∫n el punto m√°s avanzado alcanzado\n\n### **Reglas de progresi√≥n:**\n```\nSI inicio_con_enlace_o_codigo:\n    statusId = 90801072 (Ingreso con Propiedad)\n    ‚Üí Avanza a 90801080 cuando se presenta info\n\nSI inicio_sin_propiedad:\n    statusId = 90801076 (Definiendo Propiedad)\n    ‚Üí Avanza a 90801080 cuando elige propiedad\n\nSI en_90801080 Y cliente_quiere_visitar:\n    ‚Üí Avanza a 90801092 (Interesado)\n\nSI en_90801092 Y proporciona_2_horarios:\n    ‚Üí Avanza a 90801096 (Horario Indicado)\n\nSI solicita_asesor_humano_o_caso_complejo:\n    statusId = 90801084 (Caso Especial)\n```\n\n---\n\n## üìù **EXTRACCI√ìN DE FECHAS**\n\n### **Formato obligatorio:** DD/MM/YYYY HH:mm\n### **Zona horaria:** Am√©rica/Lima\n\n**Proceso de extracci√≥n:**\n1. Identificar menciones de horarios en la conversaci√≥n\n2. Usar Date & Time para convertir a formato correcto\n3. Asignar a fecha1 y fecha2 en orden de menci√≥n\n4. SOLO cambiar a \"Horario Indicado\" si tiene AMBAS fechas\n\n**Ejemplos v√°lidos:**\n- \"martes a las 3pm\" ‚Üí \"28/01/2025 15:00\"\n- \"jueves 10 de la ma√±ana\" ‚Üí \"30/01/2025 10:00\"\n- \"s√°bado 9:30am\" ‚Üí \"01/02/2025 09:30\"\n\n---\n\n## üí¨ **GENERACI√ìN DE MENSAJES DE SEGUIMIENTO**\n\n### **Principios para mensajes:**\n- Sin emojis ni formatos especiales\n- Cortos, directos y personalizados\n- Basados en la etapa y contexto\n- Generar urgencia progresiva\n\n### **Templates por etapa:**\n\n**90801076 - Definiendo Propiedad:**\n```\nseg1: \"Hola, encontr√© opciones perfectas en [distrito mencionado]. ¬øTe muestro las mejores?\"\nseg2: \"Las mejores propiedades se alquilan r√°pido. ¬øRevisamos las opciones disponibles?\"\nseg3: \"√öltima oportunidad para ver las propiedades en tu zona preferida antes que se alquilen\"\n```\n\n**90801080 - Interactuando:**\n```\nseg1: \"El departamento en [direcci√≥n] sigue disponible. ¬øTienes alguna pregunta adicional?\"\nseg2: \"Este departamento tiene mucho inter√©s. ¬øTe gustar√≠a agendarlo antes que otro lo tome?\"\nseg3: \"√öltima oportunidad para visitar el departamento de [direcci√≥n]. ¬øCoordinamos?\"\n```\n\n**90801092 - Interesado:**\n```\nseg1: \"Necesito tus horarios preferidos para coordinar la visita al departamento\"\nseg2: \"El departamento tiene alta demanda. ¬øMe indicas 2 horarios para asegurar tu visita?\"\nseg3: \"Sin tus horarios no puedo reservar la visita. ¬øMe los compartes ahora?\"\n```\n\n**90801096 - Horario Indicado:**\n```\nseg1: \"Estoy confirmando tu visita para [fecha1]. Te aviso en unos minutos\"\nseg2: \"Tu visita est√° casi lista. ¬øConfirmo el [fecha1] o prefieres el [fecha2]?\"\nseg3: \"Necesito tu confirmaci√≥n final para cerrar la visita del [fecha1]\"\n```\n\n---\n\n## üé≠ **DETECCI√ìN DE √ÅNIMO**\n\n### **üî• CALIENTE:**\n- Urgencia expl√≠cita (\"lo antes posible\", \"ya\", \"hoy\")\n- Exclamaciones de inter√©s (\"¬°Me encanta!\", \"¬°Perfecto!\")\n- Ya proporcion√≥ horarios o datos de contacto\n\n### **üå°Ô∏è TIBIO:**\n- Hace preguntas sobre la propiedad\n- Muestra inter√©s sin urgencia\n- Eval√∫a opciones, pide informaci√≥n\n\n### **‚ùÑÔ∏è FR√çO:**\n- Solo consulta precios\n- Respuestas muy cortas\n- \"Tal vez\", \"lo pensar√©\", \"solo pregunto\"\n\n---\n\n## üìä **CONSTRUCCI√ìN DE SOLICITUD ACUMULATIVA**\n\nLa variable \"solicitud\" debe narrar TODO el recorrido del cliente:\n\n**Estructura narrativa:**\n\"[Nombre si lo dio] consult√≥ inicialmente por [primera consulta], luego pregunt√≥ sobre [siguientes consultas], mostr√≥ inter√©s en [propiedad espec√≠fica], sus criterios son [criterios mencionados], consult√≥ sobre [caracter√≠sticas preguntadas], [acciones tomadas], solicita visita para [horarios si los dio]\"\n\n**Ejemplo real:**\n\"Cliente consult√≥ por departamentos en Miraflores de 2 dormitorios con presupuesto de 3000 soles, pregunt√≥ si el departamento de Av. Arequipa tiene estacionamiento y permite mascotas, confirm√≥ inter√©s y acepta condiciones de alquiler, propone visitar martes 3pm o jueves 10am\"\n\n---\n\n## üöÄ **EJEMPLOS DE PROCESAMIENTO COMPLETO**\n\n### **Ejemplo 1: Flujo completo con horarios**\n```json\n{\n  \"nombre\": \"Carlos Mendoza\",\n  \"telefono\": \"+51987654321\",\n  \"correo\": \"carlos@email.com\",\n  \"propiedadInteres\": \"MODO - Departamento 2 dormitorios San Miguel\",\n  \"fecha1\": \"28/01/2025 15:00\",\n  \"fecha2\": \"30/01/2025 10:00\",\n  \"fechaConfirmada\": \"\",\n  \"solicitud\": \"Carlos Mendoza consult√≥ por departamento MODO en San Miguel de 2 dormitorios, pregunt√≥ sobre el valor del mantenimiento, si incluye internet, confirm√≥ que tiene mascota peque√±a, acepta condiciones de alquiler con 1 mes de garant√≠a para opci√≥n sin amoblar, solicita visitar el martes 28 a las 3pm o jueves 30 a las 10am\",\n  \"animo\": \"caliente\",\n  \"estatusEmbudo\": \"Horario Indicado\",\n  \"statusId\": \"90801096\",\n  \"seg1\": \"Carlos, estoy confirmando tu visita para el martes 28/01 a las 3pm. Te aviso en breve\",\n  \"seg2\": \"Tu visita al departamento MODO est√° casi lista. Confirmo el martes 28 a las 3pm?\",\n  \"seg3\": \"Necesito tu confirmaci√≥n final para cerrar la visita del martes 28/01 a las 3pm\"\n}\n```\n\n### **Ejemplo 2: Interesado sin horarios**\n```json\n{\n  \"nombre\": \"\",\n  \"telefono\": \"\",\n  \"correo\": \"\",\n  \"propiedadInteres\": \"Departamento Miraflores - Calle Schell 450\",\n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \"fechaConfirmada\": \"\",\n  \"solicitud\": \"Cliente busca departamento en Miraflores, interesado en propiedad de Calle Schell 450, consult√≥ sobre transporte cercano, acepta condiciones y quiere visitar pero a√∫n no proporciona horarios\",\n  \"animo\": \"tibio\",\n  \"estatusEmbudo\": \"Interesado\",\n  \"statusId\": \"90801092\",\n  \"seg1\": \"El departamento en Calle Schell 450 sigue disponible. Necesito tus 2 horarios preferidos para la visita\",\n  \"seg2\": \"Este departamento tiene alta demanda. Me indicas 2 opciones de horario para asegurar tu visita?\",\n  \"seg3\": \"Sin tus horarios no puedo reservar la visita al departamento. Me los compartes ahora?\"\n}\n```\n\n### **Ejemplo 3: Caso especial**\n```json\n{\n  \"nombre\": \"Andrea L√≥pez\",\n  \"telefono\": \"+51999888777\",\n  \"correo\": \"\",\n  \"propiedadInteres\": \"Edificio Central - Jes√∫s Mar√≠a\",\n  \"fecha1\": \"\",\n  \"fecha2\": \"\",\n  \"fechaConfirmada\": \"\",\n  \"solicitud\": \"Andrea L√≥pez consulta por departamento en Edificio Central de Jes√∫s Mar√≠a, menciona que trabaja independiente con recibos por honorarios variables, solicita hablar con asesor humano para explicar situaci√≥n especial de ingresos\",\n  \"animo\": \"tibio\",\n  \"estatusEmbudo\": \"Caso Especial\",\n  \"statusId\": \"90801084\",\n  \"seg1\": \"Andrea, un asesor especializado te contactar√° pronto para ayudarte con tu caso\",\n  \"seg2\": \"Nuestro asesor puede ayudarte con situaciones especiales de documentaci√≥n. Te contactar√° hoy\",\n  \"seg3\": \"Andrea, es importante"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        1540,
        320
      ],
      "id": "2a6e3e65-5548-4e7d-989a-b45e5fc702b7",
      "name": "Campos",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a20676ee-dc3f-45fa-ad6d-f8db1ce5343e",
                    "leftValue": "={{ $('Respuesta').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "continuar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "9a725f34-1bc4-40eb-a025-096e506725da",
                    "leftValue": "={{ $('Respuesta').item.json.output }}",
                    "rightValue": "={{ $('new message').item.json.body['message[add][0][text]'] }}",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mismo mensaje"
            }
          ]
        },
        "looseTypeValidation": true,
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2288,
        350
      ],
      "id": "53c6beb6-7d84-4901-a595-dc61fb6bcd48",
      "name": "SwitchBot",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "15ef6b22-34e3-4474-a528-5875cfc10d1c",
              "name": "message.message_id",
              "value": "={{ $('new message').item.json.body['message[add][0][id]'] }}",
              "type": "string"
            },
            {
              "id": "49d4f002-9cac-49a6-b148-910afa73eeb8",
              "name": "message.chat_id",
              "value": "={{ $('new message').item.json.body['message[add][0][chat_id]'] }}",
              "type": "string"
            },
            {
              "id": "22d94f50-7b1e-4957-84fa-7707f1a7ea15",
              "name": "message.attachment_type",
              "value": "={{ $('new message').item.json.body['message[add][0][attachment][type]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "b1cd9abc-1fd4-4470-8149-172af1e40ba7",
              "name": "message.attachment_link",
              "value": "={{ $('new message').item.json.body['message[add][0][attachment][link]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "fdc7c03d-f6ed-4a07-a492-40c639068a35",
              "name": "message.content",
              "value": "={{ $('new message').item.json.body['message[add][0][text]'] || $json.cleanText || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "47983c76-fa0a-4ac9-bcf1-f44973b8ce85",
              "name": "message.timestamp",
              "value": "={{ $now }}",
              "type": "string"
            },
            {
              "id": "90da165d-479f-4371-a2fb-b3ea27521147",
              "name": "user.name",
              "value": "={{ $('new message').item.json.body['message[add][0][author][name]'] }}",
              "type": "string"
            },
            {
              "id": "bbb94191-c258-402a-a01e-29ba527fc55a",
              "name": "user.lead_id",
              "value": "={{ $('new message').item.json.body['message[add][0][element_id]'] || 'vacio' }}",
              "type": "string"
            },
            {
              "id": "f5ef142c-3165-4b6e-bbec-15491ee97519",
              "name": "user.infoPrevia",
              "value": "={{ $json.custom_fields_values.find(field => field.field_name === \"n8n - infoPrevia\")?.values[0]?.value || \"sin info\" }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2884,
        500
      ],
      "id": "93971de1-1355-4181-89b2-3fbb7e83e06e",
      "name": "Set Fields",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "text": "={{ $json.output }}",
        "attributes": {
          "attributes": [
            {
              "name": "nombreCliente",
              "description": "Nombre completo del cliente o paciente",
              "required": true
            },
            {
              "name": "telefono",
              "description": "N√∫mero de telefono con c√≥digo internacional para mexico",
              "required": true
            },
            {
              "name": "correoCliente",
              "description": "Correo electr√≥nico v√°lido del cliente, si no existe dejarlo en blanco, no inventar. ",
              "required": true
            },
            {
              "name": "propiedadInteres",
              "description": "Identificador, direcci√≥n o c√≥digo de propiedad (acumulativo)",
              "required": true
            },
            {
              "name": "animo",
              "description": "Nivel de inter√©s detectado",
              "required": true
            },
            {
              "name": "estatusEmbudo",
              "description": "Etapa actual del proceso (nombre descriptivo)",
              "required": true
            },
            {
              "name": "statusId",
              "type": "number",
              "description": "Motivo del contacto: solicitar cita, pedir informaci√≥n, etc.",
              "required": true
            },
            {
              "name": "solicitud",
              "description": "breve resumen de la solicitud del cliente",
              "required": true
            },
            {
              "name": "seg1",
              "description": "mensaje de seguimiento 1",
              "required": true
            },
            {
              "name": "seg2",
              "description": "mensaje de seguimiento 2",
              "required": true
            },
            {
              "name": "seg3",
              "description": "mensaje de seguimiento 3",
              "required": true
            },
            {
              "name": "fecha1",
              "description": "fecha 1 solicitada por el cliente",
              "required": true
            },
            {
              "name": "fecha2",
              "description": "fecha 2 solicitada por el cliente",
              "required": true
            }
          ]
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1,
      "position": [
        1912,
        325
      ],
      "id": "d5aff622-8e8e-4baa-a01e-5c6156837be6",
      "name": "Information Extractor",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('new message').item.json.body[\"account[_links][self]\"] }}/ajax/v1/chats/session",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Requested-With",
              "value": "XMLHttpRequest"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "request[chats][session][action]",
              "value": "create"
            }
          ]
        },
        "options": {
          "redirect": {
            "redirect": {}
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2508,
        350
      ],
      "id": "92a9f874-fd66-4acb-bf1b-6a6c3921ed41",
      "name": "Validacion",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}",
        "contextWindowLength": 30
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -3392,
        1020
      ],
      "id": "d8f4b9f3-15b9-404d-9baa-b3f21a15a1f9",
      "name": "Simple Memory2"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body['message[add][0][text]'] }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "b0663eb3-aeb4-43a0-90e0-e04f1414bed9"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "45aafbcb-1433-41c0-8b2e-0213e764bc8f",
                    "leftValue": "={{ $json.body['message[add][0][text]'] }}",
                    "rightValue": "/reset",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3700,
        650
      ],
      "id": "0406e78a-3876-46c2-bf6c-bbb0c9acb3c1",
      "name": "Switch"
    },
    {
      "parameters": {
        "mode": "delete",
        "deleteMode": "all"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryManager",
      "typeVersion": 1.1,
      "position": [
        -3480,
        800
      ],
      "id": "bc5a0bc8-edef-4244-8430-792343cec249",
      "name": "Chat Memory Manager1"
    },
    {
      "parameters": {
        "content": "## Paso1\nCopiar URL y crear un webhook en Kommo.\nEl webhook debe estar configurado como POST",
        "height": 360,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3990,
        450
      ],
      "typeVersion": 1,
      "id": "6a8dc48d-aa92-4606-a230-073db3daf74f",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.message.last()).message_id }}",
                    "rightValue": "={{ $('Set Fields').item.json.message.message_id }}",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    },
                    "id": "ff9642b1-0bfc-430c-8cdf-412dcb7ce8fc"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "No hacer nada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "74e8af3c-1784-4894-a07e-778136e794c0",
                    "leftValue": "={{ JSON.parse($json.message.last()).timestamp }}",
                    "rightValue": "={{ $now.minus(5, \"seconds\") }}",
                    "operator": {
                      "type": "dateTime",
                      "operation": "before"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Seguir"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Esperar"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2224,
        375
      ],
      "id": "1fcc15f7-9d7c-4110-bb57-d0b308bc8d4e",
      "name": "SwitchBuffer"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.candidates[0].content.parts[0].text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "622a3a56-f045-4994-9846-7a80ba8ca27b",
      "name": "PDF content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -244,
        850
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.candidates[0].content.parts[0].text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "5dcc584a-ba87-404a-ad0d-e818c392ca3b",
      "name": "Video content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -244,
        600
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.content }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "485cce69-8f26-46af-b8a1-b03cb303afc8",
      "name": "Image content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -244,
        400
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "24b9ff4e-40d3-4180-9acb-80a2df737bff",
      "name": "Voice content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -244,
        200
      ]
    },
    {
      "parameters": {
        "fieldsToAggregate": {
          "fieldToAggregate": [
            {
              "fieldToAggregate": "content",
              "renameField": true,
              "outputFieldName": "messages"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        416,
        350
      ],
      "id": "44febada-8fe6-499e-9eac-0f7a57718a49",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "sortFieldsUi": {
          "sortField": [
            {
              "fieldName": "timestamp"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        196,
        350
      ],
      "id": "31c1f935-7028-43b1-92d7-bed8813ae169",
      "name": "Sort"
    },
    {
      "parameters": {
        "numberInputs": 5
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        -24,
        308
      ],
      "id": "20384c1a-7f9b-46b5-a909-a2d0a156136a",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "chat_input",
              "value": "={{ $json.messages.join(\"\\n\") }}",
              "type": "string"
            },
            {
              "id": "599f652e-3bfc-4c4f-bed8-7a331d9c0031",
              "name": "infoPrevia",
              "value": "={{ $('Set Fields').item.json.user.infoPrevia }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "bd0d1474-839c-45b7-8ab4-9e0238466f95",
      "name": "Chat input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        636,
        350
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b7aef447-b01e-41b3-948d-e222ef60c3d4",
              "name": "content",
              "value": "={{ $('JSON parse').item.json.content}}",
              "type": "string"
            },
            {
              "id": "fd13b400-81d2-4261-886c-fa3bbd24dfac",
              "name": "timestamp",
              "value": "={{ $('JSON parse').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "5ae1bdc4-59d1-4174-8717-2d716e3eaebc",
      "name": "Text content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -244,
        0
      ]
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "={{ JSON.parse($json.message) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1564,
        325
      ],
      "id": "d33e86c3-93c7-45b6-b244-8a0574812853",
      "name": "JSON parse"
    },
    {
      "parameters": {
        "fieldToSplitOut": "message",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -1784,
        325
      ],
      "id": "4f54baf2-e4a4-4d25-a3fb-fdb1bd9bfc86",
      "name": "Split Out"
    },
    {
      "parameters": {
        "operation": "delete",
        "key": "={{ $('Set Fields').item.json.message.chat_id }}_buffer"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2004,
        325
      ],
      "id": "840a696c-69d0-454b-ae7d-2dd5acbc4162",
      "name": "Delete message buffer",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2004,
        125
      ],
      "id": "3c22ddd7-b7ee-47e9-b644-493a9f8c76d8",
      "name": "No Operation, do nothing"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -2004,
        550
      ],
      "id": "0eb230b4-0110-4a11-9a75-22afd04aeaa0",
      "name": "Wait2",
      "webhookId": "ec0a7b27-9464-4abf-9d4c-d913aa66ae50"
    },
    {
      "parameters": {
        "operation": "get",
        "propertyName": "message",
        "key": "={{ $('Set Fields').item.json.message.chat_id }}_buffer",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2444,
        500
      ],
      "id": "2d04d9d4-19a3-42c3-9a17-238cf1726a45",
      "name": "Redis",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {
        "operation": "push",
        "list": "={{ $('Set Fields').item.json.message.chat_id }}_buffer",
        "messageData": "={{ JSON.stringify($('Set Fields').item.json.message) }}",
        "tail": true
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        -2664,
        500
      ],
      "id": "936d4611-eabf-4777-abc4-48e30c55b6db",
      "name": "Push Buffer",
      "credentials": {
        "redis": {
          "id": "hb7kAc4XBKGABSdf",
          "name": "TamiBot"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1124,
        850
      ],
      "id": "62c24a61-9ab5-4c19-a74e-105a7da8d840",
      "name": "get PDF"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n    \"contents\": [\n        {\n            \"role\": \"user\",\n            \"parts\": [\n                {\n                    \"fileData\": {\n                        \"fileUri\": \"{{ $json.file.uri }}\",\n                        \"mimeType\": \"{{ $json.file.mimeType }}\"\n                    }\n                },\n                {\n                    \"text\": \"Describe lo que se escucha, ve y se hace en el video. Brinda como respuesta unicamente el resumen del video.\"\n                }\n            ]\n        }\n    ],\n    \"generationConfig\": {\n        \"temperature\": 1.2,\n        \"topK\": 40,\n        \"topP\": 0.95,\n        \"maxOutputTokens\": 8192,\n        \"responseModalities\": [\"Text\"]\n    }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -464,
        600
      ],
      "id": "8339dcc1-b9cb-4d0b-9ca3-28948cf87f2e",
      "name": "Analyze video Gemini"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/upload/v1beta/files?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Goog-Upload-Command",
              "value": "start, upload, finalize"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Length",
              "value": "={{ $binary.data.fileSize }}"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Type",
              "value": "=video/{{ $binary.data.fileExtension }}"
            },
            {
              "name": "Content-Type",
              "value": "video/mp4"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "=data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -904,
        600
      ],
      "id": "9a1cd6b0-b3b6-4113-869a-4f9b4292a6c9",
      "name": "Upload video Gemini"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/upload/v1beta/files?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "X-Goog-Upload-Command",
              "value": "start, upload, finalize"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Length",
              "value": "={{ $binary.data.fileSize }}"
            },
            {
              "name": "X-Goog-Upload-Header-Content-Type",
              "value": "=video/{{ $binary.data.fileExtension }}"
            },
            {
              "name": "Content-Type",
              "value": "application/pdf"
            },
            {
              "name": "X-Goog-Upload-Protocol",
              "value": "raw"
            }
          ]
        },
        "sendBody": true,
        "contentType": "binaryData",
        "inputDataFieldName": "=data",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -904,
        850
      ],
      "id": "cbe979a4-a365-4716-b85d-cd4603f50b0e",
      "name": "Upload PDF Gemini"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=AIzaSyDY84RBWdUlbQgFKh3lCihl1XhW5TNSZpc",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"contents\": [\n    {\n      \"role\": \"user\",\n      \"parts\": [\n        {\n          \"fileData\": {\n            \"fileUri\": \"{{ $('Upload PDF Gemini').item.json.file.uri }}\",\n            \"mimeType\": \"application/pdf\"\n          }\n        },\n        {\n          \"text\": \"Resume este documento en espa√±ol.\"\n        }\n      ]\n    }\n  ],\n  \"generationConfig\": {\n    \"temperature\": 0.3,\n    \"maxOutputTokens\": 1024\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -464,
        850
      ],
      "id": "6e3d1112-a538-4397-a047-f4b6d29c12c6",
      "name": "Analyze PDF Gemini"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -684,
        850
      ],
      "id": "3e61e416-bda4-4f6f-ba6a-5f0710205ec9",
      "name": "Wait1",
      "webhookId": "7d0cd0c0-ce85-4372-b7a5-b0be061fc2b9"
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1124,
        600
      ],
      "id": "94429558-1aba-4a37-aec0-2483cf045b18",
      "name": "get video"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -684,
        600
      ],
      "id": "6a6b77bf-382f-4bde-b257-36ec4a4e1186",
      "name": "Wait",
      "webhookId": "7d0cd0c0-ce85-4372-b7a5-b0be061fc2b9"
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -684,
        400
      ],
      "id": "d8dd626d-ffdb-4d92-8318-463e0e41348e",
      "name": "get image"
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "text": "Analiza la imagen y responde un resumen de la imagen detallado",
        "inputType": "base64",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -464,
        400
      ],
      "id": "16f7e2af-5e2d-49bd-a800-3308c8a8a85a",
      "name": "recognize image",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "22e56679-fe2e-4b7c-986c-3a7c33539e94",
                    "leftValue": "={{ $json.content }}",
                    "rightValue": "vacio",
                    "operator": {
                      "type": "string",
                      "operation": "notEquals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "voice",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "450ac27e-86a3-439d-a06e-6ff65026910b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "voice"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1cbc31b0-945c-4b0a-9487-1f6db0c028c5",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "picture",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "image"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b6d01933-c86a-4b74-84fc-c199391848b6",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "video",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "video"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "408bc60d-539c-48f6-8fa6-584e0e968ddf",
                    "leftValue": "={{ $json.attachment_type }}",
                    "rightValue": "file",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "file"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1344,
        283
      ],
      "id": "4003969f-6b19-4d22-8953-42a563090cfd",
      "name": "checkType"
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "id": "687c8e88-b925-4bb3-8bf4-ce8b5fd98365",
      "name": "transcribe voice",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -464,
        200
      ],
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('JSON parse').item.json.attachment_link }}",
        "options": {}
      },
      "id": "5df5d858-8194-47fd-bfa5-51c1a0753c82",
      "name": "get voice",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -684,
        200
      ]
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1564,
        545
      ],
      "id": "5bf87c99-2cd5-4be6-bb4c-c7418f578e2c",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        2000,
        545
      ],
      "id": "ff62467a-3c67-4ac3-a62b-bcbeef7b1f68",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "authentication": "longLivedToken",
        "resource": "leads",
        "operation": "updateLeads",
        "collection": {
          "lead": [
            {
              "id": "={{ $('new message').item.json.body['message[add][0][entity_id]'] }}",
              "pipeline_id": 11240224,
              "status_id": 0,
              "custom_fields_values": {
                "custom_field": [
                  {
                    "data": "{\"id\":797869,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.nombreCliente }}"
                  },
                  {
                    "data": "{\"id\":797871,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.propiedadInteres }}"
                  },
                  {
                    "data": "{\"id\":797873,\"type\":\"textarea\"}",
                    "value": "={{ $('Information Extractor').item.json.output.fechaSolicitada }}"
                  },
                  {
                    "data": "{\"id\":797875,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.estatusEmbudo }}"
                  },
                  {
                    "data": "{\"id\":797877,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.solicitud }}"
                  },
                  {
                    "data": "{\"id\":797879,\"type\":\"text\"}",
                    "value": "={{ $('Information Extractor').item.json.output.animo }}"
                  }
                ]
              }
            }
          ]
        }
      },
      "type": "n8n-nodes-kommo.kommo",
      "typeVersion": 1,
      "position": [
        2948,
        350
      ],
      "id": "982f6c94-e31b-44d7-a10b-e9415ac86cdd",
      "name": "Update leads",
      "credentials": {
        "kommoLongLivedApi": {
          "id": "20bzHfzuZvuDPmtm",
          "name": "Kommo Long Lived Token account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "rentas",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -3920,
        650
      ],
      "id": "2ff831a7-d662-44db-863f-528f3178fb0a",
      "name": "new message",
      "webhookId": "e1a2ce29-1bfe-4bac-9950-bbc8beedfee0"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Mensaje cliente: {{ $json.chat_input }}\n\nInfo previa: {{ $json.infoPrevia }}",
        "options": {
          "systemMessage": "=# David v3.0 - Sistema Profesional Proper Rentas\n\n**INSTRUCCI√ìN CR√çTICA:** Usa SIEMPRE la herramienta Date & Time para cualquier referencia temporal. Hoy es {{ $now }}\n\n---\n\n## üéØ **IDENTIDAD CENTRAL**\n\n**Eres David, profesional de Proper Rentas.**\n\n### **Principios fundamentales:**\n- Hablas en primera persona como David\n- Comunicas de forma directa y natural\n- No eres un asistente, bot o herramienta\n- Manejas todo personalmente\n- NUNCA inventas informaci√≥n\n\n### **Estilo de comunicaci√≥n:**\n- Texto plano con saltos de l√≠nea\n- Sin emojis, negritas o formatos\n- Mensajes concisos y naturales\n- Evitas repeticiones innecesarias\n\n---\n\n## üè¢ **BASE DE CONOCIMIENTO FIJA**\n\n### **PROYECTO MODO - San Miguel**\n**C√≥digos:** MODOLF / MODOTW\n**Ubicaci√≥n:** Coraz√≥n de San Miguel, cerca a PUCP\n**Caracter√≠sticas:** Edificio moderno, petfriendly\n\n**Departamentos disponibles:**\n\n**1 dormitorio (47-57 m¬≤):**\n- Sin amoblar: S/1,700 (1 mes garant√≠a + 1 adelanto)\n- Amoblado: S/1,900 (2 meses garant√≠a + 1 adelanto)\n- Incluye: mantenimiento + internet + arbitrios\n- Link: https://urbania.pe/propiedades/moderno-departamento-en-san-miguel-cerca-a-la-pu-145880126.html\n\n**2 dormitorios (47-57 m¬≤):**\n- Sin amoblar: S/1,900 (1 mes garant√≠a + 1 adelanto)\n- Amoblado: S/2,100 (2 meses garant√≠a + 1 adelanto)\n- Incluye: mantenimiento + internet + arbitrios\n- Link: https://urbania.pe/propiedades/alquiler-departamento-de-estreno-en-san-miguel-s-1800-145887441.html\n\n**Condiciones especiales MODO:**\n- Contratos de 6, 9 o 12 meses\n- Sustento de ingresos formales\n- Horarios visita: L-V 8am-8pm, S√°b 8am-5pm\n\n**Web informativa:** https://proper.com.pe/edificio-modo-departamentos-en-alquiler/\n\n### **CONDICIONES EST√ÅNDAR (resto de propiedades):**\n```\n- Dos meses de garant√≠a\n- Un mes de adelanto\n- Contrato m√≠nimo de un a√±o\n- Sustento de ingresos formales\n- Horarios: L-V 9am-6:45pm, S√°b 9am-11:45am\n```\n\n### **REQUISITOS PERSONA NATURAL:**\n```\n- DNI o CE por ambos lados\n- 3 √∫ltimas boletas (dependiente) o 4 recibos honorarios (independiente)\n- Reporte deudas SBS: https://www.sbs.gob.pe/usuarios/nuestros-servicios/reporte-de-deuda\n- Reporte antecedentes: https://www.empleosperu.gob.pe/portal-mtpe/#/\n- Tutorial: https://youtu.be/MuES73ig5oo\n```\n\n### **REQUISITOS PERSONA JUR√çDICA:**\n```\n- Ficha RUC empresa\n- Sustento ingresos 3 meses - PDT\n- Declaraci√≥n Impuesto a la Renta\n- DNI/CE representante\n- Reporte deudas SBS\n- Reporte antecedentes\n```\n\n---\n\n## üìã **FLUJOS DE CONVERSACI√ìN**\n\n### **INICIO - Con enlace proporcionado:**\n```\nCliente: \"Me interesa este depa [enlace]\"\n\nACCI√ìN: Ejecutar BUSQUEDA LINK URBANIA con URL exacta\n\nRespuesta:\nHola, soy David de Proper Rentas.\n\nEsta es la informaci√≥n de la propiedad que indicas:\n[Solo datos obtenidos de la herramienta]\nDirecci√≥n: [real]\nPrecio: S/ [real]\nDormitorios: [real]\n\n¬øQu√© m√°s te gustar√≠a saber?\n```\n\n### **INICIO - Sin propiedad definida:**\n```\nCliente: \"Hola, busco departamento\"\n\nRespuesta:\nHola, soy David de Proper Rentas.\n\nPara encontrar la mejor opci√≥n necesito saber:\n- ¬øEn qu√© distrito prefieres?\n- ¬øCu√°ntos dormitorios?\n- ¬øCu√°l es tu presupuesto mensual?\n```\n\n### **B√öSQUEDA CON CRITERIOS:**\n```\nACCI√ìN: Ejecutar PROPERTIES - SQL con datos completos\n\nCon resultados:\nEncontr√© estas opciones en [distrito]:\n[Solo informaci√≥n real obtenida]\n\nSin resultados exactos:\nNo encuentro opciones exactas con esos criterios.\n¬øTe parece si busco en distritos cercanos como [colindantes]?\n```\n\n---\n\n## üîÑ **PROTOCOLO DE INFORMACI√ìN FALTANTE**\n\n### **Cuando NO tienes un dato:**\n```\nCliente: \"¬øTiene vista al parque?\"\n\nRespuesta:\nEse detalle no lo tengo disponible, dame un momento que lo averiguo y regreso contigo.\n```\n\n### **Datos que NUNCA debes inventar:**\n- Valor de mantenimiento (si no est√° especificado)\n- Vista del departamento\n- Piso espec√≠fico\n- Caracter√≠sticas no confirmadas\n- Amenidades no verificadas\n- Detalles de construcci√≥n\n\n---\n\n## üìÖ **PROCESO DE COORDINACI√ìN DE VISITA**\n\n### **PASO 1 - Inter√©s confirmado:**\n```\nCliente: \"Me interesa visitarlo\"\n\nRespuesta:\nExcelente. Las condiciones son:\n[Usar las apropiadas seg√∫n la propiedad]\n\nSi est√°s de acuerdo, necesito que me indiques 2 opciones de fecha y hora que prefieras.\n\nNuestros horarios son:\n[Horarios seg√∫n la propiedad]\n```\n\n### **PASO 2 - Registro de horarios:**\n```\nCliente: \"Puedo el martes a las 3pm o jueves a las 10am\"\n\nACCI√ìN: Validar con Date & Time para obtener fechas completas\n\nRespuesta:\nPerfecto, registro tu solicitud de visita:\n\nPropiedad: [direcci√≥n exacta]\nOpci√≥n 1: Martes 27/01/2025 - 15:00\nOpci√≥n 2: Jueves 29/01/2025 - 10:00\n\nEsta es tu solicitud, pronto te confirmo la disponibilidad.\n\n¬øHay algo m√°s en lo que pueda ayudarte?\n```\n\n---\n\n## üí¨ **PATRONES DE RESPUESTA NATURAL**\n\n### **Evitar repeticiones:**\n```\nSi ya diste informaci√≥n:\n\"Como mencion√© arriba...\"\n\"Revisa donde te compart√≠ los requisitos\"\n\"Los detalles est√°n m√°s arriba\"\n```\n\n### **Respuestas directas:**\n```\nEn lugar de: \"He procesado tu solicitud\"\nDecir: \"Listo, lo tengo\"\n\nEn lugar de: \"El sistema indica\"\nDecir: \"Veo que...\"\n\nEn lugar de: \"He registrado en la base de datos\"\nDecir: \"Ya lo tengo anotado\"\n```\n\n---\n\n## üîß **USO CORRECTO DE HERRAMIENTAS**\n\n### **BUSQUEDA LINK URBANIA:**\n- Ejecutar inmediatamente con cualquier URL recibida\n- Enviar URL sin modificaciones\n- Presentar solo datos obtenidos\n\n### **PROPERTIES - SQL:**\n- Requiere: distrito + dormitorios + presupuesto\n- Si no hay resultados: sugerir distritos colindantes\n- Nunca inventar propiedades\n\n### **DATE & TIME:**\n- Obligatorio para validar horarios\n- Convertir \"martes\" en \"Martes 27/01/2025\"\n- Formato claro: DD/MM/AAAA - HH:MM\n\n---\n\n## ‚ö†Ô∏è **PROHIBICIONES CR√çTICAS**\n\n**NUNCA decir:**\n- \"Ya tengo la informaci√≥n en mi sistema\"\n- \"He consultado la base de datos\"\n- \"El bot/asistente indica\"\n- \"Te paso con alguien\"\n- \"Procesando tu solicitud\"\n- \"Dame un segundo\"\n\n**NUNCA hacer:**\n- Inventar precios o caracter√≠sticas\n- Sugerir fechas espec√≠ficas\n- Asumir informaci√≥n no verificada\n- Completar datos faltantes\n- Crear valores de mantenimiento\n\n**SIEMPRE:**\n- Ser David hablando directamente\n- Verificar con herramientas\n- Solicitar 2 opciones de horario\n- Presentar solo informaci√≥n real\n\n---\n\n## üìù **EJEMPLOS DE CONVERSACI√ìN OPTIMIZADA**\n\n### **Manejo del proyecto MODO:**\n```\nCliente: \"Busco depa 1 dormitorio en San Miguel, presupuesto 2000\"\n\nRespuesta:\nTengo una excelente opci√≥n en MODO, edificio moderno y petfriendly en San Miguel.\n\n1 dormitorio (47-57 m¬≤):\n- Sin amoblar: S/1,700\n- Amoblado: S/1,900\nIncluye mantenimiento, internet y arbitrios\n\nEs un proyecto muy cerca a la PUCP. ¬øTe interesa conocer m√°s detalles?\n```\n\n### **Informaci√≥n no disponible:**\n```\nCliente: \"¬øEn qu√© piso est√°?\"\n\nRespuesta:\nEse dato espec√≠fico no lo tengo ahora, dame un momento que lo averiguo y regreso contigo.\n```\n\n### **Confirmaci√≥n de visita:**\n```\nCliente: \"Perfecto, acepto las condiciones\"\n\nRespuesta:\nExcelente. Ind√≠came 2 opciones de fecha y hora que prefieras.\n\nHorarios disponibles:\nLunes a viernes: 9:00 am - 6:45 pm\nS√°bados: 9:00 am - 11:45 am\n```\n\n---\n\n## üéØ **RECORDATORIOS ESTRAT√âGICOS**\n\n1. **Identidad:** Eres David, no un sistema automatizado\n2. **Informaci√≥n:** Solo datos verificados, activar protocolo si falta\n3. **Proyecto MODO:** Usar condiciones especiales cuando aplique\n4. **Fechas:** Siempre completas con Date & Time (DD/MM/AAAA - HH:MM)\n5. **Solicitudes:** Aclarar que es solicitud, no confirmaci√≥n final\n6. **Objetivo:** Obtener siempre 2 opciones de horario del cliente\n7. **Comunicaci√≥n:** Natural, directa, sin lenguaje rob√≥tico\n\n---\n\n## üîë **PRINCIPIO MAESTRO**\n\nCada interacci√≥n debe sentirse como una conversaci√≥n real con David, un profesional que conoce su trabajo, responde con informaci√≥n precisa cuando la tiene, y es transparente cuando necesita verificar algo. La prioridad es ayudar al cliente y coordinar su visita con 2 opciones claras de horario."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        940,
        300
      ],
      "id": "9e2466a1-6a29-4303-8cd4-68385cba7849",
      "name": "Respuesta",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        1096,
        545
      ],
      "id": "5b5f484a-ccb1-43ce-ab61-256c0af134d7",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para obtener informaci√≥n de la propiedad de urbania indicada",
        "workflowId": {
          "__rl": true,
          "value": "cJUTPVdxTIIbq1h0",
          "mode": "list",
          "cachedResultName": "BUSQUEDA LINK URBANIA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('url', `url de urbania brindado por el cliente`, 'string') }}"
          },
          "matchingColumns": [
            "url"
          ],
          "schema": [
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1220,
        660
      ],
      "id": "933c94c0-f172-475b-9475-da92a0f234c6",
      "name": "BUSQUEDA LINK URBANIA"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para buscar propiedades del inventario que tenemos disponible",
        "workflowId": {
          "__rl": true,
          "value": "L1zeFzAUk5BcltFH",
          "mode": "list",
          "cachedResultName": "PROPERTIES - SQL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "busqueda": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('busqueda', `Criterio de busqueda de propiedad`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "busqueda",
              "displayName": "busqueda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        1360,
        620
      ],
      "id": "200bf275-c257-410d-b125-0c305b2487e1",
      "name": "PROPERTIES - SQL"
    },
    {
      "parameters": {
        "url": "=https://{{ $('new message').item.json.body[\"account[subdomain]\"] }}.kommo.com/api/v4/leads/{{ $('new message').item.json.body[\"message[add][0][element_id]\"] }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3402,
        500
      ],
      "id": "d5793e5e-7a56-4830-913e-f258f79ba03c",
      "name": "GET Lead",
      "credentials": {
        "oAuth2Api": {
          "id": "CUkAxEZkWpxNLUY2",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        856,
        545
      ],
      "id": "a5f89af4-aac6-4573-b240-13abe9677c86",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        980,
        580
      ],
      "id": "0fb0770c-b507-47da-a6e3-c5c48cdf21a2",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('new message').item.json.body[\"message[add][0][chat_id]\"] }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        1680,
        720
      ],
      "id": "1b124501-af48-41e1-8d6a-06b05076360b",
      "name": "Simple Memory1"
    }
  ],
  "pinData": {
    "new message": [
      {
        "json": {
          "headers": {
            "host": "primary-production-0299.up.railway.app",
            "user-agent": "amoCRM-Webhooks/3.0",
            "content-length": "937",
            "accept-encoding": "gzip",
            "content-type": "application/x-www-form-urlencoded",
            "x-amocrm-requestid": "252478dc-18ef-4b2c-b442-6bcab513db01",
            "x-forwarded-for": "169.150.216.79",
            "x-forwarded-host": "primary-production-0299.up.railway.app",
            "x-forwarded-proto": "https",
            "x-railway-edge": "railway/us-east4-eqdc4a",
            "x-railway-request-id": "5aWPX210RhKk56FwozsQ6Q",
            "x-real-ip": "169.150.216.79",
            "x-request-start": "1754924053671"
          },
          "params": {},
          "query": {},
          "body": {
            "account[subdomain]": "propertamibotcom",
            "account[id]": "30050693",
            "account[_links][self]": "https://propertamibotcom.amocrm.com",
            "message[add][0][id]": "47ca5880-93d4-4df6-84fa-be92acff0254",
            "message[add][0][chat_id]": "6a9e5903-4ef2-474a-bed6-3ff315a613bc",
            "message[add][0][talk_id]": "189001",
            "message[add][0][contact_id]": "23668637",
            "message[add][0][text]": "hola",
            "message[add][0][created_at]": "1754924052",
            "message[add][0][element_type]": "2",
            "message[add][0][entity_type]": "lead",
            "message[add][0][element_id]": "21651331",
            "message[add][0][entity_id]": "21651331",
            "message[add][0][type]": "incoming",
            "message[add][0][author][id]": "f92fe9a6-bfe9-4f1c-b754-bf61e32d10d4",
            "message[add][0][author][type]": "external",
            "message[add][0][author][name]": "Martin Velasco Ormeno",
            "message[add][0][origin]": "waba"
          },
          "webhookUrl": "https://primary-production-0299.up.railway.app/webhook/rentas",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "timezone": "America/Lima",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2025-08-01T18:41:06.465Z",
      "updatedAt": "2025-08-01T18:41:06.465Z",
      "id": "94z6tcDoVU8DriEW",
      "name": "IA"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2025-08-19T00:59:10.821Z",
  "versionId": "1316642c-f1e0-43ae-9388-e89477eb29f8"
}