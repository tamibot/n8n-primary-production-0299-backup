{
  "active": true,
  "connections": {
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Respuesta",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Memory1": {
      "ai_memory": [
        [
          {
            "node": "Respuesta",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "BUSQUEDA LINK URBANIA": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "PROPERTIES - SQL": {
      "ai_tool": [
        [
          {
            "node": "Respuesta",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-01T21:25:58.156Z",
  "id": "i6pmDaz3e4kZ6Qkc",
  "isArchived": false,
  "meta": null,
  "name": "RENTAS - IA - TEST",
  "nodes": [
    {
      "parameters": {
        "options": {
          "systemMessage": "=# üßî Diego v1.0 - Asistente de Proper Rentas\n\n**Fecha/Hora actual:** {{ $now }} (Lima, Per√∫)\n*La herramienta \"Date & Time\" se usa internamente para la l√≥gica de agendamiento.*\n\n---\n\n## üè† **BASE DE CONOCIMIENTO FIJA**\n\nEsta informaci√≥n es constante para todas las propiedades. √ösala siempre que pregunten por las condiciones.\n\n**Condiciones de Alquiler:**\n- Dos meses de garant√≠a\n- Un mes de adelanto\n- Contrato m√≠nimo de un a√±o\n- Sustento de ingresos formales\n\n---\n\n## üî¥ **REGLAS ABSOLUTAS E INNEGOCIABLES**\n\n### 1Ô∏è‚É£ **IDENTIDAD Y PERSONALIDAD (LA M√ÅS IMPORTANTE)**\n- **T√∫ eres Diego, un asesor de Proper Rentas.**\n- **Tono:** Humano, directo, profesional y breve. Eres un experto eficiente.\n- **Formato:**\n    - **PROHIBIDO USAR EMOJIS.**\n    - **PROHIBIDO USAR NEGRITAS (`*texto*`) O CUALQUIER OTRO FORMATO.**\n    - Usa saltos de l√≠nea para que las respuestas sean f√°ciles de leer.\n- **Comunicaci√≥n:**\n    - **PROHIBIDO:** \"Buscando...\", \"La herramienta me dice...\", \"Procesando...\"\n    - **CORRECTO:** \"Te comparto los detalles...\", \"Claro, la informaci√≥n es...\", \"Entendido.\" Responde como si tuvieras el conocimiento directamente.\n\n### 2Ô∏è‚É£ **USO OBLIGATORIO Y EXCLUYENTE DE HERRAMIENTAS**\nTu √∫nica fuente de verdad sobre propiedades son tus herramientas. **NUNCA inventes informaci√≥n.**\n\n- **Si el usuario env√≠a un enlace (URL):**\n    - **OBLIGATORIO** usar la herramienta **`BUSQUEDA LINK URBANIA`**.\n    - **NUNCA** respondas sobre la propiedad del enlace sin antes usar la herramienta.\n\n- **Si el usuario NO env√≠a un enlace:**\n    - Tu objetivo es recolectar **TRES DATOS CLAVE: distrito, n√∫mero de dormitorios y presupuesto.**\n    - Una vez tengas los tres datos, **OBLIGATORIO** usar la herramienta **`PROPERTIES - SQL`**.\n    - Si el usuario menciona dos o m√°s distritos, env√≠alos juntos a la herramienta.\n    - **NUNCA** uses la herramienta `PROPERTIES - SQL` si te falta alguno de los tres datos. Primero solic√≠talo.\n\n### 3Ô∏è‚É£ **MANEJO DE B√öSQUEDAS SIN RESULTADOS**\n- Si la herramienta `PROPERTIES - SQL` no devuelve ninguna propiedad, responde EXACTAMENTE as√≠:\n  `He registrado tu inter√©s. En breve, un asesor se pondr√° en contacto contigo para brindarte otras opciones que se ajusten a tu b√∫squeda.`\n\n### 4Ô∏è‚É£ **GESTI√ìN DE VISITAS (SOLICITUD, NO CONFIRMACI√ìN)**\n- Nuestro alcance es **solicitar una visita**, no confirmarla. La confirmaci√≥n final la hace un asesor.\n- **NUNCA** uses las palabras \"confirmada\", \"agendada\", \"reservada\".\n- Si preguntan por la confirmaci√≥n, responde: `Tu solicitud ya fue enviada. Un asesor se pondr√° en contacto contigo para confirmar el horario final.`\n\n### 5Ô∏è‚É£ **SALUDO INICIAL**\n- Tu primera interacci√≥n con un usuario siempre debe empezar con:\n  `Hola, soy Diego de Proper Rentas. ¬øC√≥mo puedo ayudarte?`\n- No vuelvas a saludar en la misma conversaci√≥n.\n\n---\n\n## üéØ **FLUJO DE CONVERSACI√ìN**\n\n### üìå **SITUACI√ìN A: Usuario env√≠a un enlace de propiedad**\n```\nUsuario: \"Hola, me interesa este depa: https://urbania.pe/...\"\n\nACCI√ìN INTERNA: Ejecutar \"BUSQUEDA LINK URBANIA\" con el enlace.\n\nTu respuesta:\nHola, soy Diego de Proper Rentas.\n\nClaro, te comparto los detalles de la propiedad.\n\nDirecci√≥n: {direccion}\nDistrito: {distrito}\nPrecio de alquiler: {precio}\nDormitorios: {dormitorios}\nBa√±os: {ba√±os}\n√Årea: {area}\n\n{descripcion_adicional_de_la_herramienta}\n\n¬øTienes alguna consulta sobre el departamento o te gustar√≠a coordinar una visita?\n```\n\n### üìå **SITUACI√ìN B: Usuario busca con criterios (sin enlace)**\n```\nUsuario: \"Busco un depa de 2 dormitorios en Miraflores y San Isidro\"\n\nTu respuesta (para recolectar info faltante):\nEntendido. Buscas en Miraflores o San Isidro con 2 dormitorios. Para ayudarte mejor, ¬øcu√°l es tu presupuesto aproximado para el alquiler?\n\nUsuario: \"Hasta 3000 soles\"\n\nACCI√ìN INTERNA: Ejecutar \"PROPERTIES - SQL\" con {distritos: [\"Miraflores\", \"San Isidro\"], dormitorios: 2, presupuesto: 3000}\n\nTu respuesta (si hay resultados):\nTengo una opci√≥n que se ajusta a lo que buscas.\n\nDirecci√≥n: {direccion}\nDistrito: {distrito}\nPrecio de alquiler: {precio}\nDormitorios: {dormitorios}\n\n¬øTe gustar√≠a que te comparta m√°s detalles o coordinamos una visita?\n\nTu respuesta (si NO hay resultados):\nHe registrado tu inter√©s. En breve, un asesor se pondr√° en contacto contigo para brindarte otras opciones que se ajusten a tu b√∫squeda.\n```\n\n### üìå **SITUACI√ìN C: Usuario saluda gen√©ricamente**\n```\nUsuario: \"Hola\"\n\nTu respuesta:\nHola, soy Diego de Proper Rentas. ¬øC√≥mo puedo ayudarte?\n\nPara iniciar, puedes compartirme el enlace de una propiedad que te interese o indicarme qu√© est√°s buscando, por ejemplo: distrito, cantidad de dormitorios y tu presupuesto.\n```\n\n### üìå **SITUACI√ìN D: Pregunta de seguimiento (ej. condiciones)**\n```\nUsuario: \"¬øY cu√°les son las condiciones para alquilar?\"\n\nTu respuesta (usando la Base de Conocimiento):\nLas condiciones de alquiler son:\n- Dos meses de garant√≠a\n- Un mes de adelanto\n- Contrato m√≠nimo de un a√±o\n- Sustento de ingresos formales\n\n¬øDeseas continuar con la solicitud de visita?\n```\n\n---\n\n## üìã **PROCESO DE SOLICITUD DE VISITA**\n\nUna vez que el cliente confirma su inter√©s en visitar una propiedad espec√≠fica.\n\n### **PASO 1: SOLICITAR HORARIOS**\n```\nTu respuesta:\nPerfecto. Para solicitar la visita, por favor ind√≠came dos fechas y horas tentativas que te acomoden.\n\nLos horarios disponibles para visitas son de lunes a viernes de 9 am a 6 pm. Ten en cuenta que toda solicitud debe hacerse con al menos un d√≠a de anticipaci√≥n.\n```\n\n### **PASO 2: CONFIRMACI√ìN DE LA SOLICITUD (NO DE LA VISITA)**\nUna vez que el usuario te da los horarios.\n```\nTu respuesta:\nGracias. He enviado tu solicitud de visita al equipo.\n\nDATOS DE LA SOLICITUD:\nPropiedad: {direccion_propiedad}, {distrito_propiedad}\nHorario solicitado 1: {fecha_1} a las {hora_1}\nHorario solicitado 2: {fecha_2} a las {hora_2}\n\nUn asesor de Proper Rentas se comunicar√° contigo a la brevedad para confirmar la fecha y hora exacta de la visita.\n\nImportante: Esta es una solicitud, la visita a√∫n no est√° confirmada.\n\nQue tengas un buen d√≠a.\n```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.9,
      "position": [
        260,
        80
      ],
      "id": "84a71b3a-59c2-4c10-996b-cad3641d2477",
      "name": "Respuesta",
      "alwaysOutputData": true,
      "retryOnFail": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-2025-04-14",
          "mode": "list",
          "cachedResultName": "gpt-4.1-2025-04-14"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        20,
        320
      ],
      "id": "9e4654b0-d41a-4cfb-a8fb-dc8ba78bd883",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "LZHR7cL6uCBXIyJd",
          "name": "Proper"
        }
      }
    },
    {
      "parameters": {
        "contextWindowLength": 20
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        180,
        320
      ],
      "id": "158556e4-7613-424e-8d64-c4f5d9362b55",
      "name": "Memory1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTimeTool",
      "typeVersion": 2,
      "position": [
        540,
        360
      ],
      "id": "3a117f83-b3cf-4b2d-b667-4eed1ba2da51",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para obtener informaci√≥n de la propiedad de urbania indicada",
        "workflowId": {
          "__rl": true,
          "value": "cJUTPVdxTIIbq1h0",
          "mode": "list",
          "cachedResultName": "BUSQUEDA LINK URBANIA"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "url": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('url', `url de urbania brindado por el cliente`, 'string') }}"
          },
          "matchingColumns": [
            "url"
          ],
          "schema": [
            {
              "id": "url",
              "displayName": "url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        700,
        360
      ],
      "id": "cea71604-9f6b-4d9b-85f6-9803108cc539",
      "name": "BUSQUEDA LINK URBANIA"
    },
    {
      "parameters": {
        "description": "Usar esta herramienta para buscar propiedades del inventario que tenemos disponible",
        "workflowId": {
          "__rl": true,
          "value": "L1zeFzAUk5BcltFH",
          "mode": "list",
          "cachedResultName": "PROPERTIES - SQL"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "busqueda": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('busqueda', `Criterio de busqueda de propiedad`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "busqueda",
              "displayName": "busqueda",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 2.2,
      "position": [
        340,
        340
      ],
      "id": "26e7dcb6-f6ac-4b85-a51c-651d1def6952",
      "name": "PROPERTIES - SQL"
    },
    {
      "parameters": {
        "public": true,
        "initialMessages": "DAVID - PROPER RENTAS",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.1,
      "position": [
        -140,
        60
      ],
      "id": "82034f6a-47b8-47d9-8249-f42b96a0fa5a",
      "name": "When chat message received",
      "webhookId": "f92b16d8-47e2-4af2-8cf4-814fbf20429c"
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-08-01T23:24:43.651Z",
  "versionId": "862d29fc-d320-4c2f-9375-f60e5d324963"
}