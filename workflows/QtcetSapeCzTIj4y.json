{
  "active": true,
  "connections": {
    "Ejecutar Semanal (Lun 8am)": {
      "main": [
        [
          {
            "node": "Consulta Completa SQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consulta Completa SQL": {
      "main": [
        [
          {
            "node": "Formatear Tabla Completa",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Tabla Completa": {
      "main": [
        [
          {
            "node": "Enviar Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-17T13:59:24.089Z",
  "id": "QtcetSapeCzTIj4y",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "REPORTE SEMANAL VENTAS INVERSIONES",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtDay": [
                4
              ],
              "triggerAtHour": 7
            }
          ]
        }
      },
      "id": "bb39f83f-85bf-4d07-add7-fe099d0c5745",
      "name": "Ejecutar Semanal (Lun 8am)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -48,
        -160
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH PARTICIPANTES AS (\nSELECT DISTINCT A.*, B.NOMBRE NOMBRE_1, B.APELLIDO, RIGHT(REGEXP_REPLACE(B.PHONE, '[^0-9]', '', 'g'),9) PHONE\nFROM BITRIX.PARTICIPANTES A\nLEFT JOIN (SELECT DISTINCT NOMBRE, APELLIDO, EMAIL, PHONE FROM BITRIX.INSCRITOS) B ON A.EMAIL=B.EMAIL\nLEFT JOIN (SELECT DISTINCT ID FROM BITRIX.INSCRITOS) C ON A.ID=C.ID\nWHERE C.ID IS NULL\n)\n,PARTICIPANTES_V2 AS (\nSELECT \nP.FECHA, \nP.NOMBRE, \nP.APELLIDO,\nP.EMAIL, \nP.PHONE,\nNULL AS REGISTRATIONTIME,\n'SI' AS ASISTIO,\nP.ESTANCIATOTAL DURACION,\nCASE WHEN DE.NOMBRE_ASESOR IS NOT NULL THEN DE.NOMBRE_ASESOR ELSE 'NO ASIGNADO' END AS NOMBREASESOR,\nCASE WHEN DE.CATEGORIACLIENTE IS NOT NULL THEN DE.CATEGORIACLIENTE ELSE 'NO ASIGNADO' END AS CATEGORIACLIENTE,\nP.TIPO_REUNION\nFROM PARTICIPANTES P\nLEFT JOIN BITRIX.HS_CLIENTE CLI ON LOWER(P.EMAIL) = LOWER(CLI.EMAIL) OR right(P.PHONE,9) = right(CLI.nrocelular,9)\nLEFT JOIN (\n    SELECT\n        *,\n        ROW_NUMBER() OVER (PARTITION BY IDCLIENTE ORDER BY FECHACREACION DESC) AS rn\n    FROM\n        bitrix.HS_DEALS\n    WHERE\n        LOWER(STAGE) != 'deal lost'\n\n) DE ON CLI.ID = DE.IDCLIENTE AND DE.rn = 1\n\nWHERE 1=1\nAND P.EMAIL NOT ILIKE '%PROPER%'\nORDER BY P.FECHA DESC\n)\n\n,reuniones_total AS (\nSELECT \nFECHA,\nNOMBRE,\nAPELLIDO,\nEMAIL,\nPHONE,\nREGISTRATIONTIME,\nASISTIO,\nDURACION,\nNOMBREASESOR,\nCATEGORIACLIENTE,\nTIPO_REUNION\nFROM BITRIX.TEMP_REUNIONES_SEMANALES\nWHERE EMAIL NOT ILIKE '%PROPER%'\nUNION \nSELECT *\nFROM PARTICIPANTES_V2\nWHERE EMAIL NOT ILIKE '%PROPER%'\n)\n\n--- reporte semanal ventas\n,reuniones as (\nselect \nnombreasesor asesor,\ncount(distinct case when asistio='SI' and fecha::date > current_date - 30 and categoriacliente in ('MEDIO', 'ALTO') then email else null end) leads_altos_medios_asistieron_reunion_ultimos_30d,\ncount(distinct case when asistio='SI' and fecha::date > current_date - 7 and categoriacliente in ('MEDIO', 'ALTO') then email else null end) leads_altos_medios_asistieron_reunion_ultimos_7d,\ncount(distinct case when asistio='SI' and fecha::date > current_date - 30 then email else null end) leads_asistieron_reunion_ultimos_30d\nfrom reuniones_total\ngroup by 1\n)\n\n,separaciones as (\nselect \ncase \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nend as asesor,\n\ncount(distinct case when date_trunc('month', fecha_separacion::date)=date_trunc('month', current_date) and estatus_separacion not in ('cerrado por recolocación') then a.codigo else null end) separaciones_brutas_mes_actual,\n\ncount(distinct case when date_trunc('month', fecha_separacion::date)=date_trunc('month', current_date) and fecha_separacion::date < date_trunc('week', current_date) - interval '1 week' and estatus_separacion not in ('cerrado por recolocación') then a.codigo else null end) separaciones_brutas_hasta_semana_anterior,\n\ncount(distinct case when date_trunc('month', fecha_solicitud::date)=date_trunc('month', current_date) and b.tipo='cliente desistió' then a.codigo else null end) caidas_mes_actual,\n\ncount(distinct case when date_trunc('month', fecha_separacion::date)=date_trunc('month', current_date) and estatus_separacion not in ('cerrado por recolocación') then a.codigo else null end) - count(distinct case when date_trunc('month', fecha_solicitud::date)=date_trunc('month', current_date) and b.tipo='cliente desistió' then a.codigo else null end) separaciones_netas_mes_actual,\n\t\ncount(distinct case when estatus_separacion not in ('listo para facturar', 'facturado', 'cerrado', 'devolucion', 'caida', 'bloqueado', 'cerrado por recolocación') then a.codigo else null end) separaciones_abiertas,\ncount(distinct case when estatus_separacion in ('listo para facturar') then a.codigo else null end) separaciones_listo_facturar,\ncount(distinct case when fecha_separacion::date > current_date - 60 and estatus_separacion not in ('cerrado por recolocación') then a.codigo else null end) separaciones_brutas_ultimos_60d\t\nfrom separaciones_separacion a\nleft join devoluciones_devolucion b on a.id=b.separacion_id\ngroup by 1\norder by 1\n)\n\n\n,simulaciones as (\n -- financiamiento\nselect \ncase \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nend as asesor,\ncount(distinct case when a.fecha::date > current_date - 30 then a.dni else null end) usuarios_simulados_ultimos_30d,\ncount(distinct case when a.fecha::date > current_date - 7 then a.dni else null end) usuarios_simulados_ultimos_7d\nfrom financiamiento_cliente a \nwhere 1=1\nand a.asesor not in ('valeria.vega@proper.com.pe', 'nicole.mendoza@proper.com.pe', 'ednaly.cuadros@proper.com.pe' )\ngroup by 1\norder by 1 desc\n)\n,cotizaciones as (\n -- cotizaciones\nselect \ncase \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nend as asesor,\ncount(distinct case when a.fecha::date > current_date - 30 then a.dni else null end) usuarios_cotizados_ultimos_30d,\ncount(distinct case when a.fecha::date > current_date - 7 then a.dni else null end) usuarios_cotizados_ultimos_7d\nfrom cotizaciones_proyectos a \nwhere 1=1\nand a.asesor not in ('valeria.vega@proper.com.pe', 'nicole.mendoza@proper.com.pe', 'ednaly.cuadros@proper.com.pe' )\ngroup by 1\norder by 1 desc\n)\n,reuniones_agendadas_cliente AS (\n  SELECT \n  case \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nend as asesor,\t\n\tCOUNT(DISTINCT telefono) AS cant_reuniones_agendadas_cliente\n  FROM reuniones_agendadas\n  WHERE 1=1\n  and fecha_reunion::date > current_date - 7\n  GROUP BY 1\n)\n,asesores as (\nselect distinct nombre||' '||apellido nombre_asesor\nfrom bitrix.asesor\nwhere 1=1\n)\n\n,bitrix_final as (\nselect a.*,\ncase when a.stage in ('INFLUENCERS') then 'APROBADOS' else a.stage end as etapa_vf,\nCASE \n            WHEN a.residencia IS NULL THEN 'Falta'\n            WHEN a.residencia IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') THEN 'Nacional' \n            ELSE 'Internacional'\n        END AS residencia_general,\n\nCASE\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT>=100000 THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial not in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') AND a.categoriacliente is null THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT<100000 THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=9000 AND a.web_monto_inicial::INT>=25000 THEN 'ALTO'\n\t\tWHEN (a.ingmensual in ('Entre S/9,000 y S/12,000', 'Entre S/12,000 y S/15,000', 'Entre S/15,000 y S/20,000', 'Más de S/20,000') and a.inicial not in ('Menos de S/25,000'))\n\t\tOR a.categoriacliente ILIKE 'ALTO' THEN 'ALTO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=4000 AND a.web_monto_inicial::INT>=25000 THEN 'MEDIO'\n\t\tWHEN (a.ingmensual in ('Entre S/4,000 y S/6,000', 'Entre S/6,000 y S/9,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='MEDIO' THEN 'MEDIO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=3000 AND a.web_monto_inicial::INT>=25000 THEN 'EMPUJE'\n\t\tWHEN (a.ingmensual in ('Entre S/3,000 y S/4,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='EMPUJE' THEN 'EMPUJE'\n\t\tWHEN a.ingmensual in ('Menos de S/3,000') THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_monto_inicial::INT<25000 THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT<3000 THEN 'NO APROBADO'\n\t\tWHEN a.categoriacliente='NO APROBADO NACIONAL' then 'NO APROBADO'\n\t\tEND AS categoria_cliente_vf,\t\n\t\nlower(a.utm_source) utm_source_vf,\ncase \nwhen a.utm_source in ('web_home_workshop', 'web_home', 'web_edu', 'web_internacional') then 'organico'\nwhen a.utm_source ilike '%instagram%' then 'social'\nwhen a.utm_source ilike '%vendedores%' then 'asesores_proper'\nwhen a.utm_source ilike '%juan_huerta%' then 'influencer'\nwhen a.utm_source ilike '%intalks%' then 'evento'\nwhen a.utm_source ilike '%entel%' then 'B2B'\nwhen a.utm_source ilike '%pwc%' then 'B2B'\nwhen a.utm_source ilike '%dp_world%' and a.fechacreacion='2024-07-10' then 'evento'\nelse utm_medium\nend as utm_medium_vf,\ncase \nwhen a.utm_source ilike '%pwc%' and utm_medium='evento_pwc' then 'evento_presencial'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%webinar%' then 'webinar'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%B2B%' then 'evento_presencial'\nwhen a.utm_source ilike '%hapag%' and utm_medium ilike '%B2B%' and fechacreacion='2024-11-06' then 'charla_presencial'\nelse utm_campaign \nend as utm_campaign_vf\nFROM bitrix.hs_deals a \n)\n\n,bitrix as (\nselect \nc.nombre_asesor asesor,\ncount(distinct case when etapa_vf='CALIENTES' then a.id else null end) calientes,\ncount(distinct case when etapa_vf in ('C5:UC_2GCSEY', 'ENFRIADOS') then a.id end) enfriados_totales,\ncount(distinct case when etapa_vf in ('C5:UC_2GCSEY', 'ENFRIADOS') and a.fechamodif::date > current_date - 7 then a.id else null end) enfriados_ultimos_7d,\ncount(distinct case when etapa_vf in ('C5:LOSE', 'DEAL LOST', 'SIN RESPUESTA', 'Deal lost') then a.id else null end) perdidos_totales,\ncount(distinct case when etapa_vf in ('C5:LOSE', 'DEAL LOST', 'SIN RESPUESTA', 'Deal lost') and a.fechamodif::date > current_date - 7 then a.id else null end) perdidos_ultimos_7d,\ncount(distinct case when a.fechacreacion::date > current_date - 30 and a.categoria_cliente_vf in ('ALTO', 'MEDIO') then a.id else null end) nuevos_leads_altos_medios_ultimos_30_dias,\ncount(distinct case when a.fechacreacion::date > current_date - 7 and a.categoria_cliente_vf in ('ALTO', 'MEDIO') then a.id else null end) nuevos_leads_altos_medios_ultimos_7_dias,\ncount(distinct case when a.fechacreacion::date > current_date - 30 and a.ingmensual is not null then a.id else null end) nuevos_leads_totales_ultimos_30_dias,\ncount(distinct case when a.fechacreacion::date > current_date - 30 and a.categoria_cliente_vf not in ('NO APROBADO', 'NO APROBADO INTERNACIONAL') then a.id else null end) nuevos_leads_aprobados_ultimos_30_dias\n\nfrom asesores c\nleft join bitrix_final a on c.nombre_asesor=a.nombre_asesor -- deals\ngroup by 1 \n),\n\nsemana as (\nselect *,\ncase \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nend as nombre_asesor\nfrom formulario_semanal a\nwhere 1=1\nand semana_actual=date_trunc('week', current_date)::date\n)\n,semana_pasada as (\nselect *,\ncase \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nend as nombre_asesor,\nnro_separaciones_proyectadas_semana_actual nro_separaciones_proyectadas_semana_pasada\nfrom formulario_semanal a\nwhere 1=1\nand semana_actual=date_trunc('week', current_date-7)::date\n),\n-- Base de asesores desde todas las tablas agregadas\nasesores_union AS (\n  SELECT DISTINCT asesor FROM bitrix\n  UNION SELECT DISTINCT asesor FROM separaciones\n  UNION SELECT DISTINCT asesor FROM simulaciones\n  UNION SELECT DISTINCT asesor FROM cotizaciones\n  UNION SELECT DISTINCT asesor FROM reuniones\n  UNION SELECT DISTINCT nombre_asesor AS asesor FROM semana\n  UNION SELECT DISTINCT nombre_asesor AS asesor FROM semana_pasada\n  UNION SELECT DISTINCT asesor FROM reuniones_agendadas_cliente\n)\n\nSELECT \n  u.asesor                                    AS asesor,\n  COALESCE(b.separaciones_brutas_mes_actual, 0)                           AS separaciones_brutas_mes_actual, \n  COALESCE(b.separaciones_brutas_hasta_semana_anterior, 0)                AS separaciones_brutas_hasta_semana_anterior,\n  COALESCE(b.caidas_mes_actual, 0)                                        AS caidas_mes_actual,\n  COALESCE(b.separaciones_netas_mes_actual, 0)                            AS separaciones_netas_mes_actual,\n  COALESCE(f1.nro_separaciones_proyectadas_semana_pasada, 0)              AS nro_separaciones_proyectadas_semana_pasada,\n  COALESCE(f.nro_separaciones_proyectadas_semana_actual, 0)               AS nro_separaciones_proyectadas_semana_actual,\n  COALESCE(b.separaciones_abiertas, 0)                                    AS separaciones_abiertas, \n  COALESCE(b.separaciones_listo_facturar, 0)                              AS separaciones_listo_facturar,\n  COALESCE(a.calientes, 0)                                                AS calientes,\n  COALESCE(z.usuarios_cotizados_ultimos_7d, 0)                            AS usuarios_cotizados_ultimos_7d,\n  COALESCE(c.usuarios_simulados_ultimos_7d, 0)                            AS usuarios_simulados_ultimos_7d,\n  COALESCE(d.leads_asistieron_reunion_ultimos_30d, 0)                     AS leads_asistieron_reunion_ultimos_30d,\n--   COALESCE(d.leads_altos_medios_asistieron_reunion_ultimos_30d, 0)        AS leads_altos_medios_asistieron_reunion_ultimos_30d,\n  COALESCE(a.nuevos_leads_aprobados_ultimos_30_dias, 0)                   AS nuevos_leads_aprobados_ultimos_30_dias,\n--   COALESCE(a.nuevos_leads_altos_medios_ultimos_30_dias, 0)                AS nuevos_leads_altos_medios_ultimos_30_dias,\n  COALESCE(a.enfriados_totales, 0)                                        AS enfriados_totales,\n  COALESCE(a.perdidos_ultimos_7d, 0)                                      AS perdidos_ultimos_7d,\n  COALESCE(f.nro_minutas_firmadas_semana_pasada, 0)                       AS nro_minutas_firmadas_semana_pasada,\n  COALESCE(f.nro_minutas_firmadas_semana_actual, 0)                       AS nro_minutas_firmadas_proyectadas_semana_actual,\n  COALESCE(f.nro_cartas_recibidas_semana_pasada, 0)                       AS nro_cartas_recibidas_semana_pasada,\n  COALESCE(g.cant_reuniones_agendadas_cliente, 0)                         AS nro_reuniones_agendadas_ultimos_7d,\n  COALESCE(f.nro_reuniones_semana_pasada, 0)                              AS nro_reuniones_realizadas_cliente_semana_pasada,\n  COALESCE(f.nro_reuniones_semana_actual, 0)                              AS nro_reuniones_proyectadas_cliente_semana_actual\nFROM asesores_union u\nLEFT JOIN bitrix                        a  ON u.asesor = a.asesor\nLEFT JOIN separaciones                  b  ON u.asesor = b.asesor\nLEFT JOIN simulaciones                  c  ON u.asesor = c.asesor\nLEFT JOIN cotizaciones                  z  ON u.asesor = z.asesor\nLEFT JOIN reuniones                     d  ON u.asesor = d.asesor\nLEFT JOIN semana                        f  ON u.asesor = f.nombre_asesor\nLEFT JOIN semana_pasada                 f1 ON u.asesor = f1.nombre_asesor\nLEFT JOIN reuniones_agendadas_cliente   g  ON u.asesor = g.asesor\nWHERE 1=1\nAND U.ASESOR IN ('Leidy Sanchez', 'Marcos Uribe','Sebastian Llontop', 'Sharon Caceres', 'Germain Pasapera')",
        "options": {}
      },
      "id": "3b314ea0-e160-400c-95ae-dfc772b98d2f",
      "name": "Consulta Completa SQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        176,
        -160
      ],
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.all();\n\nif (data.length === 0) {\n  return [{json: {html_table: \"<p>No se encontraron datos de ventas para esta semana.</p>\"}}];\n}\n\nlet html = '<h3 style=\"font-family: Arial, sans-serif; color: #333;\">Reporte Semanal de Ventas - Completo</h3>';\nhtml += '<div style=\"overflow-x: auto; width: 100%;\">';\nhtml += '<table style=\"border-collapse: collapse; font-family: Arial, sans-serif; font-size: 10px;\">';\n\n// Headers - Total 22 columnas\nhtml += '<tr style=\"background-color: #003366; color: white; text-align: center;\">';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Asesor</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Sep. Brutas<br>(Mes)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Sep. Brutas<br>(Ant.)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Caídas</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap; background-color: #004080;\">Sep. Netas<br>(Mes)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Proy. Sep.<br>(Pasada)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Proy. Sep.<br>(Actual)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Abiertas</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Facturables</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Hot Leads</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Cotiz.<br>(7d)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Simul.<br>(7d)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Reuniones<br>(30d)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Nuev. Aprob.<br>(30d)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Enfriados</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Perdidos<br>(7d)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Min. Firm.<br>(Pasada)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Min. Proy.<br>(Actual)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Cartas Rec.<br>(Pasada)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Reun. Agend.<br>(7d)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Reun. Realiz.<br>(Pasada)</th>';\nhtml += '<th style=\"border: 1px solid #ddd; padding: 4px; white-space: nowrap;\">Reun. Proy.<br>(Actual)</th>';\nhtml += '</tr>';\n\n// Rows\nfor (const item of data) {\n    const row = item.json;\n    \n    html += '<tr>';\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; font-weight: bold; text-align: left; white-space: nowrap;\">${row.asesor || 'Desconocido'}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.separaciones_brutas_mes_actual}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.separaciones_brutas_hasta_semana_anterior}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center; color: red;\">${row.caidas_mes_actual}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center; font-weight: bold; background-color: #e6f7ff;\">${row.separaciones_netas_mes_actual}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_separaciones_proyectadas_semana_pasada}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_separaciones_proyectadas_semana_actual}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.separaciones_abiertas}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center; background-color: #f0fff0;\">${row.separaciones_listo_facturar}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.calientes}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.usuarios_cotizados_ultimos_7d}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.usuarios_simulados_ultimos_7d}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.leads_asistieron_reunion_ultimos_30d}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nuevos_leads_aprobados_ultimos_30_dias}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.enfriados_totales}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.perdidos_ultimos_7d}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_minutas_firmadas_semana_pasada}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_minutas_firmadas_proyectadas_semana_actual}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_cartas_recibidas_semana_pasada}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_reuniones_agendadas_ultimos_7d}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_reuniones_realizadas_cliente_semana_pasada}</td>`;\n    html += `<td style=\"border: 1px solid #ddd; padding: 4px; text-align: center;\">${row.nro_reuniones_proyectadas_cliente_semana_actual}</td>`;\n    html += '</tr>';\n}\n\nhtml += '</table>';\nhtml += '</div>';\nhtml += `<p style=\"font-family: Arial; font-size: 10px; color: #666; margin-top: 10px;\">Generado automáticamente el ${new Date().toLocaleString()}.</p>`;\n\nreturn [{json: {html_table: html}}];"
      },
      "id": "65424bdc-ffad-4674-8540-8a732db804d3",
      "name": "Formatear Tabla Completa",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        -160
      ]
    },
    {
      "parameters": {
        "sendTo": "valeria.vega@proper.com.pe",
        "subject": "Reporte Semanal de Ventas - Detalle Completo",
        "message": "={{ $json.html_table }}",
        "options": {}
      },
      "id": "13764021-6700-4e62-8b12-affec9f34534",
      "name": "Enviar Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        624,
        -160
      ],
      "webhookId": "ffa10984-0cdd-4181-b6fb-70331fe3b218",
      "credentials": {
        "gmailOAuth2": {
          "id": "SPurZ4Z9pGQy8MKJ",
          "name": "Gmail account"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2025-12-17T13:59:24.089Z",
      "updatedAt": "2025-12-17T13:59:24.089Z",
      "role": "workflow:owner",
      "workflowId": "QtcetSapeCzTIj4y",
      "projectId": "tpSonpyzopDOYZNA"
    }
  ],
  "staticData": {
    "node:Ejecutar Semanal (Lun 8am)": {
      "recurrenceRules": []
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-12-17T14:09:59.904Z",
  "versionId": "46ddb42b-73ad-43a9-9240-c320cb5f03bf"
}