{
  "active": true,
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Query Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Diario": {
      "main": [
        [
          {
            "node": "Query Acumulado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Acumulado": {
      "main": [
        [
          {
            "node": "Query Asesor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Asesor": {
      "main": [
        [
          {
            "node": "Query Canales",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Canales": {
      "main": [
        [
          {
            "node": "Formatear HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear HTML": {
      "main": [
        [
          {
            "node": "Enviar Email (Gmail)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2026-01-19T17:47:52.676Z",
  "id": "fZc9su0VEenLGV1R",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "REPORTE DIARIO DE INVERSIONES",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 8
            }
          ]
        }
      },
      "id": "d95e6ea3-64b2-45cb-a4cd-ec42f707c1ed",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        96,
        -208
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH\n--COTIZACIONES\ncotizaciones as ( \nSELECT\nfecha,\ncount(distinct dni) cant_cotizados\nFROM cotizaciones_proyectos\nGROUP BY 1\norder by 1 desc\n),\n--SIMUALCIONES\nsimulaciones as (\nSELECT \nfecha,\ncount(distinct fecha) cant_simulados\nfrom financiamiento_cliente \ngroup by 1\norder by 1 desc\n)\n,\n--ASISTENCIA\nPARTICIPANTES AS (\nSELECT DISTINCT A.*, B.NOMBRE NOMBRE_1, B.APELLIDO, RIGHT(REGEXP_REPLACE(B.PHONE, '[^0-9]', '', 'g'),9) PHONE\nFROM BITRIX.PARTICIPANTES A\nLEFT JOIN (SELECT DISTINCT NOMBRE, APELLIDO, EMAIL, PHONE FROM BITRIX.INSCRITOS) B ON A.EMAIL=B.EMAIL\nLEFT JOIN (SELECT DISTINCT ID FROM BITRIX.INSCRITOS) C ON A.ID=C.ID\nWHERE C.ID IS NULL\n)\n,PARTICIPANTES_V2 AS (\nSELECT \nP.FECHA, \nP.NOMBRE, \nP.APELLIDO,\nP.EMAIL, \nP.PHONE,\nNULL AS REGISTRATIONTIME,\n'SI' AS ASISTIO,\nP.ESTANCIATOTAL DURACION,\nCASE WHEN DE.NOMBRE_ASESOR IS NOT NULL THEN DE.NOMBRE_ASESOR ELSE 'NO ASIGNADO' END AS NOMBREASESOR,\nCASE WHEN DE.CATEGORIACLIENTE IS NOT NULL THEN DE.CATEGORIACLIENTE ELSE 'NO ASIGNADO' END AS CATEGORIACLIENTE,\nP.TIPO_REUNION\nFROM PARTICIPANTES P\nLEFT JOIN BITRIX.HS_CLIENTE CLI ON LOWER(P.EMAIL) = LOWER(CLI.EMAIL) OR right(P.PHONE,9) = right(CLI.nrocelular,9)\nLEFT JOIN (\n    SELECT\n        *,\n        ROW_NUMBER() OVER (PARTITION BY IDCLIENTE ORDER BY FECHACREACION DESC) AS rn\n    FROM\n        bitrix.HS_DEALS\n    WHERE\n        LOWER(STAGE) != 'deal lost'\n\n) DE ON CLI.ID = DE.IDCLIENTE AND DE.rn = 1\n\nWHERE 1=1\nAND P.EMAIL NOT ILIKE '%PROPER%'\nORDER BY P.FECHA DESC\n)\n\n,reuniones_total AS (\nSELECT \nFECHA,\nNOMBRE,\nAPELLIDO,\nEMAIL,\nPHONE,\nREGISTRATIONTIME,\nASISTIO,\nDURACION,\nNOMBREASESOR,\nCATEGORIACLIENTE,\nTIPO_REUNION\nFROM BITRIX.TEMP_REUNIONES_SEMANALES\nWHERE EMAIL NOT ILIKE '%PROPER%'\nUNION \nSELECT *\nFROM PARTICIPANTES_V2\nWHERE EMAIL NOT ILIKE '%PROPER%'\n)\n\n,reuniones as ( \nselect \nfecha,\ncount(distinct email) cant_asistentes\nfrom reuniones_total\nwhere asistio='SI'\ngroup by 1\norder by 1 desc\n)\n\n,bitrix_final as (\nselect a.*,\ncase when a.stage in ('INFLUENCERS') then 'APROBADOS' else a.stage end as etapa_vf,\nCASE \n            WHEN a.residencia IS NULL THEN 'Falta'\n            WHEN a.residencia IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') THEN 'Nacional' \n            ELSE 'Internacional'\n        END AS residencia_general,\n\nCASE\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT>=100000 THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial not in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') AND a.categoriacliente is null THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT<100000 THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=9000 AND a.web_monto_inicial::INT>=25000 THEN 'ALTO'\n\t\tWHEN (a.ingmensual in ('Entre S/9,000 y S/12,000', 'Entre S/12,000 y S/15,000', 'Entre S/15,000 y S/20,000', 'Más de S/20,000') and a.inicial not in ('Menos de S/25,000'))\n\t\tOR a.categoriacliente ILIKE 'ALTO' THEN 'ALTO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=4000 AND a.web_monto_inicial::INT>=25000 THEN 'MEDIO'\n\t\tWHEN (a.ingmensual in ('Entre S/4,000 y S/6,000', 'Entre S/6,000 y S/9,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='MEDIO' THEN 'MEDIO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=3000 AND a.web_monto_inicial::INT>=25000 THEN 'EMPUJE'\n\t\tWHEN (a.ingmensual in ('Entre S/3,000 y S/4,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='EMPUJE' THEN 'EMPUJE'\n\t\tWHEN a.ingmensual in ('Menos de S/3,000') THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_monto_inicial::INT<25000 THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT<3000 THEN 'NO APROBADO'\n\t\tWHEN a.categoriacliente='NO APROBADO NACIONAL' then 'NO APROBADO'\n\t\tEND AS categoria_cliente_vf,\t\n\t\nlower(a.utm_source) utm_source_vf,\ncase \nwhen a.utm_source in ('web_home_workshop', 'web_home', 'web_edu', 'web_internacional') then 'organico'\nwhen a.utm_source ilike '%instagram%' then 'social'\nwhen a.utm_source ilike '%vendedores%' then 'asesores_proper'\nwhen a.utm_source ilike '%juan_huerta%' then 'influencer'\nwhen a.utm_source ilike '%intalks%' then 'evento'\nwhen a.utm_source ilike '%entel%' then 'B2B'\nwhen a.utm_source ilike '%pwc%' then 'B2B'\nwhen a.utm_source ilike '%dp_world%' and a.fechacreacion='2024-07-10' then 'evento'\nelse utm_medium\nend as utm_medium_vf,\ncase \nwhen a.utm_source ilike '%pwc%' and utm_medium='evento_pwc' then 'evento_presencial'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%webinar%' then 'webinar'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%B2B%' then 'evento_presencial'\nwhen a.utm_source ilike '%hapag%' and utm_medium ilike '%B2B%' and fechacreacion='2024-11-06' then 'charla_presencial'\nelse utm_campaign \nend as utm_campaign_vf\nFROM bitrix.hs_deals a \norder by fechacreacion desc\n)\n,leads as ( \nselect \ndistinct \na.fechacreacion fecha,\ncount(distinct a.id) leads,\ncount(distinct case when (a.ingmensual NOT IN ('Menos de S/3,000') OR a.ingmensual is NULL) and (a.inicial NOT IN ('Menos de S/25,000','2391') OR a.inicial is NULL) then a.id else null end) leads_aprobados,\ncount(distinct case when (a.ingmensual NOT IN ('Menos de S/3,000', 'Entre S/3,000 y S/4,000') OR a.ingmensual is NULL) then a.id else null end) leads_altos_medios\t\nfrom bitrix_final a -- deals \ngroup by 1\norder by 1 desc\n) \n\nselect \na.fecha,\ncoalesce(a.leads,0) leads,\ncoalesce(a.leads_aprobados,0) leads_aprobados,\ncoalesce(a.leads_altos_medios,0) leads_altos_medios,\ncoalesce(b.cant_asistentes,0) cant_asistentes,\ncoalesce(c.cant_simulados,0) cant_simulados,\ncoalesce(d.cant_cotizados,0) cant_cotizados\nfrom leads a \nleft join reuniones b on a.fecha=b.fecha\nleft join simulaciones c on a.fecha=c.fecha\nleft join cotizaciones d on a.fecha=d.fecha\nwhere 1=1\nand a.fecha = current_date - 1",
        "options": {}
      },
      "id": "2dfcc220-79cd-493c-8ba7-4573affcf74a",
      "name": "Query Diario",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        320,
        -208
      ],
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH\n--COTIZACIONES\ncotizaciones as ( \nSELECT\ndate_trunc('month', fecha)::date mes,\ncount(distinct dni) cant_cotizados\nFROM cotizaciones_proyectos\nGROUP BY 1\norder by 1 desc\n),\n--SIMUALCIONES\nsimulaciones as (\nSELECT \ndate_trunc('month', fecha)::date mes,\ncount(distinct fecha) cant_simulados\nfrom financiamiento_cliente \ngroup by 1\norder by 1 desc\n)\n,\n--ASISTENCIA\nPARTICIPANTES AS (\nSELECT DISTINCT A.*, B.NOMBRE NOMBRE_1, B.APELLIDO, RIGHT(REGEXP_REPLACE(B.PHONE, '[^0-9]', '', 'g'),9) PHONE\nFROM BITRIX.PARTICIPANTES A\nLEFT JOIN (SELECT DISTINCT NOMBRE, APELLIDO, EMAIL, PHONE FROM BITRIX.INSCRITOS) B ON A.EMAIL=B.EMAIL\nLEFT JOIN (SELECT DISTINCT ID FROM BITRIX.INSCRITOS) C ON A.ID=C.ID\nWHERE C.ID IS NULL\n)\n,PARTICIPANTES_V2 AS (\nSELECT \nP.FECHA, \nP.NOMBRE, \nP.APELLIDO,\nP.EMAIL, \nP.PHONE,\nNULL AS REGISTRATIONTIME,\n'SI' AS ASISTIO,\nP.ESTANCIATOTAL DURACION,\nCASE WHEN DE.NOMBRE_ASESOR IS NOT NULL THEN DE.NOMBRE_ASESOR ELSE 'NO ASIGNADO' END AS NOMBREASESOR,\nCASE WHEN DE.CATEGORIACLIENTE IS NOT NULL THEN DE.CATEGORIACLIENTE ELSE 'NO ASIGNADO' END AS CATEGORIACLIENTE,\nP.TIPO_REUNION\nFROM PARTICIPANTES P\nLEFT JOIN BITRIX.HS_CLIENTE CLI ON LOWER(P.EMAIL) = LOWER(CLI.EMAIL) OR right(P.PHONE,9) = right(CLI.nrocelular,9)\nLEFT JOIN (\n    SELECT\n        *,\n        ROW_NUMBER() OVER (PARTITION BY IDCLIENTE ORDER BY FECHACREACION DESC) AS rn\n    FROM\n        bitrix.HS_DEALS\n    WHERE\n        LOWER(STAGE) != 'deal lost'\n\n) DE ON CLI.ID = DE.IDCLIENTE AND DE.rn = 1\n\nWHERE 1=1\nAND P.EMAIL NOT ILIKE '%PROPER%'\nORDER BY P.FECHA DESC\n)\n\n,reuniones_total AS (\nSELECT \nFECHA,\nNOMBRE,\nAPELLIDO,\nEMAIL,\nPHONE,\nREGISTRATIONTIME,\nASISTIO,\nDURACION,\nNOMBREASESOR,\nCATEGORIACLIENTE,\nTIPO_REUNION\nFROM BITRIX.TEMP_REUNIONES_SEMANALES\nWHERE EMAIL NOT ILIKE '%PROPER%'\nUNION \nSELECT *\nFROM PARTICIPANTES_V2\nWHERE EMAIL NOT ILIKE '%PROPER%'\n)\n\n,reuniones as ( \nselect \ndate_trunc('month', fecha)::date mes,\ncount(distinct email) cant_asistentes\nfrom reuniones_total\nwhere asistio='SI'\ngroup by 1\norder by 1 desc\n)\n\n,bitrix_final as (\nselect a.*,\ncase when a.stage in ('INFLUENCERS') then 'APROBADOS' else a.stage end as etapa_vf,\nCASE \n            WHEN a.residencia IS NULL THEN 'Falta'\n            WHEN a.residencia IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') THEN 'Nacional' \n            ELSE 'Internacional'\n        END AS residencia_general,\n\nCASE\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT>=100000 THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial not in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') AND a.categoriacliente is null THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT<100000 THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=9000 AND a.web_monto_inicial::INT>=25000 THEN 'ALTO'\n\t\tWHEN (a.ingmensual in ('Entre S/9,000 y S/12,000', 'Entre S/12,000 y S/15,000', 'Entre S/15,000 y S/20,000', 'Más de S/20,000') and a.inicial not in ('Menos de S/25,000'))\n\t\tOR a.categoriacliente ILIKE 'ALTO' THEN 'ALTO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=4000 AND a.web_monto_inicial::INT>=25000 THEN 'MEDIO'\n\t\tWHEN (a.ingmensual in ('Entre S/4,000 y S/6,000', 'Entre S/6,000 y S/9,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='MEDIO' THEN 'MEDIO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=3000 AND a.web_monto_inicial::INT>=25000 THEN 'EMPUJE'\n\t\tWHEN (a.ingmensual in ('Entre S/3,000 y S/4,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='EMPUJE' THEN 'EMPUJE'\n\t\tWHEN a.ingmensual in ('Menos de S/3,000') THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_monto_inicial::INT<25000 THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT<3000 THEN 'NO APROBADO'\n\t\tWHEN a.categoriacliente='NO APROBADO NACIONAL' then 'NO APROBADO'\n\t\tEND AS categoria_cliente_vf,\t\n\t\nlower(a.utm_source) utm_source_vf,\ncase \nwhen a.utm_source in ('web_home_workshop', 'web_home', 'web_edu', 'web_internacional') then 'organico'\nwhen a.utm_source ilike '%instagram%' then 'social'\nwhen a.utm_source ilike '%vendedores%' then 'asesores_proper'\nwhen a.utm_source ilike '%juan_huerta%' then 'influencer'\nwhen a.utm_source ilike '%intalks%' then 'evento'\nwhen a.utm_source ilike '%entel%' then 'B2B'\nwhen a.utm_source ilike '%pwc%' then 'B2B'\nwhen a.utm_source ilike '%dp_world%' and a.fechacreacion='2024-07-10' then 'evento'\nelse utm_medium\nend as utm_medium_vf,\ncase \nwhen a.utm_source ilike '%pwc%' and utm_medium='evento_pwc' then 'evento_presencial'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%webinar%' then 'webinar'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%B2B%' then 'evento_presencial'\nwhen a.utm_source ilike '%hapag%' and utm_medium ilike '%B2B%' and fechacreacion='2024-11-06' then 'charla_presencial'\nelse utm_campaign \nend as utm_campaign_vf\nFROM bitrix.hs_deals a \norder by fechacreacion desc\n)\n,leads as ( \nselect \ndistinct \ndate_trunc('month', a.fechacreacion)::date mes,\ncount(distinct a.id) leads,\ncount(distinct case when (a.ingmensual NOT IN ('Menos de S/3,000') OR a.ingmensual is NULL) and (a.inicial NOT IN ('Menos de S/25,000','2391') OR a.inicial is NULL) then a.id else null end) leads_aprobados,\ncount(distinct case when (a.ingmensual NOT IN ('Menos de S/3,000', 'Entre S/3,000 y S/4,000') OR a.ingmensual is NULL) then a.id else null end) leads_altos_medios\t\nfrom bitrix_final a -- deals \ngroup by 1\norder by 1 desc\n) \n\nselect \na.mes,\ncoalesce(a.leads,0) leads,\ncoalesce(a.leads_aprobados,0) leads_aprobados,\ncoalesce(round(1.0*a.leads_aprobados/a.leads,2),0) porc_aprobados,\ncoalesce(a.leads_altos_medios,0) leads_altos_medios,\ncoalesce(round(1.0*a.leads_altos_medios/a.leads,2),0) porc_altos_medios,\ncoalesce(b.cant_asistentes,0) cant_asistentes,\ncoalesce(round(1.0*b.cant_asistentes/a.leads_aprobados,2),0) porc_asistencia,\ncoalesce(c.cant_simulados,0) cant_simulados,\ncoalesce(d.cant_cotizados,0) cant_cotizados,\ncoalesce(round(1.0*d.cant_cotizados/a.leads_aprobados,2),0) porc_cotizados\nfrom leads a \nleft join reuniones b on a.mes=b.mes\nleft join simulaciones c on a.mes=c.mes\nleft join cotizaciones d on a.mes=d.mes\nwhere 1=1\nand a.mes = date_trunc('month', current_date)\norder by a.mes desc",
        "options": {}
      },
      "id": "b883f45d-d5da-480d-9823-aa623dc6f22d",
      "name": "Query Acumulado",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        544,
        -208
      ],
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH\n--COTIZACIONES\ncotizaciones as ( \nSELECT\ndate_trunc('month', fecha)::date mes,\ncase \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nelse asesor\nend as asesor,\ncount(distinct dni) cant_cotizados\nFROM cotizaciones_proyectos\nGROUP BY 1,2\norder by 1 desc\n),\n--SIMUALCIONES\nsimulaciones as (\nSELECT \ndate_trunc('month', fecha)::date mes,\ncase \nwhen asesor='yanery.champi@proper.com.pe' then 'Yanery Champi'\nwhen asesor='eleana.mesia@proper.com.pe' then 'Eleana Mesia'\nwhen asesor='leidy.sanchez@proper.com.pe' then 'Leidy Sanchez'\nwhen asesor='elena.aranibar@proper.com.pe' then 'Elena Aranibar'\nwhen asesor='dz.diaz@proper.com.pe' then 'Dzonhatan Diaz'\nwhen asesor='germain.pasapera@proper.com.pe' then 'Germain Pasapera'\nwhen asesor='joaquin.jarama@proper.com.pe' then 'Joaquin Jarama'\nwhen asesor='luis.campos@proper.com.pe' then 'Luis Campos'\nwhen asesor='sharon.caceres@proper.com.pe' then 'Sharon Caceres'\nwhen asesor='marcos.uribe@proper.com.pe' then 'Marcos Uribe'\nwhen asesor='jean.muro@proper.com.pe' then 'Jean Muro'\nwhen asesor='sebastian.llontop@proper.com.pe' then 'Sebastian Llontop'\nelse asesor\nend as asesor,\ncount(distinct fecha) cant_simulados\nfrom financiamiento_cliente \ngroup by 1,2\norder by 1 desc\n)\n,\n--ASISTENCIA\nPARTICIPANTES AS (\nSELECT DISTINCT A.*, B.NOMBRE NOMBRE_1, B.APELLIDO, RIGHT(REGEXP_REPLACE(B.PHONE, '[^0-9]', '', 'g'),9) PHONE\nFROM BITRIX.PARTICIPANTES A\nLEFT JOIN (SELECT DISTINCT NOMBRE, APELLIDO, EMAIL, PHONE FROM BITRIX.INSCRITOS) B ON A.EMAIL=B.EMAIL\nLEFT JOIN (SELECT DISTINCT ID FROM BITRIX.INSCRITOS) C ON A.ID=C.ID\nWHERE C.ID IS NULL\n)\n,PARTICIPANTES_V2 AS (\nSELECT \nP.FECHA, \nP.NOMBRE, \nP.APELLIDO,\nP.EMAIL, \nP.PHONE,\nNULL AS REGISTRATIONTIME,\n'SI' AS ASISTIO,\nP.ESTANCIATOTAL DURACION,\nCASE WHEN DE.NOMBRE_ASESOR IS NOT NULL THEN DE.NOMBRE_ASESOR ELSE 'NO ASIGNADO' END AS NOMBREASESOR,\nCASE WHEN DE.CATEGORIACLIENTE IS NOT NULL THEN DE.CATEGORIACLIENTE ELSE 'NO ASIGNADO' END AS CATEGORIACLIENTE,\nP.TIPO_REUNION\nFROM PARTICIPANTES P\nLEFT JOIN BITRIX.HS_CLIENTE CLI ON LOWER(P.EMAIL) = LOWER(CLI.EMAIL) OR right(P.PHONE,9) = right(CLI.nrocelular,9)\nLEFT JOIN (\n    SELECT\n        *,\n        ROW_NUMBER() OVER (PARTITION BY IDCLIENTE ORDER BY FECHACREACION DESC) AS rn\n    FROM\n        bitrix.HS_DEALS\n    WHERE\n        LOWER(STAGE) != 'deal lost'\n\n) DE ON CLI.ID = DE.IDCLIENTE AND DE.rn = 1\n\nWHERE 1=1\nAND P.EMAIL NOT ILIKE '%PROPER%'\nORDER BY P.FECHA DESC\n)\n\n,reuniones_total AS (\nSELECT \nFECHA,\nNOMBRE,\nAPELLIDO,\nEMAIL,\nPHONE,\nREGISTRATIONTIME,\nASISTIO,\nDURACION,\nNOMBREASESOR,\nCATEGORIACLIENTE,\nTIPO_REUNION\nFROM BITRIX.TEMP_REUNIONES_SEMANALES\nWHERE EMAIL NOT ILIKE '%PROPER%'\nUNION \nSELECT *\nFROM PARTICIPANTES_V2\nWHERE EMAIL NOT ILIKE '%PROPER%'\n)\n\n,reuniones as ( \nselect \ndate_trunc('month', fecha)::date mes,\nnombreasesor asesor,\ncount(distinct email) cant_asistentes\nfrom reuniones_total\nwhere asistio='SI'\ngroup by 1,2\norder by 1 desc\n)\n\n,bitrix_final as (\nselect a.*,\ncase when a.stage in ('INFLUENCERS') then 'APROBADOS' else a.stage end as etapa_vf,\nCASE \n            WHEN a.residencia IS NULL THEN 'Falta'\n            WHEN a.residencia IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') THEN 'Nacional' \n            ELSE 'Internacional'\n        END AS residencia_general,\n\nCASE\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT>=100000 THEN 'APROBADO INTERNACIONAL'\n\t\tWHEN a.residencia NOT IN ('LIMA', 'Lima', 'PROVINCIA', 'Provincia','PerÃº','Perú') \n\t\tand a.inicial not in ('Más de S/100,000', 'Entre S/120,000 y S/200,000', 'Entre S/200,000 y S/350,000') AND a.categoriacliente is null THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='extranjero' AND a.web_monto_inicial::INT<100000 THEN 'NO APROBADO INTERNACIONAL'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=9000 AND a.web_monto_inicial::INT>=25000 THEN 'ALTO'\n\t\tWHEN (a.ingmensual in ('Entre S/9,000 y S/12,000', 'Entre S/12,000 y S/15,000', 'Entre S/15,000 y S/20,000', 'Más de S/20,000') and a.inicial not in ('Menos de S/25,000'))\n\t\tOR a.categoriacliente ILIKE 'ALTO' THEN 'ALTO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=4000 AND a.web_monto_inicial::INT>=25000 THEN 'MEDIO'\n\t\tWHEN (a.ingmensual in ('Entre S/4,000 y S/6,000', 'Entre S/6,000 y S/9,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='MEDIO' THEN 'MEDIO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT>=3000 AND a.web_monto_inicial::INT>=25000 THEN 'EMPUJE'\n\t\tWHEN (a.ingmensual in ('Entre S/3,000 y S/4,000') and a.inicial not in ('Menos de S/25,000')) OR a.categoriacliente ='EMPUJE' THEN 'EMPUJE'\n\t\tWHEN a.ingmensual in ('Menos de S/3,000') THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_monto_inicial::INT<25000 THEN 'NO APROBADO'\n\t\tWHEN a.web_residencia='perú' AND a.web_ingresos::INT<3000 THEN 'NO APROBADO'\n\t\tWHEN a.categoriacliente='NO APROBADO NACIONAL' then 'NO APROBADO'\n\t\tEND AS categoria_cliente_vf,\t\n\t\nlower(a.utm_source) utm_source_vf,\ncase \nwhen a.utm_source in ('web_home_workshop', 'web_home', 'web_edu', 'web_internacional') then 'organico'\nwhen a.utm_source ilike '%instagram%' then 'social'\nwhen a.utm_source ilike '%vendedores%' then 'asesores_proper'\nwhen a.utm_source ilike '%juan_huerta%' then 'influencer'\nwhen a.utm_source ilike '%intalks%' then 'evento'\nwhen a.utm_source ilike '%entel%' then 'B2B'\nwhen a.utm_source ilike '%pwc%' then 'B2B'\nwhen a.utm_source ilike '%dp_world%' and a.fechacreacion='2024-07-10' then 'evento'\nelse utm_medium\nend as utm_medium_vf,\ncase \nwhen a.utm_source ilike '%pwc%' and utm_medium='evento_pwc' then 'evento_presencial'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%webinar%' then 'webinar'\nwhen a.utm_source ilike '%pwc%' and utm_medium ilike '%B2B%' then 'evento_presencial'\nwhen a.utm_source ilike '%hapag%' and utm_medium ilike '%B2B%' and fechacreacion='2024-11-06' then 'charla_presencial'\nelse utm_campaign \nend as utm_campaign_vf\nFROM bitrix.hs_deals a \norder by fechacreacion desc\n)\n\n,leads as ( \nselect \ndistinct \ndate_trunc('month', a.fechacreacion)::date mes,\nnombre_asesor asesor,\ncount(distinct a.id) leads,\ncount(distinct case when (a.ingmensual NOT IN ('Menos de S/3,000') OR a.ingmensual is NULL) and (a.inicial NOT IN ('Menos de S/25,000','2391') OR a.inicial is NULL) then a.id else null end) leads_aprobados,\ncount(distinct case when (a.ingmensual NOT IN ('Menos de S/3,000', 'Entre S/3,000 y S/4,000') OR a.ingmensual is NULL) then a.id else null end) leads_altos_medios\t\nfrom bitrix_final a -- deals \ngroup by 1,2\norder by 1 desc\n) \n\nselect \na.mes,\na.asesor,\ncoalesce(a.leads,0) leads,\ncoalesce(a.leads_aprobados,0) leads_aprobados,\ncoalesce(round(1.0*a.leads_aprobados/a.leads,2),0) porc_aprobados,\ncoalesce(a.leads_altos_medios,0) leads_altos_medios,\ncoalesce(round(1.0*a.leads_altos_medios/a.leads,2),0) porc_altos_medios,\ncoalesce(b.cant_asistentes,0) cant_asistentes,\ncoalesce(round(1.0*b.cant_asistentes/a.leads_aprobados,2),0) porc_asistencia,\ncoalesce(c.cant_simulados,0) cant_simulados,\ncoalesce(d.cant_cotizados,0) cant_cotizados,\ncoalesce(round(1.0*d.cant_cotizados/a.leads_aprobados,2),0) porc_cotizados\nfrom leads a \nleft join reuniones b on a.mes=b.mes and a.asesor=b.asesor\nleft join simulaciones c on a.mes=c.mes and a.asesor=c.asesor\nleft join cotizaciones d on a.mes=d.mes and a.asesor=d.asesor\nwhere 1=1\nand a.mes = date_trunc('month', current_date)\norder by a.mes, a.leads desc",
        "options": {}
      },
      "id": "fab0b285-d98d-48b0-86ed-c6c050f1c6fb",
      "name": "Query Asesor",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        768,
        -208
      ],
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "   with leads_bitrix as (\n   SELECT \n        a.*,\n        CASE WHEN a.stage IN ('INFLUENCERS') THEN 'APROBADOS' ELSE a.stage END AS etapa_vf,\n        CASE \n            WHEN a.residencia IS NULL THEN 'Falta'\n            WHEN a.residencia IN ('LIMA','Lima','PROVINCIA','Provincia','PerÃº','Perú') THEN 'Nacional'\n            ELSE 'Internacional'\n        END AS residencia_general,\n        CASE\n            WHEN a.residencia NOT IN ('LIMA','Lima','PROVINCIA','Provincia','PerÃº','Perú')\n                 AND a.inicial IN ('Más de S/100,000','Entre S/120,000 y S/200,000','Entre S/200,000 y S/350,000')\n                THEN 'APROBADO INTERNACIONAL'\n            WHEN a.web_residencia = 'extranjero' AND a.web_monto_inicial::INT >= 100000\n                THEN 'APROBADO INTERNACIONAL'\n            WHEN a.residencia NOT IN ('LIMA','Lima','PROVINCIA','Provincia','PerÃº','Perú')\n                 AND a.inicial NOT IN ('Más de S/100,000','Entre S/120,000 y S/200,000','Entre S/200,000 y S/350,000')\n                 AND a.categoriacliente IS NULL\n                THEN 'NO APROBADO INTERNACIONAL'\n            WHEN a.web_residencia = 'extranjero' AND a.web_monto_inicial::INT < 100000\n                THEN 'NO APROBADO INTERNACIONAL'\n            WHEN a.web_residencia = 'perú' AND a.web_ingresos::INT >= 9000 AND a.web_monto_inicial::INT >= 25000\n                THEN 'ALTO'\n            WHEN (a.ingmensual IN ('Entre S/9,000 y S/12,000','Entre S/12,000 y S/15,000','Entre S/15,000 y S/20,000','Más de S/20,000')\n                  AND a.inicial NOT IN ('Menos de S/25,000'))\n                 OR a.categoriacliente ILIKE 'ALTO'\n                THEN 'ALTO'\n            WHEN a.web_residencia = 'perú' AND a.web_ingresos::INT >= 4000 AND a.web_monto_inicial::INT >= 25000\n                THEN 'MEDIO'\n            WHEN (a.ingmensual IN ('Entre S/4,000 y S/6,000','Entre S/6,000 y S/9,000')\n                  AND a.inicial NOT IN ('Menos de S/25,000'))\n                 OR a.categoriacliente = 'MEDIO'\n                THEN 'MEDIO'\n            WHEN a.web_residencia = 'perú' AND a.web_ingresos::INT >= 3000 AND a.web_monto_inicial::INT >= 25000\n                THEN 'EMPUJE'\n            WHEN (a.ingmensual IN ('Entre S/3,000 y S/4,000')\n                  AND a.inicial NOT IN ('Menos de S/25,000'))\n                 OR a.categoriacliente = 'EMPUJE'\n                THEN 'EMPUJE'\n            ELSE 'NO APROBADO'\n        END AS categoria_cliente_vf\n    FROM bitrix.hs_deals a)\n\t\n\tselect fechacreacion::date fecha, utm_source canal, count(distinct id) leads \n\tfrom leads_bitrix\n\twhere fechacreacion = current_date -1\n\tgroup by 1,2\n\torder by 3 desc",
        "options": {}
      },
      "id": "65fe622c-2091-49d7-9c29-4e8248527c8b",
      "name": "Query Canales",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        976,
        -208
      ],
      "executeOnce": true,
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Helper para formatear encabezados\nfunction formatHeader(key) {\n    // Reemplaza guiones bajos por espacios, pasa a mayúsculas\n    // y reemplaza 'PORC' por '%'\n    return key.replace(/_/g, ' ').toUpperCase().replace('PORC', '%');\n}\n\n// Helper para formatear fechas a YYYY-MM-DD\nfunction formatDate(val) {\n    if (val === null || val === undefined) return '';\n    \n    // Si es un objeto fecha de JS\n    if (val instanceof Date) {\n        return val.toISOString().split('T')[0];\n    }\n    \n    // Si es un string que parece fecha ISO\n    if (typeof val === 'string' && val.match(/^\\d{4}-\\d{2}-\\d{2}/)) {\n        return val.split('T')[0];\n    }\n    \n    return val;\n}\n\n// Helper para formatear valores en las celdas\nfunction formatValue(key, val) {\n    if (val === null || val === undefined) return '';\n\n    // 1. Detección de Porcentajes\n    // Si el nombre de la columna contiene 'porc' (o si ahora es %), aplicamos formato porcentaje\n    if (key.toLowerCase().includes('porc')) {\n        const num = parseFloat(val);\n        if (!isNaN(num)) {\n            // Asumimos que la BD devuelve 0.15 para 15% (según el query 'round(x/y, 2)')\n            // Multiplicamos por 100 y añadimos el signo\n            return Math.round(num * 100) + '%';\n        }\n    }\n\n    // 2. Formato por defecto (incluye fechas)\n    return formatDate(val);\n}\n\n// Función helper para construir tabla HTML\nfunction buildTable(title, items) {\n    if (!items || items.length === 0) return `<p><strong>${title}:</strong> No hay datos para mostrar.</p>`;\n\n    const headers = Object.keys(items[0]);\n\n    let html = `<h3 style=\"font-family: Arial, sans-serif; color: #333;\">${title}</h3>`;\n    html += '<table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; font-size: 14px; border: 1px solid #ddd;\">';\n    \n    // Headers\n    // Cambio: Color Azul Oscuro (#003366) para formalidad\n    html += '<thead style=\"background-color: #003366; color: white;\"><tr>';\n    \n    headers.forEach(h => {\n        const label = formatHeader(h);\n        \n        // Cambio: Estilo especial para la columna MES para que sea más ancha\n        let thStyle = \"text-align: left;\";\n        if (h.toLowerCase() === 'mes' || label === 'MES') {\n            thStyle += \" min-width: 120px; white-space: nowrap;\";\n        }\n        \n        html += `<th style=\"${thStyle}\">${label}</th>`;\n    });\n    html += '</tr></thead>';\n\n    // Rows\n    html += '<tbody>';\n    items.forEach((item, index) => {\n        const bgColor = index % 2 === 0 ? '#ffffff' : '#f9f9f9';\n        html += `<tr style=\"background-color: ${bgColor};\">`;\n        headers.forEach(h => {\n            // Aplicamos formato de valor (fechas o porcentajes)\n            let val = formatValue(h, item[h]);\n            html += `<td style=\"border: 1px solid #ddd;\">${val}</td>`;\n        });\n        html += '</tr>';\n    });\n    html += '</tbody></table><br/>';\n    return html;\n}\n\n// Obtener datos de los nodos anteriores\nconst data1 = $('Query Diario').all().map(i => i.json);\nconst data2 = $('Query Acumulado').all().map(i => i.json);\nconst data3 = $('Query Asesor').all().map(i => i.json);\nconst data4 = $('Query Canales').all().map(i => i.json);\n\n// Construir el cuerpo del correo\nlet emailBody = '<div style=\"font-family: Arial, sans-serif;\">';\nemailBody += '<h2 style=\"color: #003366;\">Reporte Diario de Inversiones</h2>';\n\nconst hoy = new Date().toISOString().split('T')[0];\n\nemailBody += '<hr/>';\n\nemailBody += buildTable('Tabla 1: Diario (Ayer)', data1);\nemailBody += buildTable('Tabla 2: Acumulado Mes', data2);\nemailBody += buildTable('Tabla 3: Acumulado por Asesor', data3);\nemailBody += buildTable('Tabla 4: Leads por Canales (Ayer)', data4);\n\nemailBody += '</div>';\n\nreturn [{ json: { html: emailBody } }];"
      },
      "id": "b80a7137-353a-4e6d-aa5a-440362804fb8",
      "name": "Formatear HTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        -208
      ]
    },
    {
      "parameters": {
        "sendTo": "valeria.vega@proper.com.pe, jorge.campos@cmcapital.in, leidy.sanchez@proper.com.pe, silvia.malca@proper.com.pe",
        "subject": "Reporte diario de inversiones",
        "message": "={{ $json.html }}",
        "options": {}
      },
      "id": "b410e060-4c32-490c-a3ff-6756daca756e",
      "name": "Enviar Email (Gmail)",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1424,
        -208
      ],
      "webhookId": "b3542d1a-1e15-46a1-945d-39b59deee3c8",
      "credentials": {
        "gmailOAuth2": {
          "id": "SPurZ4Z9pGQy8MKJ",
          "name": "Gmail account"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "shared": [
    {
      "createdAt": "2026-01-19T17:47:52.676Z",
      "updatedAt": "2026-01-19T17:47:52.676Z",
      "role": "workflow:owner",
      "workflowId": "fZc9su0VEenLGV1R",
      "projectId": "tpSonpyzopDOYZNA"
    }
  ],
  "staticData": {
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-01-19T19:06:03.343Z",
  "versionId": "688aa443-7f92-4649-9620-3ded42261c04"
}