{
  "active": true,
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Query Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Diario": {
      "main": [
        [
          {
            "node": "Query Acumulado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Acumulado": {
      "main": [
        [
          {
            "node": "Query MODO Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query MODO Diario": {
      "main": [
        [
          {
            "node": "Query MODO Acumulado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query MODO Acumulado": {
      "main": [
        [
          {
            "node": "Query Retail Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Retail Diario": {
      "main": [
        [
          {
            "node": "Query Retail Acumulado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Retail Acumulado": {
      "main": [
        [
          {
            "node": "Query Inventario Diario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Inventario Diario": {
      "main": [
        [
          {
            "node": "Query Inventario Acumulado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Inventario Acumulado": {
      "main": [
        [
          {
            "node": "Generate HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate HTML": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-12-04T18:05:49.387Z",
  "id": "0zYOliVlWXi5TPIW",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "REPORTE DIARIO RENTAS VF",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 8
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -448,
        -192
      ],
      "id": "2cf43502-c058-46e0-81b2-3def6a3446cd",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  TO_CHAR(fecha_creacion::timestamp, 'YYYY-MM-DD') as \"Fecha\",\n  COUNT(id) as \"Total Leads\",\n  SUM(inmueble_identificado) as \"Inm. Ident.\",\n  SUM(dio_horario) as \"Dieron Horario\",\n  SUM(error_marcado) as \"Error\",\n  COUNT(CASE WHEN cod_propiedad_unificado = 'MODO' THEN 1 END) as \"Leads Modo\",\n  COUNT(CASE WHEN cod_propiedad_unificado != 'MODO' OR cod_propiedad_unificado IS NULL THEN 1 END) as \"Leads Retail\"\nFROM crm.bot_leads_david\nWHERE fecha_creacion::date = CURRENT_DATE - 1\nGROUP BY 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -224,
        -192
      ],
      "id": "53c71831-efee-423e-8351-7bdf3dc553fa",
      "name": "Query Diario",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  TO_CHAR(DATE_TRUNC('month', fecha_creacion::timestamp), 'YYYY-MM') as \"Mes\",\n  COUNT(id) as \"Total Leads\",\n  SUM(inmueble_identificado) as \"Inm. Ident.\",\n  SUM(dio_horario) as \"Dieron Horario\",\n  SUM(error_marcado) as \"Error\",\n  COUNT(CASE WHEN cod_propiedad_unificado = 'MODO' THEN 1 END) as \"Leads Modo\",\n  COUNT(CASE WHEN cod_propiedad_unificado != 'MODO' OR cod_propiedad_unificado IS NULL THEN 1 END) as \"Leads Retail\"\nFROM crm.bot_leads_david\nWHERE DATE_TRUNC('month', fecha_creacion::timestamp) = DATE_TRUNC('month', CURRENT_DATE)\nGROUP BY 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        16,
        -192
      ],
      "id": "d1127367-66bf-4e1c-afec-457d59f0d12e",
      "name": "Query Acumulado",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  TO_CHAR(fecha_creacion::timestamp, 'YYYY-MM-DD') as \"Fecha\",\n  COUNT(id) as \"Leads Real\",\n  SUM(dio_horario) as \"Visitas Agend.\",\n  SUM(CASE WHEN fecha_modo::date >= CURRENT_DATE - 1 AND fecha_modo::date < CURRENT_DATE THEN 1 ELSE 0 END) as \"Visitas Real.\"\nFROM crm.bot_leads_david\nWHERE fecha_creacion::date = CURRENT_DATE - 1\nAND cod_propiedad_unificado = 'MODO'\nGROUP BY 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        240,
        -192
      ],
      "id": "cd498574-985a-4758-bd7a-217b111886ec",
      "name": "Query MODO Diario",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  TO_CHAR(DATE_TRUNC('month', fecha_creacion::timestamp), 'YYYY-MM') as \"Mes\",\n  COUNT(id) as \"Leads\",\n  SUM(dio_horario) as \"Visitas Agend.\",\n  SUM(CASE WHEN fecha_modo IS NOT NULL THEN 1 ELSE 0 END) as \"Visitas Real.\",\n  0 as \"Nuevos Ingresos\"\nFROM crm.bot_leads_david\nWHERE DATE_TRUNC('month', fecha_creacion::timestamp) = DATE_TRUNC('month', CURRENT_DATE)\nAND cod_propiedad_unificado = 'MODO'\nGROUP BY 1",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        464,
        -192
      ],
      "id": "c9c52da6-eaa4-4490-ab48-59e7376703fd",
      "name": "Query MODO Acumulado",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  TO_CHAR(CURRENT_DATE - 1, 'YYYY-MM-DD') as \"Fecha\",\n  (\n    SELECT COUNT(DISTINCT telefono)\n    FROM crm.bot_leads_david\n    WHERE fecha_creacion::date = CURRENT_DATE - 1\n    AND (cod_propiedad_unificado != 'MODO' OR cod_propiedad_unificado IS NULL)\n  ) as \"Leads Real\",\n  (\n    SELECT COUNT(DISTINCT CELULAR)\n    FROM rentas_crm.visitas\n    WHERE fecha_programada::date = CURRENT_DATE - 1\n    AND FORMULARIO ILIKE '%Inquilino interesado%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%TEST%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%PRUEBA%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%MODO%'\n  ) as \"Visitas Agend.\",\n  (\n    SELECT COUNT(DISTINCT CELULAR)\n    FROM rentas_crm.visitas\n    WHERE fecha_programada::date = CURRENT_DATE - 1\n    AND FORMULARIO ILIKE '%Inquilino interesado%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%TEST%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%PRUEBA%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%MODO%'\n    AND estado NOT IN ('No realizado', 'Cliente no asistió')\n  ) as \"Visitas Real.\"",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        688,
        -192
      ],
      "id": "7a164ada-fd73-476d-b94a-4a050419191c",
      "name": "Query Retail Diario",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  TO_CHAR(DATE_TRUNC('month', CURRENT_DATE), 'YYYY-MM') as \"Mes\",\n  (\n    SELECT COUNT(DISTINCT telefono)\n    FROM crm.bot_leads_david\n    WHERE DATE_TRUNC('month', fecha_creacion::timestamp) = DATE_TRUNC('month', CURRENT_DATE)\n    AND (cod_propiedad_unificado != 'MODO' OR cod_propiedad_unificado IS NULL)\n  ) as \"Leads\",\n  (\n    SELECT COUNT(DISTINCT CELULAR)\n    FROM rentas_crm.visitas\n    WHERE DATE_TRUNC('month', fecha_programada) = DATE_TRUNC('month', CURRENT_DATE)\n    AND FORMULARIO ILIKE '%Inquilino interesado%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%TEST%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%PRUEBA%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%MODO%'\n  ) as \"Visitas Agend.\",\n  (\n    SELECT COUNT(DISTINCT CELULAR)\n    FROM rentas_crm.visitas\n    WHERE DATE_TRUNC('month', fecha_programada) = DATE_TRUNC('month', CURRENT_DATE)\n    AND FORMULARIO ILIKE '%Inquilino interesado%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%TEST%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%PRUEBA%'\n    AND CODIGO_INMUEBLE NOT ILIKE '%MODO%'\n    AND estado NOT IN ('No realizado', 'Cliente no asistió')\n  ) as \"Visitas Real.\",\n  0 as \"Nuevos Ingresos\"",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        896,
        -192
      ],
      "id": "9c2e924d-7958-4272-b01d-8a1530a6d9a4",
      "name": "Query Retail Acumulado",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH lead_base AS (\nSELECT a.id AS lead_id,\na.fecha_creacion AS lead_fecha_creacion,\na.funnel_id,\na.\"customFields\",\nb.id AS contacto_id,\nb.nombre,\nb.apellido_paterno,\nb.telefono,\nb.email,\nb.nro_documento,\ne.nombre AS etapa_funnel\nFROM crm.leads a\nLEFT JOIN crm.contactos b ON a.contacto_id = b.id\nLEFT JOIN crm.etapas_leads e ON a.etapa_inmueble = e.codigo\nWHERE a.funnel_id = 7\n),\nkv AS (\nSELECT lb.lead_id,\nlb.contacto_id,\nlb.nombre,\nlb.apellido_paterno,\nlb.telefono,\nlb.nro_documento,\nlb.email,\nlb.lead_fecha_creacion,\nlb.funnel_id,\nlb.etapa_funnel,\nk.key   AS field_id,\nk.value AS raw_value\nFROM lead_base lb\nLEFT JOIN LATERAL jsonb_each(lb.\"customFields\"::jsonb) AS k(key, value) ON true\n),\nkv_norm AS (\nSELECT\nkv.*,\ntrim(both '\"' from kv.raw_value::text) AS raw_text,\nCASE\nWHEN jsonb_typeof(kv.raw_value) IN ('number','string')\nAND (trim(both '\"' from kv.raw_value::text) ~ '^\\\\d+$')\nTHEN (trim(both '\"' from kv.raw_value::text))::int\nELSE NULL\nEND AS raw_id\nFROM kv\n),\nresolved AS (\nSELECT\nkvn.lead_id,\nkvn.contacto_id,\nkvn.nombre,\nkvn.apellido_paterno,\nkvn.telefono,\nkvn.nro_documento,\nkvn.email,\nkvn.lead_fecha_creacion,\nkvn.etapa_funnel,\ncf.name AS field_name,\nCOALESCE(cv.value, NULLIF(kvn.raw_text,'null')) AS field_value\nFROM kv_norm kvn\nLEFT JOIN crm.custom_fields cf ON cf.id = kvn.field_id\nLEFT JOIN crm.custom_values cv\nON cv.field_id = cf.id AND cv.id = kvn.raw_id\nWHERE cf.funnel_id = 7\n),\nleads_v1 AS (\nSELECT\nr.lead_id,\nr.contacto_id,\nr.nombre,\nr.apellido_paterno,\nr.telefono,\nr.email,\nr.nro_documento,\nr.lead_fecha_creacion,\nr.etapa_funnel,\nMAX(CASE WHEN r.field_name = '¿En que departamento se encuentra tu inmueble?' THEN r.field_value END) AS departamento,\nMAX(CASE WHEN r.field_name = '¿En qué distrito se encuentra tu inmueble?' THEN r.field_value END) AS distrito,\nMAX(CASE WHEN r.field_name = '¿Tu departamento está listo para alquilar o está en construcción?' THEN r.field_value END) AS listo_alquilar\nFROM resolved r\nGROUP BY 1,2,3,4,5,6,7,8,9\n),\nleads_final AS (\nSELECT\nlead_fecha_creacion::date AS fechacreacion,\nnombre,\napellido_paterno,\nnro_documento AS nrodoc,\ntelefono,\nemail,\ndistrito,\nCASE WHEN distrito IN (\n'Miraflores', 'San Miguel', 'Magdalena', 'Lince', 'Jesús María',\n'Pueblo Libre', 'La Victoria', 'Breña', 'Barranco', 'San Borja',\n'San Isidro', 'Surquillo', 'Chorrillos', 'Santa Beatriz', 'Surco'\n)\nTHEN 'SI' ELSE 'NO'\nEND AS con_cobertura,\nlisto_alquilar\nFROM leads_v1\nWHERE lead_fecha_creacion::date = CURRENT_DATE - 1\n)\nSELECT\nTO_CHAR(CURRENT_DATE - 1, 'YYYY-MM-DD') as \"Fecha\",\n(\n    SELECT COUNT(DISTINCT telefono)\n    FROM leads_final\n    WHERE nombre NOT ILIKE '%TEST%'\n    AND nombre NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%Mendoza Mattos%'\n    AND apellido_paterno NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%TEST%'\n    AND (nrodoc <> '75946464' OR nrodoc IS NULL)\n) as \"Leads Real\",\n(\n    SELECT COUNT(DISTINCT telefono)\n    FROM leads_final\n    WHERE con_cobertura = 'SI'\n    AND nombre NOT ILIKE '%TEST%'\n    AND nombre NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%Mendoza Mattos%'\n    AND apellido_paterno NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%TEST%'\n    AND (nrodoc <> '75946464' OR nrodoc IS NULL)\n) as \"Leads en Cobertura\",\n(\n    SELECT COUNT(DISTINCT A.telefono)\n    FROM leads_final A\n    LEFT JOIN CRM.BOT_LEADS_DIEGO C \n        ON RIGHT(REGEXP_REPLACE(A.TELEFONO, '[^0-9]', '', 'g'), 9) = RIGHT(REGEXP_REPLACE(C.TELEFONO, '[^0-9]', '', 'g'), 9)\n    WHERE A.nombre NOT ILIKE '%TEST%'\n    AND A.nombre NOT ILIKE '%PRUEBA%'\n    AND A.apellido_paterno NOT ILIKE '%Mendoza Mattos%'\n    AND A.apellido_paterno NOT ILIKE '%PRUEBA%'\n    AND A.apellido_paterno NOT ILIKE '%TEST%'\n    AND (A.nrodoc <> '75946464' OR A.nrodoc IS NULL)\n    AND C.DIO_HORARIO = 1\n) as \"Horarios\",\n(\n    SELECT COUNT(DISTINCT A.telefono)\n    FROM leads_final A\n    LEFT JOIN rentas_crm.visitas B \n        ON RIGHT(REGEXP_REPLACE(A.TELEFONO, '[^0-9]', '', 'g'), 9) = RIGHT(REGEXP_REPLACE(B.CELULAR, '[^0-9]', '', 'g'), 9)\n    WHERE A.nombre NOT ILIKE '%TEST%'\n    AND A.nombre NOT ILIKE '%PRUEBA%'\n    AND A.apellido_paterno NOT ILIKE '%Mendoza Mattos%'\n    AND A.apellido_paterno NOT ILIKE '%PRUEBA%'\n    AND A.apellido_paterno NOT ILIKE '%TEST%'\n    AND (A.nrodoc <> '75946464' OR A.nrodoc IS NULL)\n    AND B.formulario = 'Propietario interesado'\n    AND RIGHT(REGEXP_REPLACE(B.celular, '[^0-9]', '', 'g'), 9) NOT IN ('959264957')\n) as \"Llamadas\"",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1120,
        -192
      ],
      "id": "3e6661f9-7517-421e-b3f5-5f7873e976e6",
      "name": "Query Inventario Diario",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH lead_base AS (\nSELECT a.id AS lead_id,\na.fecha_creacion AS lead_fecha_creacion,\na.funnel_id,\na.\"customFields\",\nb.id AS contacto_id,\nb.nombre,\nb.apellido_paterno,\nb.telefono,\nb.email,\nb.nro_documento,\ne.nombre AS etapa_funnel\nFROM crm.leads a\nLEFT JOIN crm.contactos b ON a.contacto_id = b.id\nLEFT JOIN crm.etapas_leads e ON a.etapa_inmueble = e.codigo\nWHERE a.funnel_id = 7\n),\nkv AS (\nSELECT lb.lead_id,\nlb.contacto_id,\nlb.nombre,\nlb.apellido_paterno,\nlb.telefono,\nlb.nro_documento,\nlb.email,\nlb.lead_fecha_creacion,\nlb.funnel_id,\nlb.etapa_funnel,\nk.key   AS field_id,\nk.value AS raw_value\nFROM lead_base lb\nLEFT JOIN LATERAL jsonb_each(lb.\"customFields\"::jsonb) AS k(key, value) ON true\n),\nkv_norm AS (\nSELECT\nkv.*,\ntrim(both '\"' from kv.raw_value::text) AS raw_text,\nCASE\nWHEN jsonb_typeof(kv.raw_value) IN ('number','string')\nAND (trim(both '\"' from kv.raw_value::text) ~ '^\\\\d+$')\nTHEN (trim(both '\"' from kv.raw_value::text))::int\nELSE NULL\nEND AS raw_id\nFROM kv\n),\nresolved AS (\nSELECT\nkvn.lead_id,\nkvn.contacto_id,\nkvn.nombre,\nkvn.apellido_paterno,\nkvn.telefono,\nkvn.nro_documento,\nkvn.email,\nkvn.lead_fecha_creacion,\nkvn.etapa_funnel,\ncf.name AS field_name,\nCOALESCE(cv.value, NULLIF(kvn.raw_text,'null')) AS field_value\nFROM kv_norm kvn\nLEFT JOIN crm.custom_fields cf ON cf.id = kvn.field_id\nLEFT JOIN crm.custom_values cv\nON cv.field_id = cf.id AND cv.id = kvn.raw_id\nWHERE cf.funnel_id = 7\n),\nleads_v1 AS (\nSELECT\nr.lead_id,\nr.contacto_id,\nr.nombre,\nr.apellido_paterno,\nr.telefono,\nr.email,\nr.nro_documento,\nr.lead_fecha_creacion,\nr.etapa_funnel,\nMAX(CASE WHEN r.field_name = '¿En que departamento se encuentra tu inmueble?' THEN r.field_value END) AS departamento,\nMAX(CASE WHEN r.field_name = '¿En qué distrito se encuentra tu inmueble?' THEN r.field_value END) AS distrito,\nMAX(CASE WHEN r.field_name = '¿Tu departamento está listo para alquilar o está en construcción?' THEN r.field_value END) AS listo_alquilar\nFROM resolved r\nGROUP BY 1,2,3,4,5,6,7,8,9\n),\nleads_final AS (\nSELECT\nlead_fecha_creacion::date AS fechacreacion,\nnombre,\napellido_paterno,\nnro_documento AS nrodoc,\ntelefono,\nemail,\ndistrito,\nCASE WHEN distrito IN (\n'Miraflores', 'San Miguel', 'Magdalena', 'Lince', 'Jesús María',\n'Pueblo Libre', 'La Victoria', 'Breña', 'Barranco', 'San Borja',\n'San Isidro', 'Surquillo', 'Chorrillos', 'Santa Beatriz', 'Surco'\n)\nTHEN 'SI' ELSE 'NO'\nEND AS con_cobertura,\nlisto_alquilar\nFROM leads_v1\nWHERE DATE_TRUNC('month', lead_fecha_creacion::timestamp) = DATE_TRUNC('month', CURRENT_DATE)\n)\nSELECT\nTO_CHAR(DATE_TRUNC('month', CURRENT_DATE), 'YYYY-MM') as \"Mes\",\n(\n    SELECT COUNT(DISTINCT telefono)\n    FROM leads_final\n    WHERE nombre NOT ILIKE '%TEST%'\n    AND nombre NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%Mendoza Mattos%'\n    AND apellido_paterno NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%TEST%'\n    AND (nrodoc <> '75946464' OR nrodoc IS NULL)\n) as \"Leads Tot\",\n(\n    SELECT COUNT(DISTINCT telefono)\n    FROM leads_final\n    WHERE con_cobertura = 'SI'\n    AND nombre NOT ILIKE '%TEST%'\n    AND nombre NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%Mendoza Mattos%'\n    AND apellido_paterno NOT ILIKE '%PRUEBA%'\n    AND apellido_paterno NOT ILIKE '%TEST%'\n    AND (nrodoc <> '75946464' OR nrodoc IS NULL)\n) as \"Leads Cob\",\n(\n    SELECT COUNT(DISTINCT A.telefono)\n    FROM leads_final A\n    LEFT JOIN rentas_crm.visitas B \n        ON RIGHT(REGEXP_REPLACE(A.TELEFONO, '[^0-9]', '', 'g'), 9) = RIGHT(REGEXP_REPLACE(B.CELULAR, '[^0-9]', '', 'g'), 9)\n    WHERE A.nombre NOT ILIKE '%TEST%'\n    AND A.nombre NOT ILIKE '%PRUEBA%'\n    AND A.apellido_paterno NOT ILIKE '%Mendoza Mattos%'\n    AND A.apellido_paterno NOT ILIKE '%PRUEBA%'\n    AND A.apellido_paterno NOT ILIKE '%TEST%'\n    AND (A.nrodoc <> '75946464' OR A.nrodoc IS NULL)\n    AND B.formulario = 'Propietario interesado'\n    AND RIGHT(REGEXP_REPLACE(B.celular, '[^0-9]', '', 'g'), 9) NOT IN ('959264957')\n) as \"Llamadas Agend\",\n0 as \"Inm. Recep\",\n0 as \"Dias Conv\"",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1344,
        -192
      ],
      "id": "83380d73-85ad-43db-8ace-13b1109fa5a7",
      "name": "Query Inventario Acumulado",
      "credentials": {
        "postgres": {
          "id": "fuKiWlAN9ojbRM9W",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// HTML Formatting for Rentas Report v2\nconst daily = $('Query Diario').all().map(i => i.json)[0] || {};\nconst monthly = $('Query Acumulado').all().map(i => i.json)[0] || {};\nconst modoDaily = $('Query MODO Diario').all().map(i => i.json)[0] || {};\nconst modoMonthly = $('Query MODO Acumulado').all().map(i => i.json)[0] || {};\nconst retailDaily = $('Query Retail Diario').all().map(i => i.json)[0] || {};\nconst retailMonthly = $('Query Retail Acumulado').all().map(i => i.json)[0] || {};\nconst invDaily = $('Query Inventario Diario').all().map(i => i.json)[0] || {};\nconst invMonthly = $('Query Inventario Acumulado').all().map(i => i.json)[0] || {};\n\nconst targets = {\n  modo: {\n    leads: 17,\n    visitas__agend: 4,\n    visitas_real: 2,\n    acc_leads_tgt: 300,\n    acc_vis_agend_tgt: 80,\n    acc_vis_real_tgt: 40,\n    acc_new_ing_tgt: 10\n  },\n  retail: {\n    leads: 25,\n    visitas_agend: 10,\n    visitas_real: 7,\n    acc_leads_tgt: 400,\n    acc_vis_agend_tgt: 150,\n    acc_vis_real_tgt: 100,\n    acc_new_ing_tgt: 30\n  },\n  inventario: {\n    leads: 5,\n    leads_cob: 4,\n    llamadas: 5,\n    acc_leads_tgt: 156,\n    acc_leads_cob: 120,\n    acc_inm_recep: 30\n  }\n};\n\nfunction formatPct(num, den) {\n  if (!den) return \"0%\";\n  return Math.round((num / den) * 100) + \"%\";\n}\n\nfunction getDiffColor(val) {\n    const num = parseFloat(val);\n    if (isNaN(num)) return '#FFFFFF';\n    if (num >= 0) return '#C6EFCE';\n    return '#FFC7CE';\n}\n\nfunction getTdDiff(val) {\n    const color = getDiffColor(val);\n    return `<td style=\"background-color: ${color}\">${val}</td>`;\n}\n\nlet html = `\n<div style=\"font-family: Arial, sans-serif;\">\n  <h2 style=\"color: #333;\">REPORTE DIARIO RENTAS</h2>\n  \n  <h3 style=\"border-bottom: 2px solid #007bff; padding-bottom: 5px;\">1. Resumen General Agente Corretaje (Ayer)</h3>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n    <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Fecha</th>\n        <th>Total Leads</th>\n        <th>Inm. Ident.</th>\n        <th>% Ident.</th>\n        <th>Dieron Horario</th>\n        <th>% Horario</th>\n        <th>Error</th>\n        <th>% Error</th>\n        <th>Leads Modo</th>\n        <th>Leads Retail</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${daily['Fecha'] || 'N/A'}</td>\n        <td>${daily['Total Leads'] || 0}</td>\n        <td>${daily['Inm. Ident.'] || 0}</td>\n        <td>${formatPct(daily['Inm. Ident.'], daily['Total Leads'])}</td>\n        <td>${daily['Dieron Horario'] || 0}</td>\n        <td>${formatPct(daily['Dieron Horario'], daily['Total Leads'])}</td>\n        <td>${daily['Error'] || 0}</td>\n        <td>${formatPct(daily['Error'], daily['Total Leads'])}</td>\n        <td>${daily['Leads Modo'] || 0}</td>\n        <td>${daily['Leads Retail'] || 0}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <h4 style=\"margin-top: 20px;\">Acumulado Agente Corretaje (Mes Actual)</h4>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n    <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Mes</th>\n        <th>Total Leads</th>\n        <th>Inm. Ident.</th>\n        <th>% Ident.</th>\n        <th>Dieron Horario</th>\n        <th>% Horario</th>\n        <th>Error</th>\n        <th>% Error</th>\n        <th>Leads Modo</th>\n        <th>Leads Retail</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${monthly['Mes'] || 'N/A'}</td>\n        <td>${monthly['Total Leads'] || 0}</td>\n        <td>${monthly['Inm. Ident.'] || 0}</td>\n        <td>${formatPct(monthly['Inm. Ident.'], monthly['Total Leads'])}</td>\n        <td>${monthly['Dieron Horario'] || 0}</td>\n        <td>${formatPct(monthly['Dieron Horario'], monthly['Total Leads'])}</td>\n        <td>${monthly['Error'] || 0}</td>\n        <td>${formatPct(monthly['Error'], monthly['Total Leads'])}</td>\n        <td>${monthly['Leads Modo'] || 0}</td>\n        <td>${monthly['Leads Retail'] || 0}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <h3 style=\"border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 30px;\">2. Detalle Operativo: MODO (Ayer)</h3>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n    <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Fecha</th>\n        <th>Leads Real</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>Visitas Agend.</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>% Conv</th>\n        <th>Visitas Real.</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>% Conv</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${modoDaily['Fecha'] || 'N/A'}</td>\n        <td>${modoDaily['Leads Real'] || 0}</td>\n        <td>${targets.modo.leads}</td>\n        ${getTdDiff((modoDaily['Leads Real']||0) - targets.modo.leads)}\n        \n        <td>${modoDaily['Visitas Agend.'] || 0}</td>\n        <td>${targets.modo.visitas__agend}</td>\n        ${getTdDiff((modoDaily['Visitas Agend.']||0) - targets.modo.visitas__agend)}\n        <td>${formatPct(modoDaily['Visitas Agend.'], modoDaily['Leads Real'])}</td>\n        \n        <td>${modoDaily['Visitas Real.'] || 0}</td>\n        <td>${targets.modo.visitas_real}</td>\n        ${getTdDiff((modoDaily['Visitas Real.']||0) - targets.modo.visitas_real)}\n        <td>${formatPct(modoDaily['Visitas Real.'], modoDaily['Visitas Agend.'])}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <h4 style=\"margin-top: 20px;\">Detalle MODO acumulado mes actual</h4>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n    <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Mes</th>\n        <th>Leads</th>\n        <th>Visitas Agend.</th>\n        <th>Visitas Real.</th>\n        <th>Nuevos Ingresos</th>\n        <th>Tgt</th>\n        <th>Dif</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${modoMonthly['Mes'] || 'N/A'}</td>\n        <td>${modoMonthly['Leads'] || 0}</td>\n        <td>${modoMonthly['Visitas Agend.'] || 0}</td>\n        <td>${modoMonthly['Visitas Real.'] || 0}</td>\n        <td>${modoMonthly['Nuevos Ingresos'] || 0}</td>\n        <td>${targets.modo.acc_new_ing_tgt}</td>\n        ${getTdDiff((modoMonthly['Nuevos Ingresos']||0) - targets.modo.acc_new_ing_tgt)}\n      </tr>\n    </tbody>\n  </table>\n\n  <h3 style=\"border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 30px;\">3. Detalle Operativo: RETAIL (Ayer)</h3>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n    <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Fecha</th>\n        <th>Leads Real</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>Visitas Agend.</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>% Conv</th>\n        <th>Visitas Real.</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>% Conv</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${retailDaily['Fecha'] || 'N/A'}</td>\n        <td>${retailDaily['Leads Real'] || 0}</td>\n        <td>${targets.retail.leads}</td>\n        ${getTdDiff((retailDaily['Leads Real']||0) - targets.retail.leads)}\n        \n        <td>${retailDaily['Visitas Agend.'] || 0}</td>\n        <td>${targets.retail.visitas_agend}</td>\n        ${getTdDiff((retailDaily['Visitas Agend.']||0) - targets.retail.visitas_agend)}\n        <td>${formatPct(retailDaily['Visitas Agend.'], retailDaily['Leads Real'])}</td>\n        \n        <td>${retailDaily['Visitas Real.'] || 0}</td>\n        <td>${targets.retail.visitas_real}</td>\n        ${getTdDiff((retailDaily['Visitas Real.']||0) - targets.retail.visitas_real)}\n        <td>${formatPct(retailDaily['Visitas Real.'], retailDaily['Visitas Agend.'])}</td>\n      </tr>\n    </tbody>\n  </table>\n\n  <h4 style=\"margin-top: 20px;\">Detalle RETAIL acumulado mes actual</h4>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n     <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Mes</th>\n        <th>Leads</th>\n        <th>Visitas Agend.</th>\n        <th>Visitas Real.</th>\n        <th>Nuevos Ingresos</th>\n        <th>Tgt</th>\n        <th>Dif</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${retailMonthly['Mes'] || 'N/A'}</td>\n        <td>${retailMonthly['Leads'] || 0}</td>\n        <td>${retailMonthly['Visitas Agend.'] || 0}</td>\n        <td>${retailMonthly['Visitas Real.'] || 0}</td>\n        <td>${retailMonthly['Nuevos Ingresos'] || 0}</td>\n        <td>${targets.retail.acc_new_ing_tgt}</td>\n        ${getTdDiff((retailMonthly['Nuevos Ingresos']||0) - targets.retail.acc_new_ing_tgt)}\n      </tr>\n    </tbody>\n  </table>\n\n  <h3 style=\"border-bottom: 2px solid #007bff; padding-bottom: 5px; margin-top: 30px;\">4. Detalle Operativo: INVENTARIO (Ayer)</h3>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n    <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Fecha</th>\n        <th>Leads Real</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>Leads en Cobertura</th>\n        <th>Target</th>\n        <th>Dif</th>\n        <th>Horarios</th>\n        <th>Llamadas</th>\n        <th>Target</th>\n        <th>Dif</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${invDaily['Fecha'] || 'N/A'}</td>\n        <td>${invDaily['Leads Real'] || 0}</td>\n        <td>${targets.inventario.leads}</td>\n        ${getTdDiff((invDaily['Leads Real']||0) - targets.inventario.leads)}\n        \n        <td>${invDaily['Leads en Cobertura'] || 0}</td>\n        <td>${targets.inventario.leads_cob}</td>\n        ${getTdDiff((invDaily['Leads en Cobertura']||0) - targets.inventario.leads_cob)}\n        \n        <td>${invDaily['Horarios'] || 0}</td>\n        <td>${invDaily['Llamadas'] || 0}</td>\n        <td>${targets.inventario.llamadas}</td>\n        ${getTdDiff((invDaily['Llamadas']||0) - targets.inventario.llamadas)}\n      </tr>\n    </tbody>\n  </table>\n\n   <h4 style=\"margin-top: 20px;\">Detalle INVENTARIO acumulado mes actual</h4>\n  <table border=\"1\" cellpadding=\"8\" cellspacing=\"0\" style=\"border-collapse: collapse; width: 100%; border: 1px solid #ddd; text-align: center;\">\n    <thead style=\"background-color: #f2f2f2;\">\n      <tr>\n        <th>Mes</th>\n        <th>Leads Tot</th>\n        <th>Tgt</th>\n        <th>Dif</th>\n        <th>Leads Cob</th>\n        <th>Tgt</th>\n        <th>Dif</th>\n        <th>% Cob</th>\n        <th>Llamadas Agend</th>\n        <th>Inm. Recep</th>\n        <th>Tgt</th>\n        <th>Dif</th>\n        <th>Dias Conv</th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>${invMonthly['Mes'] || 'N/A'}</td>\n        <td>${invMonthly['Leads Tot'] || 0}</td>\n        <td>${targets.inventario.acc_leads_tgt}</td>\n        ${getTdDiff((invMonthly['Leads Tot']||0) - targets.inventario.acc_leads_tgt)}\n        \n        <td>${invMonthly['Leads Cob'] || 0}</td>\n        <td>${targets.inventario.acc_leads_cob}</td>\n        ${getTdDiff((invMonthly['Leads Cob']||0) - targets.inventario.acc_leads_cob)}\n        \n        <td>${formatPct(invMonthly['Leads Cob'], invMonthly['Leads Tot'])}</td>\n        <td>${invMonthly['Llamadas Agend'] || 0}</td>\n        <td>${invMonthly['Inm. Recep'] || 0}</td>\n        <td>${targets.inventario.acc_inm_recep}</td>\n        ${getTdDiff((invMonthly['Inm. Recep']||0) - targets.inventario.acc_inm_recep)}\n        <td>${invMonthly['Dias Conv'] || 0}</td>\n      </tr>\n    </tbody>\n  </table>\n\n</div>\n`;\n\nreturn { html };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1568,
        -192
      ],
      "id": "6f213126-1467-4607-a7f9-da25bd8911cf",
      "name": "Generate HTML"
    },
    {
      "parameters": {
        "sendTo": "mvelascoo@tamibot.com",
        "subject": "REPORTE DIARIO RENTAS",
        "message": "={{ $json.html }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1776,
        -192
      ],
      "id": "dfb59fb4-01ec-439e-865a-f449e7e59441",
      "name": "Send Email",
      "webhookId": "4e361326-6605-42f7-8aa1-126208a3660e",
      "credentials": {
        "gmailOAuth2": {
          "id": "SPurZ4Z9pGQy8MKJ",
          "name": "Gmail account"
        }
      }
    }
  ],
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "shared": [
    {
      "createdAt": "2025-12-04T18:05:49.387Z",
      "updatedAt": "2025-12-04T18:05:49.387Z",
      "role": "workflow:owner",
      "workflowId": "0zYOliVlWXi5TPIW",
      "projectId": "tpSonpyzopDOYZNA"
    }
  ],
  "staticData": {
    "node:Programado (8 AM)1": {
      "recurrenceRules": []
    },
    "node:Programado (8 AM)": {
      "recurrenceRules": []
    },
    "node:Schedule Trigger": {
      "recurrenceRules": []
    }
  },
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2026-02-03T17:52:49.829Z",
  "versionId": "24c721f4-5d60-4203-81bb-3563dd3376a6"
}